"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BaseTransactionBuilder = void 0;
const errors_1 = require("./errors");
/**
 * Generic transaction builder to be extended with coin specific logic.
 * Provide a set of default steps (i.e. from, sign, build) and enforces mandatory validations.
 */
class BaseTransactionBuilder {
    /**
     * Base constructor.
     *
     * @param _coinConfig BaseCoin from statics library
     */
    constructor(_coinConfig) {
        this._coinConfig = _coinConfig;
    }
    /**
     * Parse a transaction based on existing data. The input format is determined by the coin
     * extending this class. Some examples are hex, base64, or JSON.
     *
     * @param rawTransaction A raw transaction to be parsed
     */
    from(rawTransaction) {
        this.validateRawTransaction(rawTransaction);
        this.transaction = this.fromImplementation(rawTransaction);
    }
    /**
     * Validate keys and sign the transaction.
     *
     * @param key One of the keys associated with this transaction
     */
    sign(key) {
        this.validateKey(key);
        if (!this.transaction.canSign(key)) {
            throw new errors_1.SigningError('Private key cannot sign the transaction');
        }
        this.transaction = this.signImplementation(key);
    }
    /**
     * Adds a signature to the transaction.
     *
     * @param publicKey public key that produced the signature
     * @param signature raw signature as a hex encoded Buffer
     */
    addSignature(publicKey, signature) {
        throw new errors_1.SigningError(`${this.coinName()} does not support adding signatures directly.`);
    }
    /**
     * Finalize the transaction by performing any extra step like calculating hashes, verifying
     * integrity, or adding default values.
     *
     * @returns valid coin specific transaction (signed or unsigned)
     */
    async build() {
        this.validateTransaction(this.transaction);
        return this.buildImplementation();
    }
    /**
     * Get the underlying coin full name as specified in the statics library.
     */
    displayName() {
        return this._coinConfig.fullName;
    }
    /**
     * Get the underlying coin full name as specified in the statics library.
     */
    coinName() {
        return this._coinConfig.name;
    }
    /**
     * Verified validity windows params if them exist and return a valid validity windows.
     * Unit param must be specified
     * If params are not consistent, default params will be return based on firstValid and minDuration
     * @param {ValidityWindow} params validity windows parameters to validate.
     * @param {String} params.unit Parameter that could be 'blockheight' or 'timestamp'
     * @param {Number} [params.minDuration] Optional - Minimum duration of the window
     * @param {Number} [params.maxDuration] Optional - Maximum duration of the window
     * @param {Number} [params.firstValid] Optional - First valid value
     * @param {Number} [params.lastValid] Optional - Last valid value
     * @returns {ValidityWindow} verified validity windows or default values
     */
    getValidityWindow(params) {
        if (!params.unit || (params.unit !== 'timestamp' && params.unit !== 'blockheight')) {
            throw new Error('Unit parameter must be specified as blockheight or timestamp');
        }
        const unit = params.unit;
        let defaultMinDuration;
        let defaultMaxDuration;
        let defaultFirstValid;
        let defaultLastValid;
        /* Set Default Params
          minimum duration is set as 1 hr (3600000 msec) if unit is timestamp or 20 blocks if it is blockheight
          maximum duration is set as 1 year (31536000000 msec) if unit is timestamp or 1000000 blocks if it is blockheight.
         */
        if (unit === 'timestamp') {
            defaultMinDuration = 0;
            defaultMaxDuration = 31536000000;
            defaultFirstValid = Date.now();
            defaultLastValid = defaultFirstValid + defaultMaxDuration;
        }
        else {
            defaultMinDuration = 0;
            defaultMaxDuration = 1000000;
            defaultFirstValid = 0;
            defaultLastValid = defaultFirstValid + defaultMaxDuration;
        }
        // If any params exist, they will be used, otherwise it will be used default params.
        let firstValid = params.firstValid || defaultFirstValid;
        let lastValid = params.lastValid || defaultLastValid;
        let minDuration = params.minDuration || defaultMinDuration;
        let maxDuration = params.maxDuration || defaultMaxDuration;
        /* Validate Params:
          minDuration < maxDuration
          firstValid < lastValid
          firstValid + minDuration <= lastValid <= firstValid + maxDuration
         */
        if (minDuration >= maxDuration) {
            throw new Error(`Expected maxDuration (${maxDuration}) to be grather than minDuration (${minDuration})`);
        }
        firstValid = firstValid >= 0 ? firstValid : defaultFirstValid;
        minDuration = minDuration >= 0 ? minDuration : defaultMinDuration;
        maxDuration = maxDuration > minDuration ? maxDuration : defaultMaxDuration;
        lastValid =
            lastValid >= firstValid + minDuration && lastValid <= firstValid + maxDuration
                ? lastValid
                : firstValid + maxDuration;
        return {
            firstValid,
            lastValid,
            minDuration,
            maxDuration,
            unit,
        };
    }
}
exports.BaseTransactionBuilder = BaseTransactionBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZVRyYW5zYWN0aW9uQnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hY2NvdW50LWxpYi9iYXNlQ29pbi9iYXNlVHJhbnNhY3Rpb25CdWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUlBLHFDQUF3QztBQUV4Qzs7O0dBR0c7QUFDSCxNQUFzQixzQkFBc0I7SUFFMUM7Ozs7T0FJRztJQUNILFlBQXNCLFdBQWlDO1FBQ3JELElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0lBQ2pDLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILElBQUksQ0FBQyxjQUFtQjtRQUN0QixJQUFJLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQVVEOzs7O09BSUc7SUFDSCxJQUFJLENBQUMsR0FBWTtRQUNmLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2xDLE1BQU0sSUFBSSxxQkFBWSxDQUFDLHlDQUF5QyxDQUFDLENBQUM7U0FDbkU7UUFFRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxZQUFZLENBQUMsU0FBb0IsRUFBRSxTQUFpQjtRQUNsRCxNQUFNLElBQUkscUJBQVksQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsK0NBQStDLENBQUMsQ0FBQztJQUM1RixDQUFDO0lBVUQ7Ozs7O09BS0c7SUFDSCxLQUFLLENBQUMsS0FBSztRQUNULElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0MsT0FBTyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0lBK0NEOztPQUVHO0lBQ0gsV0FBVztRQUNULE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7SUFDL0IsQ0FBQztJQUVEOzs7Ozs7Ozs7OztPQVdHO0lBQ0gsaUJBQWlCLENBQUMsTUFBc0I7UUFDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLFdBQVcsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLGFBQWEsQ0FBQyxFQUFFO1lBQ2xGLE1BQU0sSUFBSSxLQUFLLENBQUMsOERBQThELENBQUMsQ0FBQztTQUNqRjtRQUNELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDekIsSUFBSSxrQkFBMEIsQ0FBQztRQUMvQixJQUFJLGtCQUEwQixDQUFDO1FBQy9CLElBQUksaUJBQXlCLENBQUM7UUFDOUIsSUFBSSxnQkFBd0IsQ0FBQztRQUU3Qjs7O1dBR0c7UUFDSCxJQUFJLElBQUksS0FBSyxXQUFXLEVBQUU7WUFDeEIsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZCLGtCQUFrQixHQUFHLFdBQVcsQ0FBQztZQUNqQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDL0IsZ0JBQWdCLEdBQUcsaUJBQWlCLEdBQUcsa0JBQWtCLENBQUM7U0FDM0Q7YUFBTTtZQUNMLGtCQUFrQixHQUFHLENBQUMsQ0FBQztZQUN2QixrQkFBa0IsR0FBRyxPQUFPLENBQUM7WUFDN0IsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO1lBQ3RCLGdCQUFnQixHQUFHLGlCQUFpQixHQUFHLGtCQUFrQixDQUFDO1NBQzNEO1FBRUQsb0ZBQW9GO1FBQ3BGLElBQUksVUFBVSxHQUFXLE1BQU0sQ0FBQyxVQUFVLElBQUksaUJBQWlCLENBQUM7UUFDaEUsSUFBSSxTQUFTLEdBQVcsTUFBTSxDQUFDLFNBQVMsSUFBSSxnQkFBZ0IsQ0FBQztRQUM3RCxJQUFJLFdBQVcsR0FBVyxNQUFNLENBQUMsV0FBVyxJQUFJLGtCQUFrQixDQUFDO1FBQ25FLElBQUksV0FBVyxHQUFXLE1BQU0sQ0FBQyxXQUFXLElBQUksa0JBQWtCLENBQUM7UUFFbkU7Ozs7V0FJRztRQUNILElBQUksV0FBVyxJQUFJLFdBQVcsRUFBRTtZQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixXQUFXLHFDQUFxQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO1NBQzFHO1FBQ0QsVUFBVSxHQUFHLFVBQVUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUM7UUFDOUQsV0FBVyxHQUFHLFdBQVcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUM7UUFDbEUsV0FBVyxHQUFHLFdBQVcsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUM7UUFDM0UsU0FBUztZQUNQLFNBQVMsSUFBSSxVQUFVLEdBQUcsV0FBVyxJQUFJLFNBQVMsSUFBSSxVQUFVLEdBQUcsV0FBVztnQkFDNUUsQ0FBQyxDQUFDLFNBQVM7Z0JBQ1gsQ0FBQyxDQUFDLFVBQVUsR0FBRyxXQUFXLENBQUM7UUFFL0IsT0FBTztZQUNMLFVBQVU7WUFDVixTQUFTO1lBQ1QsV0FBVztZQUNYLFdBQVc7WUFDWCxJQUFJO1NBQ0wsQ0FBQztJQUNKLENBQUM7Q0FXRjtBQWxORCx3REFrTkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmlnTnVtYmVyIGZyb20gJ2JpZ251bWJlci5qcyc7XG5pbXBvcnQgeyBCYXNlQ29pbiBhcyBDb2luQ29uZmlnIH0gZnJvbSAnQGJpdGdvL3N0YXRpY3MnO1xuaW1wb3J0IHsgQmFzZUFkZHJlc3MsIEJhc2VLZXksIFB1YmxpY0tleSwgVmFsaWRpdHlXaW5kb3cgfSBmcm9tICcuL2lmYWNlJztcbmltcG9ydCB7IEJhc2VUcmFuc2FjdGlvbiB9IGZyb20gJy4vYmFzZVRyYW5zYWN0aW9uJztcbmltcG9ydCB7IFNpZ25pbmdFcnJvciB9IGZyb20gJy4vZXJyb3JzJztcblxuLyoqXG4gKiBHZW5lcmljIHRyYW5zYWN0aW9uIGJ1aWxkZXIgdG8gYmUgZXh0ZW5kZWQgd2l0aCBjb2luIHNwZWNpZmljIGxvZ2ljLlxuICogUHJvdmlkZSBhIHNldCBvZiBkZWZhdWx0IHN0ZXBzIChpLmUuIGZyb20sIHNpZ24sIGJ1aWxkKSBhbmQgZW5mb3JjZXMgbWFuZGF0b3J5IHZhbGlkYXRpb25zLlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmFzZVRyYW5zYWN0aW9uQnVpbGRlciB7XG4gIHByb3RlY3RlZCBfY29pbkNvbmZpZzogUmVhZG9ubHk8Q29pbkNvbmZpZz47XG4gIC8qKlxuICAgKiBCYXNlIGNvbnN0cnVjdG9yLlxuICAgKlxuICAgKiBAcGFyYW0gX2NvaW5Db25maWcgQmFzZUNvaW4gZnJvbSBzdGF0aWNzIGxpYnJhcnlcbiAgICovXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihfY29pbkNvbmZpZzogUmVhZG9ubHk8Q29pbkNvbmZpZz4pIHtcbiAgICB0aGlzLl9jb2luQ29uZmlnID0gX2NvaW5Db25maWc7XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgYSB0cmFuc2FjdGlvbiBiYXNlZCBvbiBleGlzdGluZyBkYXRhLiBUaGUgaW5wdXQgZm9ybWF0IGlzIGRldGVybWluZWQgYnkgdGhlIGNvaW5cbiAgICogZXh0ZW5kaW5nIHRoaXMgY2xhc3MuIFNvbWUgZXhhbXBsZXMgYXJlIGhleCwgYmFzZTY0LCBvciBKU09OLlxuICAgKlxuICAgKiBAcGFyYW0gcmF3VHJhbnNhY3Rpb24gQSByYXcgdHJhbnNhY3Rpb24gdG8gYmUgcGFyc2VkXG4gICAqL1xuICBmcm9tKHJhd1RyYW5zYWN0aW9uOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnZhbGlkYXRlUmF3VHJhbnNhY3Rpb24ocmF3VHJhbnNhY3Rpb24pO1xuICAgIHRoaXMudHJhbnNhY3Rpb24gPSB0aGlzLmZyb21JbXBsZW1lbnRhdGlvbihyYXdUcmFuc2FjdGlvbik7XG4gIH1cblxuICAvKipcbiAgICogQ29pbiBzcGVjaWZpYyBpbXBsZW1lbnRhdGlvbiBvZiB7QGNvZGUgZnJvbX0uXG4gICAqXG4gICAqIEBzZWUge0BsaW5rIGZyb219XG4gICAqIEByZXR1cm5zIHRoZSBwYXJzZWQgY29pbiBzcGVjaWZpYyB0cmFuc2FjdGlvbiBvYmplY3RcbiAgICovXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBmcm9tSW1wbGVtZW50YXRpb24ocmF3VHJhbnNhY3Rpb246IGFueSk6IEJhc2VUcmFuc2FjdGlvbjtcblxuICAvKipcbiAgICogVmFsaWRhdGUga2V5cyBhbmQgc2lnbiB0aGUgdHJhbnNhY3Rpb24uXG4gICAqXG4gICAqIEBwYXJhbSBrZXkgT25lIG9mIHRoZSBrZXlzIGFzc29jaWF0ZWQgd2l0aCB0aGlzIHRyYW5zYWN0aW9uXG4gICAqL1xuICBzaWduKGtleTogQmFzZUtleSk6IHZvaWQge1xuICAgIHRoaXMudmFsaWRhdGVLZXkoa2V5KTtcbiAgICBpZiAoIXRoaXMudHJhbnNhY3Rpb24uY2FuU2lnbihrZXkpKSB7XG4gICAgICB0aHJvdyBuZXcgU2lnbmluZ0Vycm9yKCdQcml2YXRlIGtleSBjYW5ub3Qgc2lnbiB0aGUgdHJhbnNhY3Rpb24nKTtcbiAgICB9XG5cbiAgICB0aGlzLnRyYW5zYWN0aW9uID0gdGhpcy5zaWduSW1wbGVtZW50YXRpb24oa2V5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgc2lnbmF0dXJlIHRvIHRoZSB0cmFuc2FjdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIHB1YmxpY0tleSBwdWJsaWMga2V5IHRoYXQgcHJvZHVjZWQgdGhlIHNpZ25hdHVyZVxuICAgKiBAcGFyYW0gc2lnbmF0dXJlIHJhdyBzaWduYXR1cmUgYXMgYSBoZXggZW5jb2RlZCBCdWZmZXJcbiAgICovXG4gIGFkZFNpZ25hdHVyZShwdWJsaWNLZXk6IFB1YmxpY0tleSwgc2lnbmF0dXJlOiBCdWZmZXIpOiB2b2lkIHtcbiAgICB0aHJvdyBuZXcgU2lnbmluZ0Vycm9yKGAke3RoaXMuY29pbk5hbWUoKX0gZG9lcyBub3Qgc3VwcG9ydCBhZGRpbmcgc2lnbmF0dXJlcyBkaXJlY3RseS5gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb2luIHNwZWNpZmljIGltcGxlbWVudGF0aW9uIG9mIHtAY29kZSBzaWdufS5cbiAgICpcbiAgICogQHNlZSB7QGxpbmsgc2lnbn1cbiAgICogQHJldHVybnMgY29pbiBzcGVjaWZpYyB0cmFuc2FjdGlvbiB3aXRoIHNpZ25hdHVyZSBkYXRhXG4gICAqL1xuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2lnbkltcGxlbWVudGF0aW9uKGtleTogQmFzZUtleSk6IEJhc2VUcmFuc2FjdGlvbjtcblxuICAvKipcbiAgICogRmluYWxpemUgdGhlIHRyYW5zYWN0aW9uIGJ5IHBlcmZvcm1pbmcgYW55IGV4dHJhIHN0ZXAgbGlrZSBjYWxjdWxhdGluZyBoYXNoZXMsIHZlcmlmeWluZ1xuICAgKiBpbnRlZ3JpdHksIG9yIGFkZGluZyBkZWZhdWx0IHZhbHVlcy5cbiAgICpcbiAgICogQHJldHVybnMgdmFsaWQgY29pbiBzcGVjaWZpYyB0cmFuc2FjdGlvbiAoc2lnbmVkIG9yIHVuc2lnbmVkKVxuICAgKi9cbiAgYXN5bmMgYnVpbGQoKTogUHJvbWlzZTxCYXNlVHJhbnNhY3Rpb24+IHtcbiAgICB0aGlzLnZhbGlkYXRlVHJhbnNhY3Rpb24odGhpcy50cmFuc2FjdGlvbik7XG4gICAgcmV0dXJuIHRoaXMuYnVpbGRJbXBsZW1lbnRhdGlvbigpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvaW4gc3BlY2lmaWMgaW1wbGVtZW50YXRpb24gb2Yge0Bjb2RlIGJ1aWxkfS5cbiAgICpcbiAgICogQHNlZSB7QGxpbmsgYnVpbGR9XG4gICAqIEByZXR1cm5zIHZhbGlkIGNvaW4gc3BlY2lmaWMgdHJhbnNhY3Rpb24gKHNpZ25lZCBvciB1bnNpZ25lZClcbiAgICovXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBidWlsZEltcGxlbWVudGF0aW9uKCk6IFByb21pc2U8QmFzZVRyYW5zYWN0aW9uPjtcblxuICAvKipcbiAgICogQ2hlY2sgdGhlIHByaXZhdGUga2V5IGlzIHByZXNlbnQgYW5kIGlzIHZhbGlkIGluIHRoZSBibG9ja2NoYWluIGNvbnRleHQsIHRocm93IG90aGVyd2lzZS5cbiAgICpcbiAgICogQHBhcmFtIHtCYXNlS2V5fSBrZXkgUHJpdmF0ZSBrZXkgdG8gdmFsaWRhdGVcbiAgICovXG4gIGFic3RyYWN0IHZhbGlkYXRlS2V5KGtleTogQmFzZUtleSk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIENoZWNrIHRoZSBhZGRyZXNzIHByb3ZpZGVkIGlzIHZhbGlkIGluIHRoZSBibG9ja2NoYWluIGNvbnRleHQsIHRocm93IG90aGVyd2lzZS5cbiAgICpcbiAgICogQHBhcmFtIGFkZHJlc3MgQWRkcmVzcyBkYXRhIHRvIGJlIHZhbGlkYXRlZFxuICAgKiBAcGFyYW0gYWRkcmVzc0Zvcm1hdCBUaGUgZm9ybWF0IHRoZSBhZGRyZXNzIHNob3VsZCBiZSBpbiBpZiBtb3JlIHRoYW4gb25lIGlzIHN1cHBvcnRlZFxuICAgKi9cbiAgYWJzdHJhY3QgdmFsaWRhdGVBZGRyZXNzKGFkZHJlc3M6IEJhc2VBZGRyZXNzLCBhZGRyZXNzRm9ybWF0Pzogc3RyaW5nKTogdm9pZDtcblxuICAvKipcbiAgICogQ2hlY2sgdGhlIGFtb3VudCBwcm92aWRlZCBpcyB2YWxpZCBpbiB0aGUgYmxvY2tjaGFpbiBjb250ZXh0LCB0aHJvdyBvdGhlcndpc2UuXG4gICAqXG4gICAqIEBwYXJhbSB7QmlnTnVtYmVyfSB2YWx1ZSBUcmFuc2FjdGlvbiBhbW91bnRcbiAgICovXG4gIGFic3RyYWN0IHZhbGlkYXRlVmFsdWUodmFsdWU6IEJpZ051bWJlcik6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIENoZWNrIHRoZSByYXcgdHJhbnNhY3Rpb24gaGFzIGEgdmFsaWQgZm9ybWF0IGluIHRoZSBibG9ja2NoYWluIGNvbnRleHQsIHRocm93IG90aGVyd2lzZS5cbiAgICpcbiAgICogQHBhcmFtIHJhd1RyYW5zYWN0aW9uIFRyYW5zYWN0aW9uIGluIGFueSBmb3JtYXRcbiAgICovXG4gIGFic3RyYWN0IHZhbGlkYXRlUmF3VHJhbnNhY3Rpb24ocmF3VHJhbnNhY3Rpb246IGFueSk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIENoZWNrIHRoZSB0cmFuc2FjdGlvbiBtYW5kYXRvcnkgZmllbGRzIHBlciB0cmFuc2FjdGlvbiB0eXBlIGFuZCBlbnN1cmVzIGl0IGlzIHZhbGlkLCB0aHJvd1xuICAgKiBvdGhlcndpc2UuXG4gICAqXG4gICAqIEBwYXJhbSB7QmFzZVRyYW5zYWN0aW9ufSB0cmFuc2FjdGlvblxuICAgKi9cbiAgYWJzdHJhY3QgdmFsaWRhdGVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbj86IEJhc2VUcmFuc2FjdGlvbik6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgdW5kZXJseWluZyBjb2luIGZ1bGwgbmFtZSBhcyBzcGVjaWZpZWQgaW4gdGhlIHN0YXRpY3MgbGlicmFyeS5cbiAgICovXG4gIGRpc3BsYXlOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2NvaW5Db25maWcuZnVsbE5hbWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSB1bmRlcmx5aW5nIGNvaW4gZnVsbCBuYW1lIGFzIHNwZWNpZmllZCBpbiB0aGUgc3RhdGljcyBsaWJyYXJ5LlxuICAgKi9cbiAgY29pbk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fY29pbkNvbmZpZy5uYW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWVkIHZhbGlkaXR5IHdpbmRvd3MgcGFyYW1zIGlmIHRoZW0gZXhpc3QgYW5kIHJldHVybiBhIHZhbGlkIHZhbGlkaXR5IHdpbmRvd3MuXG4gICAqIFVuaXQgcGFyYW0gbXVzdCBiZSBzcGVjaWZpZWRcbiAgICogSWYgcGFyYW1zIGFyZSBub3QgY29uc2lzdGVudCwgZGVmYXVsdCBwYXJhbXMgd2lsbCBiZSByZXR1cm4gYmFzZWQgb24gZmlyc3RWYWxpZCBhbmQgbWluRHVyYXRpb25cbiAgICogQHBhcmFtIHtWYWxpZGl0eVdpbmRvd30gcGFyYW1zIHZhbGlkaXR5IHdpbmRvd3MgcGFyYW1ldGVycyB0byB2YWxpZGF0ZS5cbiAgICogQHBhcmFtIHtTdHJpbmd9IHBhcmFtcy51bml0IFBhcmFtZXRlciB0aGF0IGNvdWxkIGJlICdibG9ja2hlaWdodCcgb3IgJ3RpbWVzdGFtcCdcbiAgICogQHBhcmFtIHtOdW1iZXJ9IFtwYXJhbXMubWluRHVyYXRpb25dIE9wdGlvbmFsIC0gTWluaW11bSBkdXJhdGlvbiBvZiB0aGUgd2luZG93XG4gICAqIEBwYXJhbSB7TnVtYmVyfSBbcGFyYW1zLm1heER1cmF0aW9uXSBPcHRpb25hbCAtIE1heGltdW0gZHVyYXRpb24gb2YgdGhlIHdpbmRvd1xuICAgKiBAcGFyYW0ge051bWJlcn0gW3BhcmFtcy5maXJzdFZhbGlkXSBPcHRpb25hbCAtIEZpcnN0IHZhbGlkIHZhbHVlXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBbcGFyYW1zLmxhc3RWYWxpZF0gT3B0aW9uYWwgLSBMYXN0IHZhbGlkIHZhbHVlXG4gICAqIEByZXR1cm5zIHtWYWxpZGl0eVdpbmRvd30gdmVyaWZpZWQgdmFsaWRpdHkgd2luZG93cyBvciBkZWZhdWx0IHZhbHVlc1xuICAgKi9cbiAgZ2V0VmFsaWRpdHlXaW5kb3cocGFyYW1zOiBWYWxpZGl0eVdpbmRvdyk6IFZhbGlkaXR5V2luZG93IHtcbiAgICBpZiAoIXBhcmFtcy51bml0IHx8IChwYXJhbXMudW5pdCAhPT0gJ3RpbWVzdGFtcCcgJiYgcGFyYW1zLnVuaXQgIT09ICdibG9ja2hlaWdodCcpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuaXQgcGFyYW1ldGVyIG11c3QgYmUgc3BlY2lmaWVkIGFzIGJsb2NraGVpZ2h0IG9yIHRpbWVzdGFtcCcpO1xuICAgIH1cbiAgICBjb25zdCB1bml0ID0gcGFyYW1zLnVuaXQ7XG4gICAgbGV0IGRlZmF1bHRNaW5EdXJhdGlvbjogbnVtYmVyO1xuICAgIGxldCBkZWZhdWx0TWF4RHVyYXRpb246IG51bWJlcjtcbiAgICBsZXQgZGVmYXVsdEZpcnN0VmFsaWQ6IG51bWJlcjtcbiAgICBsZXQgZGVmYXVsdExhc3RWYWxpZDogbnVtYmVyO1xuXG4gICAgLyogU2V0IERlZmF1bHQgUGFyYW1zXG4gICAgICBtaW5pbXVtIGR1cmF0aW9uIGlzIHNldCBhcyAxIGhyICgzNjAwMDAwIG1zZWMpIGlmIHVuaXQgaXMgdGltZXN0YW1wIG9yIDIwIGJsb2NrcyBpZiBpdCBpcyBibG9ja2hlaWdodFxuICAgICAgbWF4aW11bSBkdXJhdGlvbiBpcyBzZXQgYXMgMSB5ZWFyICgzMTUzNjAwMDAwMCBtc2VjKSBpZiB1bml0IGlzIHRpbWVzdGFtcCBvciAxMDAwMDAwIGJsb2NrcyBpZiBpdCBpcyBibG9ja2hlaWdodC5cbiAgICAgKi9cbiAgICBpZiAodW5pdCA9PT0gJ3RpbWVzdGFtcCcpIHtcbiAgICAgIGRlZmF1bHRNaW5EdXJhdGlvbiA9IDA7XG4gICAgICBkZWZhdWx0TWF4RHVyYXRpb24gPSAzMTUzNjAwMDAwMDtcbiAgICAgIGRlZmF1bHRGaXJzdFZhbGlkID0gRGF0ZS5ub3coKTtcbiAgICAgIGRlZmF1bHRMYXN0VmFsaWQgPSBkZWZhdWx0Rmlyc3RWYWxpZCArIGRlZmF1bHRNYXhEdXJhdGlvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVmYXVsdE1pbkR1cmF0aW9uID0gMDtcbiAgICAgIGRlZmF1bHRNYXhEdXJhdGlvbiA9IDEwMDAwMDA7XG4gICAgICBkZWZhdWx0Rmlyc3RWYWxpZCA9IDA7XG4gICAgICBkZWZhdWx0TGFzdFZhbGlkID0gZGVmYXVsdEZpcnN0VmFsaWQgKyBkZWZhdWx0TWF4RHVyYXRpb247XG4gICAgfVxuXG4gICAgLy8gSWYgYW55IHBhcmFtcyBleGlzdCwgdGhleSB3aWxsIGJlIHVzZWQsIG90aGVyd2lzZSBpdCB3aWxsIGJlIHVzZWQgZGVmYXVsdCBwYXJhbXMuXG4gICAgbGV0IGZpcnN0VmFsaWQ6IG51bWJlciA9IHBhcmFtcy5maXJzdFZhbGlkIHx8IGRlZmF1bHRGaXJzdFZhbGlkO1xuICAgIGxldCBsYXN0VmFsaWQ6IG51bWJlciA9IHBhcmFtcy5sYXN0VmFsaWQgfHwgZGVmYXVsdExhc3RWYWxpZDtcbiAgICBsZXQgbWluRHVyYXRpb246IG51bWJlciA9IHBhcmFtcy5taW5EdXJhdGlvbiB8fCBkZWZhdWx0TWluRHVyYXRpb247XG4gICAgbGV0IG1heER1cmF0aW9uOiBudW1iZXIgPSBwYXJhbXMubWF4RHVyYXRpb24gfHwgZGVmYXVsdE1heER1cmF0aW9uO1xuXG4gICAgLyogVmFsaWRhdGUgUGFyYW1zOlxuICAgICAgbWluRHVyYXRpb24gPCBtYXhEdXJhdGlvblxuICAgICAgZmlyc3RWYWxpZCA8IGxhc3RWYWxpZFxuICAgICAgZmlyc3RWYWxpZCArIG1pbkR1cmF0aW9uIDw9IGxhc3RWYWxpZCA8PSBmaXJzdFZhbGlkICsgbWF4RHVyYXRpb25cbiAgICAgKi9cbiAgICBpZiAobWluRHVyYXRpb24gPj0gbWF4RHVyYXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgbWF4RHVyYXRpb24gKCR7bWF4RHVyYXRpb259KSB0byBiZSBncmF0aGVyIHRoYW4gbWluRHVyYXRpb24gKCR7bWluRHVyYXRpb259KWApO1xuICAgIH1cbiAgICBmaXJzdFZhbGlkID0gZmlyc3RWYWxpZCA+PSAwID8gZmlyc3RWYWxpZCA6IGRlZmF1bHRGaXJzdFZhbGlkO1xuICAgIG1pbkR1cmF0aW9uID0gbWluRHVyYXRpb24gPj0gMCA/IG1pbkR1cmF0aW9uIDogZGVmYXVsdE1pbkR1cmF0aW9uO1xuICAgIG1heER1cmF0aW9uID0gbWF4RHVyYXRpb24gPiBtaW5EdXJhdGlvbiA/IG1heER1cmF0aW9uIDogZGVmYXVsdE1heER1cmF0aW9uO1xuICAgIGxhc3RWYWxpZCA9XG4gICAgICBsYXN0VmFsaWQgPj0gZmlyc3RWYWxpZCArIG1pbkR1cmF0aW9uICYmIGxhc3RWYWxpZCA8PSBmaXJzdFZhbGlkICsgbWF4RHVyYXRpb25cbiAgICAgICAgPyBsYXN0VmFsaWRcbiAgICAgICAgOiBmaXJzdFZhbGlkICsgbWF4RHVyYXRpb247XG5cbiAgICByZXR1cm4ge1xuICAgICAgZmlyc3RWYWxpZCxcbiAgICAgIGxhc3RWYWxpZCxcbiAgICAgIG1pbkR1cmF0aW9uLFxuICAgICAgbWF4RHVyYXRpb24sXG4gICAgICB1bml0LFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSB0cmFuc2FjdGlvbiBiZWluZyBidWlsdC5cbiAgICovXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgdHJhbnNhY3Rpb24oKTogQmFzZVRyYW5zYWN0aW9uO1xuXG4gIC8qKlxuICAgKiBTZXQgdGhlIHRyYW5zYWN0aW9uIGJlaW5nIGJ1aWx0LlxuICAgKi9cbiAgcHJvdGVjdGVkIGFic3RyYWN0IHNldCB0cmFuc2FjdGlvbih0cmFuc2FjdGlvbjogQmFzZVRyYW5zYWN0aW9uKTtcbn1cbiJdfQ==