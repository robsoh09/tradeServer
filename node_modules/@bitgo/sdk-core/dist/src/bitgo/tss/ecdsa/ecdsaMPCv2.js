"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getUserPartyGpgKey = exports.getBitGoPartyGpgKey = exports.verifyBitGoMessagesAndSignaturesRoundTwo = exports.verifyBitGoMessagesAndSignaturesRoundOne = exports.getSignatureShareRoundThree = exports.getSignatureShareRoundTwo = exports.getSignatureShareRoundOne = void 0;
const utils_1 = require("../../utils");
const sdk_lib_mpc_1 = require("@bitgo/sdk-lib-mpc");
const public_types_1 = require("@bitgo/public-types");
const assert_1 = __importDefault(require("assert"));
/**
 Helpers in this take care of all interaction with WP API's
**/
async function getSignatureShareRoundOne(round1Message, userGpgKey) {
    const serializedMessages = sdk_lib_mpc_1.DklsTypes.serializeMessages({
        broadcastMessages: [round1Message],
        p2pMessages: [],
    });
    const authEncBroadcastMessage = (await sdk_lib_mpc_1.DklsComms.encryptAndAuthOutgoingMessages(serializedMessages, [], // Broadcast message so doesn't need to encrypt to BitGo's GPG key
    [getUserPartyGpgKey(userGpgKey)])).broadcastMessages[0];
    // Share type expected by Wallet Platform's API
    (0, assert_1.default)(public_types_1.MPCv2PartyFromStringOrNumber.is(authEncBroadcastMessage.from));
    const share = {
        type: 'round1Input',
        data: {
            msg1: {
                from: authEncBroadcastMessage.from,
                message: authEncBroadcastMessage.payload.message,
                signature: authEncBroadcastMessage.payload.signature,
            },
        },
    };
    const serializedShare = JSON.stringify(share);
    return {
        from: utils_1.SignatureShareType.USER,
        to: utils_1.SignatureShareType.BITGO,
        share: serializedShare,
    };
}
exports.getSignatureShareRoundOne = getSignatureShareRoundOne;
async function getSignatureShareRoundTwo(userToBitGoMessages2, userToBitGoMessages3, userGpgKey, bitgoGpgKey) {
    const userToBitGoEncryptedMsg2 = await sdk_lib_mpc_1.DklsComms.encryptAndAuthOutgoingMessages(sdk_lib_mpc_1.DklsTypes.serializeMessages(userToBitGoMessages2), [getBitGoPartyGpgKey(bitgoGpgKey)], [getUserPartyGpgKey(userGpgKey)]);
    const userToBitGoEncryptedMsg3 = await sdk_lib_mpc_1.DklsComms.encryptAndAuthOutgoingMessages(sdk_lib_mpc_1.DklsTypes.serializeMessages(userToBitGoMessages3), [getBitGoPartyGpgKey(bitgoGpgKey)], [getUserPartyGpgKey(userGpgKey)]);
    (0, assert_1.default)(userToBitGoEncryptedMsg2.p2pMessages.length, 'User to BitGo messages 2 not present.');
    (0, assert_1.default)(userToBitGoEncryptedMsg3.p2pMessages.length, 'User to BitGo messages 3 not present.');
    (0, assert_1.default)(public_types_1.MPCv2PartyFromStringOrNumber.is(userToBitGoEncryptedMsg2.p2pMessages[0].from));
    (0, assert_1.default)(public_types_1.MPCv2PartyFromStringOrNumber.is(userToBitGoEncryptedMsg2.p2pMessages[0].to));
    (0, assert_1.default)(public_types_1.MPCv2PartyFromStringOrNumber.is(userToBitGoEncryptedMsg3.p2pMessages[0].from));
    (0, assert_1.default)(public_types_1.MPCv2PartyFromStringOrNumber.is(userToBitGoEncryptedMsg3.p2pMessages[0].to));
    const share = {
        type: 'round2Input',
        data: {
            msg2: {
                from: userToBitGoEncryptedMsg2.p2pMessages[0].from,
                to: userToBitGoEncryptedMsg2.p2pMessages[0].to,
                encryptedMessage: userToBitGoEncryptedMsg2.p2pMessages[0].payload.encryptedMessage,
                signature: userToBitGoEncryptedMsg2.p2pMessages[0].payload.signature,
            },
            msg3: {
                from: userToBitGoEncryptedMsg3.p2pMessages[0].from,
                to: userToBitGoEncryptedMsg3.p2pMessages[0].to,
                encryptedMessage: userToBitGoEncryptedMsg3.p2pMessages[0].payload.encryptedMessage,
                signature: userToBitGoEncryptedMsg3.p2pMessages[0].payload.signature,
            },
        },
    };
    return {
        from: utils_1.SignatureShareType.USER,
        to: utils_1.SignatureShareType.BITGO,
        share: JSON.stringify(share),
    };
}
exports.getSignatureShareRoundTwo = getSignatureShareRoundTwo;
async function getSignatureShareRoundThree(userToBitGoMessages4, userGpgKey, bitgoGpgKey) {
    var _a;
    const userToBitGoEncryptedMsg4 = await sdk_lib_mpc_1.DklsComms.encryptAndAuthOutgoingMessages(sdk_lib_mpc_1.DklsTypes.serializeMessages(userToBitGoMessages4), [getBitGoPartyGpgKey(bitgoGpgKey)], [getUserPartyGpgKey(userGpgKey)]);
    (0, assert_1.default)(public_types_1.MPCv2PartyFromStringOrNumber.is(userToBitGoEncryptedMsg4.broadcastMessages[0].from));
    if (!((_a = userToBitGoEncryptedMsg4.broadcastMessages[0].signatureR) === null || _a === void 0 ? void 0 : _a.message)) {
        throw Error('signatureR should be defined');
    }
    const share = {
        type: 'round3Input',
        data: {
            msg4: {
                from: userToBitGoEncryptedMsg4.broadcastMessages[0].from,
                message: userToBitGoEncryptedMsg4.broadcastMessages[0].payload.message,
                signature: userToBitGoEncryptedMsg4.broadcastMessages[0].payload.signature,
                signatureR: userToBitGoEncryptedMsg4.broadcastMessages[0].signatureR.message,
            },
        },
    };
    return {
        from: utils_1.SignatureShareType.USER,
        to: utils_1.SignatureShareType.BITGO,
        share: JSON.stringify(share),
    };
}
exports.getSignatureShareRoundThree = getSignatureShareRoundThree;
async function verifyBitGoMessagesAndSignaturesRoundOne(parsedSignatureShare, userGpgKey, bitgoGpgKey) {
    return await sdk_lib_mpc_1.DklsComms.decryptAndVerifyIncomingMessages({
        p2pMessages: [
            {
                from: parsedSignatureShare.data.msg2.from,
                to: parsedSignatureShare.data.msg2.to,
                payload: {
                    encryptedMessage: parsedSignatureShare.data.msg2.encryptedMessage,
                    signature: parsedSignatureShare.data.msg2.signature,
                },
            },
        ],
        broadcastMessages: [
            {
                from: parsedSignatureShare.data.msg1.from,
                payload: {
                    message: parsedSignatureShare.data.msg1.message,
                    signature: parsedSignatureShare.data.msg1.signature,
                },
            },
        ],
    }, [getBitGoPartyGpgKey(bitgoGpgKey)], [getUserPartyGpgKey(userGpgKey)]);
}
exports.verifyBitGoMessagesAndSignaturesRoundOne = verifyBitGoMessagesAndSignaturesRoundOne;
async function verifyBitGoMessagesAndSignaturesRoundTwo(parsedSignatureShare, userGpgKey, bitgoGpgKey) {
    return await sdk_lib_mpc_1.DklsComms.decryptAndVerifyIncomingMessages({
        p2pMessages: [
            {
                from: parsedSignatureShare.data.msg3.from,
                to: parsedSignatureShare.data.msg3.to,
                payload: {
                    encryptedMessage: parsedSignatureShare.data.msg3.encryptedMessage,
                    signature: parsedSignatureShare.data.msg3.signature,
                },
            },
        ],
        broadcastMessages: [],
    }, [getBitGoPartyGpgKey(bitgoGpgKey)], [getUserPartyGpgKey(userGpgKey)]);
}
exports.verifyBitGoMessagesAndSignaturesRoundTwo = verifyBitGoMessagesAndSignaturesRoundTwo;
function getBitGoPartyGpgKey(key) {
    return {
        partyId: 2,
        gpgKey: key.armor(),
    };
}
exports.getBitGoPartyGpgKey = getBitGoPartyGpgKey;
function getUserPartyGpgKey(key) {
    return {
        partyId: 0,
        gpgKey: key.privateKey,
    };
}
exports.getUserPartyGpgKey = getUserPartyGpgKey;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWNkc2FNUEN2Mi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9iaXRnby90c3MvZWNkc2EvZWNkc2FNUEN2Mi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSx1Q0FBdUU7QUFFdkUsb0RBQTBEO0FBQzFELHNEQU82QjtBQUM3QixvREFBNEI7QUFFNUI7O0dBRUc7QUFFSSxLQUFLLFVBQVUseUJBQXlCLENBQzdDLGFBQXFELEVBQ3JELFVBQTZDO0lBRTdDLE1BQU0sa0JBQWtCLEdBQUcsdUJBQVMsQ0FBQyxpQkFBaUIsQ0FBQztRQUNyRCxpQkFBaUIsRUFBRSxDQUFDLGFBQWEsQ0FBQztRQUNsQyxXQUFXLEVBQUUsRUFBRTtLQUNoQixDQUFDLENBQUM7SUFDSCxNQUFNLHVCQUF1QixHQUFHLENBQzlCLE1BQU0sdUJBQVMsQ0FBQyw4QkFBOEIsQ0FDNUMsa0JBQWtCLEVBQ2xCLEVBQUUsRUFBRSxrRUFBa0U7SUFDdEUsQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUNqQyxDQUNGLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdkIsK0NBQStDO0lBQy9DLElBQUEsZ0JBQU0sRUFBQywyQ0FBNEIsQ0FBQyxFQUFFLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN0RSxNQUFNLEtBQUssR0FBbUM7UUFDNUMsSUFBSSxFQUFFLGFBQWE7UUFDbkIsSUFBSSxFQUFFO1lBQ0osSUFBSSxFQUFFO2dCQUNKLElBQUksRUFBRSx1QkFBdUIsQ0FBQyxJQUFJO2dCQUNsQyxPQUFPLEVBQUUsdUJBQXVCLENBQUMsT0FBTyxDQUFDLE9BQU87Z0JBQ2hELFNBQVMsRUFBRSx1QkFBdUIsQ0FBQyxPQUFPLENBQUMsU0FBUzthQUNyRDtTQUNGO0tBQ0YsQ0FBQztJQUNGLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7SUFD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QzVELG9CQUFxRCxFQUNyRCxVQUE2QyxFQUM3QyxXQUF3QjtJQUV4QixPQUFPLE1BQU0sdUJBQVMsQ0FBQyxnQ0FBZ0MsQ0FDckQ7UUFDRSxXQUFXLEVBQUU7WUFDWDtnQkFDRSxJQUFJLEVBQUUsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJO2dCQUN6QyxFQUFFLEVBQUUsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNyQyxPQUFPLEVBQUU7b0JBQ1AsZ0JBQWdCLEVBQUUsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0I7b0JBQ2pFLFNBQVMsRUFBRSxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7aUJBQ3BEO2FBQ0Y7U0FDRjtRQUNELGlCQUFpQixFQUFFLEVBQUU7S0FDdEIsRUFDRCxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQ2xDLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FDakMsQ0FBQztBQUNKLENBQUM7QUF0QkQsNEZBc0JDO0FBRUQsU0FBZ0IsbUJBQW1CLENBQUMsR0FBZ0I7SUFDbEQsT0FBTztRQUNMLE9BQU8sRUFBRSxDQUFDO1FBQ1YsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLEVBQUU7S0FDcEIsQ0FBQztBQUNKLENBQUM7QUFMRCxrREFLQztBQUVELFNBQWdCLGtCQUFrQixDQUFDLEdBQXNDO0lBQ3ZFLE9BQU87UUFDTCxPQUFPLEVBQUUsQ0FBQztRQUNWLE1BQU0sRUFBRSxHQUFHLENBQUMsVUFBVTtLQUN2QixDQUFDO0FBQ0osQ0FBQztBQUxELGdEQUtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2lnbmF0dXJlU2hhcmVSZWNvcmQsIFNpZ25hdHVyZVNoYXJlVHlwZSB9IGZyb20gJy4uLy4uL3V0aWxzJztcbmltcG9ydCBvcGVucGdwIGZyb20gJ29wZW5wZ3AnO1xuaW1wb3J0IHsgRGtsc0NvbW1zLCBEa2xzVHlwZXMgfSBmcm9tICdAYml0Z28vc2RrLWxpYi1tcGMnO1xuaW1wb3J0IHtcbiAgTVBDdjJTaWduYXR1cmVTaGFyZVJvdW5kMUlucHV0LFxuICBNUEN2MlNpZ25hdHVyZVNoYXJlUm91bmQxT3V0cHV0LFxuICBNUEN2MlNpZ25hdHVyZVNoYXJlUm91bmQySW5wdXQsXG4gIE1QQ3YyU2lnbmF0dXJlU2hhcmVSb3VuZDJPdXRwdXQsXG4gIE1QQ3YyU2lnbmF0dXJlU2hhcmVSb3VuZDNJbnB1dCxcbiAgTVBDdjJQYXJ0eUZyb21TdHJpbmdPck51bWJlcixcbn0gZnJvbSAnQGJpdGdvL3B1YmxpYy10eXBlcyc7XG5pbXBvcnQgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5cbi8qKlxuIEhlbHBlcnMgaW4gdGhpcyB0YWtlIGNhcmUgb2YgYWxsIGludGVyYWN0aW9uIHdpdGggV1AgQVBJJ3NcbioqL1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0U2lnbmF0dXJlU2hhcmVSb3VuZE9uZShcbiAgcm91bmQxTWVzc2FnZTogRGtsc1R5cGVzLkRlc2VyaWFsaXplZEJyb2FkY2FzdE1lc3NhZ2UsXG4gIHVzZXJHcGdLZXk6IG9wZW5wZ3AuU2VyaWFsaXplZEtleVBhaXI8c3RyaW5nPlxuKTogUHJvbWlzZTxTaWduYXR1cmVTaGFyZVJlY29yZD4ge1xuICBjb25zdCBzZXJpYWxpemVkTWVzc2FnZXMgPSBEa2xzVHlwZXMuc2VyaWFsaXplTWVzc2FnZXMoe1xuICAgIGJyb2FkY2FzdE1lc3NhZ2VzOiBbcm91bmQxTWVzc2FnZV0sXG4gICAgcDJwTWVzc2FnZXM6IFtdLFxuICB9KTtcbiAgY29uc3QgYXV0aEVuY0Jyb2FkY2FzdE1lc3NhZ2UgPSAoXG4gICAgYXdhaXQgRGtsc0NvbW1zLmVuY3J5cHRBbmRBdXRoT3V0Z29pbmdNZXNzYWdlcyhcbiAgICAgIHNlcmlhbGl6ZWRNZXNzYWdlcyxcbiAgICAgIFtdLCAvLyBCcm9hZGNhc3QgbWVzc2FnZSBzbyBkb2Vzbid0IG5lZWQgdG8gZW5jcnlwdCB0byBCaXRHbydzIEdQRyBrZXlcbiAgICAgIFtnZXRVc2VyUGFydHlHcGdLZXkodXNlckdwZ0tleSldXG4gICAgKVxuICApLmJyb2FkY2FzdE1lc3NhZ2VzWzBdO1xuICAvLyBTaGFyZSB0eXBlIGV4cGVjdGVkIGJ5IFdhbGxldCBQbGF0Zm9ybSdzIEFQSVxuICBhc3NlcnQoTVBDdjJQYXJ0eUZyb21TdHJpbmdPck51bWJlci5pcyhhdXRoRW5jQnJvYWRjYXN0TWVzc2FnZS5mcm9tKSk7XG4gIGNvbnN0IHNoYXJlOiBNUEN2MlNpZ25hdHVyZVNoYXJlUm91bmQxSW5wdXQgPSB7XG4gICAgdHlwZTogJ3JvdW5kMUlucHV0JyxcbiAgICBkYXRhOiB7XG4gICAgICBtc2cxOiB7XG4gICAgICAgIGZyb206IGF1dGhFbmNCcm9hZGNhc3RNZXNzYWdlLmZyb20sXG4gICAgICAgIG1lc3NhZ2U6IGF1dGhFbmNCcm9hZGNhc3RNZXNzYWdlLnBheWxvYWQubWVzc2FnZSxcbiAgICAgICAgc2lnbmF0dXJlOiBhdXRoRW5jQnJvYWRjYXN0TWVzc2FnZS5wYXlsb2FkLnNpZ25hdHVyZSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcbiAgY29uc3Qgc2VyaWFsaXplZFNoYXJlID0gSlNPTi5zdHJpbmdpZnkoc2hhcmUpO1xuICByZXR1cm4ge1xuICAgIGZyb206IFNpZ25hdHVyZVNoYXJlVHlwZS5VU0VSLFxuICAgIHRvOiBTaWduYXR1cmVTaGFyZVR5cGUuQklUR08sXG4gICAgc2hhcmU6IHNlcmlhbGl6ZWRTaGFyZSxcbiAgfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNpZ25hdHVyZVNoYXJlUm91bmRUd28oXG4gIHVzZXJUb0JpdEdvTWVzc2FnZXMyOiBEa2xzVHlwZXMuRGVzZXJpYWxpemVkTWVzc2FnZXMsXG4gIHVzZXJUb0JpdEdvTWVzc2FnZXMzOiBEa2xzVHlwZXMuRGVzZXJpYWxpemVkTWVzc2FnZXMsXG4gIHVzZXJHcGdLZXk6IG9wZW5wZ3AuU2VyaWFsaXplZEtleVBhaXI8c3RyaW5nPixcbiAgYml0Z29HcGdLZXk6IG9wZW5wZ3AuS2V5XG4pOiBQcm9taXNlPFNpZ25hdHVyZVNoYXJlUmVjb3JkPiB7XG4gIGNvbnN0IHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnMiA9IGF3YWl0IERrbHNDb21tcy5lbmNyeXB0QW5kQXV0aE91dGdvaW5nTWVzc2FnZXMoXG4gICAgRGtsc1R5cGVzLnNlcmlhbGl6ZU1lc3NhZ2VzKHVzZXJUb0JpdEdvTWVzc2FnZXMyKSxcbiAgICBbZ2V0Qml0R29QYXJ0eUdwZ0tleShiaXRnb0dwZ0tleSldLFxuICAgIFtnZXRVc2VyUGFydHlHcGdLZXkodXNlckdwZ0tleSldXG4gICk7XG5cbiAgY29uc3QgdXNlclRvQml0R29FbmNyeXB0ZWRNc2czID0gYXdhaXQgRGtsc0NvbW1zLmVuY3J5cHRBbmRBdXRoT3V0Z29pbmdNZXNzYWdlcyhcbiAgICBEa2xzVHlwZXMuc2VyaWFsaXplTWVzc2FnZXModXNlclRvQml0R29NZXNzYWdlczMpLFxuICAgIFtnZXRCaXRHb1BhcnR5R3BnS2V5KGJpdGdvR3BnS2V5KV0sXG4gICAgW2dldFVzZXJQYXJ0eUdwZ0tleSh1c2VyR3BnS2V5KV1cbiAgKTtcbiAgYXNzZXJ0KHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnMi5wMnBNZXNzYWdlcy5sZW5ndGgsICdVc2VyIHRvIEJpdEdvIG1lc3NhZ2VzIDIgbm90IHByZXNlbnQuJyk7XG4gIGFzc2VydCh1c2VyVG9CaXRHb0VuY3J5cHRlZE1zZzMucDJwTWVzc2FnZXMubGVuZ3RoLCAnVXNlciB0byBCaXRHbyBtZXNzYWdlcyAzIG5vdCBwcmVzZW50LicpO1xuICBhc3NlcnQoTVBDdjJQYXJ0eUZyb21TdHJpbmdPck51bWJlci5pcyh1c2VyVG9CaXRHb0VuY3J5cHRlZE1zZzIucDJwTWVzc2FnZXNbMF0uZnJvbSkpO1xuICBhc3NlcnQoTVBDdjJQYXJ0eUZyb21TdHJpbmdPck51bWJlci5pcyh1c2VyVG9CaXRHb0VuY3J5cHRlZE1zZzIucDJwTWVzc2FnZXNbMF0udG8pKTtcbiAgYXNzZXJ0KE1QQ3YyUGFydHlGcm9tU3RyaW5nT3JOdW1iZXIuaXModXNlclRvQml0R29FbmNyeXB0ZWRNc2czLnAycE1lc3NhZ2VzWzBdLmZyb20pKTtcbiAgYXNzZXJ0KE1QQ3YyUGFydHlGcm9tU3RyaW5nT3JOdW1iZXIuaXModXNlclRvQml0R29FbmNyeXB0ZWRNc2czLnAycE1lc3NhZ2VzWzBdLnRvKSk7XG4gIGNvbnN0IHNoYXJlOiBNUEN2MlNpZ25hdHVyZVNoYXJlUm91bmQySW5wdXQgPSB7XG4gICAgdHlwZTogJ3JvdW5kMklucHV0JyxcbiAgICBkYXRhOiB7XG4gICAgICBtc2cyOiB7XG4gICAgICAgIGZyb206IHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnMi5wMnBNZXNzYWdlc1swXS5mcm9tLFxuICAgICAgICB0bzogdXNlclRvQml0R29FbmNyeXB0ZWRNc2cyLnAycE1lc3NhZ2VzWzBdLnRvLFxuICAgICAgICBlbmNyeXB0ZWRNZXNzYWdlOiB1c2VyVG9CaXRHb0VuY3J5cHRlZE1zZzIucDJwTWVzc2FnZXNbMF0ucGF5bG9hZC5lbmNyeXB0ZWRNZXNzYWdlLFxuICAgICAgICBzaWduYXR1cmU6IHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnMi5wMnBNZXNzYWdlc1swXS5wYXlsb2FkLnNpZ25hdHVyZSxcbiAgICAgIH0sXG4gICAgICBtc2czOiB7XG4gICAgICAgIGZyb206IHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnMy5wMnBNZXNzYWdlc1swXS5mcm9tLFxuICAgICAgICB0bzogdXNlclRvQml0R29FbmNyeXB0ZWRNc2czLnAycE1lc3NhZ2VzWzBdLnRvLFxuICAgICAgICBlbmNyeXB0ZWRNZXNzYWdlOiB1c2VyVG9CaXRHb0VuY3J5cHRlZE1zZzMucDJwTWVzc2FnZXNbMF0ucGF5bG9hZC5lbmNyeXB0ZWRNZXNzYWdlLFxuICAgICAgICBzaWduYXR1cmU6IHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnMy5wMnBNZXNzYWdlc1swXS5wYXlsb2FkLnNpZ25hdHVyZSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiBTaWduYXR1cmVTaGFyZVR5cGUuVVNFUixcbiAgICB0bzogU2lnbmF0dXJlU2hhcmVUeXBlLkJJVEdPLFxuICAgIHNoYXJlOiBKU09OLnN0cmluZ2lmeShzaGFyZSksXG4gIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRTaWduYXR1cmVTaGFyZVJvdW5kVGhyZWUoXG4gIHVzZXJUb0JpdEdvTWVzc2FnZXM0OiBEa2xzVHlwZXMuRGVzZXJpYWxpemVkTWVzc2FnZXMsXG4gIHVzZXJHcGdLZXk6IG9wZW5wZ3AuU2VyaWFsaXplZEtleVBhaXI8c3RyaW5nPixcbiAgYml0Z29HcGdLZXk6IG9wZW5wZ3AuS2V5XG4pOiBQcm9taXNlPFNpZ25hdHVyZVNoYXJlUmVjb3JkPiB7XG4gIGNvbnN0IHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnNCA9IGF3YWl0IERrbHNDb21tcy5lbmNyeXB0QW5kQXV0aE91dGdvaW5nTWVzc2FnZXMoXG4gICAgRGtsc1R5cGVzLnNlcmlhbGl6ZU1lc3NhZ2VzKHVzZXJUb0JpdEdvTWVzc2FnZXM0KSxcbiAgICBbZ2V0Qml0R29QYXJ0eUdwZ0tleShiaXRnb0dwZ0tleSldLFxuICAgIFtnZXRVc2VyUGFydHlHcGdLZXkodXNlckdwZ0tleSldXG4gICk7XG4gIGFzc2VydChNUEN2MlBhcnR5RnJvbVN0cmluZ09yTnVtYmVyLmlzKHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnNC5icm9hZGNhc3RNZXNzYWdlc1swXS5mcm9tKSk7XG4gIGlmICghdXNlclRvQml0R29FbmNyeXB0ZWRNc2c0LmJyb2FkY2FzdE1lc3NhZ2VzWzBdLnNpZ25hdHVyZVI/Lm1lc3NhZ2UpIHtcbiAgICB0aHJvdyBFcnJvcignc2lnbmF0dXJlUiBzaG91bGQgYmUgZGVmaW5lZCcpO1xuICB9XG4gIGNvbnN0IHNoYXJlOiBNUEN2MlNpZ25hdHVyZVNoYXJlUm91bmQzSW5wdXQgPSB7XG4gICAgdHlwZTogJ3JvdW5kM0lucHV0JyxcbiAgICBkYXRhOiB7XG4gICAgICBtc2c0OiB7XG4gICAgICAgIGZyb206IHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnNC5icm9hZGNhc3RNZXNzYWdlc1swXS5mcm9tLFxuICAgICAgICBtZXNzYWdlOiB1c2VyVG9CaXRHb0VuY3J5cHRlZE1zZzQuYnJvYWRjYXN0TWVzc2FnZXNbMF0ucGF5bG9hZC5tZXNzYWdlLFxuICAgICAgICBzaWduYXR1cmU6IHVzZXJUb0JpdEdvRW5jcnlwdGVkTXNnNC5icm9hZGNhc3RNZXNzYWdlc1swXS5wYXlsb2FkLnNpZ25hdHVyZSxcbiAgICAgICAgc2lnbmF0dXJlUjogdXNlclRvQml0R29FbmNyeXB0ZWRNc2c0LmJyb2FkY2FzdE1lc3NhZ2VzWzBdLnNpZ25hdHVyZVIubWVzc2FnZSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiBTaWduYXR1cmVTaGFyZVR5cGUuVVNFUixcbiAgICB0bzogU2lnbmF0dXJlU2hhcmVUeXBlLkJJVEdPLFxuICAgIHNoYXJlOiBKU09OLnN0cmluZ2lmeShzaGFyZSksXG4gIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlCaXRHb01lc3NhZ2VzQW5kU2lnbmF0dXJlc1JvdW5kT25lKFxuICBwYXJzZWRTaWduYXR1cmVTaGFyZTogTVBDdjJTaWduYXR1cmVTaGFyZVJvdW5kMU91dHB1dCxcbiAgdXNlckdwZ0tleTogb3BlbnBncC5TZXJpYWxpemVkS2V5UGFpcjxzdHJpbmc+LFxuICBiaXRnb0dwZ0tleTogb3BlbnBncC5LZXlcbik6IFByb21pc2U8RGtsc1R5cGVzLlNlcmlhbGl6ZWRNZXNzYWdlcz4ge1xuICByZXR1cm4gYXdhaXQgRGtsc0NvbW1zLmRlY3J5cHRBbmRWZXJpZnlJbmNvbWluZ01lc3NhZ2VzKFxuICAgIHtcbiAgICAgIHAycE1lc3NhZ2VzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBmcm9tOiBwYXJzZWRTaWduYXR1cmVTaGFyZS5kYXRhLm1zZzIuZnJvbSxcbiAgICAgICAgICB0bzogcGFyc2VkU2lnbmF0dXJlU2hhcmUuZGF0YS5tc2cyLnRvLFxuICAgICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICAgIGVuY3J5cHRlZE1lc3NhZ2U6IHBhcnNlZFNpZ25hdHVyZVNoYXJlLmRhdGEubXNnMi5lbmNyeXB0ZWRNZXNzYWdlLFxuICAgICAgICAgICAgc2lnbmF0dXJlOiBwYXJzZWRTaWduYXR1cmVTaGFyZS5kYXRhLm1zZzIuc2lnbmF0dXJlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgYnJvYWRjYXN0TWVzc2FnZXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIGZyb206IHBhcnNlZFNpZ25hdHVyZVNoYXJlLmRhdGEubXNnMS5mcm9tLFxuICAgICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IHBhcnNlZFNpZ25hdHVyZVNoYXJlLmRhdGEubXNnMS5tZXNzYWdlLFxuICAgICAgICAgICAgc2lnbmF0dXJlOiBwYXJzZWRTaWduYXR1cmVTaGFyZS5kYXRhLm1zZzEuc2lnbmF0dXJlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0sXG4gICAgW2dldEJpdEdvUGFydHlHcGdLZXkoYml0Z29HcGdLZXkpXSxcbiAgICBbZ2V0VXNlclBhcnR5R3BnS2V5KHVzZXJHcGdLZXkpXVxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5Qml0R29NZXNzYWdlc0FuZFNpZ25hdHVyZXNSb3VuZFR3byhcbiAgcGFyc2VkU2lnbmF0dXJlU2hhcmU6IE1QQ3YyU2lnbmF0dXJlU2hhcmVSb3VuZDJPdXRwdXQsXG4gIHVzZXJHcGdLZXk6IG9wZW5wZ3AuU2VyaWFsaXplZEtleVBhaXI8c3RyaW5nPixcbiAgYml0Z29HcGdLZXk6IG9wZW5wZ3AuS2V5XG4pOiBQcm9taXNlPERrbHNUeXBlcy5TZXJpYWxpemVkTWVzc2FnZXM+IHtcbiAgcmV0dXJuIGF3YWl0IERrbHNDb21tcy5kZWNyeXB0QW5kVmVyaWZ5SW5jb21pbmdNZXNzYWdlcyhcbiAgICB7XG4gICAgICBwMnBNZXNzYWdlczogW1xuICAgICAgICB7XG4gICAgICAgICAgZnJvbTogcGFyc2VkU2lnbmF0dXJlU2hhcmUuZGF0YS5tc2czLmZyb20sXG4gICAgICAgICAgdG86IHBhcnNlZFNpZ25hdHVyZVNoYXJlLmRhdGEubXNnMy50byxcbiAgICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgICBlbmNyeXB0ZWRNZXNzYWdlOiBwYXJzZWRTaWduYXR1cmVTaGFyZS5kYXRhLm1zZzMuZW5jcnlwdGVkTWVzc2FnZSxcbiAgICAgICAgICAgIHNpZ25hdHVyZTogcGFyc2VkU2lnbmF0dXJlU2hhcmUuZGF0YS5tc2czLnNpZ25hdHVyZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIGJyb2FkY2FzdE1lc3NhZ2VzOiBbXSxcbiAgICB9LFxuICAgIFtnZXRCaXRHb1BhcnR5R3BnS2V5KGJpdGdvR3BnS2V5KV0sXG4gICAgW2dldFVzZXJQYXJ0eUdwZ0tleSh1c2VyR3BnS2V5KV1cbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEJpdEdvUGFydHlHcGdLZXkoa2V5OiBvcGVucGdwLktleSk6IERrbHNUeXBlcy5QYXJ0eUdwZ0tleSB7XG4gIHJldHVybiB7XG4gICAgcGFydHlJZDogMixcbiAgICBncGdLZXk6IGtleS5hcm1vcigpLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VXNlclBhcnR5R3BnS2V5KGtleTogb3BlbnBncC5TZXJpYWxpemVkS2V5UGFpcjxzdHJpbmc+KTogRGtsc1R5cGVzLlBhcnR5R3BnS2V5IHtcbiAgcmV0dXJuIHtcbiAgICBwYXJ0eUlkOiAwLFxuICAgIGdwZ0tleToga2V5LnByaXZhdGVLZXksXG4gIH07XG59XG4iXX0=