"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AddressBook = void 0;
class AddressBook {
    constructor(enterpriseId, bitgo, wallet) {
        this.enterpriseId = enterpriseId;
        this.wallet = wallet;
        this.bitgo = bitgo;
    }
    listing() {
        /**
         * TODO(PX-2794): Move to structuredClone
         * https://github.com/BitGo/BitGoJS/pull/4119
         */
        return JSON.parse(JSON.stringify(this._listing));
    }
    /**
     * Get a list of connections the wallet has made to other directory or manually added contacts.
     */
    getConnections(params) {
        const url = this.bitgo.microservicesUrl('/api/address-book/v1/connections');
        return this.bitgo.get(url).set('enterprise-id', this.enterpriseId).send(params).result();
    }
    /**
     * Create a connection between an enterprise listing entry (wallet) to another listing entry
     * @param params
     * @param {string} listingEntryId Your enterprise listing entry id. Requires the creation of a listing entry before use.
     * @param {string=} localListingEntryDescription Optional name to override the name of the counterparties listing entry.
     * @param {string} targetListingEntryId If you know the other parties listing entry id
     * @param {string} walletId If you don't know the targetListingEntryId and are adding manually
     * @param {string} localListingName Required if using walletId
     * @returns {Promise<CreateAddressBookConnectionResponse>}
     */
    createConnection(params) {
        const url = this.bitgo.microservicesUrl('/api/address-book/v1/connections');
        return this.bitgo.post(url).set('enterprise-id', this.enterpriseId).send(params).result();
    }
    /**
     * Update one or many connections to a new status
     */
    updateConnection(params) {
        const url = this.bitgo.microservicesUrl('/api/address-book/v1/connections');
        return this.bitgo.put(url).set('enterprise-id', this.enterpriseId).send(params).result();
    }
    /**
     * Get the address book listing for the enterprise
     */
    async getListing() {
        const url = this.bitgo.microservicesUrl('/api/address-book/v1/listing/global');
        const response = await this.bitgo
            .get(url)
            .set('enterprise-id', this.enterpriseId)
            .send()
            .result();
        this._listing = response;
        return this.listing();
    }
    /**
     * Create the listing used for each wallet's listing entry
     */
    async createListing(params) {
        const url = this.bitgo.microservicesUrl('/api/address-book/v1/listing/global');
        const response = await this.bitgo
            .post(url)
            .set('enterprise-id', this.enterpriseId)
            .send(params)
            .result();
        this._listing = { ...response, listingEntries: [] };
        return this.listing();
    }
    /**
     * Update the name and description of the listing
     */
    async updateListing({ listingId, ...params }) {
        var _a;
        const url = this.bitgo.microservicesUrl(`/api/address-book/v1/listing/${listingId}`);
        const response = await this.bitgo
            .put(url)
            .set('enterprise-id', this.enterpriseId)
            .send(params)
            .result();
        this._listing = { ...response, listingEntries: ((_a = this._listing) === null || _a === void 0 ? void 0 : _a.listingEntries) ? this._listing.listingEntries : [] };
        return this.listing();
    }
    /**
     * Return a list of listing entry contacts that are connected to your enterprise listing entries (wallets)
     */
    getListingEntryContacts(params) {
        const url = this.bitgo.microservicesUrl('/api/address-book/v1/listing/entry/contacts');
        return this.bitgo.get(url).set('enterprise-id', this.enterpriseId).send(params).result();
    }
    /**
     * Return a public list of other listing entries that you can connect with.
     */
    getListingEntryDirectory(params) {
        const url = this.bitgo.microservicesUrl('/api/address-book/v1/listing/entry/directory');
        return this.bitgo.get(url).set('enterprise-id', this.enterpriseId).send(params).result();
    }
    /**
     * Create a listing entry for use in the public directory or keep private and share the listing entry id with others.
     */
    async createListingEntry(params) {
        var _a;
        if (!params.walletId && this.wallet) {
            params.walletId = this.wallet.id();
        }
        const url = this.bitgo.microservicesUrl('/api/address-book/v1/listing/entry/global');
        const response = await this.bitgo
            .post(url)
            .set('enterprise-id', this.enterpriseId)
            .send(params)
            .result();
        if (this._listing) {
            (_a = this._listing.listingEntries) === null || _a === void 0 ? void 0 : _a.push({ ...response });
        }
        return response;
    }
    /**
     * Update a listing entry (wallet)
     */
    async updateListingEntry({ listingEntryId, ...params }) {
        var _a, _b, _c, _d;
        const url = this.bitgo.microservicesUrl(`/api/address-book/v1/listing/entry/${listingEntryId}`);
        const response = await this.bitgo
            .put(url)
            .set('enterprise-id', this.enterpriseId)
            .send(params)
            .result();
        if (this._listing) {
            const index = (_c = (_b = (_a = this._listing) === null || _a === void 0 ? void 0 : _a.listingEntries) === null || _b === void 0 ? void 0 : _b.findIndex((x) => x.id === response.id)) !== null && _c !== void 0 ? _c : -1;
            if (index > -1 && this._listing.listingEntries) {
                this._listing.listingEntries[index] = { ...response };
            }
            else {
                (_d = this._listing.listingEntries) === null || _d === void 0 ? void 0 : _d.push({ ...response });
            }
        }
        return response;
    }
}
exports.AddressBook = AddressBook;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkcmVzcy1ib29rLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2JpdGdvL2FkZHJlc3MtYm9vay9hZGRyZXNzLWJvb2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBMEJBLE1BQWEsV0FBVztJQU90QixZQUFZLFlBQW9CLEVBQUUsS0FBZ0IsRUFBRSxNQUFnQjtRQUNsRSxJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBRUQsT0FBTztRQUNMOzs7V0FHRztRQUNILE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRDs7T0FFRztJQUNILGNBQWMsQ0FBQyxNQUF3QztRQUNyRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLGtDQUFrQyxDQUFDLENBQUM7UUFDNUUsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDM0YsQ0FBQztJQUVEOzs7Ozs7Ozs7T0FTRztJQUNILGdCQUFnQixDQUFDLE1BQXlDO1FBQ3hELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUM1RSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLElB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QyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsc0NBQXNDLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDaEcsTUFBTSxRQUFRLEdBQTBDLE1BQU0sSUFBSSxDQUFDLEtBQUs7YUFDckUsR0FBRyxDQUFDLEdBQUcsQ0FBQzthQUNSLEdBQUcsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQzthQUN2QyxJQUFJLENBQUMsTUFBTSxDQUFDO2FBQ1osTUFBTSxFQUFFLENBQUM7UUFDWixJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsTUFBTSxLQUFLLEdBQUcsTUFBQSxNQUFBLE1BQUEsSUFBSSxDQUFDLFFBQVEsMENBQUUsY0FBYywwQ0FBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssUUFBUSxDQUFDLEVBQUUsQ0FBQyxtQ0FBSSxDQUFDLENBQUMsQ0FBQztZQUMxRixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsRUFBRTtnQkFDOUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLFFBQVEsRUFBRSxDQUFDO2FBQ3ZEO2lCQUFNO2dCQUNMLE1BQUEsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLDBDQUFFLElBQUksQ0FBQyxFQUFFLEdBQUcsUUFBUSxFQUFFLENBQUMsQ0FBQzthQUNyRDtTQUNGO1FBQ0QsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztDQUNGO0FBaEtELGtDQWdLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJpdEdvQmFzZSB9IGZyb20gJy4uL2JpdGdvQmFzZSc7XG5pbXBvcnQgeyBJV2FsbGV0IH0gZnJvbSAnLi4vd2FsbGV0JztcbmltcG9ydCB7XG4gIEFkZHJlc3NCb29rTGlzdGluZyxcbiAgQ3JlYXRlQWRkcmVzc0Jvb2tDb25uZWN0aW9uUGFyYW1zLFxuICBDcmVhdGVBZGRyZXNzQm9va0Nvbm5lY3Rpb25SZXNwb25zZSxcbiAgQ3JlYXRlQWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlQYXJhbXMsXG4gIENyZWF0ZUFkZHJlc3NCb29rTGlzdGluZ0VudHJ5UmVzcG9uc2UsXG4gIENyZWF0ZUFkZHJlc3NCb29rTGlzdGluZ1BhcmFtcyxcbiAgQ3JlYXRlQWRkcmVzc0Jvb2tMaXN0aW5nUmVzcG9uc2UsXG4gIEdldEFkZHJlc3NCb29rQ29ubmVjdGlvbnNQYXJhbXMsXG4gIEdldEFkZHJlc3NCb29rQ29ubmVjdGlvbnNSZXNwb25zZSxcbiAgR2V0QWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlDb250YWN0c1BhcmFtcyxcbiAgR2V0QWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlDb250YWN0c1Jlc3BvbnNlLFxuICBHZXRBZGRyZXNzQm9va0xpc3RpbmdFbnRyeURpcmVjdG9yeVBhcmFtcyxcbiAgR2V0QWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlEaXJlY3RvcnlSZXNwb25zZSxcbiAgR2V0QWRkcmVzc0Jvb2tMaXN0aW5nUmVzcG9uc2UsXG4gIElBZGRyZXNzQm9vayxcbiAgVXBkYXRlQWRkcmVzc0Jvb2tDb25uZWN0aW9uUGFyYW1zLFxuICBVcGRhdGVBZGRyZXNzQm9va0Nvbm5lY3Rpb25SZXNwb25zZSxcbiAgVXBkYXRlQWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlQYXJhbXMsXG4gIFVwZGF0ZUFkZHJlc3NCb29rTGlzdGluZ0VudHJ5UmVzcG9uc2UsXG4gIFVwZGF0ZUFkZHJlc3NCb29rTGlzdGluZ1BhcmFtcyxcbiAgVXBkYXRlQWRkcmVzc0Jvb2tMaXN0aW5nUmVzcG9uc2UsXG59IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgQWRkcmVzc0Jvb2sgaW1wbGVtZW50cyBJQWRkcmVzc0Jvb2sge1xuICBwcml2YXRlIHJlYWRvbmx5IGJpdGdvOiBCaXRHb0Jhc2U7XG4gIHByaXZhdGUgcmVhZG9ubHkgZW50ZXJwcmlzZUlkOiBzdHJpbmc7XG5cbiAgcHVibGljIHdhbGxldD86IElXYWxsZXQ7XG4gIHByaXZhdGUgX2xpc3Rpbmc/OiBBZGRyZXNzQm9va0xpc3Rpbmc7XG5cbiAgY29uc3RydWN0b3IoZW50ZXJwcmlzZUlkOiBzdHJpbmcsIGJpdGdvOiBCaXRHb0Jhc2UsIHdhbGxldD86IElXYWxsZXQpIHtcbiAgICB0aGlzLmVudGVycHJpc2VJZCA9IGVudGVycHJpc2VJZDtcbiAgICB0aGlzLndhbGxldCA9IHdhbGxldDtcbiAgICB0aGlzLmJpdGdvID0gYml0Z287XG4gIH1cblxuICBsaXN0aW5nKCk6IEFkZHJlc3NCb29rTGlzdGluZyB8IHVuZGVmaW5lZCB7XG4gICAgLyoqXG4gICAgICogVE9ETyhQWC0yNzk0KTogTW92ZSB0byBzdHJ1Y3R1cmVkQ2xvbmVcbiAgICAgKiBodHRwczovL2dpdGh1Yi5jb20vQml0R28vQml0R29KUy9wdWxsLzQxMTlcbiAgICAgKi9cbiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLl9saXN0aW5nKSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgbGlzdCBvZiBjb25uZWN0aW9ucyB0aGUgd2FsbGV0IGhhcyBtYWRlIHRvIG90aGVyIGRpcmVjdG9yeSBvciBtYW51YWxseSBhZGRlZCBjb250YWN0cy5cbiAgICovXG4gIGdldENvbm5lY3Rpb25zKHBhcmFtcz86IEdldEFkZHJlc3NCb29rQ29ubmVjdGlvbnNQYXJhbXMpOiBQcm9taXNlPEdldEFkZHJlc3NCb29rQ29ubmVjdGlvbnNSZXNwb25zZT4ge1xuICAgIGNvbnN0IHVybCA9IHRoaXMuYml0Z28ubWljcm9zZXJ2aWNlc1VybCgnL2FwaS9hZGRyZXNzLWJvb2svdjEvY29ubmVjdGlvbnMnKTtcbiAgICByZXR1cm4gdGhpcy5iaXRnby5nZXQodXJsKS5zZXQoJ2VudGVycHJpc2UtaWQnLCB0aGlzLmVudGVycHJpc2VJZCkuc2VuZChwYXJhbXMpLnJlc3VsdCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIGNvbm5lY3Rpb24gYmV0d2VlbiBhbiBlbnRlcnByaXNlIGxpc3RpbmcgZW50cnkgKHdhbGxldCkgdG8gYW5vdGhlciBsaXN0aW5nIGVudHJ5XG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHBhcmFtIHtzdHJpbmd9IGxpc3RpbmdFbnRyeUlkIFlvdXIgZW50ZXJwcmlzZSBsaXN0aW5nIGVudHJ5IGlkLiBSZXF1aXJlcyB0aGUgY3JlYXRpb24gb2YgYSBsaXN0aW5nIGVudHJ5IGJlZm9yZSB1c2UuXG4gICAqIEBwYXJhbSB7c3RyaW5nPX0gbG9jYWxMaXN0aW5nRW50cnlEZXNjcmlwdGlvbiBPcHRpb25hbCBuYW1lIHRvIG92ZXJyaWRlIHRoZSBuYW1lIG9mIHRoZSBjb3VudGVycGFydGllcyBsaXN0aW5nIGVudHJ5LlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdGFyZ2V0TGlzdGluZ0VudHJ5SWQgSWYgeW91IGtub3cgdGhlIG90aGVyIHBhcnRpZXMgbGlzdGluZyBlbnRyeSBpZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gd2FsbGV0SWQgSWYgeW91IGRvbid0IGtub3cgdGhlIHRhcmdldExpc3RpbmdFbnRyeUlkIGFuZCBhcmUgYWRkaW5nIG1hbnVhbGx5XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhbExpc3RpbmdOYW1lIFJlcXVpcmVkIGlmIHVzaW5nIHdhbGxldElkXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPENyZWF0ZUFkZHJlc3NCb29rQ29ubmVjdGlvblJlc3BvbnNlPn1cbiAgICovXG4gIGNyZWF0ZUNvbm5lY3Rpb24ocGFyYW1zOiBDcmVhdGVBZGRyZXNzQm9va0Nvbm5lY3Rpb25QYXJhbXMpOiBQcm9taXNlPENyZWF0ZUFkZHJlc3NCb29rQ29ubmVjdGlvblJlc3BvbnNlPiB7XG4gICAgY29uc3QgdXJsID0gdGhpcy5iaXRnby5taWNyb3NlcnZpY2VzVXJsKCcvYXBpL2FkZHJlc3MtYm9vay92MS9jb25uZWN0aW9ucycpO1xuICAgIHJldHVybiB0aGlzLmJpdGdvLnBvc3QodXJsKS5zZXQoJ2VudGVycHJpc2UtaWQnLCB0aGlzLmVudGVycHJpc2VJZCkuc2VuZChwYXJhbXMpLnJlc3VsdCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBvbmUgb3IgbWFueSBjb25uZWN0aW9ucyB0byBhIG5ldyBzdGF0dXNcbiAgICovXG4gIHVwZGF0ZUNvbm5lY3Rpb24ocGFyYW1zOiBVcGRhdGVBZGRyZXNzQm9va0Nvbm5lY3Rpb25QYXJhbXMpOiBQcm9taXNlPFVwZGF0ZUFkZHJlc3NCb29rQ29ubmVjdGlvblJlc3BvbnNlPiB7XG4gICAgY29uc3QgdXJsID0gdGhpcy5iaXRnby5taWNyb3NlcnZpY2VzVXJsKCcvYXBpL2FkZHJlc3MtYm9vay92MS9jb25uZWN0aW9ucycpO1xuICAgIHJldHVybiB0aGlzLmJpdGdvLnB1dCh1cmwpLnNldCgnZW50ZXJwcmlzZS1pZCcsIHRoaXMuZW50ZXJwcmlzZUlkKS5zZW5kKHBhcmFtcykucmVzdWx0KCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBhZGRyZXNzIGJvb2sgbGlzdGluZyBmb3IgdGhlIGVudGVycHJpc2VcbiAgICovXG4gIGFzeW5jIGdldExpc3RpbmcoKTogUHJvbWlzZTxBZGRyZXNzQm9va0xpc3Rpbmc+IHtcbiAgICBjb25zdCB1cmwgPSB0aGlzLmJpdGdvLm1pY3Jvc2VydmljZXNVcmwoJy9hcGkvYWRkcmVzcy1ib29rL3YxL2xpc3RpbmcvZ2xvYmFsJyk7XG4gICAgY29uc3QgcmVzcG9uc2U6IEdldEFkZHJlc3NCb29rTGlzdGluZ1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5iaXRnb1xuICAgICAgLmdldCh1cmwpXG4gICAgICAuc2V0KCdlbnRlcnByaXNlLWlkJywgdGhpcy5lbnRlcnByaXNlSWQpXG4gICAgICAuc2VuZCgpXG4gICAgICAucmVzdWx0KCk7XG4gICAgdGhpcy5fbGlzdGluZyA9IHJlc3BvbnNlO1xuICAgIHJldHVybiB0aGlzLmxpc3RpbmcoKSBhcyBBZGRyZXNzQm9va0xpc3Rpbmc7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIHRoZSBsaXN0aW5nIHVzZWQgZm9yIGVhY2ggd2FsbGV0J3MgbGlzdGluZyBlbnRyeVxuICAgKi9cbiAgYXN5bmMgY3JlYXRlTGlzdGluZyhwYXJhbXM6IENyZWF0ZUFkZHJlc3NCb29rTGlzdGluZ1BhcmFtcyk6IFByb21pc2U8QWRkcmVzc0Jvb2tMaXN0aW5nPiB7XG4gICAgY29uc3QgdXJsID0gdGhpcy5iaXRnby5taWNyb3NlcnZpY2VzVXJsKCcvYXBpL2FkZHJlc3MtYm9vay92MS9saXN0aW5nL2dsb2JhbCcpO1xuICAgIGNvbnN0IHJlc3BvbnNlOiBDcmVhdGVBZGRyZXNzQm9va0xpc3RpbmdSZXNwb25zZSA9IGF3YWl0IHRoaXMuYml0Z29cbiAgICAgIC5wb3N0KHVybClcbiAgICAgIC5zZXQoJ2VudGVycHJpc2UtaWQnLCB0aGlzLmVudGVycHJpc2VJZClcbiAgICAgIC5zZW5kKHBhcmFtcylcbiAgICAgIC5yZXN1bHQoKTtcbiAgICB0aGlzLl9saXN0aW5nID0geyAuLi5yZXNwb25zZSwgbGlzdGluZ0VudHJpZXM6IFtdIH07XG4gICAgcmV0dXJuIHRoaXMubGlzdGluZygpIGFzIEFkZHJlc3NCb29rTGlzdGluZztcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIG5hbWUgYW5kIGRlc2NyaXB0aW9uIG9mIHRoZSBsaXN0aW5nXG4gICAqL1xuICBhc3luYyB1cGRhdGVMaXN0aW5nKHsgbGlzdGluZ0lkLCAuLi5wYXJhbXMgfTogVXBkYXRlQWRkcmVzc0Jvb2tMaXN0aW5nUGFyYW1zKTogUHJvbWlzZTxBZGRyZXNzQm9va0xpc3Rpbmc+IHtcbiAgICBjb25zdCB1cmwgPSB0aGlzLmJpdGdvLm1pY3Jvc2VydmljZXNVcmwoYC9hcGkvYWRkcmVzcy1ib29rL3YxL2xpc3RpbmcvJHtsaXN0aW5nSWR9YCk7XG4gICAgY29uc3QgcmVzcG9uc2U6IFVwZGF0ZUFkZHJlc3NCb29rTGlzdGluZ1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5iaXRnb1xuICAgICAgLnB1dCh1cmwpXG4gICAgICAuc2V0KCdlbnRlcnByaXNlLWlkJywgdGhpcy5lbnRlcnByaXNlSWQpXG4gICAgICAuc2VuZChwYXJhbXMpXG4gICAgICAucmVzdWx0KCk7XG4gICAgdGhpcy5fbGlzdGluZyA9IHsgLi4ucmVzcG9uc2UsIGxpc3RpbmdFbnRyaWVzOiB0aGlzLl9saXN0aW5nPy5saXN0aW5nRW50cmllcyA/IHRoaXMuX2xpc3RpbmcubGlzdGluZ0VudHJpZXMgOiBbXSB9O1xuICAgIHJldHVybiB0aGlzLmxpc3RpbmcoKSBhcyBBZGRyZXNzQm9va0xpc3Rpbmc7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGEgbGlzdCBvZiBsaXN0aW5nIGVudHJ5IGNvbnRhY3RzIHRoYXQgYXJlIGNvbm5lY3RlZCB0byB5b3VyIGVudGVycHJpc2UgbGlzdGluZyBlbnRyaWVzICh3YWxsZXRzKVxuICAgKi9cbiAgZ2V0TGlzdGluZ0VudHJ5Q29udGFjdHMoXG4gICAgcGFyYW1zPzogR2V0QWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlDb250YWN0c1BhcmFtc1xuICApOiBQcm9taXNlPEdldEFkZHJlc3NCb29rTGlzdGluZ0VudHJ5Q29udGFjdHNSZXNwb25zZT4ge1xuICAgIGNvbnN0IHVybCA9IHRoaXMuYml0Z28ubWljcm9zZXJ2aWNlc1VybCgnL2FwaS9hZGRyZXNzLWJvb2svdjEvbGlzdGluZy9lbnRyeS9jb250YWN0cycpO1xuICAgIHJldHVybiB0aGlzLmJpdGdvLmdldCh1cmwpLnNldCgnZW50ZXJwcmlzZS1pZCcsIHRoaXMuZW50ZXJwcmlzZUlkKS5zZW5kKHBhcmFtcykucmVzdWx0KCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGEgcHVibGljIGxpc3Qgb2Ygb3RoZXIgbGlzdGluZyBlbnRyaWVzIHRoYXQgeW91IGNhbiBjb25uZWN0IHdpdGguXG4gICAqL1xuICBnZXRMaXN0aW5nRW50cnlEaXJlY3RvcnkoXG4gICAgcGFyYW1zPzogR2V0QWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlEaXJlY3RvcnlQYXJhbXNcbiAgKTogUHJvbWlzZTxHZXRBZGRyZXNzQm9va0xpc3RpbmdFbnRyeURpcmVjdG9yeVJlc3BvbnNlPiB7XG4gICAgY29uc3QgdXJsID0gdGhpcy5iaXRnby5taWNyb3NlcnZpY2VzVXJsKCcvYXBpL2FkZHJlc3MtYm9vay92MS9saXN0aW5nL2VudHJ5L2RpcmVjdG9yeScpO1xuICAgIHJldHVybiB0aGlzLmJpdGdvLmdldCh1cmwpLnNldCgnZW50ZXJwcmlzZS1pZCcsIHRoaXMuZW50ZXJwcmlzZUlkKS5zZW5kKHBhcmFtcykucmVzdWx0KCk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbGlzdGluZyBlbnRyeSBmb3IgdXNlIGluIHRoZSBwdWJsaWMgZGlyZWN0b3J5IG9yIGtlZXAgcHJpdmF0ZSBhbmQgc2hhcmUgdGhlIGxpc3RpbmcgZW50cnkgaWQgd2l0aCBvdGhlcnMuXG4gICAqL1xuICBhc3luYyBjcmVhdGVMaXN0aW5nRW50cnkoXG4gICAgcGFyYW1zOiBPbWl0PENyZWF0ZUFkZHJlc3NCb29rTGlzdGluZ0VudHJ5UGFyYW1zLCAnd2FsbGV0SWQnPiAmIHtcbiAgICAgIHdhbGxldElkPzogc3RyaW5nO1xuICAgIH1cbiAgKTogUHJvbWlzZTxDcmVhdGVBZGRyZXNzQm9va0xpc3RpbmdFbnRyeVJlc3BvbnNlPiB7XG4gICAgaWYgKCFwYXJhbXMud2FsbGV0SWQgJiYgdGhpcy53YWxsZXQpIHtcbiAgICAgIHBhcmFtcy53YWxsZXRJZCA9IHRoaXMud2FsbGV0LmlkKCk7XG4gICAgfVxuICAgIGNvbnN0IHVybCA9IHRoaXMuYml0Z28ubWljcm9zZXJ2aWNlc1VybCgnL2FwaS9hZGRyZXNzLWJvb2svdjEvbGlzdGluZy9lbnRyeS9nbG9iYWwnKTtcbiAgICBjb25zdCByZXNwb25zZTogQ3JlYXRlQWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlSZXNwb25zZSA9IGF3YWl0IHRoaXMuYml0Z29cbiAgICAgIC5wb3N0KHVybClcbiAgICAgIC5zZXQoJ2VudGVycHJpc2UtaWQnLCB0aGlzLmVudGVycHJpc2VJZClcbiAgICAgIC5zZW5kKHBhcmFtcylcbiAgICAgIC5yZXN1bHQoKTtcbiAgICBpZiAodGhpcy5fbGlzdGluZykge1xuICAgICAgdGhpcy5fbGlzdGluZy5saXN0aW5nRW50cmllcz8ucHVzaCh7IC4uLnJlc3BvbnNlIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2U7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGEgbGlzdGluZyBlbnRyeSAod2FsbGV0KVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlTGlzdGluZ0VudHJ5KHtcbiAgICBsaXN0aW5nRW50cnlJZCxcbiAgICAuLi5wYXJhbXNcbiAgfTogVXBkYXRlQWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlQYXJhbXMpOiBQcm9taXNlPFVwZGF0ZUFkZHJlc3NCb29rTGlzdGluZ0VudHJ5UmVzcG9uc2U+IHtcbiAgICBjb25zdCB1cmwgPSB0aGlzLmJpdGdvLm1pY3Jvc2VydmljZXNVcmwoYC9hcGkvYWRkcmVzcy1ib29rL3YxL2xpc3RpbmcvZW50cnkvJHtsaXN0aW5nRW50cnlJZH1gKTtcbiAgICBjb25zdCByZXNwb25zZTogVXBkYXRlQWRkcmVzc0Jvb2tMaXN0aW5nRW50cnlSZXNwb25zZSA9IGF3YWl0IHRoaXMuYml0Z29cbiAgICAgIC5wdXQodXJsKVxuICAgICAgLnNldCgnZW50ZXJwcmlzZS1pZCcsIHRoaXMuZW50ZXJwcmlzZUlkKVxuICAgICAgLnNlbmQocGFyYW1zKVxuICAgICAgLnJlc3VsdCgpO1xuICAgIGlmICh0aGlzLl9saXN0aW5nKSB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuX2xpc3Rpbmc/Lmxpc3RpbmdFbnRyaWVzPy5maW5kSW5kZXgoKHgpID0+IHguaWQgPT09IHJlc3BvbnNlLmlkKSA/PyAtMTtcbiAgICAgIGlmIChpbmRleCA+IC0xICYmIHRoaXMuX2xpc3RpbmcubGlzdGluZ0VudHJpZXMpIHtcbiAgICAgICAgdGhpcy5fbGlzdGluZy5saXN0aW5nRW50cmllc1tpbmRleF0gPSB7IC4uLnJlc3BvbnNlIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9saXN0aW5nLmxpc3RpbmdFbnRyaWVzPy5wdXNoKHsgLi4ucmVzcG9uc2UgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxufVxuIl19