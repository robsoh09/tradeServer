"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BlockstreamApi = void 0;
const utxo_lib_1 = require("@bitgo/utxo-lib");
const BaseHttpClient_1 = require("../BaseHttpClient");
const ApiBuilder_1 = require("../ApiBuilder");
const formatOutputId = utxo_lib_1.bitgo.formatOutputId;
function toBitGoUnspent(u, address, value) {
    return {
        id: formatOutputId(u),
        address,
        value,
    };
}
class BlockstreamApi {
    constructor(client) {
        this.client = client;
    }
    static forCoin(coinName, params = {}) {
        const { httpClient = new BaseHttpClient_1.BaseHttpClient() } = params;
        switch (coinName) {
            case 'btc':
                return new BlockstreamApi(httpClient.withBaseUrl('https://blockstream.info/api'));
            case 'tbtc':
                return new BlockstreamApi(httpClient.withBaseUrl('https://blockstream.info/testnet/api'));
        }
        throw new ApiBuilder_1.ApiNotImplementedError(coinName);
    }
    async getAddressInfo(address) {
        const response = await this.client.get(`/address/${address}`);
        return response.map((body) => {
            return {
                txCount: body.chain_stats.tx_count,
                balance: body.chain_stats.funded_txo_sum - body.chain_stats.spent_txo_sum,
            };
        });
    }
    async getUnspentsForAddresses(addrs) {
        if (addrs.length !== 1) {
            return (await (0, BaseHttpClient_1.mapSeries)(addrs, (a) => this.getUnspentsForAddresses([a]))).flat();
        }
        const [address] = addrs;
        return (await this.client.get(`/address/${address}/utxo`)).map((unspents) => unspents.map((u) => toBitGoUnspent(u, address, u.value)));
    }
    async getTransactionHex(txid) {
        return (await this.client.get(`/tx/${txid}/hex`)).map((v) => v);
    }
    async getTransactionStatus(txid) {
        try {
            return (await this.client.get(`/tx/${txid}`)).map(({ status }) => status.confirmed
                ? { found: true, confirmed: true, blockHeight: status.block_height, blockHash: status.block_hash }
                : { found: true, confirmed: false });
        }
        catch (e) {
            if (e instanceof BaseHttpClient_1.ApiRequestError) {
                const reason = e.reason;
                if (reason.response.status === 404 && reason.response.text === 'Transaction not found') {
                    return { found: false };
                }
            }
            throw e;
        }
    }
    async getTransactionInputs(txid) {
        return (await this.client.get(`/tx/${txid}`)).map((body) => body.vin.map((u) => toBitGoUnspent(u, u.prevout.scriptpubkey_address, u.prevout.value)));
    }
    async getTransactionIO(txid) {
        const tx = await this.client.get(`/tx/${txid}`);
        const inputs = tx.map((body) => body.vin.map((u) => {
            return {
                address: u.prevout.scriptpubkey_address,
            };
        }));
        const outputs = tx.map((body) => body.vout.map((u) => {
            return {
                address: u.scriptpubkey_address,
            };
        }));
        return {
            inputs,
            outputs,
        };
    }
    async getTransactionSpends(txid) {
        return (await this.client.get(`/tx/${txid}/outspends`)).map((arr) => arr.map((v) => (v.txid ? { txid: v.txid, vin: v.vin } : { txid: undefined, vin: undefined })));
    }
}
exports.BlockstreamApi = BlockstreamApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmxvY2tzdHJlYW1BcGkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW1wbC9CbG9ja3N0cmVhbUFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4Q0FBd0M7QUFHeEMsc0RBQTJGO0FBQzNGLDhDQUF1RDtBQUl2RCxNQUFNLGNBQWMsR0FBRyxnQkFBSyxDQUFDLGNBQWMsQ0FBQztBQXNDNUMsU0FBUyxjQUFjLENBQUMsQ0FBYSxFQUFFLE9BQWUsRUFBRSxLQUFhO0lBQ25FLE9BQU87UUFDTCxFQUFFLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUNyQixPQUFPO1FBQ1AsS0FBSztLQUNOLENBQUM7QUFDSixDQUFDO0FBcUJELE1BQWEsY0FBYztJQWF6QixZQUFtQixNQUFrQjtRQUFsQixXQUFNLEdBQU4sTUFBTSxDQUFZO0lBQUcsQ0FBQztJQVp6QyxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQWdCLEVBQUUsU0FBc0MsRUFBRTtRQUN2RSxNQUFNLEVBQUUsVUFBVSxHQUFHLElBQUksK0JBQWMsRUFBRSxFQUFFLEdBQUcsTUFBTSxDQUFDO1FBQ3JELFFBQVEsUUFBUSxFQUFFO1lBQ2hCLEtBQUssS0FBSztnQkFDUixPQUFPLElBQUksY0FBYyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsOEJBQThCLENBQUMsQ0FBQyxDQUFDO1lBQ3BGLEtBQUssTUFBTTtnQkFDVCxPQUFPLElBQUksY0FBYyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsc0NBQXNDLENBQUMsQ0FBQyxDQUFDO1NBQzdGO1FBRUQsTUFBTSxJQUFJLG1DQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFJRCxLQUFLLENBQUMsY0FBYyxDQUFDLE9BQWU7UUFDbEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBaUIsWUFBWSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzlFLE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQzNCLE9BQU87Z0JBQ0wsT0FBTyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUTtnQkFDbEMsT0FBTyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYTthQUMxRSxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLHVCQUF1QixDQUFDLEtBQWU7UUFDM0MsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUN0QixPQUFPLENBQUMsTUFBTSxJQUFBLDBCQUFTLEVBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNsRjtRQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxLQUFLLENBQUM7UUFFeEIsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQWUsWUFBWSxPQUFPLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FDeEYsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQ3pELENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLGlCQUFpQixDQUFDLElBQVk7UUFDbEMsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQVMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQsS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQVk7UUFDckMsSUFBSTtZQUNGLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFxQixPQUFPLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsQ0FDbkYsTUFBTSxDQUFDLFNBQVM7Z0JBQ2QsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxNQUFNLENBQUMsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLENBQUMsVUFBVSxFQUFFO2dCQUNsRyxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FDdEMsQ0FBQztTQUNIO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixJQUFJLENBQUMsWUFBWSxnQ0FBZSxFQUFFO2dCQUNoQyxNQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBYSxDQUFDO2dCQUMvQixJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyx1QkFBdUIsRUFBRTtvQkFDdEYsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQztpQkFDekI7YUFDRjtZQUNELE1BQU0sQ0FBQyxDQUFDO1NBQ1Q7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQVk7UUFDckMsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQXFCLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQzdFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUN4RixDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFZO1FBQ2pDLE1BQU0sRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQXFCLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNwRSxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FDN0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUNqQixPQUFPO2dCQUNMLE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLG9CQUFvQjthQUN4QyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ2xCLE9BQU87Z0JBQ0wsT0FBTyxFQUFFLENBQUMsQ0FBQyxvQkFBb0I7YUFDaEMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7UUFDRixPQUFPO1lBQ0wsTUFBTTtZQUNOLE9BQU87U0FDUixDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxJQUFZO1FBQ3JDLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFvQixPQUFPLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUNyRixHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQzlGLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1RkQsd0NBNEZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYml0Z28gfSBmcm9tICdAYml0Z28vdXR4by1saWInO1xuaW1wb3J0IHsgQWRkcmVzc0FwaSwgQWRkcmVzc0luZm8gfSBmcm9tICcuLi9BZGRyZXNzQXBpJztcbmltcG9ydCB7IE91dHB1dFNwZW5kLCBUcmFuc2FjdGlvbklPLCBVdHhvQXBpIH0gZnJvbSAnLi4vVXR4b0FwaSc7XG5pbXBvcnQgeyBBcGlSZXF1ZXN0RXJyb3IsIEJhc2VIdHRwQ2xpZW50LCBIdHRwQ2xpZW50LCBtYXBTZXJpZXMgfSBmcm9tICcuLi9CYXNlSHR0cENsaWVudCc7XG5pbXBvcnQgeyBBcGlOb3RJbXBsZW1lbnRlZEVycm9yIH0gZnJvbSAnLi4vQXBpQnVpbGRlcic7XG5pbXBvcnQgeyBUcmFuc2FjdGlvblN0YXR1cyB9IGZyb20gJy4uL1RyYW5zYWN0aW9uQXBpJztcblxudHlwZSBVbnNwZW50ID0gYml0Z28uVW5zcGVudDtcbmNvbnN0IGZvcm1hdE91dHB1dElkID0gYml0Z28uZm9ybWF0T3V0cHV0SWQ7XG5cbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9CbG9ja3N0cmVhbS9lc3Bsb3JhL2Jsb2IvbWFzdGVyL0FQSS5tZCNnZXQtYWRkcmVzc2FkZHJlc3NcbnR5cGUgRXNwbG9yYUFkZHJlc3NTdGF0cyA9IHtcbiAgdHhfY291bnQ6IG51bWJlcjtcbiAgZnVuZGVkX3R4b19zdW06IG51bWJlcjtcbiAgc3BlbnRfdHhvX3N1bTogbnVtYmVyO1xufTtcblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL0Jsb2Nrc3RyZWFtL2VzcGxvcmEvYmxvYi9tYXN0ZXIvQVBJLm1kI2dldC1hZGRyZXNzYWRkcmVzc1xudHlwZSBFc3Bsb3JhQWRkcmVzcyA9IHtcbiAgYWRkcmVzczogc3RyaW5nO1xuICBjaGFpbl9zdGF0czogRXNwbG9yYUFkZHJlc3NTdGF0cztcbiAgbWVtcG9vbF9zdGFhdHM6IEVzcGxvcmFBZGRyZXNzU3RhdHM7XG59O1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vQmxvY2tzdHJlYW0vZXNwbG9yYS9ibG9iL21hc3Rlci9BUEkubWQjZ2V0LWFkZHJlc3NhZGRyZXNzdXR4b1xudHlwZSBFc3Bsb3JhVmluID0ge1xuICB0eGlkOiBzdHJpbmc7XG4gIHZvdXQ6IG51bWJlcjtcbiAgc3RhdHVzOiB1bmtub3duO1xuICB2YWx1ZTogbnVtYmVyO1xuICBwcmV2b3V0OiBFc3Bsb3JhVm91dDtcbn07XG5cbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9CbG9ja3N0cmVhbS9lc3Bsb3JhL2Jsb2IvbWFzdGVyL0FQSS5tZCNnZXQtYWRkcmVzc2FkZHJlc3N1dHhvXG50eXBlIEVzcGxvcmFWb3V0ID0ge1xuICBzY3JpcHRwdWJrZXk6IHN0cmluZztcbiAgc2NyaXB0cHVia2V5X2FkZHJlc3M6IHN0cmluZztcbiAgdmFsdWU6IG51bWJlcjtcbn07XG5cbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9CbG9ja3N0cmVhbS9lc3Bsb3JhL2Jsb2IvbWFzdGVyL0FQSS5tZCNnZXQtdHh0eGlkb3V0c3BlbmR2b3V0XG50eXBlIEVzcGxvcmFPdXRzcGVuZCA9IHtcbiAgdHhpZDogc3RyaW5nO1xuICB2aW46IG51bWJlcjtcbn07XG5cbmZ1bmN0aW9uIHRvQml0R29VbnNwZW50KHU6IEVzcGxvcmFWaW4sIGFkZHJlc3M6IHN0cmluZywgdmFsdWU6IG51bWJlcik6IFVuc3BlbnQge1xuICByZXR1cm4ge1xuICAgIGlkOiBmb3JtYXRPdXRwdXRJZCh1KSxcbiAgICBhZGRyZXNzLFxuICAgIHZhbHVlLFxuICB9O1xufVxuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vQmxvY2tzdHJlYW0vZXNwbG9yYS9ibG9iL21hc3Rlci9BUEkubWQjZ2V0LXR4dHhpZHN0YXR1c1xudHlwZSBFc3Bsb3JhU3RhdHVzID1cbiAgfCB7XG4gICAgICBjb25maXJtZWQ6IGZhbHNlO1xuICAgIH1cbiAgfCB7XG4gICAgICBjb25maXJtZWQ6IHRydWU7XG4gICAgICBibG9ja19oZWlnaHQ6IG51bWJlcjtcbiAgICAgIGJsb2NrX2hhc2g6IHN0cmluZztcbiAgICB9O1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vQmxvY2tzdHJlYW0vZXNwbG9yYS9ibG9iL21hc3Rlci9BUEkubWQjZ2V0LXR4dHhpZFxudHlwZSBFc3Bsb3JhVHJhbnNhY3Rpb24gPSB7XG4gIHR4aWQ6IHN0cmluZztcbiAgdmluOiBFc3Bsb3JhVmluW107XG4gIHZvdXQ6IEVzcGxvcmFWb3V0W107XG4gIHN0YXR1czogRXNwbG9yYVN0YXR1cztcbn07XG5cbmV4cG9ydCBjbGFzcyBCbG9ja3N0cmVhbUFwaSBpbXBsZW1lbnRzIEFkZHJlc3NBcGksIFV0eG9BcGkge1xuICBzdGF0aWMgZm9yQ29pbihjb2luTmFtZTogc3RyaW5nLCBwYXJhbXM6IHsgaHR0cENsaWVudD86IEh0dHBDbGllbnQgfSA9IHt9KTogQmxvY2tzdHJlYW1BcGkge1xuICAgIGNvbnN0IHsgaHR0cENsaWVudCA9IG5ldyBCYXNlSHR0cENsaWVudCgpIH0gPSBwYXJhbXM7XG4gICAgc3dpdGNoIChjb2luTmFtZSkge1xuICAgICAgY2FzZSAnYnRjJzpcbiAgICAgICAgcmV0dXJuIG5ldyBCbG9ja3N0cmVhbUFwaShodHRwQ2xpZW50LndpdGhCYXNlVXJsKCdodHRwczovL2Jsb2Nrc3RyZWFtLmluZm8vYXBpJykpO1xuICAgICAgY2FzZSAndGJ0Yyc6XG4gICAgICAgIHJldHVybiBuZXcgQmxvY2tzdHJlYW1BcGkoaHR0cENsaWVudC53aXRoQmFzZVVybCgnaHR0cHM6Ly9ibG9ja3N0cmVhbS5pbmZvL3Rlc3RuZXQvYXBpJykpO1xuICAgIH1cblxuICAgIHRocm93IG5ldyBBcGlOb3RJbXBsZW1lbnRlZEVycm9yKGNvaW5OYW1lKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBjbGllbnQ6IEh0dHBDbGllbnQpIHt9XG5cbiAgYXN5bmMgZ2V0QWRkcmVzc0luZm8oYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxBZGRyZXNzSW5mbz4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQuZ2V0PEVzcGxvcmFBZGRyZXNzPihgL2FkZHJlc3MvJHthZGRyZXNzfWApO1xuICAgIHJldHVybiByZXNwb25zZS5tYXAoKGJvZHkpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHR4Q291bnQ6IGJvZHkuY2hhaW5fc3RhdHMudHhfY291bnQsXG4gICAgICAgIGJhbGFuY2U6IGJvZHkuY2hhaW5fc3RhdHMuZnVuZGVkX3R4b19zdW0gLSBib2R5LmNoYWluX3N0YXRzLnNwZW50X3R4b19zdW0sXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0VW5zcGVudHNGb3JBZGRyZXNzZXMoYWRkcnM6IHN0cmluZ1tdKTogUHJvbWlzZTxVbnNwZW50W10+IHtcbiAgICBpZiAoYWRkcnMubGVuZ3RoICE9PSAxKSB7XG4gICAgICByZXR1cm4gKGF3YWl0IG1hcFNlcmllcyhhZGRycywgKGEpID0+IHRoaXMuZ2V0VW5zcGVudHNGb3JBZGRyZXNzZXMoW2FdKSkpLmZsYXQoKTtcbiAgICB9XG5cbiAgICBjb25zdCBbYWRkcmVzc10gPSBhZGRycztcblxuICAgIHJldHVybiAoYXdhaXQgdGhpcy5jbGllbnQuZ2V0PEVzcGxvcmFWaW5bXT4oYC9hZGRyZXNzLyR7YWRkcmVzc30vdXR4b2ApKS5tYXAoKHVuc3BlbnRzKSA9PlxuICAgICAgdW5zcGVudHMubWFwKCh1KSA9PiB0b0JpdEdvVW5zcGVudCh1LCBhZGRyZXNzLCB1LnZhbHVlKSlcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25IZXgodHhpZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuY2xpZW50LmdldDxzdHJpbmc+KGAvdHgvJHt0eGlkfS9oZXhgKSkubWFwKCh2KSA9PiB2KTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uU3RhdHVzKHR4aWQ6IHN0cmluZyk6IFByb21pc2U8VHJhbnNhY3Rpb25TdGF0dXM+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIChhd2FpdCB0aGlzLmNsaWVudC5nZXQ8RXNwbG9yYVRyYW5zYWN0aW9uPihgL3R4LyR7dHhpZH1gKSkubWFwKCh7IHN0YXR1cyB9KSA9PlxuICAgICAgICBzdGF0dXMuY29uZmlybWVkXG4gICAgICAgICAgPyB7IGZvdW5kOiB0cnVlLCBjb25maXJtZWQ6IHRydWUsIGJsb2NrSGVpZ2h0OiBzdGF0dXMuYmxvY2tfaGVpZ2h0LCBibG9ja0hhc2g6IHN0YXR1cy5ibG9ja19oYXNoIH1cbiAgICAgICAgICA6IHsgZm91bmQ6IHRydWUsIGNvbmZpcm1lZDogZmFsc2UgfVxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZSBpbnN0YW5jZW9mIEFwaVJlcXVlc3RFcnJvcikge1xuICAgICAgICBjb25zdCByZWFzb24gPSBlLnJlYXNvbiBhcyBhbnk7XG4gICAgICAgIGlmIChyZWFzb24ucmVzcG9uc2Uuc3RhdHVzID09PSA0MDQgJiYgcmVhc29uLnJlc3BvbnNlLnRleHQgPT09ICdUcmFuc2FjdGlvbiBub3QgZm91bmQnKSB7XG4gICAgICAgICAgcmV0dXJuIHsgZm91bmQ6IGZhbHNlIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25JbnB1dHModHhpZDogc3RyaW5nKTogUHJvbWlzZTxVbnNwZW50W10+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuY2xpZW50LmdldDxFc3Bsb3JhVHJhbnNhY3Rpb24+KGAvdHgvJHt0eGlkfWApKS5tYXAoKGJvZHkpID0+XG4gICAgICBib2R5LnZpbi5tYXAoKHUpID0+IHRvQml0R29VbnNwZW50KHUsIHUucHJldm91dC5zY3JpcHRwdWJrZXlfYWRkcmVzcywgdS5wcmV2b3V0LnZhbHVlKSlcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25JTyh0eGlkOiBzdHJpbmcpOiBQcm9taXNlPFRyYW5zYWN0aW9uSU8+IHtcbiAgICBjb25zdCB0eCA9IGF3YWl0IHRoaXMuY2xpZW50LmdldDxFc3Bsb3JhVHJhbnNhY3Rpb24+KGAvdHgvJHt0eGlkfWApO1xuICAgIGNvbnN0IGlucHV0cyA9IHR4Lm1hcCgoYm9keSkgPT5cbiAgICAgIGJvZHkudmluLm1hcCgodSkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGFkZHJlc3M6IHUucHJldm91dC5zY3JpcHRwdWJrZXlfYWRkcmVzcyxcbiAgICAgICAgfTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBvdXRwdXRzID0gdHgubWFwKChib2R5KSA9PlxuICAgICAgYm9keS52b3V0Lm1hcCgodSkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGFkZHJlc3M6IHUuc2NyaXB0cHVia2V5X2FkZHJlc3MsXG4gICAgICAgIH07XG4gICAgICB9KVxuICAgICk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlucHV0cyxcbiAgICAgIG91dHB1dHMsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uU3BlbmRzKHR4aWQ6IHN0cmluZyk6IFByb21pc2U8T3V0cHV0U3BlbmRbXT4ge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5jbGllbnQuZ2V0PEVzcGxvcmFPdXRzcGVuZFtdPihgL3R4LyR7dHhpZH0vb3V0c3BlbmRzYCkpLm1hcCgoYXJyKSA9PlxuICAgICAgYXJyLm1hcCgodikgPT4gKHYudHhpZCA/IHsgdHhpZDogdi50eGlkLCB2aW46IHYudmluIH0gOiB7IHR4aWQ6IHVuZGVmaW5lZCwgdmluOiB1bmRlZmluZWQgfSkpXG4gICAgKTtcbiAgfVxufVxuIl19