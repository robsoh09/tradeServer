"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BlockchairApi = void 0;
const utxo_lib_1 = require("@bitgo/utxo-lib");
const BaseHttpClient_1 = require("../BaseHttpClient");
const ApiBuilder_1 = require("../ApiBuilder");
const formatOutputId = utxo_lib_1.bitgo.formatOutputId;
class ErrorKeyNotInResponse extends Error {
    constructor(key) {
        super(`key ${key} not in response`);
    }
}
function unwrapRecord(body, key) {
    if (!(key in body.data)) {
        throw new ErrorKeyNotInResponse(key);
    }
    return body.data[key];
}
class BlockchairApi {
    constructor(client, apiToken) {
        this.client = client;
        this.apiToken = apiToken !== null && apiToken !== void 0 ? apiToken : process.env.BLOCKCHAIR_TOKEN;
    }
    static forCoin(coinName, params = {}) {
        // https://blockchair.com/api/docs#link_M0
        let blockchain;
        switch (coinName) {
            case 'btc':
                blockchain = 'bitcoin';
                break;
            case 'tbtc':
                blockchain = 'bitcoin/testnet';
                break;
            case 'bsv':
                blockchain = 'bitcoin-sv';
                break;
            case 'bch':
                blockchain = 'bitcoin-cash';
                break;
            case 'bcha':
                blockchain = 'ecash';
                break;
            case 'ltc':
                blockchain = 'litecoin';
                break;
            case 'dash':
                blockchain = 'dash';
                break;
            case 'doge':
                blockchain = 'dogecoin';
                break;
            case 'zec':
                blockchain = 'zcash';
                break;
            default:
                throw new ApiBuilder_1.ApiNotImplementedError(coinName);
        }
        const { httpClient = new BaseHttpClient_1.BaseHttpClient() } = params;
        return new BlockchairApi(httpClient.withBaseUrl(`https://api.blockchair.com/${blockchain}`), params.apiToken);
    }
    get(path) {
        return this.client.get(path + (this.apiToken ? `?key=${this.apiToken}` : ''));
    }
    async getAddressInfo(address) {
        if (!address || address.length === 0) {
            throw new Error('invalid address');
        }
        // https://blockchair.com/api/docs#link_300
        return (await this.get(`/dashboards/address/${address}`)).map((body) => {
            return {
                txCount: body.data[address].address.transaction_count,
                balance: body.data[address].address.balance,
            };
        });
    }
    async getUnspentsForAddresses(addr) {
        if (addr.length > 100) {
            throw new Error(`invalid size`);
        }
        const response = await this.get(`/dashboards/addresses/${addr.join(',')}`);
        return response.map((body) => {
            return body.data.utxo
                .flatMap((unspent) => {
                if (addr.includes(unspent.address)) {
                    return {
                        id: formatOutputId({ txid: unspent.transaction_hash, vout: unspent.index }),
                        address: unspent.address,
                        value: unspent.value,
                    };
                }
                return undefined;
            })
                .filter((unspent) => unspent !== undefined);
        });
    }
    async getTransaction(txid) {
        return (await this.get(`/dashboards/transaction/${txid}`)).map((body) => {
            return unwrapRecord(body, txid);
        });
    }
    async getTransactionStatus(txid) {
        let transaction;
        try {
            transaction = (await this.getTransaction(txid)).transaction;
        }
        catch (e) {
            if (e instanceof ErrorKeyNotInResponse) {
                return { found: false };
            }
            throw e;
        }
        const { block_id, time } = transaction;
        const date = new Date(Date.parse(time.replace(' ', 'T') + '.000Z' /* force UTC parsing */));
        return block_id === -1
            ? { found: true, confirmed: false }
            : {
                found: true,
                confirmed: true,
                blockHeight: block_id,
                date,
            };
    }
    async getTransactionInputs(txid) {
        return (await this.getTransaction(txid)).inputs.map((i) => {
            return {
                id: formatOutputId({ txid: i.transaction_hash, vout: i.index }),
                address: i.recipient,
                value: i.value,
            };
        });
    }
    async getTransactionIO(txid) {
        const tx = await this.getTransaction(txid);
        const inputs = tx.inputs.map((input) => {
            return {
                address: input.recipient,
            };
        });
        const outputs = tx.outputs.map((output) => {
            return {
                address: output.recipient,
            };
        });
        return {
            inputs,
            outputs,
        };
    }
    async getTransactionSpends(txid) {
        return (await this.getTransaction(txid)).outputs.map((o) => o.spending_transaction_hash
            ? {
                txid: o.spending_transaction_hash,
                vin: o.spending_index,
            }
            : { txid: undefined, vin: undefined });
    }
    async getTransactionHex(txid) {
        return (await this.get(`/raw/transaction/${txid}`)).map((body) => {
            return unwrapRecord(body, txid).raw_transaction;
        });
    }
}
exports.BlockchairApi = BlockchairApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmxvY2tjaGFpckFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbXBsL0Jsb2NrY2hhaXJBcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOENBQXdDO0FBQ3hDLHNEQUF5RTtBQUN6RSw4Q0FBdUQ7QUFNdkQsTUFBTSxjQUFjLEdBQUcsZ0JBQUssQ0FBQyxjQUFjLENBQUM7QUFRNUMsTUFBTSxxQkFBc0IsU0FBUSxLQUFLO0lBQ3ZDLFlBQVksR0FBVztRQUNyQixLQUFLLENBQUMsT0FBTyxHQUFHLGtCQUFrQixDQUFDLENBQUM7SUFDdEMsQ0FBQztDQUNGO0FBRUQsU0FBUyxZQUFZLENBQUksSUFBaUMsRUFBRSxHQUFXO0lBQ3JFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDdkIsTUFBTSxJQUFJLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQ3RDO0lBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLENBQUM7QUFvREQsTUFBYSxhQUFhO0lBeUN4QixZQUFtQixNQUFrQixFQUFFLFFBQWlCO1FBQXJDLFdBQU0sR0FBTixNQUFNLENBQVk7UUFDbkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLGFBQVIsUUFBUSxjQUFSLFFBQVEsR0FBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO0lBQzNELENBQUM7SUF4Q0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFnQixFQUFFLFNBQXlELEVBQUU7UUFDMUYsMENBQTBDO1FBQzFDLElBQUksVUFBVSxDQUFDO1FBQ2YsUUFBUSxRQUFRLEVBQUU7WUFDaEIsS0FBSyxLQUFLO2dCQUNSLFVBQVUsR0FBRyxTQUFTLENBQUM7Z0JBQ3ZCLE1BQU07WUFDUixLQUFLLE1BQU07Z0JBQ1QsVUFBVSxHQUFHLGlCQUFpQixDQUFDO2dCQUMvQixNQUFNO1lBQ1IsS0FB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QUFZO1FBQ3JDLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FDekQsQ0FBQyxDQUFDLHlCQUF5QjtZQUN6QixDQUFDLENBQUM7Z0JBQ0UsSUFBSSxFQUFFLENBQUMsQ0FBQyx5QkFBeUI7Z0JBQ2pDLEdBQUcsRUFBRSxDQUFDLENBQUMsY0FBYzthQUN0QjtZQUNILENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxDQUN4QyxDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxJQUFZO1FBQ2xDLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQXFELG9CQUFvQixJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUN6RyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ1AsT0FBTyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLGVBQWUsQ0FBQztRQUNsRCxDQUFDLENBQ0YsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXJLRCxzQ0FxS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBiaXRnbyB9IGZyb20gJ0BiaXRnby91dHhvLWxpYic7XG5pbXBvcnQgeyBCYXNlSHR0cENsaWVudCwgSHR0cENsaWVudCwgUmVzcG9uc2UgfSBmcm9tICcuLi9CYXNlSHR0cENsaWVudCc7XG5pbXBvcnQgeyBBcGlOb3RJbXBsZW1lbnRlZEVycm9yIH0gZnJvbSAnLi4vQXBpQnVpbGRlcic7XG5pbXBvcnQgeyBBZGRyZXNzQXBpLCBBZGRyZXNzSW5mbyB9IGZyb20gJy4uL0FkZHJlc3NBcGknO1xuaW1wb3J0IHsgT3V0cHV0U3BlbmQsIFRyYW5zYWN0aW9uSU8sIFV0eG9BcGkgfSBmcm9tICcuLi9VdHhvQXBpJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uU3RhdHVzIH0gZnJvbSAnLi4vVHJhbnNhY3Rpb25BcGknO1xuXG50eXBlIFVuc3BlbnQgPSBiaXRnby5VbnNwZW50O1xuY29uc3QgZm9ybWF0T3V0cHV0SWQgPSBiaXRnby5mb3JtYXRPdXRwdXRJZDtcblxudHlwZSBCbG9ja2NoYWlyUmVzcG9uc2U8VD4gPSB7XG4gIGRhdGE6IFQ7XG59O1xuXG50eXBlIEJsb2NrY2hhaXJSZWNvcmRSZXNwb25zZTxUPiA9IEJsb2NrY2hhaXJSZXNwb25zZTxSZWNvcmQ8c3RyaW5nLCBUPj47XG5cbmNsYXNzIEVycm9yS2V5Tm90SW5SZXNwb25zZSBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3Ioa2V5OiBzdHJpbmcpIHtcbiAgICBzdXBlcihga2V5ICR7a2V5fSBub3QgaW4gcmVzcG9uc2VgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB1bndyYXBSZWNvcmQ8VD4oYm9keTogQmxvY2tjaGFpclJlY29yZFJlc3BvbnNlPFQ+LCBrZXk6IHN0cmluZyk6IFQge1xuICBpZiAoIShrZXkgaW4gYm9keS5kYXRhKSkge1xuICAgIHRocm93IG5ldyBFcnJvcktleU5vdEluUmVzcG9uc2Uoa2V5KTtcbiAgfVxuICByZXR1cm4gYm9keS5kYXRhW2tleV07XG59XG5cbi8vIGh0dHBzOi8vYmxvY2tjaGFpci5jb20vYXBpL2RvY3MjbGlua18zMDBcbnR5cGUgQmxvY2tjaGFpclVuc3BlbnQgPSB7XG4gIHRyYW5zYWN0aW9uX2hhc2g6IHN0cmluZztcbiAgaW5kZXg6IG51bWJlcjtcbiAgcmVjaXBpZW50OiBzdHJpbmc7XG4gIHZhbHVlOiBudW1iZXI7XG4gIGJsb2NrX2lkOiBudW1iZXI7XG4gIHNjcmlwdF9oZXg6IHN0cmluZztcbiAgc3BlbmRpbmdfdHJhbnNhY3Rpb25faGFzaDogc3RyaW5nO1xuICBzcGVuZGluZ19pbmRleDogbnVtYmVyO1xuICBhZGRyZXNzOiBzdHJpbmc7XG59O1xuXG4vLyBodHRwczovL2Jsb2NrY2hhaXIuY29tL2FwaS9kb2NzI2xpbmtfMzAwXG50eXBlIEJsb2NrY2hhaXJBZGRyZXNzID0ge1xuICBhZGRyZXNzOiB7XG4gICAgdHJhbnNhY3Rpb25faGFzaDogc3RyaW5nO1xuICAgIC8vIHZvdXRcbiAgICBpbmRleDogbnVtYmVyO1xuICAgIHZhbHVlOiBudW1iZXI7XG4gICAgYmxvY2tfaWQ6IG51bWJlcjtcbiAgICB0cmFuc2FjdGlvbl9jb3VudDogbnVtYmVyO1xuICAgIGJhbGFuY2U6IG51bWJlcjtcbiAgfTtcbiAgdXR4bzogQmxvY2tjaGFpclVuc3BlbnRbXTtcbn07XG5cbi8vIGh0dHBzOi8vYmxvY2tjaGFpci5jb20vYXBpL2RvY3MjbGlua18yMDBcbnR5cGUgQmxvY2tjaGFpclRyYW5zYWN0aW9uID0ge1xuICB0cmFuc2FjdGlvbjoge1xuICAgIC8qKlxuICAgICAgVGhlIGJsb2NrIG51bWJlciBpdCdzIGluY2x1ZGVkIGluLlxuICAgICAgSWYgdGhlIHRyYW5zYWN0aW9uIGlzIGluIHRoZSBtZW1wb29sLCBkYXRhLns6aGFzaH3htaIudHJhbnNhY3Rpb24uYmxvY2tfaWQgeWllbGRzIC0xXG4gICAgKi9cbiAgICBibG9ja19pZDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIExpa2UgaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1kYXRlLXRpbWUtc3RyaW5nLWZvcm1hdCBidXQgd2l0aCBhIHNwYWNlIGluc3RlYWQgb2YgJ1QnXG4gICAgICogWVlZWS1NTS1ERCBISDptbTpzc1xuICAgICAqL1xuICAgIHRpbWU6IHN0cmluZztcbiAgfTtcbiAgaW5wdXRzOiBCbG9ja2NoYWlyVW5zcGVudFtdO1xuICBvdXRwdXRzOiBCbG9ja2NoYWlyVW5zcGVudFtdO1xufTtcblxuLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rXzIwMVxudHlwZSBCbG9ja2NoYWlyUmF3VHJhbnNhY3Rpb24gPSB7XG4gIHJhd190cmFuc2FjdGlvbjogc3RyaW5nO1xufTtcblxuZXhwb3J0IGNsYXNzIEJsb2NrY2hhaXJBcGkgaW1wbGVtZW50cyBBZGRyZXNzQXBpLCBVdHhvQXBpIHtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGFwaVRva2VuPzogc3RyaW5nO1xuXG4gIHN0YXRpYyBmb3JDb2luKGNvaW5OYW1lOiBzdHJpbmcsIHBhcmFtczogeyBhcGlUb2tlbj86IHN0cmluZzsgaHR0cENsaWVudD86IEh0dHBDbGllbnQgfSA9IHt9KTogQmxvY2tjaGFpckFwaSB7XG4gICAgLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rX00wXG4gICAgbGV0IGJsb2NrY2hhaW47XG4gICAgc3dpdGNoIChjb2luTmFtZSkge1xuICAgICAgY2FzZSAnYnRjJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd0YnRjJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luL3Rlc3RuZXQnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2Jzdic6XG4gICAgICAgIGJsb2NrY2hhaW4gPSAnYml0Y29pbi1zdic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnYmNoJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luLWNhc2gnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2JjaGEnOlxuICAgICAgICBibG9ja2NoYWluID0gJ2VjYXNoJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdsdGMnOlxuICAgICAgICBibG9ja2NoYWluID0gJ2xpdGVjb2luJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkYXNoJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdkYXNoJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkb2dlJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdkb2dlY29pbic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnemVjJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICd6Y2FzaCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEFwaU5vdEltcGxlbWVudGVkRXJyb3IoY29pbk5hbWUpO1xuICAgIH1cbiAgICBjb25zdCB7IGh0dHBDbGllbnQgPSBuZXcgQmFzZUh0dHBDbGllbnQoKSB9ID0gcGFyYW1zO1xuICAgIHJldHVybiBuZXcgQmxvY2tjaGFpckFwaShodHRwQ2xpZW50LndpdGhCYXNlVXJsKGBodHRwczovL2FwaS5ibG9ja2NoYWlyLmNvbS8ke2Jsb2NrY2hhaW59YCksIHBhcmFtcy5hcGlUb2tlbik7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgY2xpZW50OiBIdHRwQ2xpZW50LCBhcGlUb2tlbj86IHN0cmluZykge1xuICAgIHRoaXMuYXBpVG9rZW4gPSBhcGlUb2tlbiA/PyBwcm9jZXNzLmVudi5CTE9DS0NIQUlSX1RPS0VOO1xuICB9XG5cbiAgZ2V0PFQ+KHBhdGg6IHN0cmluZyk6IFByb21pc2U8UmVzcG9uc2U8VD4+IHtcbiAgICByZXR1cm4gdGhpcy5jbGllbnQuZ2V0KHBhdGggKyAodGhpcy5hcGlUb2tlbiA/IGA/a2V5PSR7dGhpcy5hcGlUb2tlbn1gIDogJycpKTtcbiAgfVxuXG4gIGFzeW5jIGdldEFkZHJlc3NJbmZvKGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWRkcmVzc0luZm8+IHtcbiAgICBpZiAoIWFkZHJlc3MgfHwgYWRkcmVzcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBhZGRyZXNzJyk7XG4gICAgfVxuICAgIC8vIGh0dHBzOi8vYmxvY2tjaGFpci5jb20vYXBpL2RvY3MjbGlua18zMDBcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0PEJsb2NrY2hhaXJSZWNvcmRSZXNwb25zZTxCbG9ja2NoYWlyQWRkcmVzcz4+KGAvZGFzaGJvYXJkcy9hZGRyZXNzLyR7YWRkcmVzc31gKSkubWFwKFxuICAgICAgKGJvZHkpID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eENvdW50OiBib2R5LmRhdGFbYWRkcmVzc10uYWRkcmVzcy50cmFuc2FjdGlvbl9jb3VudCxcbiAgICAgICAgICBiYWxhbmNlOiBib2R5LmRhdGFbYWRkcmVzc10uYWRkcmVzcy5iYWxhbmNlLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBhc3luYyBnZXRVbnNwZW50c0ZvckFkZHJlc3NlcyhhZGRyOiBzdHJpbmdbXSk6IFByb21pc2U8VW5zcGVudFtdPiB7XG4gICAgaWYgKGFkZHIubGVuZ3RoID4gMTAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgc2l6ZWApO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5nZXQ8QmxvY2tjaGFpclJlc3BvbnNlPHsgdXR4bzogQmxvY2tjaGFpclVuc3BlbnRbXSB9Pj4oXG4gICAgICBgL2Rhc2hib2FyZHMvYWRkcmVzc2VzLyR7YWRkci5qb2luKCcsJyl9YFxuICAgICk7XG5cbiAgICByZXR1cm4gcmVzcG9uc2UubWFwKChib2R5KSA9PiB7XG4gICAgICByZXR1cm4gYm9keS5kYXRhLnV0eG9cbiAgICAgICAgLmZsYXRNYXAoKHVuc3BlbnQpOiBVbnNwZW50IHwgdW5kZWZpbmVkID0+IHtcbiAgICAgICAgICBpZiAoYWRkci5pbmNsdWRlcyh1bnNwZW50LmFkZHJlc3MpKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBpZDogZm9ybWF0T3V0cHV0SWQoeyB0eGlkOiB1bnNwZW50LnRyYW5zYWN0aW9uX2hhc2gsIHZvdXQ6IHVuc3BlbnQuaW5kZXggfSksXG4gICAgICAgICAgICAgIGFkZHJlc3M6IHVuc3BlbnQuYWRkcmVzcyxcbiAgICAgICAgICAgICAgdmFsdWU6IHVuc3BlbnQudmFsdWUsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9KVxuICAgICAgICAuZmlsdGVyKCh1bnNwZW50KTogdW5zcGVudCBpcyBVbnNwZW50ID0+IHVuc3BlbnQgIT09IHVuZGVmaW5lZCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRUcmFuc2FjdGlvbih0eGlkOiBzdHJpbmcpOiBQcm9taXNlPEJsb2NrY2hhaXJUcmFuc2FjdGlvbj4ge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXQ8QmxvY2tjaGFpclJlY29yZFJlc3BvbnNlPEJsb2NrY2hhaXJUcmFuc2FjdGlvbj4+KGAvZGFzaGJvYXJkcy90cmFuc2FjdGlvbi8ke3R4aWR9YCkpLm1hcChcbiAgICAgIChib2R5KSA9PiB7XG4gICAgICAgIHJldHVybiB1bndyYXBSZWNvcmQoYm9keSwgdHhpZCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uU3RhdHVzKHR4aWQ6IHN0cmluZyk6IFByb21pc2U8VHJhbnNhY3Rpb25TdGF0dXM+IHtcbiAgICBsZXQgdHJhbnNhY3Rpb247XG4gICAgdHJ5IHtcbiAgICAgIHRyYW5zYWN0aW9uID0gKGF3YWl0IHRoaXMuZ2V0VHJhbnNhY3Rpb24odHhpZCkpLnRyYW5zYWN0aW9uO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgRXJyb3JLZXlOb3RJblJlc3BvbnNlKSB7XG4gICAgICAgIHJldHVybiB7IGZvdW5kOiBmYWxzZSB9O1xuICAgICAgfVxuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gICAgY29uc3QgeyBibG9ja19pZCwgdGltZSB9ID0gdHJhbnNhY3Rpb247XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKERhdGUucGFyc2UodGltZS5yZXBsYWNlKCcgJywgJ1QnKSArICcuMDAwWicgLyogZm9yY2UgVVRDIHBhcnNpbmcgKi8pKTtcbiAgICByZXR1cm4gYmxvY2tfaWQgPT09IC0xXG4gICAgICA/IHsgZm91bmQ6IHRydWUsIGNvbmZpcm1lZDogZmFsc2UgfVxuICAgICAgOiB7XG4gICAgICAgICAgZm91bmQ6IHRydWUsXG4gICAgICAgICAgY29uZmlybWVkOiB0cnVlLFxuICAgICAgICAgIGJsb2NrSGVpZ2h0OiBibG9ja19pZCxcbiAgICAgICAgICBkYXRlLFxuICAgICAgICB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25JbnB1dHModHhpZDogc3RyaW5nKTogUHJvbWlzZTxVbnNwZW50W10+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0VHJhbnNhY3Rpb24odHhpZCkpLmlucHV0cy5tYXAoKGkpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBmb3JtYXRPdXRwdXRJZCh7IHR4aWQ6IGkudHJhbnNhY3Rpb25faGFzaCwgdm91dDogaS5pbmRleCB9KSxcbiAgICAgICAgYWRkcmVzczogaS5yZWNpcGllbnQsXG4gICAgICAgIHZhbHVlOiBpLnZhbHVlLFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uSU8odHhpZDogc3RyaW5nKTogUHJvbWlzZTxUcmFuc2FjdGlvbklPPiB7XG4gICAgY29uc3QgdHggPSBhd2FpdCB0aGlzLmdldFRyYW5zYWN0aW9uKHR4aWQpO1xuICAgIGNvbnN0IGlucHV0cyA9IHR4LmlucHV0cy5tYXAoKGlucHV0KSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBhZGRyZXNzOiBpbnB1dC5yZWNpcGllbnQsXG4gICAgICB9O1xuICAgIH0pO1xuICAgIGNvbnN0IG91dHB1dHMgPSB0eC5vdXRwdXRzLm1hcCgob3V0cHV0KSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBhZGRyZXNzOiBvdXRwdXQucmVjaXBpZW50LFxuICAgICAgfTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgaW5wdXRzLFxuICAgICAgb3V0cHV0cyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25TcGVuZHModHhpZDogc3RyaW5nKTogUHJvbWlzZTxPdXRwdXRTcGVuZFtdPiB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldFRyYW5zYWN0aW9uKHR4aWQpKS5vdXRwdXRzLm1hcCgobykgPT5cbiAgICAgIG8uc3BlbmRpbmdfdHJhbnNhY3Rpb25faGFzaFxuICAgICAgICA/IHtcbiAgICAgICAgICAgIHR4aWQ6IG8uc3BlbmRpbmdfdHJhbnNhY3Rpb25faGFzaCxcbiAgICAgICAgICAgIHZpbjogby5zcGVuZGluZ19pbmRleCxcbiAgICAgICAgICB9XG4gICAgICAgIDogeyB0eGlkOiB1bmRlZmluZWQsIHZpbjogdW5kZWZpbmVkIH1cbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25IZXgodHhpZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0PEJsb2NrY2hhaXJSZWNvcmRSZXNwb25zZTxCbG9ja2NoYWlyUmF3VHJhbnNhY3Rpb24+PihgL3Jhdy90cmFuc2FjdGlvbi8ke3R4aWR9YCkpLm1hcChcbiAgICAgIChib2R5KSA9PiB7XG4gICAgICAgIHJldHVybiB1bndyYXBSZWNvcmQoYm9keSwgdHhpZCkucmF3X3RyYW5zYWN0aW9uO1xuICAgICAgfVxuICAgICk7XG4gIH1cbn1cbiJdfQ==