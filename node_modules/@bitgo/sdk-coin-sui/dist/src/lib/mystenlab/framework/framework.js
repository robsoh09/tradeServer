"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Delegation = exports.Coin = exports.CoinMetadataStruct = exports.isObjectDataFull = exports.COIN_TYPE_ARG_REGEX = exports.PAY_JOIN_COIN_FUNC_NAME = exports.PAY_SPLIT_COIN_VEC_FUNC_NAME = exports.PAY_MODULE_NAME = exports.SUI_CLOCK_OBJECT_ID = exports.VALIDATORS_EVENTS_QUERY = exports.SUI_TYPE_ARG = exports.ID_STRUCT_NAME = exports.UID_STRUCT_NAME = exports.OBJECT_MODULE_NAME = exports.MOVE_STDLIB_ADDRESS = exports.SUI_FRAMEWORK_ADDRESS = exports.SUI_SYSTEM_ADDRESS = void 0;
const objects_1 = require("../types/objects");
const common_1 = require("../types/common");
const option_1 = require("../types/option");
const superstruct_1 = require("superstruct");
exports.SUI_SYSTEM_ADDRESS = '0x3';
exports.SUI_FRAMEWORK_ADDRESS = '0x2';
exports.MOVE_STDLIB_ADDRESS = '0x1';
exports.OBJECT_MODULE_NAME = 'object';
exports.UID_STRUCT_NAME = 'UID';
exports.ID_STRUCT_NAME = 'ID';
exports.SUI_TYPE_ARG = `${exports.SUI_FRAMEWORK_ADDRESS}::sui::SUI`;
exports.VALIDATORS_EVENTS_QUERY = '0x3::validator_set::ValidatorEpochInfoEvent';
exports.SUI_CLOCK_OBJECT_ID = (0, common_1.normalizeSuiObjectId)('0x6');
// `sui::pay` module is used for Coin management (split, join, join_and_transfer etc);
exports.PAY_MODULE_NAME = 'pay';
exports.PAY_SPLIT_COIN_VEC_FUNC_NAME = 'split_vec';
exports.PAY_JOIN_COIN_FUNC_NAME = 'join';
exports.COIN_TYPE_ARG_REGEX = /^0x2::coin::Coin<(.+)>$/;
function isObjectDataFull(resp) {
    return !!resp.data || !!resp.type;
}
exports.isObjectDataFull = isObjectDataFull;
exports.CoinMetadataStruct = (0, superstruct_1.object)({
    decimals: (0, superstruct_1.number)(),
    name: (0, superstruct_1.string)(),
    symbol: (0, superstruct_1.string)(),
    description: (0, superstruct_1.string)(),
    iconUrl: (0, superstruct_1.union)([(0, superstruct_1.string)(), (0, superstruct_1.literal)(null)]),
    id: (0, superstruct_1.union)([common_1.ObjectId, (0, superstruct_1.literal)(null)]),
});
/**
 * Utility class for 0x2::coin
 * as defined in https://github.com/MystenLabs/sui/blob/ca9046fd8b1a9e8634a4b74b0e7dabdc7ea54475/sui_programmability/framework/sources/Coin.move#L4
 */
class Coin {
    static isCoin(data) {
        var _a;
        return ((_a = Coin.getType(data)) === null || _a === void 0 ? void 0 : _a.match(exports.COIN_TYPE_ARG_REGEX)) != null;
    }
    static getCoinType(type) {
        var _a;
        const [, res] = (_a = type.match(exports.COIN_TYPE_ARG_REGEX)) !== null && _a !== void 0 ? _a : [];
        return res || null;
    }
    static getCoinTypeArg(obj) {
        const type = Coin.getType(obj);
        return type ? Coin.getCoinType(type) : null;
    }
    static isSUI(obj) {
        const arg = Coin.getCoinTypeArg(obj);
        return arg ? Coin.getCoinSymbol(arg) === 'SUI' : false;
    }
    static getCoinSymbol(coinTypeArg) {
        return coinTypeArg.substring(coinTypeArg.lastIndexOf(':') + 1);
    }
    static getCoinStructTag(coinTypeArg) {
        return {
            address: (0, common_1.normalizeSuiObjectId)(coinTypeArg.split('::')[0]),
            module: coinTypeArg.split('::')[1],
            name: coinTypeArg.split('::')[2],
            typeParams: [],
        };
    }
    static getID(obj) {
        if ('fields' in obj) {
            return obj.fields.id.id;
        }
        return (0, objects_1.getObjectId)(obj);
    }
    static totalBalance(coins) {
        return coins.reduce((partialSum, c) => partialSum + Coin.getBalanceFromCoinStruct(c), BigInt(0));
    }
    /**
     * Sort coin by balance in an ascending order
     */
    static sortByBalance(coins) {
        return [...coins].sort((a, b) => Coin.getBalanceFromCoinStruct(a) < Coin.getBalanceFromCoinStruct(b)
            ? -1
            : Coin.getBalanceFromCoinStruct(a) > Coin.getBalanceFromCoinStruct(b)
                ? 1
                : 0);
    }
    static getBalanceFromCoinStruct(coin) {
        return BigInt(coin.balance);
    }
    static getBalance(data) {
        var _a;
        if (!Coin.isCoin(data)) {
            return undefined;
        }
        const balance = (_a = (0, objects_1.getObjectFields)(data)) === null || _a === void 0 ? void 0 : _a.balance;
        return BigInt(balance);
    }
    static getType(data) {
        if (isObjectDataFull(data)) {
            return (0, objects_1.getObjectType)(data);
        }
        return data.type;
    }
}
exports.Coin = Coin;
// Class for delegation.move
// see https://github.com/MystenLabs/fastnft/blob/161aa27fe7eb8ecf2866ec9eb192e768f25da768/crates/sui-framework/sources/governance/delegation.move
class Delegation {
    constructor(obj) {
        this.suiObject = obj;
    }
    static isDelegationSuiObject(obj) {
        return 'type' in obj && obj.type === Delegation.SUI_OBJECT_TYPE;
    }
    nextRewardUnclaimedEpoch() {
        return this.suiObject.data.fields.next_reward_unclaimed_epoch;
    }
    activeDelegation() {
        return BigInt((0, option_1.getOption)(this.suiObject.data.fields.active_delegation) || 0);
    }
    delegateAmount() {
        return this.suiObject.data.fields.delegate_amount;
    }
    endingEpoch() {
        return (0, option_1.getOption)(this.suiObject.data.fields.ending_epoch);
    }
    validatorAddress() {
        return this.suiObject.data.fields.validator_address;
    }
    isActive() {
        return this.activeDelegation() > 0 && !this.endingEpoch();
    }
    hasUnclaimedRewards(epoch) {
        return this.nextRewardUnclaimedEpoch() <= epoch && (this.isActive() || (this.endingEpoch() || 0) > epoch);
    }
}
exports.Delegation = Delegation;
Delegation.SUI_OBJECT_TYPE = '0x2::delegation::Delegation';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWV3b3JrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9teXN0ZW5sYWIvZnJhbWV3b3JrL2ZyYW1ld29yay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4Q0FRMEI7QUFDMUIsNENBQTZFO0FBRTdFLDRDQUFvRDtBQUdwRCw2Q0FBNEU7QUFFL0QsUUFBQSxrQkFBa0IsR0FBRyxLQUFLLENBQUM7QUFDM0IsUUFBQSxxQkFBcUIsR0FBRyxLQUFLLENBQUM7QUFDOUIsUUFBQSxtQkFBbUIsR0FBRyxLQUFLLENBQUM7QUFDNUIsUUFBQSxrQkFBa0IsR0FBRyxRQUFRLENBQUM7QUFDOUIsUUFBQSxlQUFlLEdBQUcsS0FBSyxDQUFDO0FBQ3hCLFFBQUEsY0FBYyxHQUFHLElBQUksQ0FBQztBQUN0QixRQUFBLFlBQVksR0FBRyxHQUFHLDZCQUFxQixZQUFZLENBQUM7QUFDcEQsUUFBQSx1QkFBdUIsR0FBRyw2Q0FBNkMsQ0FBQztBQUV4RSxRQUFBLG1CQUFtQixHQUFHLElBQUEsNkJBQW9CLEVBQUMsS0FBSyxDQUFDLENBQUM7QUFFL0Qsc0ZBQXNGO0FBQ3pFLFFBQUEsZUFBZSxHQUFHLEtBQUssQ0FBQztBQUN4QixRQUFBLDRCQUE0QixHQUFHLFdBQVcsQ0FBQztBQUMzQyxRQUFBLHVCQUF1QixHQUFHLE1BQU0sQ0FBQztBQUNqQyxRQUFBLG1CQUFtQixHQUFHLHlCQUF5QixDQUFDO0FBSzdELFNBQWdCLGdCQUFnQixDQUFDLElBQWlDO0lBQ2hFLE9BQU8sQ0FBQyxDQUFFLElBQTBCLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBRSxJQUFzQixDQUFDLElBQUksQ0FBQztBQUM5RSxDQUFDO0FBRkQsNENBRUM7QUFFWSxRQUFBLGtCQUFrQixHQUFHLElBQUEsb0JBQU0sRUFBQztJQUN2QyxRQUFRLEVBQUUsSUFBQSxvQkFBTSxHQUFFO0lBQ2xCLElBQUksRUFBRSxJQUFBLG9CQUFNLEdBQUU7SUFD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QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGdldE9iamVjdEZpZWxkcyxcbiAgU3VpT2JqZWN0UmVzcG9uc2UsXG4gIFN1aU1vdmVPYmplY3QsXG4gIFN1aU9iamVjdEluZm8sXG4gIFN1aU9iamVjdERhdGEsXG4gIGdldE9iamVjdElkLFxuICBnZXRPYmplY3RUeXBlLFxufSBmcm9tICcuLi90eXBlcy9vYmplY3RzJztcbmltcG9ydCB7IG5vcm1hbGl6ZVN1aU9iamVjdElkLCBPYmplY3RJZCwgU3VpQWRkcmVzcyB9IGZyb20gJy4uL3R5cGVzL2NvbW1vbic7XG5cbmltcG9ydCB7IGdldE9wdGlvbiwgT3B0aW9uIH0gZnJvbSAnLi4vdHlwZXMvb3B0aW9uJztcbmltcG9ydCB7IENvaW5TdHJ1Y3QgfSBmcm9tICcuLi90eXBlcy9jb2luJztcbmltcG9ydCB7IFN0cnVjdFRhZyB9IGZyb20gJy4uL3R5cGVzL3N1aS1iY3MnO1xuaW1wb3J0IHsgSW5mZXIsIGxpdGVyYWwsIG51bWJlciwgb2JqZWN0LCBzdHJpbmcsIHVuaW9uIH0gZnJvbSAnc3VwZXJzdHJ1Y3QnO1xuXG5leHBvcnQgY29uc3QgU1VJX1NZU1RFTV9BRERSRVNTID0gJzB4Myc7XG5leHBvcnQgY29uc3QgU1VJX0ZSQU1FV09SS19BRERSRVNTID0gJzB4Mic7XG5leHBvcnQgY29uc3QgTU9WRV9TVERMSUJfQUREUkVTUyA9ICcweDEnO1xuZXhwb3J0IGNvbnN0IE9CSkVDVF9NT0RVTEVfTkFNRSA9ICdvYmplY3QnO1xuZXhwb3J0IGNvbnN0IFVJRF9TVFJVQ1RfTkFNRSA9ICdVSUQnO1xuZXhwb3J0IGNvbnN0IElEX1NUUlVDVF9OQU1FID0gJ0lEJztcbmV4cG9ydCBjb25zdCBTVUlfVFlQRV9BUkcgPSBgJHtTVUlfRlJBTUVXT1JLX0FERFJFU1N9OjpzdWk6OlNVSWA7XG5leHBvcnQgY29uc3QgVkFMSURBVE9SU19FVkVOVFNfUVVFUlkgPSAnMHgzOjp2YWxpZGF0b3Jfc2V0OjpWYWxpZGF0b3JFcG9jaEluZm9FdmVudCc7XG5cbmV4cG9ydCBjb25zdCBTVUlfQ0xPQ0tfT0JKRUNUX0lEID0gbm9ybWFsaXplU3VpT2JqZWN0SWQoJzB4NicpO1xuXG4vLyBgc3VpOjpwYXlgIG1vZHVsZSBpcyB1c2VkIGZvciBDb2luIG1hbmFnZW1lbnQgKHNwbGl0LCBqb2luLCBqb2luX2FuZF90cmFuc2ZlciBldGMpO1xuZXhwb3J0IGNvbnN0IFBBWV9NT0RVTEVfTkFNRSA9ICdwYXknO1xuZXhwb3J0IGNvbnN0IFBBWV9TUExJVF9DT0lOX1ZFQ19GVU5DX05BTUUgPSAnc3BsaXRfdmVjJztcbmV4cG9ydCBjb25zdCBQQVlfSk9JTl9DT0lOX0ZVTkNfTkFNRSA9ICdqb2luJztcbmV4cG9ydCBjb25zdCBDT0lOX1RZUEVfQVJHX1JFR0VYID0gL14weDI6OmNvaW46OkNvaW48KC4rKT4kLztcblxudHlwZSBPYmplY3REYXRhID0gT2JqZWN0RGF0YUZ1bGwgfCBTdWlPYmplY3RJbmZvO1xudHlwZSBPYmplY3REYXRhRnVsbCA9IFN1aU9iamVjdFJlc3BvbnNlIHwgU3VpTW92ZU9iamVjdDtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzT2JqZWN0RGF0YUZ1bGwocmVzcDogT2JqZWN0RGF0YSB8IE9iamVjdERhdGFGdWxsKTogcmVzcCBpcyBTdWlPYmplY3RSZXNwb25zZSB7XG4gIHJldHVybiAhIShyZXNwIGFzIFN1aU9iamVjdFJlc3BvbnNlKS5kYXRhIHx8ICEhKHJlc3AgYXMgU3VpTW92ZU9iamVjdCkudHlwZTtcbn1cblxuZXhwb3J0IGNvbnN0IENvaW5NZXRhZGF0YVN0cnVjdCA9IG9iamVjdCh7XG4gIGRlY2ltYWxzOiBudW1iZXIoKSxcbiAgbmFtZTogc3RyaW5nKCksXG4gIHN5bWJvbDogc3RyaW5nKCksXG4gIGRlc2NyaXB0aW9uOiBzdHJpbmcoKSxcbiAgaWNvblVybDogdW5pb24oW3N0cmluZygpLCBsaXRlcmFsKG51bGwpXSksXG4gIGlkOiB1bmlvbihbT2JqZWN0SWQsIGxpdGVyYWwobnVsbCldKSxcbn0pO1xuXG5leHBvcnQgdHlwZSBDb2luTWV0YWRhdGEgPSBJbmZlcjx0eXBlb2YgQ29pbk1ldGFkYXRhU3RydWN0PjtcblxuLyoqXG4gKiBVdGlsaXR5IGNsYXNzIGZvciAweDI6OmNvaW5cbiAqIGFzIGRlZmluZWQgaW4gaHR0cHM6Ly9naXRodWIuY29tL015c3RlbkxhYnMvc3VpL2Jsb2IvY2E5MDQ2ZmQ4YjFhOWU4NjM0YTRiNzRiMGU3ZGFiZGM3ZWE1NDQ3NS9zdWlfcHJvZ3JhbW1hYmlsaXR5L2ZyYW1ld29yay9zb3VyY2VzL0NvaW4ubW92ZSNMNFxuICovXG5leHBvcnQgY2xhc3MgQ29pbiB7XG4gIHN0YXRpYyBpc0NvaW4oZGF0YTogT2JqZWN0RGF0YSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBDb2luLmdldFR5cGUoZGF0YSk/Lm1hdGNoKENPSU5fVFlQRV9BUkdfUkVHRVgpICE9IG51bGw7XG4gIH1cblxuICBzdGF0aWMgZ2V0Q29pblR5cGUodHlwZTogc3RyaW5nKSB7XG4gICAgY29uc3QgWywgcmVzXSA9IHR5cGUubWF0Y2goQ09JTl9UWVBFX0FSR19SRUdFWCkgPz8gW107XG4gICAgcmV0dXJuIHJlcyB8fCBudWxsO1xuICB9XG5cbiAgc3RhdGljIGdldENvaW5UeXBlQXJnKG9iajogT2JqZWN0RGF0YSkge1xuICAgIGNvbnN0IHR5cGUgPSBDb2luLmdldFR5cGUob2JqKTtcbiAgICByZXR1cm4gdHlwZSA/IENvaW4uZ2V0Q29pblR5cGUodHlwZSkgOiBudWxsO1xuICB9XG5cbiAgc3RhdGljIGlzU1VJKG9iajogT2JqZWN0RGF0YSkge1xuICAgIGNvbnN0IGFyZyA9IENvaW4uZ2V0Q29pblR5cGVBcmcob2JqKTtcbiAgICByZXR1cm4gYXJnID8gQ29pbi5nZXRDb2luU3ltYm9sKGFyZykgPT09ICdTVUknIDogZmFsc2U7XG4gIH1cblxuICBzdGF0aWMgZ2V0Q29pblN5bWJvbChjb2luVHlwZUFyZzogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGNvaW5UeXBlQXJnLnN1YnN0cmluZyhjb2luVHlwZUFyZy5sYXN0SW5kZXhPZignOicpICsgMSk7XG4gIH1cblxuICBzdGF0aWMgZ2V0Q29pblN0cnVjdFRhZyhjb2luVHlwZUFyZzogc3RyaW5nKTogU3RydWN0VGFnIHtcbiAgICByZXR1cm4ge1xuICAgICAgYWRkcmVzczogbm9ybWFsaXplU3VpT2JqZWN0SWQoY29pblR5cGVBcmcuc3BsaXQoJzo6JylbMF0pLFxuICAgICAgbW9kdWxlOiBjb2luVHlwZUFyZy5zcGxpdCgnOjonKVsxXSxcbiAgICAgIG5hbWU6IGNvaW5UeXBlQXJnLnNwbGl0KCc6OicpWzJdLFxuICAgICAgdHlwZVBhcmFtczogW10sXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0SUQob2JqOiBPYmplY3REYXRhKTogT2JqZWN0SWQge1xuICAgIGlmICgnZmllbGRzJyBpbiBvYmopIHtcbiAgICAgIHJldHVybiBvYmouZmllbGRzLmlkLmlkO1xuICAgIH1cbiAgICByZXR1cm4gZ2V0T2JqZWN0SWQob2JqKTtcbiAgfVxuXG4gIHN0YXRpYyB0b3RhbEJhbGFuY2UoY29pbnM6IENvaW5TdHJ1Y3RbXSk6IGJpZ2ludCB7XG4gICAgcmV0dXJuIGNvaW5zLnJlZHVjZSgocGFydGlhbFN1bSwgYykgPT4gcGFydGlhbFN1bSArIENvaW4uZ2V0QmFsYW5jZUZyb21Db2luU3RydWN0KGMpLCBCaWdJbnQoMCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNvcnQgY29pbiBieSBiYWxhbmNlIGluIGFuIGFzY2VuZGluZyBvcmRlclxuICAgKi9cbiAgc3RhdGljIHNvcnRCeUJhbGFuY2UoY29pbnM6IENvaW5TdHJ1Y3RbXSk6IENvaW5TdHJ1Y3RbXSB7XG4gICAgcmV0dXJuIFsuLi5jb2luc10uc29ydCgoYSwgYikgPT5cbiAgICAgIENvaW4uZ2V0QmFsYW5jZUZyb21Db2luU3RydWN0KGEpIDwgQ29pbi5nZXRCYWxhbmNlRnJvbUNvaW5TdHJ1Y3QoYilcbiAgICAgICAgPyAtMVxuICAgICAgICA6IENvaW4uZ2V0QmFsYW5jZUZyb21Db2luU3RydWN0KGEpID4gQ29pbi5nZXRCYWxhbmNlRnJvbUNvaW5TdHJ1Y3QoYilcbiAgICAgICAgPyAxXG4gICAgICAgIDogMFxuICAgICk7XG4gIH1cblxuICBzdGF0aWMgZ2V0QmFsYW5jZUZyb21Db2luU3RydWN0KGNvaW46IENvaW5TdHJ1Y3QpOiBiaWdpbnQge1xuICAgIHJldHVybiBCaWdJbnQoY29pbi5iYWxhbmNlKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRCYWxhbmNlKGRhdGE6IE9iamVjdERhdGFGdWxsKTogYmlnaW50IHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIUNvaW4uaXNDb2luKGRhdGEpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCBiYWxhbmNlID0gZ2V0T2JqZWN0RmllbGRzKGRhdGEpPy5iYWxhbmNlO1xuICAgIHJldHVybiBCaWdJbnQoYmFsYW5jZSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRUeXBlKGRhdGE6IE9iamVjdERhdGEpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGlmIChpc09iamVjdERhdGFGdWxsKGRhdGEpKSB7XG4gICAgICByZXR1cm4gZ2V0T2JqZWN0VHlwZShkYXRhKTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGEudHlwZTtcbiAgfVxufVxuXG5leHBvcnQgdHlwZSBEZWxlZ2F0aW9uRGF0YSA9IFN1aU1vdmVPYmplY3QgJiB7XG4gIGRhdGFUeXBlOiAnbW92ZU9iamVjdCc7XG4gIHR5cGU6ICcweDI6OmRlbGVnYXRpb246OkRlbGVnYXRpb24nO1xuICBmaWVsZHM6IHtcbiAgICBhY3RpdmVfZGVsZWdhdGlvbjogT3B0aW9uPG51bWJlcj47XG4gICAgZGVsZWdhdGVfYW1vdW50OiBudW1iZXI7XG4gICAgbmV4dF9yZXdhcmRfdW5jbGFpbWVkX2Vwb2NoOiBudW1iZXI7XG4gICAgdmFsaWRhdG9yX2FkZHJlc3M6IFN1aUFkZHJlc3M7XG4gICAgaW5mbzoge1xuICAgICAgaWQ6IHN0cmluZztcbiAgICAgIHZlcnNpb246IG51bWJlcjtcbiAgICB9O1xuICAgIGNvaW5fbG9ja2VkX3VudGlsX2Vwb2NoOiBPcHRpb248U3VpTW92ZU9iamVjdD47XG4gICAgZW5kaW5nX2Vwb2NoOiBPcHRpb248bnVtYmVyPjtcbiAgfTtcbn07XG5cbmV4cG9ydCB0eXBlIERlbGVnYXRpb25TdWlPYmplY3QgPSBPbWl0PFN1aU9iamVjdERhdGEsICdkYXRhJz4gJiB7XG4gIGRhdGE6IERlbGVnYXRpb25EYXRhO1xufTtcblxuLy8gQ2xhc3MgZm9yIGRlbGVnYXRpb24ubW92ZVxuLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9NeXN0ZW5MYWJzL2Zhc3RuZnQvYmxvYi8xNjFhYTI3ZmU3ZWI4ZWNmMjg2NmVjOWViMTkyZTc2OGYyNWRhNzY4L2NyYXRlcy9zdWktZnJhbWV3b3JrL3NvdXJjZXMvZ292ZXJuYW5jZS9kZWxlZ2F0aW9uLm1vdmVcbmV4cG9ydCBjbGFzcyBEZWxlZ2F0aW9uIHtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBTVUlfT0JKRUNUX1RZUEUgPSAnMHgyOjpkZWxlZ2F0aW9uOjpEZWxlZ2F0aW9uJztcbiAgcHJpdmF0ZSBzdWlPYmplY3Q6IERlbGVnYXRpb25TdWlPYmplY3Q7XG5cbiAgcHVibGljIHN0YXRpYyBpc0RlbGVnYXRpb25TdWlPYmplY3Qob2JqOiBTdWlPYmplY3REYXRhKTogb2JqIGlzIERlbGVnYXRpb25TdWlPYmplY3Qge1xuICAgIHJldHVybiAndHlwZScgaW4gb2JqICYmIG9iai50eXBlID09PSBEZWxlZ2F0aW9uLlNVSV9PQkpFQ1RfVFlQRTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKG9iajogRGVsZWdhdGlvblN1aU9iamVjdCkge1xuICAgIHRoaXMuc3VpT2JqZWN0ID0gb2JqO1xuICB9XG5cbiAgcHVibGljIG5leHRSZXdhcmRVbmNsYWltZWRFcG9jaCgpIHtcbiAgICByZXR1cm4gdGhpcy5zdWlPYmplY3QuZGF0YS5maWVsZHMubmV4dF9yZXdhcmRfdW5jbGFpbWVkX2Vwb2NoO1xuICB9XG5cbiAgcHVibGljIGFjdGl2ZURlbGVnYXRpb24oKSB7XG4gICAgcmV0dXJuIEJpZ0ludChnZXRPcHRpb24odGhpcy5zdWlPYmplY3QuZGF0YS5maWVsZHMuYWN0aXZlX2RlbGVnYXRpb24pIHx8IDApO1xuICB9XG5cbiAgcHVibGljIGRlbGVnYXRlQW1vdW50KCkge1xuICAgIHJldHVybiB0aGlzLnN1aU9iamVjdC5kYXRhLmZpZWxkcy5kZWxlZ2F0ZV9hbW91bnQ7XG4gIH1cblxuICBwdWJsaWMgZW5kaW5nRXBvY2goKSB7XG4gICAgcmV0dXJuIGdldE9wdGlvbih0aGlzLnN1aU9iamVjdC5kYXRhLmZpZWxkcy5lbmRpbmdfZXBvY2gpO1xuICB9XG5cbiAgcHVibGljIHZhbGlkYXRvckFkZHJlc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3VpT2JqZWN0LmRhdGEuZmllbGRzLnZhbGlkYXRvcl9hZGRyZXNzO1xuICB9XG5cbiAgcHVibGljIGlzQWN0aXZlKCkge1xuICAgIHJldHVybiB0aGlzLmFjdGl2ZURlbGVnYXRpb24oKSA+IDAgJiYgIXRoaXMuZW5kaW5nRXBvY2goKTtcbiAgfVxuXG4gIHB1YmxpYyBoYXNVbmNsYWltZWRSZXdhcmRzKGVwb2NoOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5uZXh0UmV3YXJkVW5jbGFpbWVkRXBvY2goKSA8PSBlcG9jaCAmJiAodGhpcy5pc0FjdGl2ZSgpIHx8ICh0aGlzLmVuZGluZ0Vwb2NoKCkgfHwgMCkgPiBlcG9jaCk7XG4gIH1cbn1cbiJdfQ==