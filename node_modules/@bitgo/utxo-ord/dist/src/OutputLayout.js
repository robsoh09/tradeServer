"use strict";
/*

This file contains code for creating an output layouts for transactions that pass on inscriptions.

When passing on an inscription, we want to satisfy a few constraints:

* All outputs should be larger than a minimal value (dust limit)
* The sum of all output values needs to be less than the input to cover the transaction fee.
* The output containing the inscription should be as small as possible, but large enough to
  contain the inscription.

To keep the inscription output small, we can pad the satoshi range preceding and following the range
with change outputs, which have a minimal size and incur a fee cost.


Broadly speaking, there are four scenarios:

(1) Small inscription input that has just enough value to pay for fee and a single inscription
    output (u0). No padding outputs.
    ┌────────┬────────┐
    │        │ u0     │
    │      r ┼        │
    │        ├────────┘
    │        │ fee
    └────────┘


(2) Large inscription input with inscription close to start of input.
    Inscription output followed by change output (u1) padding the remaining value.

    ┌────────┬────────┐
    │        │ u0     │
    │      r ┼        │
    │        ├────────┤
    │        │ u1     │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        ├────────┘
    │        │
    │        │ fee
    │        │
    └────────┘


(3) Large inscription input with inscription close to end of input.
    Change output padding start followed by inscription output.

    ┌────────┬────────┐
    │        │ u0     │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        ├────────┤
    │      r ┼        │
    │        │ u1     │
    │        ├────────┘
    │        │
    │        │ fee
    │        │
    └────────┘


(4) Large inscription input with inscription in the middle.
    Inscription input (u1) with padding on both sides (u0 and u2)

    ┌────────┬────────┐
    │        │ u0     │
    │        │        │
    │        │        │
    │        │        │
    │        │        │
    │        ├────────┤
    │        │ u1     │
    │      r ┼        │
    │        ├────────┤
    │        │ u2     │
    │        │        │
    │        │        │
    │        │        │
    │        ├────────┘
    │        │
    │        │ fee
    │        │
    └────────┘
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.findOutputLayout = exports.getOrdOutputsForLayout = exports.toParameters = exports.toArray = void 0;
const ZERO = BigInt(0);
const ONE = BigInt(1);
function max(a, b) {
    return a < b ? b : a;
}
function min(a, b) {
    return a < b ? a : b;
}
function sum(arr) {
    return arr.reduce((a, b) => a + b, ZERO);
}
/** @return canonical sequence of parameters */
function toArray(p) {
    return [p.firstChangeOutput, p.inscriptionOutput, p.secondChangeOutput, p.feeOutput];
}
exports.toArray = toArray;
function toParameters(firstChangeOutput, inscriptionOutput, secondChangeOutput, feeOutput) {
    return {
        firstChangeOutput,
        inscriptionOutput,
        secondChangeOutput,
        feeOutput,
    };
}
exports.toParameters = toParameters;
/**
 * Translates a layout into OrdOutputs. Absent outputs are set to `null`.
 *
 * @param inscriptionInput
 * @param layout
 * @return OrdOutputs for layout
 */
function getOrdOutputsForLayout(inscriptionInput, layout) {
    const outputs = inscriptionInput.splitAllWithParams(toArray(layout), { exact: true, allowZero: true });
    if (outputs.length !== 4) {
        throw new Error(`unexpected result`);
    }
    return toParameters(...outputs);
}
exports.getOrdOutputsForLayout = getOrdOutputsForLayout;
/**
 * @param constraints
 * @param inscriptionInput
 * @param layout
 * @return true iff layout satisfies constraints
 */
function check(constraints, inscriptionInput, layout) {
    var _a;
    if ((layout.firstChangeOutput === ZERO || constraints.minChangeOutput <= layout.firstChangeOutput) &&
        (layout.secondChangeOutput === ZERO || constraints.minChangeOutput <= layout.secondChangeOutput) &&
        constraints.minInscriptionOutput <= layout.inscriptionOutput &&
        layout.inscriptionOutput <= constraints.maxInscriptionOutput &&
        getFeeForOutputs(constraints, [layout.firstChangeOutput, layout.inscriptionOutput, layout.secondChangeOutput]) <=
            layout.feeOutput &&
        sum(toArray(layout)) === inscriptionInput.value) {
        /* make sure inscription actually lies on the inscriptionOutput */
        const outputs = getOrdOutputsForLayout(inscriptionInput, layout);
        return ((_a = outputs.inscriptionOutput) === null || _a === void 0 ? void 0 : _a.ordinals.length) === 1;
    }
    return false;
}
function getFeeForOutputs(p, outputs) {
    return outputs.reduce((sum, oValue) => sum + (oValue === ZERO ? ZERO : p.feePerOutput), p.feeFixed);
}
function getStartChangeOutput(c) {
    // we don't need a change padding output
    if (c.satPos < c.maxInscriptionOutput) {
        return ZERO;
    }
    if (c.minChangeOutput <= c.satPos) {
        return c.satPos;
    }
    return null;
}
function getInscriptionOutput(c, startChangeOutput) {
    const result = min(c.maxInscriptionOutput, max(c.minInscriptionOutput, c.satPos - startChangeOutput + ONE));
    if (c.satPos < startChangeOutput || startChangeOutput + result < c.satPos) {
        return null;
    }
    // if is not worth creating an end change output, let's maximize the inscription output
    if (getEndChangeOutput(c, startChangeOutput, result) === ZERO) {
        const remainder = c.total - startChangeOutput - getFeeForOutputs(c, [startChangeOutput, result]);
        return min(remainder, c.maxInscriptionOutput);
    }
    return result;
}
function getEndChangeOutput(c, startChangeOutput, inscriptionOutput) {
    const remainder = c.total - sum([startChangeOutput, inscriptionOutput]);
    const minFeeWithoutSecondOutput = getFeeForOutputs(c, [startChangeOutput, inscriptionOutput]);
    const minFeeWithSecondOutput = getFeeForOutputs(c, [startChangeOutput, inscriptionOutput, c.minChangeOutput]);
    if (remainder < minFeeWithoutSecondOutput) {
        // We cannot even pay the fee for the output(s) we have so far.
        return null;
    }
    if (remainder - minFeeWithSecondOutput < c.minChangeOutput) {
        // The remainder is too small to pay for the end change output. Let's skip it and pay a higher fee.
        return ZERO;
    }
    // let's use as much as we can for fee while leaving enough for fee
    return remainder - minFeeWithSecondOutput;
}
function getFeeOutput(c, startChangeOutput, inscriptionOutput, endChangeOutput) {
    const minFee = getFeeForOutputs(c, [startChangeOutput, inscriptionOutput, endChangeOutput]);
    const remainder = c.total - sum([startChangeOutput, inscriptionOutput, endChangeOutput]);
    if (remainder < minFee) {
        return null;
    }
    return remainder;
}
/**
 * @param inscriptionInput
 * @param search
 * @return a solution that satisfies constraints. If no solution can be found, return `undefined`.
 */
function findOutputLayout(inscriptionInput, search) {
    if (inscriptionInput.ordinals.length !== 1) {
        throw new Error(`unexpected ordinal count ${inscriptionInput.ordinals.length}`);
    }
    if (inscriptionInput.ordinals[0].size() !== ONE) {
        throw new Error(`only single-satoshi inscriptions are supported`);
    }
    const satPos = inscriptionInput.ordinals[0].start;
    const total = inscriptionInput.value;
    const constraints = { ...search, satPos, total };
    const startChangeOutput = getStartChangeOutput(constraints);
    if (startChangeOutput === null) {
        return;
    }
    const inscriptionOutput = getInscriptionOutput(constraints, startChangeOutput);
    if (inscriptionOutput === null) {
        return;
    }
    const endChangeOutput = getEndChangeOutput(constraints, startChangeOutput, inscriptionOutput);
    if (endChangeOutput === null) {
        return;
    }
    const feeOutput = getFeeOutput(constraints, startChangeOutput, inscriptionOutput, endChangeOutput);
    if (feeOutput === null) {
        return;
    }
    const result = toParameters(startChangeOutput, inscriptionOutput, endChangeOutput, feeOutput);
    if (!check(constraints, inscriptionInput, result)) {
        throw new Error(`invalid result`);
    }
    return result;
}
exports.findOutputLayout = findOutputLayout;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3V0cHV0TGF5b3V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL091dHB1dExheW91dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWdHRzs7O0FBSUgsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUV0QixTQUFTLEdBQUcsQ0FBQyxDQUFTLEVBQUUsQ0FBUztJQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZCLENBQUM7QUFFRCxTQUFTLEdBQUcsQ0FBQyxDQUFTLEVBQUUsQ0FBUztJQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZCLENBQUM7QUFFRCxTQUFTLEdBQUcsQ0FBQyxHQUFhO0lBQ3hCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQWdCRCwrQ0FBK0M7QUFDL0MsU0FBZ0IsT0FBTyxDQUFJLENBQWdCO0lBQ3pDLE9BQU8sQ0FBQyxDQUFDLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDdkYsQ0FBQztBQUZELDBCQUVDO0FBRUQsU0FBZ0IsWUFBWSxDQUMxQixpQkFBb0IsRUFDcEIsaUJBQW9C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LG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzVELElBQUksaUJBQWlCLEtBQUssSUFBSSxFQUFFO1FBQzlCLE9BQU87S0FDUjtJQUNELE1BQU0saUJBQWlCLEdBQUcsb0JBQW9CLENBQUMsV0FBVyxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFDL0UsSUFBSSxpQkFBaUIsS0FBSyxJQUFJLEVBQUU7UUFDOUIsT0FBTztLQUNSO0lBQ0QsTUFBTSxlQUFlLEdBQUcsa0JBQWtCLENBQUMsV0FBVyxFQUFFLGlCQUFpQixFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFDOUYsSUFBSSxlQUFlLEtBQUssSUFBSSxFQUFFO1FBQzVCLE9BQU87S0FDUjtJQUNELE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsaUJBQWlCLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDbkcsSUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFO1FBQ3RCLE9BQU87S0FDUjtJQUNELE1BQU0sTUFBTSxHQUFHLFlBQVksQ0FBQyxpQkFBaUIsRUFBRSxpQkFBaUIsRUFBRSxlQUFlLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDOUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLEVBQUU7UUFDakQsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0tBQ25DO0lBQ0QsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQXJDRCw0Q0FxQ0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuXG5UaGlzIGZpbGUgY29udGFpbnMgY29kZSBmb3IgY3JlYXRpbmcgYW4gb3V0cHV0IGxheW91dHMgZm9yIHRyYW5zYWN0aW9ucyB0aGF0IHBhc3Mgb24gaW5zY3JpcHRpb25zLlxuXG5XaGVuIHBhc3Npbmcgb24gYW4gaW5zY3JpcHRpb24sIHdlIHdhbnQgdG8gc2F0aXNmeSBhIGZldyBjb25zdHJhaW50czpcblxuKiBBbGwgb3V0cHV0cyBzaG91bGQgYmUgbGFyZ2VyIHRoYW4gYSBtaW5pbWFsIHZhbHVlIChkdXN0IGxpbWl0KVxuKiBUaGUgc3VtIG9mIGFsbCBvdXRwdXQgdmFsdWVzIG5lZWRzIHRvIGJlIGxlc3MgdGhhbiB0aGUgaW5wdXQgdG8gY292ZXIgdGhlIHRyYW5zYWN0aW9uIGZlZS5cbiogVGhlIG91dHB1dCBjb250YWluaW5nIHRoZSBpbnNjcmlwdGlvbiBzaG91bGQgYmUgYXMgc21hbGwgYXMgcG9zc2libGUsIGJ1dCBsYXJnZSBlbm91Z2ggdG9cbiAgY29udGFpbiB0aGUgaW5zY3JpcHRpb24uXG5cblRvIGtlZXAgdGhlIGluc2NyaXB0aW9uIG91dHB1dCBzbWFsbCwgd2UgY2FuIHBhZCB0aGUgc2F0b3NoaSByYW5nZSBwcmVjZWRpbmcgYW5kIGZvbGxvd2luZyB0aGUgcmFuZ2VcbndpdGggY2hhbmdlIG91dHB1dHMsIHdoaWNoIGhhdmUgYSBtaW5pbWFsIHNpemUgYW5kIGluY3VyIGEgZmVlIGNvc3QuXG5cblxuQnJvYWRseSBzcGVha2luZywgdGhlcmUgYXJlIGZvdXIgc2NlbmFyaW9zOlxuXG4oMSkgU21hbGwgaW5zY3JpcHRpb24gaW5wdXQgdGhhdCBoYXMganVzdCBlbm91Z2ggdmFsdWUgdG8gcGF5IGZvciBmZWUgYW5kIGEgc2luZ2xlIGluc2NyaXB0aW9uXG4gICAgb3V0cHV0ICh1MCkuIE5vIHBhZGRpbmcgb3V0cHV0cy5cbiAgICDilIzilIDilIDilIDilIDilIDilIDilIDilIDilKzilIDilIDilIDilIDilIDilIDilIDilIDilJBcbiAgICDilIIgICAgICAgIOKUgiB1MCAgICAg4pSCXG4gICAg4pSCICAgICAgciDilLwgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSc4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSYXG4gICAg4pSCICAgICAgICDilIIgZmVlXG4gICAg4pSU4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSYXG5cblxuKDIpIExhcmdlIGluc2NyaXB0aW9uIGlucHV0IHdpdGggaW5zY3JpcHRpb24gY2xvc2UgdG8gc3RhcnQgb2YgaW5wdXQuXG4gICAgSW5zY3JpcHRpb24gb3V0cHV0IGZvbGxvd2VkIGJ5IGNoYW5nZSBvdXRwdXQgKHUxKSBwYWRkaW5nIHRoZSByZW1haW5pbmcgdmFsdWUuXG5cbiAgICDilIzilIDilIDilIDilIDilIDilIDilIDilIDilKzilIDilIDilIDilIDilIDilIDilIDilIDilJBcbiAgICDilIIgICAgICAgIOKUgiB1MCAgICAg4pSCXG4gICAg4pSCICAgICAgciDilLwgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSc4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSkXG4gICAg4pSCICAgICAgICDilIIgdTEgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilIIgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilIIgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilIIgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSc4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSYXG4gICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiBmZWVcbiAgICDilIIgICAgICAgIOKUglxuICAgIOKUlOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUmFxuXG5cbigzKSBMYXJnZSBpbnNjcmlwdGlvbiBpbnB1dCB3aXRoIGluc2NyaXB0aW9uIGNsb3NlIHRvIGVuZCBvZiBpbnB1dC5cbiAgICBDaGFuZ2Ugb3V0cHV0IHBhZGRpbmcgc3RhcnQgZm9sbG93ZWQgYnkgaW5zY3JpcHRpb24gb3V0cHV0LlxuXG4gICAg4pSM4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSs4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSQXG4gICAg4pSCICAgICAgICDilIIgdTAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilIIgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilIIgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilJzilIDilIDilIDilIDilIDilIDilIDilIDilKRcbiAgICDilIIgICAgICByIOKUvCAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilIIgdTEgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSc4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSYXG4gICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiBmZWVcbiAgICDilIIgICAgICAgIOKUglxuICAgIOKUlOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUmFxuXG5cbig0KSBMYXJnZSBpbnNjcmlwdGlvbiBpbnB1dCB3aXRoIGluc2NyaXB0aW9uIGluIHRoZSBtaWRkbGUuXG4gICAgSW5zY3JpcHRpb24gaW5wdXQgKHUxKSB3aXRoIHBhZGRpbmcgb24gYm90aCBzaWRlcyAodTAgYW5kIHUyKVxuXG4gICAg4pSM4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSs4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSQXG4gICAg4pSCICAgICAgICDilIIgdTAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilIIgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUnOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUpFxuICAgIOKUgiAgICAgICAg4pSCIHUxICAgICDilIJcbiAgICDilIIgICAgICByIOKUvCAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilJzilIDilIDilIDilIDilIDilIDilIDilIDilKRcbiAgICDilIIgICAgICAgIOKUgiB1MiAgICAg4pSCXG4gICAg4pSCICAgICAgICDilIIgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCICAgICAgICDilIJcbiAgICDilIIgICAgICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSCICAgICAgICDilJzilIDilIDilIDilIDilIDilIDilIDilIDilJhcbiAgICDilIIgICAgICAgIOKUglxuICAgIOKUgiAgICAgICAg4pSCIGZlZVxuICAgIOKUgiAgICAgICAg4pSCXG4gICAg4pSU4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSYXG4gKi9cblxuaW1wb3J0IHsgT3JkT3V0cHV0IH0gZnJvbSAnLi9PcmRPdXRwdXQnO1xuXG5jb25zdCBaRVJPID0gQmlnSW50KDApO1xuY29uc3QgT05FID0gQmlnSW50KDEpO1xuXG5mdW5jdGlvbiBtYXgoYTogYmlnaW50LCBiOiBiaWdpbnQpOiBiaWdpbnQge1xuICByZXR1cm4gYSA8IGIgPyBiIDogYTtcbn1cblxuZnVuY3Rpb24gbWluKGE6IGJpZ2ludCwgYjogYmlnaW50KTogYmlnaW50IHtcbiAgcmV0dXJuIGEgPCBiID8gYSA6IGI7XG59XG5cbmZ1bmN0aW9uIHN1bShhcnI6IGJpZ2ludFtdKTogYmlnaW50IHtcbiAgcmV0dXJuIGFyci5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCBaRVJPKTtcbn1cblxuLyoqXG4gKiBBIHJhbmdlIGNvbnN0cmFpbnRcbiAqL1xudHlwZSBQYXJhbWV0ZXJzPFQ+ID0ge1xuICAvKiogUGFkZGluZyBwcmVjZWRpbmcgdGhlIGluc2NyaXB0aW9uIG91dHB1dCAqL1xuICBmaXJzdENoYW5nZU91dHB1dDogVDtcbiAgLyoqIFRoZSBpbnNjcmlwdGlvbiBvdXRwdXQgdGhhdCB3aWxsIGluaGVyaXQgdGhlIGlucHV0IGluc2NyaXB0aW9uICovXG4gIGluc2NyaXB0aW9uT3V0cHV0OiBUO1xuICAvKiogUGFkZGluZyBmb2xsb3dpbmcgdGhlIGluc2NyaXB0aW9uIG91dHB1dCAqL1xuICBzZWNvbmRDaGFuZ2VPdXRwdXQ6IFQ7XG4gIC8qKiBOb3QgYSByZWFsIG91dHB1dCwgdXNlZCBvbmx5IHRvIHNpbXBsaWZ5IGNhbGN1bGF0aW9ucyAqL1xuICBmZWVPdXRwdXQ6IFQ7XG59O1xuXG4vKiogQHJldHVybiBjYW5vbmljYWwgc2VxdWVuY2Ugb2YgcGFyYW1ldGVycyAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRvQXJyYXk8VD4ocDogUGFyYW1ldGVyczxUPik6IFtULCBULCBULCBUXSB7XG4gIHJldHVybiBbcC5maXJzdENoYW5nZU91dHB1dCwgcC5pbnNjcmlwdGlvbk91dHB1dCwgcC5zZWNvbmRDaGFuZ2VPdXRwdXQsIHAuZmVlT3V0cHV0XTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvUGFyYW1ldGVyczxUPihcbiAgZmlyc3RDaGFuZ2VPdXRwdXQ6IFQsXG4gIGluc2NyaXB0aW9uT3V0cHV0OiBULFxuICBzZWNvbmRDaGFuZ2VPdXRwdXQ6IFQsXG4gIGZlZU91dHB1dDogVFxuKTogUGFyYW1ldGVyczxUPiB7XG4gIHJldHVybiB7XG4gICAgZmlyc3RDaGFuZ2VPdXRwdXQsXG4gICAgaW5zY3JpcHRpb25PdXRwdXQsXG4gICAgc2Vjb25kQ2hhbmdlT3V0cHV0LFxuICAgIGZlZU91dHB1dCxcbiAgfTtcbn1cblxuLyoqIEEgZmluaXNoZWQgb3V0cHV0IGxheW91dCAqL1xuZXhwb3J0IHR5cGUgT3V0cHV0TGF5b3V0ID0gUGFyYW1ldGVyczxiaWdpbnQ+O1xuXG4vKipcbiAqIFRyYW5zbGF0ZXMgYSBsYXlvdXQgaW50byBPcmRPdXRwdXRzLiBBYnNlbnQgb3V0cHV0cyBhcmUgc2V0IHRvIGBudWxsYC5cbiAqXG4gKiBAcGFyYW0gaW5zY3JpcHRpb25JbnB1dFxuICogQHBhcmFtIGxheW91dFxuICogQHJldHVybiBPcmRPdXRwdXRzIGZvciBsYXlvdXRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldE9yZE91dHB1dHNGb3JMYXlvdXQoXG4gIGluc2NyaXB0aW9uSW5wdXQ6IE9yZE91dHB1dCxcbiAgbGF5b3V0OiBPdXRwdXRMYXlvdXRcbik6IFBhcmFtZXRlcnM8T3JkT3V0cHV0IHwgbnVsbD4ge1xuICBjb25zdCBvdXRwdXRzID0gaW5zY3JpcHRpb25JbnB1dC5zcGxpdEFsbFdpdGhQYXJhbXModG9BcnJheShsYXlvdXQpLCB7IGV4YWN0OiB0cnVlLCBhbGxvd1plcm86IHRydWUgfSk7XG4gIGlmIChvdXRwdXRzLmxlbmd0aCAhPT0gNCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZCByZXN1bHRgKTtcbiAgfVxuICB0eXBlIFQgPSBPcmRPdXRwdXQgfCBudWxsO1xuICByZXR1cm4gdG9QYXJhbWV0ZXJzKC4uLihvdXRwdXRzIGFzIFtULCBULCBULCBUXSkpO1xufVxuXG4vKipcbiAqIEBwYXJhbSBjb25zdHJhaW50c1xuICogQHBhcmFtIGluc2NyaXB0aW9uSW5wdXRcbiAqIEBwYXJhbSBsYXlvdXRcbiAqIEByZXR1cm4gdHJ1ZSBpZmYgbGF5b3V0IHNhdGlzZmllcyBjb25zdHJhaW50c1xuICovXG5mdW5jdGlvbiBjaGVjayhjb25zdHJhaW50czogQ29uc3RyYWludHMsIGluc2NyaXB0aW9uSW5wdXQ6IE9yZE91dHB1dCwgbGF5b3V0OiBPdXRwdXRMYXlvdXQpOiBib29sZWFuIHtcbiAgaWYgKFxuICAgIChsYXlvdXQuZmlyc3RDaGFuZ2VPdXRwdXQgPT09IFpFUk8gfHwgY29uc3RyYWludHMubWluQ2hhbmdlT3V0cHV0IDw9IGxheW91dC5maXJzdENoYW5nZU91dHB1dCkgJiZcbiAgICAobGF5b3V0LnNlY29uZENoYW5nZU91dHB1dCA9PT0gWkVSTyB8fCBjb25zdHJhaW50cy5taW5DaGFuZ2VPdXRwdXQgPD0gbGF5b3V0LnNlY29uZENoYW5nZU91dHB1dCkgJiZcbiAgICBjb25zdHJhaW50cy5taW5JbnNjcmlwdGlvbk91dHB1dCA8PSBsYXlvdXQuaW5zY3JpcHRpb25PdXRwdXQgJiZcbiAgICBsYXlvdXQuaW5zY3JpcHRpb25PdXRwdXQgPD0gY29uc3RyYWludHMubWF4SW5zY3JpcHRpb25PdXRwdXQgJiZcbiAgICBnZXRGZWVGb3JPdXRwdXRzKGNvbnN0cmFpbnRzLCBbbGF5b3V0LmZpcnN0Q2hhbmdlT3V0cHV0LCBsYXlvdXQuaW5zY3JpcHRpb25PdXRwdXQsIGxheW91dC5zZWNvbmRDaGFuZ2VPdXRwdXRdKSA8PVxuICAgICAgbGF5b3V0LmZlZU91dHB1dCAmJlxuICAgIHN1bSh0b0FycmF5KGxheW91dCkpID09PSBpbnNjcmlwdGlvbklucHV0LnZhbHVlXG4gICkge1xuICAgIC8qIG1ha2Ugc3VyZSBpbnNjcmlwdGlvbiBhY3R1YWxseSBsaWVzIG9uIHRoZSBpbnNjcmlwdGlvbk91dHB1dCAqL1xuICAgIGNvbnN0IG91dHB1dHMgPSBnZXRPcmRPdXRwdXRzRm9yTGF5b3V0KGluc2NyaXB0aW9uSW5wdXQsIGxheW91dCk7XG4gICAgcmV0dXJuIG91dHB1dHMuaW5zY3JpcHRpb25PdXRwdXQ/Lm9yZGluYWxzLmxlbmd0aCA9PT0gMTtcbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cblxuLyoqXG4gKiBIaWdoLWxldmVsIGNvbnN0cmFpbnRzIGZvciBvdXRwdXQgbGF5b3V0XG4gKi9cbmV4cG9ydCB0eXBlIENvbnN0cmFpbnRzID0ge1xuICBtaW5DaGFuZ2VPdXRwdXQ6IGJpZ2ludDtcbiAgbWluSW5zY3JpcHRpb25PdXRwdXQ6IGJpZ2ludDtcbiAgbWF4SW5zY3JpcHRpb25PdXRwdXQ6IGJpZ2ludDtcbiAgZmVlRml4ZWQ6IGJpZ2ludDtcbiAgZmVlUGVyT3V0cHV0OiBiaWdpbnQ7XG4gIHNhdFBvczogYmlnaW50O1xuICB0b3RhbDogYmlnaW50O1xufTtcblxuZnVuY3Rpb24gZ2V0RmVlRm9yT3V0cHV0cyhwOiB7IGZlZVBlck91dHB1dDogYmlnaW50OyBmZWVGaXhlZDogYmlnaW50IH0sIG91dHB1dHM6IGJpZ2ludFtdKTogYmlnaW50IHtcbiAgcmV0dXJuIG91dHB1dHMucmVkdWNlKChzdW0sIG9WYWx1ZSk6IGJpZ2ludCA9PiBzdW0gKyAob1ZhbHVlID09PSBaRVJPID8gWkVSTyA6IHAuZmVlUGVyT3V0cHV0KSwgcC5mZWVGaXhlZCk7XG59XG5mdW5jdGlvbiBnZXRTdGFydENoYW5nZU91dHB1dChjOiBDb25zdHJhaW50cyk6IGJpZ2ludCB8IG51bGwge1xuICAvLyB3ZSBkb24ndCBuZWVkIGEgY2hhbmdlIHBhZGRpbmcgb3V0cHV0XG4gIGlmIChjLnNhdFBvcyA8IGMubWF4SW5zY3JpcHRpb25PdXRwdXQpIHtcbiAgICByZXR1cm4gWkVSTztcbiAgfVxuICBpZiAoYy5taW5DaGFuZ2VPdXRwdXQgPD0gYy5zYXRQb3MpIHtcbiAgICByZXR1cm4gYy5zYXRQb3M7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGdldEluc2NyaXB0aW9uT3V0cHV0KGM6IENvbnN0cmFpbnRzLCBzdGFydENoYW5nZU91dHB1dDogYmlnaW50KTogYmlnaW50IHwgbnVsbCB7XG4gIGNvbnN0IHJlc3VsdCA9IG1pbihjLm1heEluc2NyaXB0aW9uT3V0cHV0LCBtYXgoYy5taW5JbnNjcmlwdGlvbk91dHB1dCwgYy5zYXRQb3MgLSBzdGFydENoYW5nZU91dHB1dCArIE9ORSkpO1xuICBpZiAoYy5zYXRQb3MgPCBzdGFydENoYW5nZU91dHB1dCB8fCBzdGFydENoYW5nZU91dHB1dCArIHJlc3VsdCA8IGMuc2F0UG9zKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgLy8gaWYgaXMgbm90IHdvcnRoIGNyZWF0aW5nIGFuIGVuZCBjaGFuZ2Ugb3V0cHV0LCBsZXQncyBtYXhpbWl6ZSB0aGUgaW5zY3JpcHRpb24gb3V0cHV0XG4gIGlmIChnZXRFbmRDaGFuZ2VPdXRwdXQoYywgc3RhcnRDaGFuZ2VPdXRwdXQsIHJlc3VsdCkgPT09IFpFUk8pIHtcbiAgICBjb25zdCByZW1haW5kZXIgPSBjLnRvdGFsIC0gc3RhcnRDaGFuZ2VPdXRwdXQgLSBnZXRGZWVGb3JPdXRwdXRzKGMsIFtzdGFydENoYW5nZU91dHB1dCwgcmVzdWx0XSk7XG4gICAgcmV0dXJuIG1pbihyZW1haW5kZXIsIGMubWF4SW5zY3JpcHRpb25PdXRwdXQpO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIGdldEVuZENoYW5nZU91dHB1dChjOiBDb25zdHJhaW50cywgc3RhcnRDaGFuZ2VPdXRwdXQ6IGJpZ2ludCwgaW5zY3JpcHRpb25PdXRwdXQ6IGJpZ2ludCk6IGJpZ2ludCB8IG51bGwge1xuICBjb25zdCByZW1haW5kZXIgPSBjLnRvdGFsIC0gc3VtKFtzdGFydENoYW5nZU91dHB1dCwgaW5zY3JpcHRpb25PdXRwdXRdKTtcbiAgY29uc3QgbWluRmVlV2l0aG91dFNlY29uZE91dHB1dCA9IGdldEZlZUZvck91dHB1dHMoYywgW3N0YXJ0Q2hhbmdlT3V0cHV0LCBpbnNjcmlwdGlvbk91dHB1dF0pO1xuICBjb25zdCBtaW5GZWVXaXRoU2Vjb25kT3V0cHV0ID0gZ2V0RmVlRm9yT3V0cHV0cyhjLCBbc3RhcnRDaGFuZ2VPdXRwdXQsIGluc2NyaXB0aW9uT3V0cHV0LCBjLm1pbkNoYW5nZU91dHB1dF0pO1xuICBpZiAocmVtYWluZGVyIDwgbWluRmVlV2l0aG91dFNlY29uZE91dHB1dCkge1xuICAgIC8vIFdlIGNhbm5vdCBldmVuIHBheSB0aGUgZmVlIGZvciB0aGUgb3V0cHV0KHMpIHdlIGhhdmUgc28gZmFyLlxuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGlmIChyZW1haW5kZXIgLSBtaW5GZWVXaXRoU2Vjb25kT3V0cHV0IDwgYy5taW5DaGFuZ2VPdXRwdXQpIHtcbiAgICAvLyBUaGUgcmVtYWluZGVyIGlzIHRvbyBzbWFsbCB0byBwYXkgZm9yIHRoZSBlbmQgY2hhbmdlIG91dHB1dC4gTGV0J3Mgc2tpcCBpdCBhbmQgcGF5IGEgaGlnaGVyIGZlZS5cbiAgICByZXR1cm4gWkVSTztcbiAgfVxuICAvLyBsZXQncyB1c2UgYXMgbXVjaCBhcyB3ZSBjYW4gZm9yIGZlZSB3aGlsZSBsZWF2aW5nIGVub3VnaCBmb3IgZmVlXG4gIHJldHVybiByZW1haW5kZXIgLSBtaW5GZWVXaXRoU2Vjb25kT3V0cHV0O1xufVxuXG5mdW5jdGlvbiBnZXRGZWVPdXRwdXQoXG4gIGM6IENvbnN0cmFpbnRzLFxuICBzdGFydENoYW5nZU91dHB1dDogYmlnaW50LFxuICBpbnNjcmlwdGlvbk91dHB1dDogYmlnaW50LFxuICBlbmRDaGFuZ2VPdXRwdXQ6IGJpZ2ludFxuKTogYmlnaW50IHwgbnVsbCB7XG4gIGNvbnN0IG1pbkZlZSA9IGdldEZlZUZvck91dHB1dHMoYywgW3N0YXJ0Q2hhbmdlT3V0cHV0LCBpbnNjcmlwdGlvbk91dHB1dCwgZW5kQ2hhbmdlT3V0cHV0XSk7XG4gIGNvbnN0IHJlbWFpbmRlciA9IGMudG90YWwgLSBzdW0oW3N0YXJ0Q2hhbmdlT3V0cHV0LCBpbnNjcmlwdGlvbk91dHB1dCwgZW5kQ2hhbmdlT3V0cHV0XSk7XG4gIGlmIChyZW1haW5kZXIgPCBtaW5GZWUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gcmVtYWluZGVyO1xufVxuXG4vKipcbiAqIEBwYXJhbSBpbnNjcmlwdGlvbklucHV0XG4gKiBAcGFyYW0gc2VhcmNoXG4gKiBAcmV0dXJuIGEgc29sdXRpb24gdGhhdCBzYXRpc2ZpZXMgY29uc3RyYWludHMuIElmIG5vIHNvbHV0aW9uIGNhbiBiZSBmb3VuZCwgcmV0dXJuIGB1bmRlZmluZWRgLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZmluZE91dHB1dExheW91dChcbiAgaW5zY3JpcHRpb25JbnB1dDogT3JkT3V0cHV0LFxuICBzZWFyY2g6IE9taXQ8Q29uc3RyYWludHMsICdzYXRQb3MnIHwgJ3RvdGFsJz5cbik6IE91dHB1dExheW91dCB8IHVuZGVmaW5lZCB7XG4gIGlmIChpbnNjcmlwdGlvbklucHV0Lm9yZGluYWxzLmxlbmd0aCAhPT0gMSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZCBvcmRpbmFsIGNvdW50ICR7aW5zY3JpcHRpb25JbnB1dC5vcmRpbmFscy5sZW5ndGh9YCk7XG4gIH1cbiAgaWYgKGluc2NyaXB0aW9uSW5wdXQub3JkaW5hbHNbMF0uc2l6ZSgpICE9PSBPTkUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYG9ubHkgc2luZ2xlLXNhdG9zaGkgaW5zY3JpcHRpb25zIGFyZSBzdXBwb3J0ZWRgKTtcbiAgfVxuXG4gIGNvbnN0IHNhdFBvcyA9IGluc2NyaXB0aW9uSW5wdXQub3JkaW5hbHNbMF0uc3RhcnQ7XG4gIGNvbnN0IHRvdGFsID0gaW5zY3JpcHRpb25JbnB1dC52YWx1ZTtcblxuICBjb25zdCBjb25zdHJhaW50czogQ29uc3RyYWludHMgPSB7IC4uLnNlYXJjaCwgc2F0UG9zLCB0b3RhbCB9O1xuXG4gIGNvbnN0IHN0YXJ0Q2hhbmdlT3V0cHV0ID0gZ2V0U3RhcnRDaGFuZ2VPdXRwdXQoY29uc3RyYWludHMpO1xuICBpZiAoc3RhcnRDaGFuZ2VPdXRwdXQgPT09IG51bGwpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgaW5zY3JpcHRpb25PdXRwdXQgPSBnZXRJbnNjcmlwdGlvbk91dHB1dChjb25zdHJhaW50cywgc3RhcnRDaGFuZ2VPdXRwdXQpO1xuICBpZiAoaW5zY3JpcHRpb25PdXRwdXQgPT09IG51bGwpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgZW5kQ2hhbmdlT3V0cHV0ID0gZ2V0RW5kQ2hhbmdlT3V0cHV0KGNvbnN0cmFpbnRzLCBzdGFydENoYW5nZU91dHB1dCwgaW5zY3JpcHRpb25PdXRwdXQpO1xuICBpZiAoZW5kQ2hhbmdlT3V0cHV0ID09PSBudWxsKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IGZlZU91dHB1dCA9IGdldEZlZU91dHB1dChjb25zdHJhaW50cywgc3RhcnRDaGFuZ2VPdXRwdXQsIGluc2NyaXB0aW9uT3V0cHV0LCBlbmRDaGFuZ2VPdXRwdXQpO1xuICBpZiAoZmVlT3V0cHV0ID09PSBudWxsKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IHJlc3VsdCA9IHRvUGFyYW1ldGVycyhzdGFydENoYW5nZU91dHB1dCwgaW5zY3JpcHRpb25PdXRwdXQsIGVuZENoYW5nZU91dHB1dCwgZmVlT3V0cHV0KTtcbiAgaWYgKCFjaGVjayhjb25zdHJhaW50cywgaW5zY3JpcHRpb25JbnB1dCwgcmVzdWx0KSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCByZXN1bHRgKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuIl19