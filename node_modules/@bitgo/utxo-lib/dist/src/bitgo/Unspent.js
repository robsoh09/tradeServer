"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.unspentSum = exports.addToTransactionBuilder = exports.toPrevOutputWithPrevTx = exports.toPrevOutput = exports.getOutputIdForInput = exports.formatOutputId = exports.parseOutputId = exports.fromOutputWithPrevTx = exports.fromOutput = exports.toOutput = exports.isUnspentWithPrevTx = void 0;
const address_1 = require("../address");
function isUnspentWithPrevTx(u) {
    return Buffer.isBuffer(u.prevTx);
}
exports.isUnspentWithPrevTx = isUnspentWithPrevTx;
/**
 * @return TxOutput from Unspent
 */
function toOutput(u, network) {
    return {
        script: (0, address_1.toOutputScript)(u.address, network),
        value: u.value,
    };
}
exports.toOutput = toOutput;
/**
 * @return Unspent from TxOutput
 */
function fromOutput(tx, vout) {
    const o = tx.outs[vout];
    if (!o) {
        throw new Error(`invalid vout`);
    }
    return {
        id: formatOutputId({ txid: tx.getId(), vout }),
        address: (0, address_1.fromOutputScript)(o.script, tx.network),
        value: o.value,
    };
}
exports.fromOutput = fromOutput;
function fromOutputWithPrevTx(tx, vout) {
    return {
        ...fromOutput(tx, vout),
        prevTx: tx.toBuffer(),
    };
}
exports.fromOutputWithPrevTx = fromOutputWithPrevTx;
/**
 * @param outputId
 * @return TxOutPoint
 */
function parseOutputId(outputId) {
    const parts = outputId.split(':');
    if (parts.length !== 2) {
        throw new Error(`invalid outputId, must have format txid:vout`);
    }
    const [txid, voutStr] = parts;
    const vout = Number(voutStr);
    if (txid.length !== 64) {
        throw new Error(`invalid txid ${txid} ${txid.length}`);
    }
    if (Number.isNaN(vout) || vout < 0 || !Number.isSafeInteger(vout)) {
        throw new Error(`invalid vout: must be integer >= 0`);
    }
    return { txid, vout };
}
exports.parseOutputId = parseOutputId;
/**
 * @param txid
 * @param vout
 * @return outputId
 */
function formatOutputId({ txid, vout }) {
    return `${txid}:${vout}`;
}
exports.formatOutputId = formatOutputId;
function getOutputIdForInput(i) {
    return {
        txid: Buffer.from(i.hash).reverse().toString('hex'),
        vout: i.index,
    };
}
exports.getOutputIdForInput = getOutputIdForInput;
/**
 * @return PrevOutput from Unspent
 */
function toPrevOutput(u, network) {
    return {
        ...parseOutputId(u.id),
        ...toOutput(u, network),
    };
}
exports.toPrevOutput = toPrevOutput;
/**
 * @return PrevOutput with prevTx from Unspent
 */
function toPrevOutputWithPrevTx(u, network) {
    let prevTx;
    if (typeof u.prevTx === 'string') {
        prevTx = Buffer.from(u.prevTx, 'hex');
    }
    else if (Buffer.isBuffer(u.prevTx)) {
        prevTx = u.prevTx;
    }
    else if (u.prevTx !== undefined) {
        throw new Error(`Invalid prevTx type for unspent ${u.prevTx}`);
    }
    return {
        ...parseOutputId(u.id),
        ...toOutput(u, network),
        prevTx,
    };
}
exports.toPrevOutputWithPrevTx = toPrevOutputWithPrevTx;
/**
 * @param txb
 * @param u
 * @param sequence - sequenceId
 */
function addToTransactionBuilder(txb, u, sequence) {
    const { txid, vout, script, value } = toPrevOutput(u, txb.network);
    txb.addInput(txid, vout, sequence, script, value);
}
exports.addToTransactionBuilder = addToTransactionBuilder;
/**
 * Sum the values of the unspents.
 * Throws error if sum is not a safe integer value, or if unspent amount types do not match `amountType`
 * @param unspents - array of unspents to sum
 * @param amountType - expected value type of unspents
 * @return unspentSum - type matches amountType
 */
function unspentSum(unspents, amountType = 'number') {
    if (amountType === 'bigint') {
        return unspents.reduce((sum, u) => sum + u.value, BigInt(0));
    }
    else {
        const sum = unspents.reduce((sum, u) => sum + u.value, Number(0));
        if (!Number.isSafeInteger(sum)) {
            throw new Error('unspent sum is not a safe integer number, consider using bigint');
        }
        return sum;
    }
}
exports.unspentSum = unspentSum;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVW5zcGVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9iaXRnby9VbnNwZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLHdDQUE4RDtBQTRCOUQsU0FBZ0IsbUJBQW1CLENBQ2pDLENBQW1CO0lBRW5CLE9BQU8sTUFBTSxDQUFDLFFBQVEsQ0FBRSxDQUFnQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ25FLENBQUM7QUFKRCxrREFJQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IsUUFBUSxDQUFrQyxDQUFtQixFQUFFLE9BQWdCO0lBQzdGLE9BQU87UUFDTCxNQUFNLEVBQUUsSUFBQSx3QkFBYyxFQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDO1FBQzFDLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSztLQUNmLENBQUM7QUFDSixDQUFDO0FBTEQsNEJBS0M7QUFFRDs7R0FFRztBQUNILFNBQWdCLFVBQVUsQ0FDeEIsRUFBNEIsRUFDNUIsSUFBWTtJQUVaLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEIsSUFBSSxDQUFDLENBQUMsRUFBRTtRQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUM7S0FDakM7SUFDRCxPQUFPO1FBQ0wsRUFBRSxFQUFFLGNBQWMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDOUMsT0FBTyxFQUFFLElBQUEsMEJBQWdCLEVBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDO1FBQy9DLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSztLQUNmLENBQUM7QUFDSixDQUFDO0FBYkQsZ0NBYUM7QUFFRCxTQUFnQixvQkFBb0IsQ0FDbEMsRUFBNEIsRUFDNUIsSUFBWTtJQUVaLE9BQU87UUFDTCxHQUFHLFVBQVUsQ0FBQyxF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aUI7SUFFakIsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLFlBQVksQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLE9BQWtCLENBQUMsQ0FBQztJQUM5RSxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNwRCxDQUFDO0FBUEQsMERBT0M7QUFFRDs7Ozs7O0dBTUc7QUFDSCxTQUFnQixVQUFVLENBQ3hCLFFBQThCLEVBQzlCLGFBQWtDLFFBQVE7SUFFMUMsSUFBSSxVQUFVLEtBQUssUUFBUSxFQUFFO1FBQzNCLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBSSxDQUFDLENBQUMsS0FBZ0IsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQVksQ0FBQztLQUNyRjtTQUFNO1FBQ0wsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBSSxDQUFDLENBQUMsS0FBZ0IsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5RSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLGlFQUFpRSxDQUFDLENBQUM7U0FDcEY7UUFDRCxPQUFPLEdBQWMsQ0FBQztLQUN2QjtBQUNILENBQUM7QUFiRCxnQ0FhQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFR4T3V0cHV0IH0gZnJvbSAnYml0Y29pbmpzLWxpYic7XG5pbXBvcnQgeyBOZXR3b3JrIH0gZnJvbSAnLi4nO1xuaW1wb3J0IHsgZnJvbU91dHB1dFNjcmlwdCwgdG9PdXRwdXRTY3JpcHQgfSBmcm9tICcuLi9hZGRyZXNzJztcbmltcG9ydCB7IFV0eG9UcmFuc2FjdGlvbkJ1aWxkZXIgfSBmcm9tICcuL1V0eG9UcmFuc2FjdGlvbkJ1aWxkZXInO1xuaW1wb3J0IHsgVXR4b1RyYW5zYWN0aW9uIH0gZnJvbSAnLi9VdHhvVHJhbnNhY3Rpb24nO1xuXG4vKipcbiAqIFB1YmxpYyB1bnNwZW50IGRhdGEgaW4gQml0R28tc3BlY2lmaWMgcmVwcmVzZW50YXRpb24uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVW5zcGVudDxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50ID0gbnVtYmVyPiB7XG4gIC8qKlxuICAgKiBGb3JtYXQ6ICR7dHhpZH06JHt2b3V0fS5cbiAgICogVXNlIGBwYXJzZU91dHB1dElkKGlkKWAgdG8gcGFyc2UuXG4gICAqL1xuICBpZDogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIG5ldHdvcmstc3BlY2lmaWMgZW5jb2RlZCBhZGRyZXNzLlxuICAgKiBVc2UgYHRvT3V0cHV0U2NyaXB0KGFkZHJlc3MsIG5ldHdvcmspYCB0byBvYnRhaW4gc2NyaXB0UHViS2V5LlxuICAgKi9cbiAgYWRkcmVzczogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIGFtb3VudCBpbiBzYXRvc2hpLlxuICAgKi9cbiAgdmFsdWU6IFROdW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVW5zcGVudFdpdGhQcmV2VHg8VE51bWJlciBleHRlbmRzIG51bWJlciB8IGJpZ2ludCA9IG51bWJlcj4gZXh0ZW5kcyBVbnNwZW50PFROdW1iZXI+IHtcbiAgcHJldlR4OiBCdWZmZXI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1Vuc3BlbnRXaXRoUHJldlR4PFROdW1iZXIgZXh0ZW5kcyBudW1iZXIgfCBiaWdpbnQsIFRVbnNwZW50IGV4dGVuZHMgVW5zcGVudDxUTnVtYmVyPj4oXG4gIHU6IFVuc3BlbnQ8VE51bWJlcj5cbik6IHUgaXMgVFVuc3BlbnQgJiB7IHByZXZUeDogQnVmZmVyIH0ge1xuICByZXR1cm4gQnVmZmVyLmlzQnVmZmVyKCh1IGFzIFVuc3BlbnRXaXRoUHJldlR4PFROdW1iZXI+KS5wcmV2VHgpO1xufVxuXG4vKipcbiAqIEByZXR1cm4gVHhPdXRwdXQgZnJvbSBVbnNwZW50XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0b091dHB1dDxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50Pih1OiBVbnNwZW50PFROdW1iZXI+LCBuZXR3b3JrOiBOZXR3b3JrKTogVHhPdXRwdXQ8VE51bWJlcj4ge1xuICByZXR1cm4ge1xuICAgIHNjcmlwdDogdG9PdXRwdXRTY3JpcHQodS5hZGRyZXNzLCBuZXR3b3JrKSxcbiAgICB2YWx1ZTogdS52YWx1ZSxcbiAgfTtcbn1cblxuLyoqXG4gKiBAcmV0dXJuIFVuc3BlbnQgZnJvbSBUeE91dHB1dFxuICovXG5leHBvcnQgZnVuY3Rpb24gZnJvbU91dHB1dDxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50PihcbiAgdHg6IFV0eG9UcmFuc2FjdGlvbjxUTnVtYmVyPixcbiAgdm91dDogbnVtYmVyXG4pOiBVbnNwZW50PFROdW1iZXI+IHtcbiAgY29uc3QgbyA9IHR4Lm91dHNbdm91dF07XG4gIGlmICghbykge1xuICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCB2b3V0YCk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBpZDogZm9ybWF0T3V0cHV0SWQoeyB0eGlkOiB0eC5nZXRJZCgpLCB2b3V0IH0pLFxuICAgIGFkZHJlc3M6IGZyb21PdXRwdXRTY3JpcHQoby5zY3JpcHQsIHR4Lm5ldHdvcmspLFxuICAgIHZhbHVlOiBvLnZhbHVlLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZnJvbU91dHB1dFdpdGhQcmV2VHg8VE51bWJlciBleHRlbmRzIG51bWJlciB8IGJpZ2ludD4oXG4gIHR4OiBVdHhvVHJhbnNhY3Rpb248VE51bWJlcj4sXG4gIHZvdXQ6IG51bWJlclxuKTogVW5zcGVudFdpdGhQcmV2VHg8VE51bWJlcj4ge1xuICByZXR1cm4ge1xuICAgIC4uLmZyb21PdXRwdXQodHgsIHZvdXQpLFxuICAgIHByZXZUeDogdHgudG9CdWZmZXIoKSxcbiAgfTtcbn1cblxuLyoqXG4gKiBAcGFyYW0gb3V0cHV0SWRcbiAqIEByZXR1cm4gVHhPdXRQb2ludFxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VPdXRwdXRJZChvdXRwdXRJZDogc3RyaW5nKTogVHhPdXRQb2ludCB7XG4gIGNvbnN0IHBhcnRzID0gb3V0cHV0SWQuc3BsaXQoJzonKTtcbiAgaWYgKHBhcnRzLmxlbmd0aCAhPT0gMikge1xuICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBvdXRwdXRJZCwgbXVzdCBoYXZlIGZvcm1hdCB0eGlkOnZvdXRgKTtcbiAgfVxuICBjb25zdCBbdHhpZCwgdm91dFN0cl0gPSBwYXJ0cztcbiAgY29uc3Qgdm91dCA9IE51bWJlcih2b3V0U3RyKTtcbiAgaWYgKHR4aWQubGVuZ3RoICE9PSA2NCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCB0eGlkICR7dHhpZH0gJHt0eGlkLmxlbmd0aH1gKTtcbiAgfVxuICBpZiAoTnVtYmVyLmlzTmFOKHZvdXQpIHx8IHZvdXQgPCAwIHx8ICFOdW1iZXIuaXNTYWZlSW50ZWdlcih2b3V0KSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCB2b3V0OiBtdXN0IGJlIGludGVnZXIgPj0gMGApO1xuICB9XG4gIHJldHVybiB7IHR4aWQsIHZvdXQgfTtcbn1cblxuLyoqXG4gKiBAcGFyYW0gdHhpZFxuICogQHBhcmFtIHZvdXRcbiAqIEByZXR1cm4gb3V0cHV0SWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdE91dHB1dElkKHsgdHhpZCwgdm91dCB9OiBUeE91dFBvaW50KTogc3RyaW5nIHtcbiAgcmV0dXJuIGAke3R4aWR9OiR7dm91dH1gO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0T3V0cHV0SWRGb3JJbnB1dChpOiB7IGhhc2g6IEJ1ZmZlcjsgaW5kZXg6IG51bWJlciB9KTogVHhPdXRQb2ludCB7XG4gIHJldHVybiB7XG4gICAgdHhpZDogQnVmZmVyLmZyb20oaS5oYXNoKS5yZXZlcnNlKCkudG9TdHJpbmcoJ2hleCcpLFxuICAgIHZvdXQ6IGkuaW5kZXgsXG4gIH07XG59XG5cbi8qKlxuICogUmVmZXJlbmNlIHRvIG91dHB1dCBvZiBhbiBleGlzdGluZyB0cmFuc2FjdGlvblxuICovXG5leHBvcnQgdHlwZSBUeE91dFBvaW50ID0ge1xuICB0eGlkOiBzdHJpbmc7XG4gIHZvdXQ6IG51bWJlcjtcbn07XG5cbi8qKlxuICogT3V0cHV0IHJlZmVyZW5jZSBhbmQgc2NyaXB0IGRhdGEuXG4gKiBTdWl0YWJsZSBmb3IgdXNlIGZvciBgdHhiLmFkZElucHV0KClgXG4gKi9cbmV4cG9ydCB0eXBlIFByZXZPdXRwdXQ8VE51bWJlciBleHRlbmRzIG51bWJlciB8IGJpZ2ludCA9IG51bWJlcj4gPSBUeE91dFBvaW50ICZcbiAgVHhPdXRwdXQ8VE51bWJlcj4gJiB7XG4gICAgcHJldlR4PzogQnVmZmVyO1xuICB9O1xuXG4vKipcbiAqIEByZXR1cm4gUHJldk91dHB1dCBmcm9tIFVuc3BlbnRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRvUHJldk91dHB1dDxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50PihcbiAgdTogVW5zcGVudDxUTnVtYmVyPixcbiAgbmV0d29yazogTmV0d29ya1xuKTogUHJldk91dHB1dDxUTnVtYmVyPiB7XG4gIHJldHVybiB7XG4gICAgLi4ucGFyc2VPdXRwdXRJZCh1LmlkKSxcbiAgICAuLi50b091dHB1dCh1LCBuZXR3b3JrKSxcbiAgfTtcbn1cblxuLyoqXG4gKiBAcmV0dXJuIFByZXZPdXRwdXQgd2l0aCBwcmV2VHggZnJvbSBVbnNwZW50XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0b1ByZXZPdXRwdXRXaXRoUHJldlR4PFROdW1iZXIgZXh0ZW5kcyBudW1iZXIgfCBiaWdpbnQ+KFxuICB1OiBVbnNwZW50PFROdW1iZXI+ICYgeyBwcmV2VHg/OiB1bmtub3duIH0sXG4gIG5ldHdvcms6IE5ldHdvcmtcbik6IFByZXZPdXRwdXQ8VE51bWJlcj4ge1xuICBsZXQgcHJldlR4O1xuICBpZiAodHlwZW9mIHUucHJldlR4ID09PSAnc3RyaW5nJykge1xuICAgIHByZXZUeCA9IEJ1ZmZlci5mcm9tKHUucHJldlR4LCAnaGV4Jyk7XG4gIH0gZWxzZSBpZiAoQnVmZmVyLmlzQnVmZmVyKHUucHJldlR4KSkge1xuICAgIHByZXZUeCA9IHUucHJldlR4O1xuICB9IGVsc2UgaWYgKHUucHJldlR4ICE9PSB1bmRlZmluZWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcHJldlR4IHR5cGUgZm9yIHVuc3BlbnQgJHt1LnByZXZUeH1gKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIC4uLnBhcnNlT3V0cHV0SWQodS5pZCksXG4gICAgLi4udG9PdXRwdXQodSwgbmV0d29yayksXG4gICAgcHJldlR4LFxuICB9O1xufVxuXG4vKipcbiAqIEBwYXJhbSB0eGJcbiAqIEBwYXJhbSB1XG4gKiBAcGFyYW0gc2VxdWVuY2UgLSBzZXF1ZW5jZUlkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhZGRUb1RyYW5zYWN0aW9uQnVpbGRlcjxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50PihcbiAgdHhiOiBVdHhvVHJhbnNhY3Rpb25CdWlsZGVyPFROdW1iZXI+LFxuICB1OiBVbnNwZW50PFROdW1iZXI+LFxuICBzZXF1ZW5jZT86IG51bWJlclxuKTogdm9pZCB7XG4gIGNvbnN0IHsgdHhpZCwgdm91dCwgc2NyaXB0LCB2YWx1ZSB9ID0gdG9QcmV2T3V0cHV0KHUsIHR4Yi5uZXR3b3JrIGFzIE5ldHdvcmspO1xuICB0eGIuYWRkSW5wdXQodHhpZCwgdm91dCwgc2VxdWVuY2UsIHNjcmlwdCwgdmFsdWUpO1xufVxuXG4vKipcbiAqIFN1bSB0aGUgdmFsdWVzIG9mIHRoZSB1bnNwZW50cy5cbiAqIFRocm93cyBlcnJvciBpZiBzdW0gaXMgbm90IGEgc2FmZSBpbnRlZ2VyIHZhbHVlLCBvciBpZiB1bnNwZW50IGFtb3VudCB0eXBlcyBkbyBub3QgbWF0Y2ggYGFtb3VudFR5cGVgXG4gKiBAcGFyYW0gdW5zcGVudHMgLSBhcnJheSBvZiB1bnNwZW50cyB0byBzdW1cbiAqIEBwYXJhbSBhbW91bnRUeXBlIC0gZXhwZWN0ZWQgdmFsdWUgdHlwZSBvZiB1bnNwZW50c1xuICogQHJldHVybiB1bnNwZW50U3VtIC0gdHlwZSBtYXRjaGVzIGFtb3VudFR5cGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVuc3BlbnRTdW08VE51bWJlciBleHRlbmRzIG51bWJlciB8IGJpZ2ludD4oXG4gIHVuc3BlbnRzOiB7IHZhbHVlOiBUTnVtYmVyIH1bXSxcbiAgYW1vdW50VHlwZTogJ251bWJlcicgfCAnYmlnaW50JyA9ICdudW1iZXInXG4pOiBUTnVtYmVyIHtcbiAgaWYgKGFtb3VudFR5cGUgPT09ICdiaWdpbnQnKSB7XG4gICAgcmV0dXJuIHVuc3BlbnRzLnJlZHVjZSgoc3VtLCB1KSA9PiBzdW0gKyAodS52YWx1ZSBhcyBiaWdpbnQpLCBCaWdJbnQoMCkpIGFzIFROdW1iZXI7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc3VtID0gdW5zcGVudHMucmVkdWNlKChzdW0sIHUpID0+IHN1bSArICh1LnZhbHVlIGFzIG51bWJlciksIE51bWJlcigwKSk7XG4gICAgaWYgKCFOdW1iZXIuaXNTYWZlSW50ZWdlcihzdW0pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Vuc3BlbnQgc3VtIGlzIG5vdCBhIHNhZmUgaW50ZWdlciBudW1iZXIsIGNvbnNpZGVyIHVzaW5nIGJpZ2ludCcpO1xuICAgIH1cbiAgICByZXR1cm4gc3VtIGFzIFROdW1iZXI7XG4gIH1cbn1cbiJdfQ==