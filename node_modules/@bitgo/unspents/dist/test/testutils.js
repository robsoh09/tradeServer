"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSignedTransaction = exports.constructPsbt = exports.getOutputDimensionsForUnspentType = exports.getInputDimensionsForUnspentType = exports.getInputScriptTypes = exports.UnspentTypeOpReturn = exports.UnspentTypePubKeyHash = exports.UnspentTypeScript2of3 = exports.UnspentTypeP2shP2pk = void 0;
const unspents = __importStar(require("../src"));
const utxolib = __importStar(require("@bitgo/utxo-lib"));
const assert_1 = __importDefault(require("assert"));
const txGen_1 = require("./signedTx/txGen");
/**
 * makeEnum('a', 'b') returns `{ a: 'a', b: 'b' }`
 *
 * @param args
 * @return map with string keys and symbol values
 */
const makeEnum = (...args) => args.reduce((obj, key) => Object.assign(obj, { [key]: key }), {});
exports.UnspentTypeP2shP2pk = 'p2shP2pk';
// p2trMusig2 is assumed to be script path only. taprootKeyPathSpend is for p2trMusig2 key path
exports.UnspentTypeScript2of3 = makeEnum('p2sh', 'p2shP2wsh', 'p2wsh', 'p2tr', 'p2trMusig2', 'taprootKeyPathSpend');
exports.UnspentTypePubKeyHash = makeEnum('p2pkh', 'p2wpkh');
class UnspentTypeOpReturn {
    constructor(size) {
        this.size = size;
    }
    toString() {
        return `opReturn(${this.size})`;
    }
}
exports.UnspentTypeOpReturn = UnspentTypeOpReturn;
function getInputScriptTypes() {
    return [...utxolib.bitgo.outputScripts.scriptTypes2Of3, 'p2shP2pk', 'taprootKeyPathSpend'];
}
exports.getInputScriptTypes = getInputScriptTypes;
/**
 * Return the input dimensions based on unspent type
 * @param unspentType - one of UnspentTypeScript2of3
 * @return Dimensions
 */
const getInputDimensionsForUnspentType = (unspentType) => {
    switch (unspentType) {
        case exports.UnspentTypeScript2of3.p2sh:
            return unspents.Dimensions.sum({ nP2shInputs: 1 });
        case exports.UnspentTypeScript2of3.p2shP2wsh:
            return unspents.Dimensions.sum({ nP2shP2wshInputs: 1 });
        case exports.UnspentTypeScript2of3.p2wsh:
            return unspents.Dimensions.sum({ nP2wshInputs: 1 });
        case exports.UnspentTypeScript2of3.p2tr:
        case exports.UnspentTypeScript2of3.p2trMusig2:
            return unspents.Dimensions.sum({ nP2trScriptPathLevel1Inputs: 1 });
        case exports.UnspentTypeScript2of3.taprootKeyPathSpend:
            return unspents.Dimensions.sum({ nP2trKeypathInputs: 1 });
        case exports.UnspentTypeP2shP2pk:
            return unspents.Dimensions.sum({ nP2shP2pkInputs: 1 });
    }
    throw new Error(`no input dimensions for ${unspentType}`);
};
exports.getInputDimensionsForUnspentType = getInputDimensionsForUnspentType;
const getOutputDimensionsForUnspentType = (unspentType) => {
    /* The values here are validated in the test 'calculates output dimensions dynamically' */
    switch (unspentType) {
        case exports.UnspentTypeScript2of3.p2sh:
        case exports.UnspentTypeScript2of3.p2shP2wsh:
        case exports.UnspentTypeP2shP2pk:
            return unspents.Dimensions.fromOutputScriptLength(23);
        case exports.UnspentTypeScript2of3.p2wsh:
            return unspents.Dimensions.fromOutputScriptLength(34);
        case exports.UnspentTypeScript2of3.p2tr:
        case exports.UnspentTypeScript2of3.p2trMusig2:
        case exports.UnspentTypeScript2of3.taprootKeyPathSpend:
            return unspents.Dimensions.fromOutputScriptLength(34);
        case exports.UnspentTypePubKeyHash.p2pkh:
            return unspents.Dimensions.fromOutputScriptLength(25);
        case exports.UnspentTypePubKeyHash.p2wpkh:
            return unspents.Dimensions.fromOutputScriptLength(22);
        default:
            if (unspentType instanceof UnspentTypeOpReturn) {
                return unspents.Dimensions.fromOutputScriptLength(1 + unspentType.size);
            }
            throw new TypeError(`unknown unspentType ${unspentType}`);
    }
};
exports.getOutputDimensionsForUnspentType = getOutputDimensionsForUnspentType;
function getDefaultSignerNames(inputType, signers) {
    if (signers) {
        return [signers.signerName, signers.cosignerName];
    }
    if (inputType === 'p2shP2pk') {
        return ['user'];
    }
    if (inputType === 'p2trMusig2') {
        return ['user', 'backup'];
    }
    return ['user', 'bitgo'];
}
function constructPsbt(keys, inputTypes, outputTypes, signatureStatus, signers) {
    const psbt = utxolib.bitgo.createPsbtForNetwork({ network: utxolib.networks.bitcoin });
    inputTypes.forEach((t, i) => {
        if (t === 'p2shP2pk') {
            const signer = keys[getDefaultSignerNames(t, signers)[0]];
            const unspent = utxolib.testutil.mockReplayProtectionUnspent(utxolib.networks.bitcoin, BigInt(10), {
                key: signer,
                vout: i,
            });
            const { redeemScript } = utxolib.bitgo.outputScripts.createOutputScriptP2shP2pk(signer.publicKey);
            assert_1.default.ok(redeemScript);
            utxolib.bitgo.addReplayProtectionUnspentToPsbt(psbt, unspent, redeemScript);
        }
        else {
            const unspent = utxolib.testutil.mockWalletUnspent(utxolib.networks.bitcoin, BigInt(10), {
                keys,
                chain: utxolib.bitgo.getExternalChainCode(t === 'taprootKeyPathSpend' ? 'p2trMusig2' : t),
                vout: i,
                index: i,
            });
            const signerNames = getDefaultSignerNames(t, signers);
            utxolib.bitgo.addWalletUnspentToPsbt(psbt, unspent, keys, signerNames[0], signerNames[1]);
        }
    });
    outputTypes.forEach((t, index) => {
        psbt.addOutput({
            script: (0, txGen_1.createScriptPubKey)(keys.triple, t),
            value: BigInt(10),
        });
    });
    if (signatureStatus === 'unsigned') {
        return psbt;
    }
    psbt.setAllInputsMusig2NonceHD(keys['user']);
    psbt.setAllInputsMusig2NonceHD(keys['bitgo']);
    inputTypes.forEach((t, i) => {
        const signerNames = getDefaultSignerNames(t, signers);
        if (t === 'p2shP2pk') {
            if (signatureStatus === 'fullysigned') {
                psbt.signInput(i, keys[signerNames[0]]);
            }
        }
        else {
            psbt.signInputHD(i, keys[signerNames[0]]);
            if (signatureStatus === 'fullysigned') {
                psbt.signInputHD(i, keys[signerNames[1]]);
            }
        }
    });
    if (signatureStatus === 'fullysigned') {
        assert_1.default.ok(psbt.validateSignaturesOfAllInputs());
    }
    return psbt;
}
exports.constructPsbt = constructPsbt;
function getSignedTransaction(keys, signerName, cosignerName, inputTypes, outputTypes) {
    const psbt = constructPsbt(keys, inputTypes, outputTypes, 'fullysigned', { signerName, cosignerName });
    psbt.finalizeAllInputs();
    return psbt.extractTransaction().clone('number');
}
exports.getSignedTransaction = getSignedTransaction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdHV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdGVzdC90ZXN0dXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxpREFBbUM7QUFDbkMseURBQTJDO0FBQzNDLG9EQUE0QjtBQUM1Qiw0Q0FBc0Q7QUFFdEQ7Ozs7O0dBS0c7QUFDSCxNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQUcsSUFBYyxFQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFFbEcsUUFBQSxtQkFBbUIsR0FBRyxVQUFVLENBQUM7QUFFOUMsK0ZBQStGO0FBQ2xGLFFBQUEscUJBQXFCLEdBTzlCLFFBQVEsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLHFCQUFxQixDQUFDLENBQUM7QUFFM0UsUUFBQSxxQkFBcUIsR0FHOUIsUUFBUSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztBQUloQyxNQUFhLG1CQUFtQjtJQUM5QixZQUFtQixJQUFZO1FBQVosU0FBSSxHQUFKLElBQUksQ0FBUTtJQUFHLENBQUM7SUFFNUIsUUFBUTtRQUNiLE9BQU8sWUFBWSxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUM7SUFDbEMsQ0FBQztDQUNGO0FBTkQsa0RBTUM7QUFJRCxTQUFnQixtQkFBbUI7SUFDakMsT0FBTyxDQUFDLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsZUFBZSxFQUFFLFVBQVUsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO0FBQzdGLENBQUM7QUFGRCxrREFFQztBQUVEOzs7O0dBSUc7QUFD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QixFQUE0QyxDQUFDLEtBQUssQ0FBUyxRQUFRLENBQUMsQ0FBQztBQUN0RyxDQUFDO0FBVkQsb0RBVUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1bnNwZW50cyBmcm9tICcuLi9zcmMnO1xuaW1wb3J0ICogYXMgdXR4b2xpYiBmcm9tICdAYml0Z28vdXR4by1saWInO1xuaW1wb3J0IGFzc2VydCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0IHsgY3JlYXRlU2NyaXB0UHViS2V5IH0gZnJvbSAnLi9zaWduZWRUeC90eEdlbic7XG5cbi8qKlxuICogbWFrZUVudW0oJ2EnLCAnYicpIHJldHVybnMgYHsgYTogJ2EnLCBiOiAnYicgfWBcbiAqXG4gKiBAcGFyYW0gYXJnc1xuICogQHJldHVybiBtYXAgd2l0aCBzdHJpbmcga2V5cyBhbmQgc3ltYm9sIHZhbHVlc1xuICovXG5jb25zdCBtYWtlRW51bSA9ICguLi5hcmdzOiBzdHJpbmdbXSk6IGFueSA9PiBhcmdzLnJlZHVjZSgob2JqLCBrZXkpID0+IE9iamVjdC5hc3NpZ24ob2JqLCB7IFtrZXldOiBrZXkgfSksIHt9KTtcblxuZXhwb3J0IGNvbnN0IFVuc3BlbnRUeXBlUDJzaFAycGsgPSAncDJzaFAycGsnO1xuXG4vLyBwMnRyTXVzaWcyIGlzIGFzc3VtZWQgdG8gYmUgc2NyaXB0IHBhdGggb25seS4gdGFwcm9vdEtleVBhdGhTcGVuZCBpcyBmb3IgcDJ0ck11c2lnMiBrZXkgcGF0aFxuZXhwb3J0IGNvbnN0IFVuc3BlbnRUeXBlU2NyaXB0Mm9mMzoge1xuICBwMnNoOiBzdHJpbmc7XG4gIHAyc2hQMndzaDogc3RyaW5nO1xuICBwMndzaDogc3RyaW5nO1xuICBwMnRyOiBzdHJpbmc7XG4gIHAydHJNdXNpZzI6IHN0cmluZztcbiAgdGFwcm9vdEtleVBhdGhTcGVuZDogc3RyaW5nO1xufSA9IG1ha2VFbnVtKCdwMnNoJywgJ3Ayc2hQMndzaCcsICdwMndzaCcsICdwMnRyJywgJ3AydHJNdXNpZzInLCAndGFwcm9vdEtleVBhdGhTcGVuZCcpO1xuXG5leHBvcnQgY29uc3QgVW5zcGVudFR5cGVQdWJLZXlIYXNoOiB7XG4gIHAycGtoOiAncDJwa2gnO1xuICBwMndwa2g6ICdwMndwa2gnO1xufSA9IG1ha2VFbnVtKCdwMnBraCcsICdwMndwa2gnKTtcblxuZXhwb3J0IHR5cGUgVGVzdFVuc3BlbnRUeXBlID0gc3RyaW5nIHwgVW5zcGVudFR5cGVPcFJldHVybjtcblxuZXhwb3J0IGNsYXNzIFVuc3BlbnRUeXBlT3BSZXR1cm4ge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgc2l6ZTogbnVtYmVyKSB7fVxuXG4gIHB1YmxpYyB0b1N0cmluZygpOiBzdHJpbmcge1xuICAgIHJldHVybiBgb3BSZXR1cm4oJHt0aGlzLnNpemV9KWA7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgSW5wdXRTY3JpcHRUeXBlID0gdXR4b2xpYi5iaXRnby5vdXRwdXRTY3JpcHRzLlNjcmlwdFR5cGUgfCAndGFwcm9vdEtleVBhdGhTcGVuZCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbnB1dFNjcmlwdFR5cGVzKCk6IElucHV0U2NyaXB0VHlwZVtdIHtcbiAgcmV0dXJuIFsuLi51dHhvbGliLmJpdGdvLm91dHB1dFNjcmlwdHMuc2NyaXB0VHlwZXMyT2YzLCAncDJzaFAycGsnLCAndGFwcm9vdEtleVBhdGhTcGVuZCddO1xufVxuXG4vKipcbiAqIFJldHVybiB0aGUgaW5wdXQgZGltZW5zaW9ucyBiYXNlZCBvbiB1bnNwZW50IHR5cGVcbiAqIEBwYXJhbSB1bnNwZW50VHlwZSAtIG9uZSBvZiBVbnNwZW50VHlwZVNjcmlwdDJvZjNcbiAqIEByZXR1cm4gRGltZW5zaW9uc1xuICovXG5leHBvcnQgY29uc3QgZ2V0SW5wdXREaW1lbnNpb25zRm9yVW5zcGVudFR5cGUgPSAodW5zcGVudFR5cGU6IFRlc3RVbnNwZW50VHlwZSk6IHVuc3BlbnRzLkRpbWVuc2lvbnMgPT4ge1xuICBzd2l0Y2ggKHVuc3BlbnRUeXBlKSB7XG4gICAgY2FzZSBVbnNwZW50VHlwZVNjcmlwdDJvZjMucDJzaDpcbiAgICAgIHJldHVybiB1bnNwZW50cy5EaW1lbnNpb25zLnN1bSh7IG5QMnNoSW5wdXRzOiAxIH0pO1xuICAgIGNhc2UgVW5zcGVudFR5cGVTY3JpcHQyb2YzLnAyc2hQMndzaDpcbiAgICAgIHJldHVybiB1bnNwZW50cy5EaW1lbnNpb25zLnN1bSh7IG5QMnNoUDJ3c2hJbnB1dHM6IDEgfSk7XG4gICAgY2FzZSBVbnNwZW50VHlwZVNjcmlwdDJvZjMucDJ3c2g6XG4gICAgICByZXR1cm4gdW5zcGVudHMuRGltZW5zaW9ucy5zdW0oeyBuUDJ3c2hJbnB1dHM6IDEgfSk7XG4gICAgY2FzZSBVbnNwZW50VHlwZVNjcmlwdDJvZjMucDJ0cjpcbiAgICBjYXNlIFVuc3BlbnRUeXBlU2NyaXB0Mm9mMy5wMnRyTXVzaWcyOlxuICAgICAgcmV0dXJuIHVuc3BlbnRzLkRpbWVuc2lvbnMuc3VtKHsgblAydHJTY3JpcHRQYXRoTGV2ZWwxSW5wdXRzOiAxIH0pO1xuICAgIGNhc2UgVW5zcGVudFR5cGVTY3JpcHQyb2YzLnRhcHJvb3RLZXlQYXRoU3BlbmQ6XG4gICAgICByZXR1cm4gdW5zcGVudHMuRGltZW5zaW9ucy5zdW0oeyBuUDJ0cktleXBhdGhJbnB1dHM6IDEgfSk7XG4gICAgY2FzZSBVbnNwZW50VHlwZVAyc2hQMnBrOlxuICAgICAgcmV0dXJuIHVuc3BlbnRzLkRpbWVuc2lvbnMuc3VtKHsgblAyc2hQMnBrSW5wdXRzOiAxIH0pO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgbm8gaW5wdXQgZGltZW5zaW9ucyBmb3IgJHt1bnNwZW50VHlwZX1gKTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRPdXRwdXREaW1lbnNpb25zRm9yVW5zcGVudFR5cGUgPSAodW5zcGVudFR5cGU6IFRlc3RVbnNwZW50VHlwZSk6IHVuc3BlbnRzLkRpbWVuc2lvbnMgPT4ge1xuICAvKiBUaGUgdmFsdWVzIGhlcmUgYXJlIHZhbGlkYXRlZCBpbiB0aGUgdGVzdCAnY2FsY3VsYXRlcyBvdXRwdXQgZGltZW5zaW9ucyBkeW5hbWljYWxseScgKi9cbiAgc3dpdGNoICh1bnNwZW50VHlwZSkge1xuICAgIGNhc2UgVW5zcGVudFR5cGVTY3JpcHQyb2YzLnAyc2g6XG4gICAgY2FzZSBVbnNwZW50VHlwZVNjcmlwdDJvZjMucDJzaFAyd3NoOlxuICAgIGNhc2UgVW5zcGVudFR5cGVQMnNoUDJwazpcbiAgICAgIHJldHVybiB1bnNwZW50cy5EaW1lbnNpb25zLmZyb21PdXRwdXRTY3JpcHRMZW5ndGgoMjMpO1xuICAgIGNhc2UgVW5zcGVudFR5cGVTY3JpcHQyb2YzLnAyd3NoOlxuICAgICAgcmV0dXJuIHVuc3BlbnRzLkRpbWVuc2lvbnMuZnJvbU91dHB1dFNjcmlwdExlbmd0aCgzNCk7XG4gICAgY2FzZSBVbnNwZW50VHlwZVNjcmlwdDJvZjMucDJ0cjpcbiAgICBjYXNlIFVuc3BlbnRUeXBlU2NyaXB0Mm9mMy5wMnRyTXVzaWcyOlxuICAgIGNhc2UgVW5zcGVudFR5cGVTY3JpcHQyb2YzLnRhcHJvb3RLZXlQYXRoU3BlbmQ6XG4gICAgICByZXR1cm4gdW5zcGVudHMuRGltZW5zaW9ucy5mcm9tT3V0cHV0U2NyaXB0TGVuZ3RoKDM0KTtcbiAgICBjYXNlIFVuc3BlbnRUeXBlUHViS2V5SGFzaC5wMnBraDpcbiAgICAgIHJldHVybiB1bnNwZW50cy5EaW1lbnNpb25zLmZyb21PdXRwdXRTY3JpcHRMZW5ndGgoMjUpO1xuICAgIGNhc2UgVW5zcGVudFR5cGVQdWJLZXlIYXNoLnAyd3BraDpcbiAgICAgIHJldHVybiB1bnNwZW50cy5EaW1lbnNpb25zLmZyb21PdXRwdXRTY3JpcHRMZW5ndGgoMjIpO1xuICAgIGRlZmF1bHQ6XG4gICAgICBpZiAodW5zcGVudFR5cGUgaW5zdGFuY2VvZiBVbnNwZW50VHlwZU9wUmV0dXJuKSB7XG4gICAgICAgIHJldHVybiB1bnNwZW50cy5EaW1lbnNpb25zLmZyb21PdXRwdXRTY3JpcHRMZW5ndGgoMSArIHVuc3BlbnRUeXBlLnNpemUpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgdW5rbm93biB1bnNwZW50VHlwZSAke3Vuc3BlbnRUeXBlfWApO1xuICB9XG59O1xuXG5mdW5jdGlvbiBnZXREZWZhdWx0U2lnbmVyTmFtZXMoXG4gIGlucHV0VHlwZTogSW5wdXRTY3JpcHRUeXBlLFxuICBzaWduZXJzPzogeyBzaWduZXJOYW1lOiB1dHhvbGliLmJpdGdvLktleU5hbWU7IGNvc2lnbmVyTmFtZTogdXR4b2xpYi5iaXRnby5LZXlOYW1lIH1cbik6IHV0eG9saWIuYml0Z28uS2V5TmFtZVtdIHtcbiAgaWYgKHNpZ25lcnMpIHtcbiAgICByZXR1cm4gW3NpZ25lcnMuc2lnbmVyTmFtZSwgc2lnbmVycy5jb3NpZ25lck5hbWVdO1xuICB9XG4gIGlmIChpbnB1dFR5cGUgPT09ICdwMnNoUDJwaycpIHtcbiAgICByZXR1cm4gWyd1c2VyJ107XG4gIH1cbiAgaWYgKGlucHV0VHlwZSA9PT0gJ3AydHJNdXNpZzInKSB7XG4gICAgcmV0dXJuIFsndXNlcicsICdiYWNrdXAnXTtcbiAgfVxuICByZXR1cm4gWyd1c2VyJywgJ2JpdGdvJ107XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdHJ1Y3RQc2J0KFxuICBrZXlzOiB1dHhvbGliLmJpdGdvLlJvb3RXYWxsZXRLZXlzLFxuICBpbnB1dFR5cGVzOiBJbnB1dFNjcmlwdFR5cGVbXSxcbiAgb3V0cHV0VHlwZXM6IFRlc3RVbnNwZW50VHlwZVtdLFxuICBzaWduYXR1cmVTdGF0dXM6ICd1bnNpZ25lZCcgfCAnaGFsZnNpZ25lZCcgfCAnZnVsbHlzaWduZWQnLFxuICBzaWduZXJzPzogeyBzaWduZXJOYW1lOiB1dHhvbGliLmJpdGdvLktleU5hbWU7IGNvc2lnbmVyTmFtZTogdXR4b2xpYi5iaXRnby5LZXlOYW1lIH1cbik6IHV0eG9saWIuYml0Z28uVXR4b1BzYnQ8dXR4b2xpYi5iaXRnby5VdHhvVHJhbnNhY3Rpb248YmlnaW50Pj4ge1xuICBjb25zdCBwc2J0ID0gdXR4b2xpYi5iaXRnby5jcmVhdGVQc2J0Rm9yTmV0d29yayh7IG5ldHdvcms6IHV0eG9saWIubmV0d29ya3MuYml0Y29pbiB9KTtcblxuICBpbnB1dFR5cGVzLmZvckVhY2goKHQsIGkpID0+IHtcbiAgICBpZiAodCA9PT0gJ3Ayc2hQMnBrJykge1xuICAgICAgY29uc3Qgc2lnbmVyID0ga2V5c1tnZXREZWZhdWx0U2lnbmVyTmFtZXModCwgc2lnbmVycylbMF1dO1xuICAgICAgY29uc3QgdW5zcGVudCA9IHV0eG9saWIudGVzdHV0aWwubW9ja1JlcGxheVByb3RlY3Rpb25VbnNwZW50KHV0eG9saWIubmV0d29ya3MuYml0Y29pbiwgQmlnSW50KDEwKSwge1xuICAgICAgICBrZXk6IHNpZ25lcixcbiAgICAgICAgdm91dDogaSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgeyByZWRlZW1TY3JpcHQgfSA9IHV0eG9saWIuYml0Z28ub3V0cHV0U2NyaXB0cy5jcmVhdGVPdXRwdXRTY3JpcHRQMnNoUDJwayhzaWduZXIucHVibGljS2V5KTtcbiAgICAgIGFzc2VydC5vayhyZWRlZW1TY3JpcHQpO1xuICAgICAgdXR4b2xpYi5iaXRnby5hZGRSZXBsYXlQcm90ZWN0aW9uVW5zcGVudFRvUHNidChwc2J0LCB1bnNwZW50LCByZWRlZW1TY3JpcHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB1bnNwZW50ID0gdXR4b2xpYi50ZXN0dXRpbC5tb2NrV2FsbGV0VW5zcGVudCh1dHhvbGliLm5ldHdvcmtzLmJpdGNvaW4sIEJpZ0ludCgxMCksIHtcbiAgICAgICAga2V5cyxcbiAgICAgICAgY2hhaW46IHV0eG9saWIuYml0Z28uZ2V0RXh0ZXJuYWxDaGFpbkNvZGUodCA9PT0gJ3RhcHJvb3RLZXlQYXRoU3BlbmQnID8gJ3AydHJNdXNpZzInIDogdCksXG4gICAgICAgIHZvdXQ6IGksXG4gICAgICAgIGluZGV4OiBpLFxuICAgICAgfSk7XG4gICAgICBjb25zdCBzaWduZXJOYW1lcyA9IGdldERlZmF1bHRTaWduZXJOYW1lcyh0LCBzaWduZXJzKTtcbiAgICAgIHV0eG9saWIuYml0Z28uYWRkV2FsbGV0VW5zcGVudFRvUHNidChwc2J0LCB1bnNwZW50LCBrZXlzLCBzaWduZXJOYW1lc1swXSwgc2lnbmVyTmFtZXNbMV0pO1xuICAgIH1cbiAgfSk7XG5cbiAgb3V0cHV0VHlwZXMuZm9yRWFjaCgodCwgaW5kZXgpID0+IHtcbiAgICBwc2J0LmFkZE91dHB1dCh7XG4gICAgICBzY3JpcHQ6IGNyZWF0ZVNjcmlwdFB1YktleShrZXlzLnRyaXBsZSwgdCksXG4gICAgICB2YWx1ZTogQmlnSW50KDEwKSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgaWYgKHNpZ25hdHVyZVN0YXR1cyA9PT0gJ3Vuc2lnbmVkJykge1xuICAgIHJldHVybiBwc2J0O1xuICB9XG5cbiAgcHNidC5zZXRBbGxJbnB1dHNNdXNpZzJOb25jZUhEKGtleXNbJ3VzZXInXSk7XG4gIHBzYnQuc2V0QWxsSW5wdXRzTXVzaWcyTm9uY2VIRChrZXlzWydiaXRnbyddKTtcblxuICBpbnB1dFR5cGVzLmZvckVhY2goKHQsIGkpID0+IHtcbiAgICBjb25zdCBzaWduZXJOYW1lcyA9IGdldERlZmF1bHRTaWduZXJOYW1lcyh0LCBzaWduZXJzKTtcbiAgICBpZiAodCA9PT0gJ3Ayc2hQMnBrJykge1xuICAgICAgaWYgKHNpZ25hdHVyZVN0YXR1cyA9PT0gJ2Z1bGx5c2lnbmVkJykge1xuICAgICAgICBwc2J0LnNpZ25JbnB1dChpLCBrZXlzW3NpZ25lck5hbWVzWzBdXSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHBzYnQuc2lnbklucHV0SEQoaSwga2V5c1tzaWduZXJOYW1lc1swXV0pO1xuICAgICAgaWYgKHNpZ25hdHVyZVN0YXR1cyA9PT0gJ2Z1bGx5c2lnbmVkJykge1xuICAgICAgICBwc2J0LnNpZ25JbnB1dEhEKGksIGtleXNbc2lnbmVyTmFtZXNbMV1dKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuICBpZiAoc2lnbmF0dXJlU3RhdHVzID09PSAnZnVsbHlzaWduZWQnKSB7XG4gICAgYXNzZXJ0Lm9rKHBzYnQudmFsaWRhdGVTaWduYXR1cmVzT2ZBbGxJbnB1dHMoKSk7XG4gIH1cbiAgcmV0dXJuIHBzYnQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTaWduZWRUcmFuc2FjdGlvbihcbiAga2V5czogdXR4b2xpYi5iaXRnby5Sb290V2FsbGV0S2V5cyxcbiAgc2lnbmVyTmFtZTogdXR4b2xpYi5iaXRnby5LZXlOYW1lLFxuICBjb3NpZ25lck5hbWU6IHV0eG9saWIuYml0Z28uS2V5TmFtZSxcbiAgaW5wdXRUeXBlczogSW5wdXRTY3JpcHRUeXBlW10sXG4gIG91dHB1dFR5cGVzOiBUZXN0VW5zcGVudFR5cGVbXVxuKTogdXR4b2xpYi5iaXRnby5VdHhvVHJhbnNhY3Rpb24ge1xuICBjb25zdCBwc2J0ID0gY29uc3RydWN0UHNidChrZXlzLCBpbnB1dFR5cGVzLCBvdXRwdXRUeXBlcywgJ2Z1bGx5c2lnbmVkJywgeyBzaWduZXJOYW1lLCBjb3NpZ25lck5hbWUgfSk7XG4gIHBzYnQuZmluYWxpemVBbGxJbnB1dHMoKTtcbiAgcmV0dXJuIChwc2J0LmV4dHJhY3RUcmFuc2FjdGlvbigpIGFzIHV0eG9saWIuYml0Z28uVXR4b1RyYW5zYWN0aW9uPGJpZ2ludD4pLmNsb25lPG51bWJlcj4oJ251bWJlcicpO1xufVxuIl19