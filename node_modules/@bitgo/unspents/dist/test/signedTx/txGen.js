"use strict";
/* eslint-disable @typescript-eslint/ban-ts-comment */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.runSignedTransactions = exports.runCombinations = exports.Histogram = exports.TxCombo = exports.createScriptPubKey = void 0;
const utxolib = __importStar(require("@bitgo/utxo-lib"));
const utxo_lib_1 = require("@bitgo/utxo-lib");
const lodash_1 = __importDefault(require("lodash"));
require("lodash.combinations");
const src_1 = require("../../src");
const testutils_1 = require("../testutils");
function createUnspent(pubkeys, inputType, value) {
    let spendableScript;
    const scriptType = inputType === 'taprootKeyPathSpend' ? 'p2trMusig2' : inputType;
    if (scriptType === testutils_1.UnspentTypeP2shP2pk) {
        spendableScript = utxolib.bitgo.outputScripts.createOutputScriptP2shP2pk(pubkeys[0]);
    }
    else if (utxolib.bitgo.outputScripts.isScriptType2Of3(scriptType)) {
        spendableScript = utxolib.bitgo.outputScripts.createOutputScript2of3(pubkeys, scriptType);
    }
    else {
        throw new Error(`unexpected inputType ${scriptType}`);
    }
    return {
        ...spendableScript,
        value,
        inputType: scriptType,
    };
}
/**
 *
 * @param keys - Pubkeys to use for generating the address.
 *               If unspentType is one of UnspentTypePubKeyHash is used, the first key will be used.
 * @param unspentType {String} - one of UnspentTypeScript2of3 or UnspentTypePubKeyHash
 * @return {String} address
 */
const createScriptPubKey = (keys, unspentType) => {
    const pubkeys = keys.map((key) => key.publicKey);
    if (typeof unspentType === 'string' && unspentType in testutils_1.UnspentTypeScript2of3) {
        return createUnspent(pubkeys, unspentType, 0).scriptPubKey;
    }
    const pkHash = utxolib.crypto.hash160(pubkeys[0]);
    switch (unspentType) {
        case testutils_1.UnspentTypePubKeyHash.p2pkh:
            return utxolib.payments.p2pkh({ hash: pkHash }).output;
        case testutils_1.UnspentTypePubKeyHash.p2wpkh:
            return utxolib.payments.p2wpkh({ hash: pkHash }).output;
    }
    if (unspentType instanceof testutils_1.UnspentTypeOpReturn) {
        const payload = Buffer.alloc(unspentType.size).fill(pubkeys[0]);
        return utxolib.script.compile([0x6a, payload]);
    }
    throw new Error(`unsupported output type ${unspentType}`);
};
exports.createScriptPubKey = createScriptPubKey;
const createInputTx = (unspents, inputValue) => {
    const txInputBuilder = new utxolib.bitgo.UtxoTransactionBuilder(utxolib.networks.bitcoin);
    txInputBuilder.addInput(Array(32).fill('01').join(''), 0);
    unspents.forEach(({ scriptPubKey }) => txInputBuilder.addOutput(scriptPubKey, inputValue));
    return txInputBuilder.buildIncomplete();
};
function signInput(txBuilder, index, walletKeys, unspent, signKeys = unspent.inputType === 'p2shP2pk' ? [walletKeys[0]] : [walletKeys[0], walletKeys[2]]) {
    signKeys.forEach((keyPair) => {
        if (unspent.inputType === 'p2shP2pk') {
            utxolib.bitgo.signInputP2shP2pk(txBuilder, index, keyPair);
        }
        else {
            if (signKeys.length !== 2) {
                throw new Error(`invalid signKeys length`);
            }
            const cosigner = keyPair === signKeys[0] ? signKeys[1] : signKeys[0];
            utxolib.bitgo.signInput2Of3(txBuilder, index, unspent.inputType, walletKeys.map((k) => k.publicKey), keyPair, cosigner.publicKey, unspent.value);
        }
    });
}
class TxCombo {
    constructor(walletKeys, inputTypes, outputTypes, expectedDims = src_1.Dimensions.ZERO, signKeys, inputValue = 10) {
        this.walletKeys = walletKeys;
        this.inputTypes = inputTypes;
        this.outputTypes = outputTypes;
        this.expectedDims = expectedDims;
        this.signKeys = signKeys;
        this.inputValue = inputValue;
        this.unspents = inputTypes.map((inputType) => createUnspent(walletKeys.map((key) => key.publicKey), inputType, this.inputValue));
        this.inputTx = createInputTx(this.unspents, inputValue);
    }
    getBuilderWithUnsignedTx() {
        const txBuilder = utxolib.bitgo.createTransactionBuilderForNetwork(utxolib.networks.bitcoin);
        this.inputTx.outs.forEach(({}, i) => txBuilder.addInput(this.inputTx, i));
        this.outputTypes.forEach((unspentType) => txBuilder.addOutput((0, exports.createScriptPubKey)(this.walletKeys, unspentType), this.inputValue));
        return txBuilder;
    }
    getUnsignedTx() {
        return this.getBuilderWithUnsignedTx().buildIncomplete();
    }
    getSignedTx() {
        const txBuilder = this.getBuilderWithUnsignedTx();
        this.unspents.forEach((unspent, i) => {
            signInput(txBuilder, i, this.walletKeys, unspent, this.signKeys);
        });
        return txBuilder.build();
    }
}
exports.TxCombo = TxCombo;
const runCombinations = ({ inputTypes, maxNInputs, outputTypes, maxNOutputs, }, callback) => {
    // Create combinations of different input and output types. Length between 1 and 3.
    const inputCombinations = lodash_1.default.flatten(
    // @ts-ignore
    [...Array(maxNInputs)].map((__, i) => lodash_1.default.combinations(inputTypes, i + 1)));
    const outputCombinations = lodash_1.default.flatten(
    // @ts-ignore
    [...Array(maxNOutputs)].map((__, i) => lodash_1.default.combinations(outputTypes, i + 1)));
    inputCombinations.forEach((inputTypeCombo) => outputCombinations.forEach((outputTypeCombo) => {
        callback(inputTypeCombo, outputTypeCombo);
    }));
};
exports.runCombinations = runCombinations;
class Histogram {
    constructor(map = new Map()) {
        this.map = map;
        this.total = 0;
    }
    add(size) {
        this.map.set(size, (this.map.get(size) || 0) + 1);
        this.total++;
    }
    asSortedArray() {
        return [...this.map.entries()].sort(([a], [b]) => a - b);
    }
    asFullSortedArray() {
        return lodash_1.default.range(this.getPercentile(0), this.getPercentile(1)).map((v) => [v, this.map.get(v) || 0]);
    }
    getPercentile(p) {
        if (0 > p || p > 1) {
            throw new Error(`p must be between 0 and 1`);
        }
        let sum = 0;
        for (const [k, v] of this.asSortedArray()) {
            sum += v;
            if (sum / this.total >= p) {
                return k;
            }
        }
        throw new Error('could not find percentile');
    }
    toString() {
        const keys = [...this.map.keys()].sort((a, b) => a - b);
        return `[${keys.map((k) => `[${k}, ${this.map.get(k)}]`).join(' ')}]`;
    }
}
exports.Histogram = Histogram;
const getKeyTriplets = (prefix, count) => [...Array(count)].map((v, i) => [1, 2, 3].map((j) => utxo_lib_1.bip32.fromSeed(Buffer.alloc(16, `${prefix}/${i}/${j}`), utxolib.networks.bitcoin)));
/**
 *
 * Calls `callback` with a variety of signed txs, based on input parameters
 * Callback arguments are
 *   inputType, inputCount, outputType, txs
 *  where `txs` implements `forEach()`
 *
 * @param inputTypes - input types to test
 * @param nInputKeyTriplets - number of different input key triples to cycle through
 * @param outputTypes - output types to test
 * @param nOutputKeyTriplets - number of different output key triplets to cycle through
 * @param callback
 */
const runSignedTransactions = ({ inputTypes, nInputKeyTriplets, outputTypes, nOutputKeyTriplets, }, callback) => {
    const inputKeyTriplets = getKeyTriplets('test/input/', nInputKeyTriplets);
    const outputKeyTriplets = getKeyTriplets('test/output/', nOutputKeyTriplets);
    const outputValue = 1e8;
    inputTypes.forEach(({ inputType, count: inputCount }) => {
        const inputTxs = inputKeyTriplets.map((inputKeys) => {
            const unspents = [...Array(inputCount)].map(() => createUnspent(inputKeys.map((key) => key.publicKey), inputType, outputValue));
            const inputTx = createInputTx(unspents, outputValue);
            return { inputKeys, unspents, inputTx };
        });
        outputTypes.forEach((outputType) => {
            const outputs = outputKeyTriplets.map((outputKeys) => (0, exports.createScriptPubKey)(outputKeys, outputType));
            const txs = {
                forEach(cb) {
                    inputTxs.forEach(({ inputKeys, unspents, inputTx }) => {
                        outputs.forEach((scriptPubKey) => {
                            const txBuilder = utxolib.bitgo.createTransactionBuilderForNetwork(utxolib.networks.bitcoin);
                            inputTx.outs.forEach((v, i) => txBuilder.addInput(inputTx, i));
                            txBuilder.addOutput(scriptPubKey, outputValue);
                            unspents.forEach((unspent, i) => {
                                signInput(txBuilder, i, inputKeys, unspent);
                            });
                            cb(txBuilder.build());
                        });
                    });
                },
            };
            callback(inputType, inputCount, outputType, txs);
        });
    });
};
exports.runSignedTransactions = runSignedTransactions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHhHZW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90ZXN0L3NpZ25lZFR4L3R4R2VuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxzREFBc0Q7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRXRELHlEQUEyQztBQUMzQyw4Q0FBd0Q7QUFDeEQsb0RBQXVCO0FBQ3ZCLCtCQUE2QjtBQUM3QixtQ0FBdUM7QUFDdkMsNENBT3NCO0FBVXRCLFNBQVMsYUFBYSxDQUFDLE9BQWlCLEVBQUUsU0FBaUIsRUFBRSxLQUFhO0lBQ3hFLElBQUksZUFBZSxDQUFDO0lBQ3BCLE1BQU0sVUFBVSxHQUFHLFNBQVMsS0FBSyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDbEYsSUFBSSxVQUFVLEtBQUssK0JBQW1CLEVBQUU7UUFDdEMsZUFBZSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLDBCQUEwQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3RGO1NBQU0sSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsRUFBRTtRQUNuRSxlQUFlLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsc0JBQXNCLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0tBQzNGO1NBQU07UUFDTCxNQUFNLElBQUksS0FBSyxDQUFDLHdCQUF3QixVQUFVLEVBQUUsQ0FBQyxDQUFDO0tBQ3ZEO0lBRUQsT0FBTztRQUNMLEdBQUcsZUFBZTtRQUNsQixLQUFLO1FBQ0wsU0FBUyxFQUFFLFVBQVU7S0FDdEIsQ0FBQztBQUNKLENBQUM7QUFFRDs7Ozs7O0dBTUc7QUFDSSxNQUFNLGtCQUFrQixHQUFHLENBQUMsSUFBc0IsRUFBRSxXQUE0QixFQUFVLEVBQUU7SUFDakcsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2pELElBQUksT0FBTyxXQUFXLEtBQUssUUFBUSxJQUFJLFdBQVcsSUFBSSxpQ0FBcUIsRUFBRTtRQUMzRSxPQUFPLGFBQWEsQ0FBQyxPQUFPLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQztLQUM1RDtJQUVELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xELFFBQVEsV0FBVyxFQUFFO1FBQ25CLEtBQUssaUNBQXFCLENBQUMsS0FBSztZQUM5QixPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTyxDQUFDO1FBQzFELEtBQUssaUNBQXFCLENBQUMsTUFBTTtZQUMvQixPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTyxDQUFDO0tBQzVEO0lBRUQsSUFBSSxXQUFXLFlBQVksK0JBQW1CLEVBQUU7UUFDOUMsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hFLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztLQUNoRDtJQUVELE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDNUQsQ0FBQyxDQUFDO0FBcEJXLFFBQUEsa0JBQWtCLHNCQW9CN0I7QUFFRixNQUFNLGFBQWEsR0FBRyxDQUFDLFFBQWUsRUFBRSxVQUFrQixFQUFFLEVBQUU7SUFDNUQsTUFBTSxjQUFjLEdBQUcsSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUYsY0FBYyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMxRCxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUMzRixPQUFPLGNBQWMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztBQUMxQyxDQUFDLENBQUM7QUFFRixTQUFTLFNBQVMsQ0FDaEIsU0FBK0MsRUFDL0MsS0FBYSxFQUNiLFVBQTRCLEVBQzVCLE9BQWlCLEVBQ2pCLFdBQTZCLE9BQU8sQ0FBQyxTQUFTLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFaEgsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzNCLElBQUksT0FBTyxDQUFDLFNBQVMsS0FBSyxVQUFVLEVBQUU7WUFDcEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzVEO2FBQU07WUFDTCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUN6QixNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7YUFDNUM7WUFDRCxNQUFNLFFBQVEsR0FBRyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyRSxPQUFPLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FDekIsU0FBUyxFQUNULEtBQUssRUFDTCxPQUFPLENBQUMsU0FBUyxFQUNqQixVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFpQyxFQUNsRSxPQUFPLEVBQ1AsUUFBUSxDQUFDLFNBQVMsRUFDbEIsT0FBTyxDQUFDLEtBQUssQ0FDZCxDQUFDO1NBQ0g7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxNQUFNLE9BQU87SUFJWCxZQUNTLFVBQTRCLEVBQzVCLFVBQW9CLEVBQ3BCLFdBQThCLEVBQzlCLGVBQXFDLGdCQUFVLENBQUMsSUFBSSxFQUNwRCxRQUEyQixFQUMzQixhQUFxQixFQUFFO1FBTHZCLGVBQVUsR0FBVixVQUFVLENBQWtCO1FBQzVCLGVBQVUsR0FBVixVQUFVLENBQVU7UUFDcEIsZ0JBQVcsR0FBWCxXQUFXLENBQW1CO1FBQzlCLGlCQUFZLEdBQVosWUFBWSxDQUF3QztRQUNwRCxhQUFRLEdBQVIsUUFBUSxDQUFtQjtRQUMzQixlQUFVLEdBQVYsVUFBVSxDQUFhO1FBRTlCLElBQUksQ0FBQyxRQUFRLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQzNDLGFBQWEsQ0FDWCxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQ3RDLFNBQVMsRUFDVCxJQUFJLENBQUMsVUFBVSxDQUNoQixDQUNGLENBQUM7UUFDRixJQUFJLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFTSx3QkFBd0I7UUFDN0IsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdGLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFTLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FDdkMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFBLDBCQUFrQixFQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUN2RixDQUFDO1FBQ0YsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVNLGFBQWE7UUFDbEIsT0FBTyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUMzRCxDQUFDO0lBRU0sV0FBVztRQUNoQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUNsRCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNuQyxTQUFTLENBQUMsU0FBUyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkUsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMzQixDQUFDO0NBQ0Y7QUFtSlEsMEJBQU87QUFqSmhCLE1BQU0sZUFBZSxHQUFHLENBQ3RCLEVBQ0UsVUFBVSxFQUNWLFVBQVUsRUFDVixXQUFXLEVBQ1gsV0FBVyxHQU1aLEVBQ0QsUUFBaUYsRUFDM0UsRUFBRTtJQUNSLG1GQUFtRjtJQUNuRixNQUFNLGlCQUFpQixHQUFHLGdCQUFDLENBQUMsT0FBTztJQUNqQyxhQUFhO0lBQ2IsQ0FBQyxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLGdCQUFDLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FDekUsQ0FBQztJQUNGLE1BQU0sa0JBQWtCLEdBQUcsZ0JBQUMsQ0FBQyxPQUFPO0lBQ2xDLGFBQWE7SUFDYixDQUFDLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsZ0JBQUMsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUMzRSxDQUFDO0lBRUYsaUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FDM0Msa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsZUFBZSxFQUFFLEVBQUU7UUFDN0MsUUFBUSxDQUFDLGNBQWMsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FDSCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBb0gyQiwwQ0FBZTtBQWxINUMsTUFBTSxTQUFTO0lBR2IsWUFBbUIsTUFBMkIsSUFBSSxHQUFHLEVBQUU7UUFBcEMsUUFBRyxHQUFILEdBQUcsQ0FBaUM7UUFGaEQsVUFBSyxHQUFHLENBQUMsQ0FBQztJQUV5QyxDQUFDO0lBRXBELEdBQUcsQ0FBQyxJQUFZO1FBQ3JCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNmLENBQUM7SUFFTSxhQUFhO1FBQ2xCLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRU0saUJBQWlCO1FBQ3RCLE9BQU8sZ0JBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JHLENBQUM7SUFFTSxhQUFhLENBQUMsQ0FBUztRQUM1QixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7U0FDOUM7UUFFRCxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDWixLQUFLLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUFFO1lBQ3pDLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDVCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsRUFBRTtnQkFDekIsT0FBTyxDQUFDLENBQUM7YUFDVjtTQUNGO1FBRUQsTUFBTSxJQUFJLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFTSxRQUFRO1FBQ2IsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDeEQsT0FBTyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztJQUN4RSxDQUFDO0NBQ0Y7QUE0RWlCLDhCQUFTO0FBMUUzQixNQUFNLGNBQWMsR0FBRyxDQUFDLE1BQWMsRUFBRSxLQUFhLEVBQUUsRUFBRSxDQUN2RCxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQzdCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGdCQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FDeEcsQ0FBQztBQUVKOzs7Ozs7Ozs7Ozs7R0FZRztBQUNILE1BQU0scUJBQXFCLEdBQUcsQ0FDNUIsRUFDRSxVQUFVLEVBQ1YsaUJBQWlCLEVBQ2pCLFdBQVcsRUFDWCxrQkFBa0IsR0FNbkIsRUFDRCxRQUFnRyxFQUMxRixFQUFFO0lBQ1IsTUFBTSxnQkFBZ0IsR0FBRyxjQUFjLENBQUMsYUFBYSxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFDMUUsTUFBTSxpQkFBaUIsR0FBRyxjQUFjLENBQUMsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUM7SUFDN0UsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDO0lBRXhCLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRTtRQUN0RCxNQUFNLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTtZQUNsRCxNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUMvQyxhQUFhLENBQ1gsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUNyQyxTQUFTLEVBQ1QsV0FBVyxDQUNaLENBQ0YsQ0FBQztZQUNGLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDakMsTUFBTSxPQUFPLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxJQUFBLDBCQUFrQixFQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBRWxHLE1BQU0sR0FBRyxHQUFHO2dCQUNWLE9BQU8sQ0FBQyxFQUFxQztvQkFDM0MsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFO3dCQUNwRCxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUU7NEJBQy9CLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0NBQWtDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQzs0QkFDN0YsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFNLEVBQUUsQ0FBUyxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUM1RSxTQUFTLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQzs0QkFDL0MsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQ0FDOUIsU0FBUyxDQUFDLFNBQVMsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDOzRCQUM5QyxDQUFDLENBQUMsQ0FBQzs0QkFFSCxFQUFFLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7d0JBQ3hCLENBQUMsQ0FBQyxDQUFDO29CQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUNMLENBQUM7YUFDRixDQUFDO1lBRUYsUUFBUSxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFFNEMsc0RBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50ICovXG5cbmltcG9ydCAqIGFzIHV0eG9saWIgZnJvbSAnQGJpdGdvL3V0eG8tbGliJztcbmltcG9ydCB7IGJpcDMyLCBCSVAzMkludGVyZmFjZSB9IGZyb20gJ0BiaXRnby91dHhvLWxpYic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0ICdsb2Rhc2guY29tYmluYXRpb25zJztcbmltcG9ydCB7IERpbWVuc2lvbnMgfSBmcm9tICcuLi8uLi9zcmMnO1xuaW1wb3J0IHtcbiAgSW5wdXRTY3JpcHRUeXBlLFxuICBUZXN0VW5zcGVudFR5cGUsXG4gIFVuc3BlbnRUeXBlT3BSZXR1cm4sXG4gIFVuc3BlbnRUeXBlUDJzaFAycGssXG4gIFVuc3BlbnRUeXBlUHViS2V5SGFzaCxcbiAgVW5zcGVudFR5cGVTY3JpcHQyb2YzLFxufSBmcm9tICcuLi90ZXN0dXRpbHMnO1xuXG5pbnRlcmZhY2UgSVVuc3BlbnQge1xuICBzY3JpcHRQdWJLZXk6IEJ1ZmZlcjtcbiAgcmVkZWVtU2NyaXB0PzogQnVmZmVyO1xuICB3aXRuZXNzU2NyaXB0PzogQnVmZmVyO1xuICB2YWx1ZTogbnVtYmVyO1xuICBpbnB1dFR5cGU6IHV0eG9saWIuYml0Z28ub3V0cHV0U2NyaXB0cy5TY3JpcHRUeXBlO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVVbnNwZW50KHB1YmtleXM6IEJ1ZmZlcltdLCBpbnB1dFR5cGU6IHN0cmluZywgdmFsdWU6IG51bWJlcik6IElVbnNwZW50IHtcbiAgbGV0IHNwZW5kYWJsZVNjcmlwdDtcbiAgY29uc3Qgc2NyaXB0VHlwZSA9IGlucHV0VHlwZSA9PT0gJ3RhcHJvb3RLZXlQYXRoU3BlbmQnID8gJ3AydHJNdXNpZzInIDogaW5wdXRUeXBlO1xuICBpZiAoc2NyaXB0VHlwZSA9PT0gVW5zcGVudFR5cGVQMnNoUDJwaykge1xuICAgIHNwZW5kYWJsZVNjcmlwdCA9IHV0eG9saWIuYml0Z28ub3V0cHV0U2NyaXB0cy5jcmVhdGVPdXRwdXRTY3JpcHRQMnNoUDJwayhwdWJrZXlzWzBdKTtcbiAgfSBlbHNlIGlmICh1dHhvbGliLmJpdGdvLm91dHB1dFNjcmlwdHMuaXNTY3JpcHRUeXBlMk9mMyhzY3JpcHRUeXBlKSkge1xuICAgIHNwZW5kYWJsZVNjcmlwdCA9IHV0eG9saWIuYml0Z28ub3V0cHV0U2NyaXB0cy5jcmVhdGVPdXRwdXRTY3JpcHQyb2YzKHB1YmtleXMsIHNjcmlwdFR5cGUpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZCBpbnB1dFR5cGUgJHtzY3JpcHRUeXBlfWApO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICAuLi5zcGVuZGFibGVTY3JpcHQsXG4gICAgdmFsdWUsXG4gICAgaW5wdXRUeXBlOiBzY3JpcHRUeXBlLFxuICB9O1xufVxuXG4vKipcbiAqXG4gKiBAcGFyYW0ga2V5cyAtIFB1YmtleXMgdG8gdXNlIGZvciBnZW5lcmF0aW5nIHRoZSBhZGRyZXNzLlxuICogICAgICAgICAgICAgICBJZiB1bnNwZW50VHlwZSBpcyBvbmUgb2YgVW5zcGVudFR5cGVQdWJLZXlIYXNoIGlzIHVzZWQsIHRoZSBmaXJzdCBrZXkgd2lsbCBiZSB1c2VkLlxuICogQHBhcmFtIHVuc3BlbnRUeXBlIHtTdHJpbmd9IC0gb25lIG9mIFVuc3BlbnRUeXBlU2NyaXB0Mm9mMyBvciBVbnNwZW50VHlwZVB1YktleUhhc2hcbiAqIEByZXR1cm4ge1N0cmluZ30gYWRkcmVzc1xuICovXG5leHBvcnQgY29uc3QgY3JlYXRlU2NyaXB0UHViS2V5ID0gKGtleXM6IEJJUDMySW50ZXJmYWNlW10sIHVuc3BlbnRUeXBlOiBUZXN0VW5zcGVudFR5cGUpOiBCdWZmZXIgPT4ge1xuICBjb25zdCBwdWJrZXlzID0ga2V5cy5tYXAoKGtleSkgPT4ga2V5LnB1YmxpY0tleSk7XG4gIGlmICh0eXBlb2YgdW5zcGVudFR5cGUgPT09ICdzdHJpbmcnICYmIHVuc3BlbnRUeXBlIGluIFVuc3BlbnRUeXBlU2NyaXB0Mm9mMykge1xuICAgIHJldHVybiBjcmVhdGVVbnNwZW50KHB1YmtleXMsIHVuc3BlbnRUeXBlLCAwKS5zY3JpcHRQdWJLZXk7XG4gIH1cblxuICBjb25zdCBwa0hhc2ggPSB1dHhvbGliLmNyeXB0by5oYXNoMTYwKHB1YmtleXNbMF0pO1xuICBzd2l0Y2ggKHVuc3BlbnRUeXBlKSB7XG4gICAgY2FzZSBVbnNwZW50VHlwZVB1YktleUhhc2gucDJwa2g6XG4gICAgICByZXR1cm4gdXR4b2xpYi5wYXltZW50cy5wMnBraCh7IGhhc2g6IHBrSGFzaCB9KS5vdXRwdXQhO1xuICAgIGNhc2UgVW5zcGVudFR5cGVQdWJLZXlIYXNoLnAyd3BraDpcbiAgICAgIHJldHVybiB1dHhvbGliLnBheW1lbnRzLnAyd3BraCh7IGhhc2g6IHBrSGFzaCB9KS5vdXRwdXQhO1xuICB9XG5cbiAgaWYgKHVuc3BlbnRUeXBlIGluc3RhbmNlb2YgVW5zcGVudFR5cGVPcFJldHVybikge1xuICAgIGNvbnN0IHBheWxvYWQgPSBCdWZmZXIuYWxsb2ModW5zcGVudFR5cGUuc2l6ZSkuZmlsbChwdWJrZXlzWzBdKTtcbiAgICByZXR1cm4gdXR4b2xpYi5zY3JpcHQuY29tcGlsZShbMHg2YSwgcGF5bG9hZF0pO1xuICB9XG5cbiAgdGhyb3cgbmV3IEVycm9yKGB1bnN1cHBvcnRlZCBvdXRwdXQgdHlwZSAke3Vuc3BlbnRUeXBlfWApO1xufTtcblxuY29uc3QgY3JlYXRlSW5wdXRUeCA9ICh1bnNwZW50czogYW55W10sIGlucHV0VmFsdWU6IG51bWJlcikgPT4ge1xuICBjb25zdCB0eElucHV0QnVpbGRlciA9IG5ldyB1dHhvbGliLmJpdGdvLlV0eG9UcmFuc2FjdGlvbkJ1aWxkZXIodXR4b2xpYi5uZXR3b3Jrcy5iaXRjb2luKTtcbiAgdHhJbnB1dEJ1aWxkZXIuYWRkSW5wdXQoQXJyYXkoMzIpLmZpbGwoJzAxJykuam9pbignJyksIDApO1xuICB1bnNwZW50cy5mb3JFYWNoKCh7IHNjcmlwdFB1YktleSB9KSA9PiB0eElucHV0QnVpbGRlci5hZGRPdXRwdXQoc2NyaXB0UHViS2V5LCBpbnB1dFZhbHVlKSk7XG4gIHJldHVybiB0eElucHV0QnVpbGRlci5idWlsZEluY29tcGxldGUoKTtcbn07XG5cbmZ1bmN0aW9uIHNpZ25JbnB1dChcbiAgdHhCdWlsZGVyOiB1dHhvbGliLmJpdGdvLlV0eG9UcmFuc2FjdGlvbkJ1aWxkZXIsXG4gIGluZGV4OiBudW1iZXIsXG4gIHdhbGxldEtleXM6IEJJUDMySW50ZXJmYWNlW10sXG4gIHVuc3BlbnQ6IElVbnNwZW50LFxuICBzaWduS2V5czogQklQMzJJbnRlcmZhY2VbXSA9IHVuc3BlbnQuaW5wdXRUeXBlID09PSAncDJzaFAycGsnID8gW3dhbGxldEtleXNbMF1dIDogW3dhbGxldEtleXNbMF0sIHdhbGxldEtleXNbMl1dXG4pIHtcbiAgc2lnbktleXMuZm9yRWFjaCgoa2V5UGFpcikgPT4ge1xuICAgIGlmICh1bnNwZW50LmlucHV0VHlwZSA9PT0gJ3Ayc2hQMnBrJykge1xuICAgICAgdXR4b2xpYi5iaXRnby5zaWduSW5wdXRQMnNoUDJwayh0eEJ1aWxkZXIsIGluZGV4LCBrZXlQYWlyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHNpZ25LZXlzLmxlbmd0aCAhPT0gMikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgc2lnbktleXMgbGVuZ3RoYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBjb3NpZ25lciA9IGtleVBhaXIgPT09IHNpZ25LZXlzWzBdID8gc2lnbktleXNbMV0gOiBzaWduS2V5c1swXTtcbiAgICAgIHV0eG9saWIuYml0Z28uc2lnbklucHV0Mk9mMyhcbiAgICAgICAgdHhCdWlsZGVyLFxuICAgICAgICBpbmRleCxcbiAgICAgICAgdW5zcGVudC5pbnB1dFR5cGUsXG4gICAgICAgIHdhbGxldEtleXMubWFwKChrKSA9PiBrLnB1YmxpY0tleSkgYXMgdXR4b2xpYi5iaXRnby5UcmlwbGU8QnVmZmVyPixcbiAgICAgICAga2V5UGFpcixcbiAgICAgICAgY29zaWduZXIucHVibGljS2V5LFxuICAgICAgICB1bnNwZW50LnZhbHVlXG4gICAgICApO1xuICAgIH1cbiAgfSk7XG59XG5cbmNsYXNzIFR4Q29tYm8ge1xuICBwdWJsaWMgdW5zcGVudHM6IElVbnNwZW50W107XG4gIHB1YmxpYyBpbnB1dFR4OiBhbnk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHdhbGxldEtleXM6IEJJUDMySW50ZXJmYWNlW10sXG4gICAgcHVibGljIGlucHV0VHlwZXM6IHN0cmluZ1tdLFxuICAgIHB1YmxpYyBvdXRwdXRUeXBlczogVGVzdFVuc3BlbnRUeXBlW10sXG4gICAgcHVibGljIGV4cGVjdGVkRGltczogUmVhZG9ubHk8RGltZW5zaW9ucz4gPSBEaW1lbnNpb25zLlpFUk8sXG4gICAgcHVibGljIHNpZ25LZXlzPzogQklQMzJJbnRlcmZhY2VbXSxcbiAgICBwdWJsaWMgaW5wdXRWYWx1ZTogbnVtYmVyID0gMTBcbiAgKSB7XG4gICAgdGhpcy51bnNwZW50cyA9IGlucHV0VHlwZXMubWFwKChpbnB1dFR5cGUpID0+XG4gICAgICBjcmVhdGVVbnNwZW50KFxuICAgICAgICB3YWxsZXRLZXlzLm1hcCgoa2V5KSA9PiBrZXkucHVibGljS2V5KSxcbiAgICAgICAgaW5wdXRUeXBlLFxuICAgICAgICB0aGlzLmlucHV0VmFsdWVcbiAgICAgIClcbiAgICApO1xuICAgIHRoaXMuaW5wdXRUeCA9IGNyZWF0ZUlucHV0VHgodGhpcy51bnNwZW50cywgaW5wdXRWYWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0QnVpbGRlcldpdGhVbnNpZ25lZFR4KCk6IHV0eG9saWIuYml0Z28uVXR4b1RyYW5zYWN0aW9uQnVpbGRlciB7XG4gICAgY29uc3QgdHhCdWlsZGVyID0gdXR4b2xpYi5iaXRnby5jcmVhdGVUcmFuc2FjdGlvbkJ1aWxkZXJGb3JOZXR3b3JrKHV0eG9saWIubmV0d29ya3MuYml0Y29pbik7XG4gICAgdGhpcy5pbnB1dFR4Lm91dHMuZm9yRWFjaCgoe30sIGk6IG51bWJlcikgPT4gdHhCdWlsZGVyLmFkZElucHV0KHRoaXMuaW5wdXRUeCwgaSkpO1xuICAgIHRoaXMub3V0cHV0VHlwZXMuZm9yRWFjaCgodW5zcGVudFR5cGUpID0+XG4gICAgICB0eEJ1aWxkZXIuYWRkT3V0cHV0KGNyZWF0ZVNjcmlwdFB1YktleSh0aGlzLndhbGxldEtleXMsIHVuc3BlbnRUeXBlKSwgdGhpcy5pbnB1dFZhbHVlKVxuICAgICk7XG4gICAgcmV0dXJuIHR4QnVpbGRlcjtcbiAgfVxuXG4gIHB1YmxpYyBnZXRVbnNpZ25lZFR4KCk6IHV0eG9saWIuYml0Z28uVXR4b1RyYW5zYWN0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5nZXRCdWlsZGVyV2l0aFVuc2lnbmVkVHgoKS5idWlsZEluY29tcGxldGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTaWduZWRUeCgpOiB1dHhvbGliLlRyYW5zYWN0aW9uIHtcbiAgICBjb25zdCB0eEJ1aWxkZXIgPSB0aGlzLmdldEJ1aWxkZXJXaXRoVW5zaWduZWRUeCgpO1xuICAgIHRoaXMudW5zcGVudHMuZm9yRWFjaCgodW5zcGVudCwgaSkgPT4ge1xuICAgICAgc2lnbklucHV0KHR4QnVpbGRlciwgaSwgdGhpcy53YWxsZXRLZXlzLCB1bnNwZW50LCB0aGlzLnNpZ25LZXlzKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdHhCdWlsZGVyLmJ1aWxkKCk7XG4gIH1cbn1cblxuY29uc3QgcnVuQ29tYmluYXRpb25zID0gKFxuICB7XG4gICAgaW5wdXRUeXBlcyxcbiAgICBtYXhOSW5wdXRzLFxuICAgIG91dHB1dFR5cGVzLFxuICAgIG1heE5PdXRwdXRzLFxuICB9OiB7XG4gICAgaW5wdXRUeXBlczogSW5wdXRTY3JpcHRUeXBlW107XG4gICAgbWF4TklucHV0czogbnVtYmVyO1xuICAgIG91dHB1dFR5cGVzOiBUZXN0VW5zcGVudFR5cGVbXTtcbiAgICBtYXhOT3V0cHV0czogbnVtYmVyO1xuICB9LFxuICBjYWxsYmFjazogKGlucHV0Q29tYm86IElucHV0U2NyaXB0VHlwZVtdLCBvdXRwdXRDb21ibzogVGVzdFVuc3BlbnRUeXBlW10pID0+IHZvaWRcbik6IHZvaWQgPT4ge1xuICAvLyBDcmVhdGUgY29tYmluYXRpb25zIG9mIGRpZmZlcmVudCBpbnB1dCBhbmQgb3V0cHV0IHR5cGVzLiBMZW5ndGggYmV0d2VlbiAxIGFuZCAzLlxuICBjb25zdCBpbnB1dENvbWJpbmF0aW9ucyA9IF8uZmxhdHRlbihcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgWy4uLkFycmF5KG1heE5JbnB1dHMpXS5tYXAoKF9fLCBpKSA9PiBfLmNvbWJpbmF0aW9ucyhpbnB1dFR5cGVzLCBpICsgMSkpXG4gICk7XG4gIGNvbnN0IG91dHB1dENvbWJpbmF0aW9ucyA9IF8uZmxhdHRlbihcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgWy4uLkFycmF5KG1heE5PdXRwdXRzKV0ubWFwKChfXywgaSkgPT4gXy5jb21iaW5hdGlvbnMob3V0cHV0VHlwZXMsIGkgKyAxKSlcbiAgKTtcblxuICBpbnB1dENvbWJpbmF0aW9ucy5mb3JFYWNoKChpbnB1dFR5cGVDb21ibykgPT5cbiAgICBvdXRwdXRDb21iaW5hdGlvbnMuZm9yRWFjaCgob3V0cHV0VHlwZUNvbWJvKSA9PiB7XG4gICAgICBjYWxsYmFjayhpbnB1dFR5cGVDb21ibywgb3V0cHV0VHlwZUNvbWJvKTtcbiAgICB9KVxuICApO1xufTtcblxuY2xhc3MgSGlzdG9ncmFtIHtcbiAgcHVibGljIHRvdGFsID0gMDtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgbWFwOiBNYXA8bnVtYmVyLCBudW1iZXI+ID0gbmV3IE1hcCgpKSB7fVxuXG4gIHB1YmxpYyBhZGQoc2l6ZTogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5tYXAuc2V0KHNpemUsICh0aGlzLm1hcC5nZXQoc2l6ZSkgfHwgMCkgKyAxKTtcbiAgICB0aGlzLnRvdGFsKys7XG4gIH1cblxuICBwdWJsaWMgYXNTb3J0ZWRBcnJheSgpOiBudW1iZXJbXVtdIHtcbiAgICByZXR1cm4gWy4uLnRoaXMubWFwLmVudHJpZXMoKV0uc29ydCgoW2FdLCBbYl0pID0+IGEgLSBiKTtcbiAgfVxuXG4gIHB1YmxpYyBhc0Z1bGxTb3J0ZWRBcnJheSgpOiBudW1iZXJbXVtdIHtcbiAgICByZXR1cm4gXy5yYW5nZSh0aGlzLmdldFBlcmNlbnRpbGUoMCksIHRoaXMuZ2V0UGVyY2VudGlsZSgxKSkubWFwKCh2KSA9PiBbdiwgdGhpcy5tYXAuZ2V0KHYpIHx8IDBdKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRQZXJjZW50aWxlKHA6IG51bWJlcik6IG51bWJlciB7XG4gICAgaWYgKDAgPiBwIHx8IHAgPiAxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHAgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDFgKTtcbiAgICB9XG5cbiAgICBsZXQgc3VtID0gMDtcbiAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiB0aGlzLmFzU29ydGVkQXJyYXkoKSkge1xuICAgICAgc3VtICs9IHY7XG4gICAgICBpZiAoc3VtIC8gdGhpcy50b3RhbCA+PSBwKSB7XG4gICAgICAgIHJldHVybiBrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcignY291bGQgbm90IGZpbmQgcGVyY2VudGlsZScpO1xuICB9XG5cbiAgcHVibGljIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgY29uc3Qga2V5cyA9IFsuLi50aGlzLm1hcC5rZXlzKCldLnNvcnQoKGEsIGIpID0+IGEgLSBiKTtcbiAgICByZXR1cm4gYFske2tleXMubWFwKChrKSA9PiBgWyR7a30sICR7dGhpcy5tYXAuZ2V0KGspfV1gKS5qb2luKCcgJyl9XWA7XG4gIH1cbn1cblxuY29uc3QgZ2V0S2V5VHJpcGxldHMgPSAocHJlZml4OiBzdHJpbmcsIGNvdW50OiBudW1iZXIpID0+XG4gIFsuLi5BcnJheShjb3VudCldLm1hcCgodiwgaSkgPT5cbiAgICBbMSwgMiwgM10ubWFwKChqKSA9PiBiaXAzMi5mcm9tU2VlZChCdWZmZXIuYWxsb2MoMTYsIGAke3ByZWZpeH0vJHtpfS8ke2p9YCksIHV0eG9saWIubmV0d29ya3MuYml0Y29pbikpXG4gICk7XG5cbi8qKlxuICpcbiAqIENhbGxzIGBjYWxsYmFja2Agd2l0aCBhIHZhcmlldHkgb2Ygc2lnbmVkIHR4cywgYmFzZWQgb24gaW5wdXQgcGFyYW1ldGVyc1xuICogQ2FsbGJhY2sgYXJndW1lbnRzIGFyZVxuICogICBpbnB1dFR5cGUsIGlucHV0Q291bnQsIG91dHB1dFR5cGUsIHR4c1xuICogIHdoZXJlIGB0eHNgIGltcGxlbWVudHMgYGZvckVhY2goKWBcbiAqXG4gKiBAcGFyYW0gaW5wdXRUeXBlcyAtIGlucHV0IHR5cGVzIHRvIHRlc3RcbiAqIEBwYXJhbSBuSW5wdXRLZXlUcmlwbGV0cyAtIG51bWJlciBvZiBkaWZmZXJlbnQgaW5wdXQga2V5IHRyaXBsZXMgdG8gY3ljbGUgdGhyb3VnaFxuICogQHBhcmFtIG91dHB1dFR5cGVzIC0gb3V0cHV0IHR5cGVzIHRvIHRlc3RcbiAqIEBwYXJhbSBuT3V0cHV0S2V5VHJpcGxldHMgLSBudW1iZXIgb2YgZGlmZmVyZW50IG91dHB1dCBrZXkgdHJpcGxldHMgdG8gY3ljbGUgdGhyb3VnaFxuICogQHBhcmFtIGNhbGxiYWNrXG4gKi9cbmNvbnN0IHJ1blNpZ25lZFRyYW5zYWN0aW9ucyA9IChcbiAge1xuICAgIGlucHV0VHlwZXMsXG4gICAgbklucHV0S2V5VHJpcGxldHMsXG4gICAgb3V0cHV0VHlwZXMsXG4gICAgbk91dHB1dEtleVRyaXBsZXRzLFxuICB9OiB7XG4gICAgaW5wdXRUeXBlczogQXJyYXk8eyBpbnB1dFR5cGU6IHN0cmluZzsgY291bnQ6IG51bWJlciB9PjtcbiAgICBuSW5wdXRLZXlUcmlwbGV0czogbnVtYmVyO1xuICAgIG91dHB1dFR5cGVzOiBUZXN0VW5zcGVudFR5cGVbXTtcbiAgICBuT3V0cHV0S2V5VHJpcGxldHM6IG51bWJlcjtcbiAgfSxcbiAgY2FsbGJhY2s6IChpbnB1dFR5cGU6IHN0cmluZywgaW5wdXRDb3VudDogbnVtYmVyLCBvdXRwdXRUeXBlOiBUZXN0VW5zcGVudFR5cGUsIHR4czogYW55KSA9PiB2b2lkXG4pOiB2b2lkID0+IHtcbiAgY29uc3QgaW5wdXRLZXlUcmlwbGV0cyA9IGdldEtleVRyaXBsZXRzKCd0ZXN0L2lucHV0LycsIG5JbnB1dEtleVRyaXBsZXRzKTtcbiAgY29uc3Qgb3V0cHV0S2V5VHJpcGxldHMgPSBnZXRLZXlUcmlwbGV0cygndGVzdC9vdXRwdXQvJywgbk91dHB1dEtleVRyaXBsZXRzKTtcbiAgY29uc3Qgb3V0cHV0VmFsdWUgPSAxZTg7XG5cbiAgaW5wdXRUeXBlcy5mb3JFYWNoKCh7IGlucHV0VHlwZSwgY291bnQ6IGlucHV0Q291bnQgfSkgPT4ge1xuICAgIGNvbnN0IGlucHV0VHhzID0gaW5wdXRLZXlUcmlwbGV0cy5tYXAoKGlucHV0S2V5cykgPT4ge1xuICAgICAgY29uc3QgdW5zcGVudHMgPSBbLi4uQXJyYXkoaW5wdXRDb3VudCldLm1hcCgoKSA9PlxuICAgICAgICBjcmVhdGVVbnNwZW50KFxuICAgICAgICAgIGlucHV0S2V5cy5tYXAoKGtleSkgPT4ga2V5LnB1YmxpY0tleSksXG4gICAgICAgICAgaW5wdXRUeXBlLFxuICAgICAgICAgIG91dHB1dFZhbHVlXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgICBjb25zdCBpbnB1dFR4ID0gY3JlYXRlSW5wdXRUeCh1bnNwZW50cywgb3V0cHV0VmFsdWUpO1xuICAgICAgcmV0dXJuIHsgaW5wdXRLZXlzLCB1bnNwZW50cywgaW5wdXRUeCB9O1xuICAgIH0pO1xuXG4gICAgb3V0cHV0VHlwZXMuZm9yRWFjaCgob3V0cHV0VHlwZSkgPT4ge1xuICAgICAgY29uc3Qgb3V0cHV0cyA9IG91dHB1dEtleVRyaXBsZXRzLm1hcCgob3V0cHV0S2V5cykgPT4gY3JlYXRlU2NyaXB0UHViS2V5KG91dHB1dEtleXMsIG91dHB1dFR5cGUpKTtcblxuICAgICAgY29uc3QgdHhzID0ge1xuICAgICAgICBmb3JFYWNoKGNiOiAodHg6IHV0eG9saWIuVHJhbnNhY3Rpb24pID0+IHZvaWQpIHtcbiAgICAgICAgICBpbnB1dFR4cy5mb3JFYWNoKCh7IGlucHV0S2V5cywgdW5zcGVudHMsIGlucHV0VHggfSkgPT4ge1xuICAgICAgICAgICAgb3V0cHV0cy5mb3JFYWNoKChzY3JpcHRQdWJLZXkpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgdHhCdWlsZGVyID0gdXR4b2xpYi5iaXRnby5jcmVhdGVUcmFuc2FjdGlvbkJ1aWxkZXJGb3JOZXR3b3JrKHV0eG9saWIubmV0d29ya3MuYml0Y29pbik7XG4gICAgICAgICAgICAgIGlucHV0VHgub3V0cy5mb3JFYWNoKCh2OiBhbnksIGk6IG51bWJlcikgPT4gdHhCdWlsZGVyLmFkZElucHV0KGlucHV0VHgsIGkpKTtcbiAgICAgICAgICAgICAgdHhCdWlsZGVyLmFkZE91dHB1dChzY3JpcHRQdWJLZXksIG91dHB1dFZhbHVlKTtcbiAgICAgICAgICAgICAgdW5zcGVudHMuZm9yRWFjaCgodW5zcGVudCwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIHNpZ25JbnB1dCh0eEJ1aWxkZXIsIGksIGlucHV0S2V5cywgdW5zcGVudCk7XG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgIGNiKHR4QnVpbGRlci5idWlsZCgpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgY2FsbGJhY2soaW5wdXRUeXBlLCBpbnB1dENvdW50LCBvdXRwdXRUeXBlLCB0eHMpO1xuICAgIH0pO1xuICB9KTtcbn07XG5cbmV4cG9ydCB7IFR4Q29tYm8sIEhpc3RvZ3JhbSwgcnVuQ29tYmluYXRpb25zLCBydW5TaWduZWRUcmFuc2FjdGlvbnMgfTtcbiJdfQ==