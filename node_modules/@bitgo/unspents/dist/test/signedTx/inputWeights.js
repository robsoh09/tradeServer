"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const assert = __importStar(require("assert"));
const utxolib = __importStar(require("@bitgo/utxo-lib"));
const utxo_lib_1 = require("@bitgo/utxo-lib");
const inputWeights_1 = require("../../src/inputWeights");
const scriptSizes_1 = require("../../src/scriptSizes");
const testutils_1 = require("../testutils");
describe('Input Script Sizes (Worst-Case)', function () {
    const keys = [1, 2, 3].map((v) => utxo_lib_1.bip32.fromSeed(Buffer.alloc(16, `test/${v}`)));
    const rootWalletKeys = new utxolib.bitgo.RootWalletKeys([keys[0], keys[1], keys[2]]);
    function getLargestInputWithType(inputType, signKeys, inputCount = 100) {
        const signerName = signKeys[0];
        const cosignerName = signKeys.length > 1 ? signKeys[1] : signerName;
        const inputScriptTypes = Array.from({ length: inputCount }).fill(inputType);
        const outputScriptTypes = [testutils_1.UnspentTypeScript2of3.p2sh];
        return (0, testutils_1.getSignedTransaction)(rootWalletKeys, signerName, cosignerName, inputScriptTypes, outputScriptTypes).ins.reduce((a, b) => ((0, inputWeights_1.getInputWeight)(a) > (0, inputWeights_1.getInputWeight)(b) ? a : b));
    }
    function getInputComponents(input) {
        const decompiled = utxolib.script.decompile(input.script);
        if (!decompiled) {
            throw new Error();
        }
        const script = decompiled.map((v) => {
            if (!Buffer.isBuffer(v)) {
                return { length: 1 };
            }
            return { length: v.length + (0, scriptSizes_1.pushdataEncodingLength)(v.length) };
        });
        const witness = (input.witness || []).map((v) => ({ length: v.length }));
        const scriptSize = script.reduce((a, b) => a + b.length, 0);
        assert.strictEqual(scriptSize, input.script.length, utxolib.script.toASM(decompiled));
        return {
            script: script.map((v) => v.length),
            witness: witness.map((v) => v.length),
        };
    }
    function runTestComponentSizes(inputType, signKeys) {
        const signKeysStr = signKeys.join(',');
        describe(`inputType=${inputType} signKeys=${signKeysStr}`, function () {
            it(`component sizes`, function () {
                this.timeout(10000);
                let expectedComponents;
                switch (inputType) {
                    case 'p2sh':
                        expectedComponents = inputWeights_1.inputComponentsP2sh;
                        break;
                    case 'p2shP2wsh':
                        expectedComponents = inputWeights_1.inputComponentsP2shP2wsh;
                        break;
                    case 'p2wsh':
                        expectedComponents = inputWeights_1.inputComponentsP2wsh;
                        break;
                    case 'p2shP2pk':
                        expectedComponents = inputWeights_1.inputComponentsP2shP2pk;
                        break;
                    case 'p2tr':
                        if (signKeys[1] === 'bitgo') {
                            expectedComponents = inputWeights_1.inputComponentsP2trScriptSpendLevel1;
                        }
                        else if (signKeys[1] === 'backup') {
                            expectedComponents = inputWeights_1.inputComponentsP2trScriptSpendLevel2;
                        }
                        else {
                            throw new Error(`unexpected cosigner`);
                        }
                        break;
                    case 'p2trMusig2':
                        // assumes only script path
                        expectedComponents = inputWeights_1.inputComponentsP2trScriptSpendLevel1;
                        break;
                    case 'taprootKeyPathSpend':
                        expectedComponents = inputWeights_1.inputComponentsP2trKeySpend;
                        break;
                    default:
                        throw new Error(`invalid inputType ${inputType}`);
                }
                const input = getLargestInputWithType(inputType, signKeys, inputType === 'p2tr' || inputType === 'p2trMusig2' || inputType === 'taprootKeyPathSpend' ? 10 : 100);
                const components = getInputComponents(input);
                assert.deepStrictEqual(components, expectedComponents);
                assert.strictEqual((0, inputWeights_1.getInputComponentsWeight)(components), (0, inputWeights_1.getInputWeight)(input));
            });
        });
    }
    (0, testutils_1.getInputScriptTypes)().forEach((inputType) => {
        if (inputType !== 'p2trMusig2') {
            runTestComponentSizes(inputType, inputType === 'p2shP2pk' ? ['user'] : ['user', 'bitgo']);
        }
        if (inputType !== 'p2shP2pk' && inputType !== 'taprootKeyPathSpend') {
            runTestComponentSizes(inputType, ['user', 'backup']);
        }
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXRXZWlnaHRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdGVzdC9zaWduZWRUeC9pbnB1dFdlaWdodHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtDQUFpQztBQUdqQyx5REFBMkM7QUFDM0MsOENBQXdEO0FBQ3hELHlEQVdnQztBQUNoQyx1REFBK0Q7QUFDL0QsNENBTXNCO0FBRXRCLFFBQVEsQ0FBQyxpQ0FBaUMsRUFBRTtJQUMxQyxNQUFNLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxnQkFBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBcUIsQ0FBQztJQUNyRyxNQUFNLGNBQWMsR0FBRyxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXJGLFNBQVMsdUJBQXVCLENBQzlCLFNBQWlCLEVBQ2pCLFFBQWlDLEVBQ2pDLFVBQVUsR0FBRyxHQUFHO1FBRWhCLE1BQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQixNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7UUFDcEUsTUFBTSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FB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Q0FBQztJQUVELElBQUEsK0JBQW1CLEdBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFpQixFQUFFLEVBQUU7UUFDbEQsSUFBSSxTQUFTLEtBQUssWUFBWSxFQUFFO1lBQzlCLHFCQUFxQixDQUFDLFNBQVMsRUFBRSxTQUFTLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzNGO1FBQ0QsSUFBSSxTQUFTLEtBQUssVUFBVSxJQUFJLFNBQVMsS0FBSyxxQkFBcUIsRUFBRTtZQUNuRSxxQkFBcUIsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztTQUN0RDtJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSAnYXNzZXJ0JztcblxuaW1wb3J0ICogYXMgbW9jaGEgZnJvbSAnbW9jaGEnO1xuaW1wb3J0ICogYXMgdXR4b2xpYiBmcm9tICdAYml0Z28vdXR4by1saWInO1xuaW1wb3J0IHsgYmlwMzIsIEJJUDMySW50ZXJmYWNlIH0gZnJvbSAnQGJpdGdvL3V0eG8tbGliJztcbmltcG9ydCB7XG4gIGdldElucHV0Q29tcG9uZW50c1dlaWdodCxcbiAgZ2V0SW5wdXRXZWlnaHQsXG4gIElucHV0Q29tcG9uZW50cyxcbiAgaW5wdXRDb21wb25lbnRzUDJzaCxcbiAgaW5wdXRDb21wb25lbnRzUDJzaFAycGssXG4gIGlucHV0Q29tcG9uZW50c1Ayc2hQMndzaCxcbiAgaW5wdXRDb21wb25lbnRzUDJ0cktleVNwZW5kLFxuICBpbnB1dENvbXBvbmVudHNQMnRyU2NyaXB0U3BlbmRMZXZlbDEsXG4gIGlucHV0Q29tcG9uZW50c1AydHJTY3JpcHRTcGVuZExldmVsMixcbiAgaW5wdXRDb21wb25lbnRzUDJ3c2gsXG59IGZyb20gJy4uLy4uL3NyYy9pbnB1dFdlaWdodHMnO1xuaW1wb3J0IHsgcHVzaGRhdGFFbmNvZGluZ0xlbmd0aCB9IGZyb20gJy4uLy4uL3NyYy9zY3JpcHRTaXplcyc7XG5pbXBvcnQge1xuICBnZXRJbnB1dFNjcmlwdFR5cGVzLFxuICBnZXRTaWduZWRUcmFuc2FjdGlvbixcbiAgSW5wdXRTY3JpcHRUeXBlLFxuICBUZXN0VW5zcGVudFR5cGUsXG4gIFVuc3BlbnRUeXBlU2NyaXB0Mm9mMyxcbn0gZnJvbSAnLi4vdGVzdHV0aWxzJztcblxuZGVzY3JpYmUoJ0lucHV0IFNjcmlwdCBTaXplcyAoV29yc3QtQ2FzZSknLCBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IGtleXMgPSBbMSwgMiwgM10ubWFwKCh2KSA9PiBiaXAzMi5mcm9tU2VlZChCdWZmZXIuYWxsb2MoMTYsIGB0ZXN0LyR7dn1gKSkpIGFzIEJJUDMySW50ZXJmYWNlW107XG4gIGNvbnN0IHJvb3RXYWxsZXRLZXlzID0gbmV3IHV0eG9saWIuYml0Z28uUm9vdFdhbGxldEtleXMoW2tleXNbMF0sIGtleXNbMV0sIGtleXNbMl1dKTtcblxuICBmdW5jdGlvbiBnZXRMYXJnZXN0SW5wdXRXaXRoVHlwZShcbiAgICBpbnB1dFR5cGU6IHN0cmluZyxcbiAgICBzaWduS2V5czogdXR4b2xpYi5iaXRnby5LZXlOYW1lW10sXG4gICAgaW5wdXRDb3VudCA9IDEwMFxuICApOiB1dHhvbGliLlR4SW5wdXQge1xuICAgIGNvbnN0IHNpZ25lck5hbWUgPSBzaWduS2V5c1swXTtcbiAgICBjb25zdCBjb3NpZ25lck5hbWUgPSBzaWduS2V5cy5sZW5ndGggPiAxID8gc2lnbktleXNbMV0gOiBzaWduZXJOYW1lO1xuICAgIGNvbnN0IGlucHV0U2NyaXB0VHlwZXMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBpbnB1dENvdW50IH0pLmZpbGwoaW5wdXRUeXBlKSBhcyBJbnB1dFNjcmlwdFR5cGVbXTtcbiAgICBjb25zdCBvdXRwdXRTY3JpcHRUeXBlcyA9IFtVbnNwZW50VHlwZVNjcmlwdDJvZjMucDJzaF0gYXMgVGVzdFVuc3BlbnRUeXBlW107XG4gICAgcmV0dXJuIGdldFNpZ25lZFRyYW5zYWN0aW9uKFxuICAgICAgcm9vdFdhbGxldEtleXMsXG4gICAgICBzaWduZXJOYW1lLFxuICAgICAgY29zaWduZXJOYW1lLFxuICAgICAgaW5wdXRTY3JpcHRUeXBlcyxcbiAgICAgIG91dHB1dFNjcmlwdFR5cGVzXG4gICAgKS5pbnMucmVkdWNlKChhLCBiKSA9PiAoZ2V0SW5wdXRXZWlnaHQoYSkgPiBnZXRJbnB1dFdlaWdodChiKSA/IGEgOiBiKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRJbnB1dENvbXBvbmVudHMoaW5wdXQ6IHV0eG9saWIuVHhJbnB1dCk6IElucHV0Q29tcG9uZW50cyB7XG4gICAgY29uc3QgZGVjb21waWxlZCA9IHV0eG9saWIuc2NyaXB0LmRlY29tcGlsZShpbnB1dC5zY3JpcHQpO1xuICAgIGlmICghZGVjb21waWxlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2NyaXB0ID0gZGVjb21waWxlZC5tYXAoKHYpID0+IHtcbiAgICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKHYpKSB7XG4gICAgICAgIHJldHVybiB7IGxlbmd0aDogMSB9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHsgbGVuZ3RoOiB2Lmxlbmd0aCArIHB1c2hkYXRhRW5jb2RpbmdMZW5ndGgodi5sZW5ndGgpIH07XG4gICAgfSk7XG4gICAgY29uc3Qgd2l0bmVzcyA9IChpbnB1dC53aXRuZXNzIHx8IFtdKS5tYXAoKHYpID0+ICh7IGxlbmd0aDogdi5sZW5ndGggfSkpO1xuXG4gICAgY29uc3Qgc2NyaXB0U2l6ZSA9IHNjcmlwdC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLmxlbmd0aCwgMCk7XG4gICAgYXNzZXJ0LnN0cmljdEVxdWFsKHNjcmlwdFNpemUsIGlucHV0LnNjcmlwdC5sZW5ndGgsIHV0eG9saWIuc2NyaXB0LnRvQVNNKGRlY29tcGlsZWQpKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzY3JpcHQ6IHNjcmlwdC5tYXAoKHYpID0+IHYubGVuZ3RoKSxcbiAgICAgIHdpdG5lc3M6IHdpdG5lc3MubWFwKCh2KSA9PiB2Lmxlbmd0aCksXG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJ1blRlc3RDb21wb25lbnRTaXplcyhpbnB1dFR5cGU6IHN0cmluZywgc2lnbktleXM6IHV0eG9saWIuYml0Z28uS2V5TmFtZVtdKSB7XG4gICAgY29uc3Qgc2lnbktleXNTdHIgPSBzaWduS2V5cy5qb2luKCcsJyk7XG5cbiAgICBkZXNjcmliZShgaW5wdXRUeXBlPSR7aW5wdXRUeXBlfSBzaWduS2V5cz0ke3NpZ25LZXlzU3RyfWAsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGl0KGBjb21wb25lbnQgc2l6ZXNgLCBmdW5jdGlvbiAodGhpczogbW9jaGEuQ29udGV4dCkge1xuICAgICAgICB0aGlzLnRpbWVvdXQoMTBfMDAwKTtcbiAgICAgICAgbGV0IGV4cGVjdGVkQ29tcG9uZW50cztcbiAgICAgICAgc3dpdGNoIChpbnB1dFR5cGUpIHtcbiAgICAgICAgICBjYXNlICdwMnNoJzpcbiAgICAgICAgICAgIGV4cGVjdGVkQ29tcG9uZW50cyA9IGlucHV0Q29tcG9uZW50c1Ayc2g7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdwMnNoUDJ3c2gnOlxuICAgICAgICAgICAgZXhwZWN0ZWRDb21wb25lbnRzID0gaW5wdXRDb21wb25lbnRzUDJzaFAyd3NoO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAncDJ3c2gnOlxuICAgICAgICAgICAgZXhwZWN0ZWRDb21wb25lbnRzID0gaW5wdXRDb21wb25lbnRzUDJ3c2g7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdwMnNoUDJwayc6XG4gICAgICAgICAgICBleHBlY3RlZENvbXBvbmVudHMgPSBpbnB1dENvbXBvbmVudHNQMnNoUDJwaztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ3AydHInOlxuICAgICAgICAgICAgaWYgKHNpZ25LZXlzWzFdID09PSAnYml0Z28nKSB7XG4gICAgICAgICAgICAgIGV4cGVjdGVkQ29tcG9uZW50cyA9IGlucHV0Q29tcG9uZW50c1AydHJTY3JpcHRTcGVuZExldmVsMTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2lnbktleXNbMV0gPT09ICdiYWNrdXAnKSB7XG4gICAgICAgICAgICAgIGV4cGVjdGVkQ29tcG9uZW50cyA9IGlucHV0Q29tcG9uZW50c1AydHJTY3JpcHRTcGVuZExldmVsMjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZCBjb3NpZ25lcmApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAncDJ0ck11c2lnMic6XG4gICAgICAgICAgICAvLyBhc3N1bWVzIG9ubHkgc2NyaXB0IHBhdGhcbiAgICAgICAgICAgIGV4cGVjdGVkQ29tcG9uZW50cyA9IGlucHV0Q29tcG9uZW50c1AydHJTY3JpcHRTcGVuZExldmVsMTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ3RhcHJvb3RLZXlQYXRoU3BlbmQnOlxuICAgICAgICAgICAgZXhwZWN0ZWRDb21wb25lbnRzID0gaW5wdXRDb21wb25lbnRzUDJ0cktleVNwZW5kO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBpbnB1dFR5cGUgJHtpbnB1dFR5cGV9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpbnB1dCA9IGdldExhcmdlc3RJbnB1dFdpdGhUeXBlKFxuICAgICAgICAgIGlucHV0VHlwZSxcbiAgICAgICAgICBzaWduS2V5cyxcbiAgICAgICAgICBpbnB1dFR5cGUgPT09ICdwMnRyJyB8fCBpbnB1dFR5cGUgPT09ICdwMnRyTXVzaWcyJyB8fCBpbnB1dFR5cGUgPT09ICd0YXByb290S2V5UGF0aFNwZW5kJyA/IDEwIDogMTAwXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGNvbXBvbmVudHMgPSBnZXRJbnB1dENvbXBvbmVudHMoaW5wdXQpO1xuICAgICAgICBhc3NlcnQuZGVlcFN0cmljdEVxdWFsKGNvbXBvbmVudHMsIGV4cGVjdGVkQ29tcG9uZW50cyk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChnZXRJbnB1dENvbXBvbmVudHNXZWlnaHQoY29tcG9uZW50cyksIGdldElucHV0V2VpZ2h0KGlucHV0KSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldElucHV0U2NyaXB0VHlwZXMoKS5mb3JFYWNoKChpbnB1dFR5cGU6IHN0cmluZykgPT4ge1xuICAgIGlmIChpbnB1dFR5cGUgIT09ICdwMnRyTXVzaWcyJykge1xuICAgICAgcnVuVGVzdENvbXBvbmVudFNpemVzKGlucHV0VHlwZSwgaW5wdXRUeXBlID09PSAncDJzaFAycGsnID8gWyd1c2VyJ10gOiBbJ3VzZXInLCAnYml0Z28nXSk7XG4gICAgfVxuICAgIGlmIChpbnB1dFR5cGUgIT09ICdwMnNoUDJwaycgJiYgaW5wdXRUeXBlICE9PSAndGFwcm9vdEtleVBhdGhTcGVuZCcpIHtcbiAgICAgIHJ1blRlc3RDb21wb25lbnRTaXplcyhpbnB1dFR5cGUsIFsndXNlcicsICdiYWNrdXAnXSk7XG4gICAgfVxuICB9KTtcbn0pO1xuIl19