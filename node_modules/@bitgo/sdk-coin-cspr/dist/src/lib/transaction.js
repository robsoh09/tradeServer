"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Transaction = void 0;
const _ = __importStar(require("lodash"));
const casper_js_sdk_1 = require("casper-js-sdk");
const sdk_core_1 = require("@bitgo/sdk-core");
const keyPair_1 = require("./keyPair");
const constants_1 = require("./constants");
const utils_1 = require("./utils");
class Transaction extends sdk_core_1.BaseTransaction {
    constructor(_coinConfig) {
        super(_coinConfig);
    }
    /** @inheritdoc */
    canSign(key) {
        return true;
    }
    sign(keyPair) {
        const keys = keyPair.getKeys();
        if (!keys.prv) {
            throw new sdk_core_1.SigningError('Missing private key');
        }
        if (this._deploy.approvals.some((ap) => !ap.signer.startsWith(constants_1.SECP256K1_PREFIX) || !(0, utils_1.isValidPublicKey)((0, utils_1.removeAlgoPrefixFromHexValue)(ap.signer)))) {
            throw new sdk_core_1.SigningError('Invalid deploy. Already signed with an invalid key');
        }
        const secpKeys = new casper_js_sdk_1.Keys.Secp256K1(Uint8Array.from(Buffer.from(keys.pub, 'hex')), Uint8Array.from(Buffer.from(keys.prv, 'hex')));
        const signedDeploy = casper_js_sdk_1.DeployUtil.signDeploy(this._deploy, secpKeys);
        this._signatures.push(signedDeploy.approvals[signedDeploy.approvals.length - 1].signature);
    }
    /**
     * Add a signature to this transaction and to and its deploy
     *
     * @param {string} signature The signature to add, in string hex format
     * @param {KeyPair} keyPair The key pair that created the signature
     */
    addSignature(signature, keyPair) {
        const pub = keyPair.getKeys().pub;
        const signatureBuffer = Uint8Array.from(Buffer.from(signature, 'hex'));
        const pubKeyBuffer = Uint8Array.from(Buffer.from(pub, 'hex'));
        const parsedPublicKey = casper_js_sdk_1.Keys.Secp256K1.parsePublicKey(pubKeyBuffer, 'raw');
        const pubKeyHex = casper_js_sdk_1.Keys.Secp256K1.accountHex(parsedPublicKey);
        if ((0, utils_1.removeAlgoPrefixFromHexValue)(pubKeyHex) !== pub) {
            throw new sdk_core_1.SigningError('Signer does not match signature');
        }
        const signedDeploy = casper_js_sdk_1.DeployUtil.setSignature(this._deploy, signatureBuffer, casper_js_sdk_1.CLPublicKey.fromSecp256K1(parsedPublicKey));
        const approval = _.last(signedDeploy.approvals);
        if ((0, utils_1.removeAlgoPrefixFromHexValue)(approval.signature) !== signature) {
            throw new sdk_core_1.SigningError('Invalid signature');
        }
        this._signatures.push(signature);
    }
    /** @inheritdoc */
    toBroadcastFormat() {
        if (!this.casperTx) {
            throw new sdk_core_1.InvalidTransactionError('Empty transaction');
        }
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const txJson = casper_js_sdk_1.DeployUtil.deployToJson(this.casperTx);
        // The new casper lib is converting the TTL from miliseconds to another date format, in this case 1 day
        // we need to leave it as ms for the HSM to be able to parse it
        txJson.deploy.header.ttl = `${this.casperTx.header.ttl}ms`;
        this.setOwnersInJson(txJson);
        this.setTransfersFieldsInJson(txJson);
        this.setDelegateFieldsInJson(txJson);
        return JSON.stringify(txJson);
    }
    /** @inheritdoc */
    toJson() {
        var _a;
        const deployPayment = (_a = this._deploy.payment.asModuleBytes()) === null || _a === void 0 ? void 0 : _a.getArgByName('amount');
        if (!deployPayment) {
            throw new sdk_core_1.InvalidTransactionError('Undefined fee');
        }
        const owner1Index = 0;
        const owner2Index = 1;
        const owner3Index = 2;
        const sourcePublicKey = Buffer.from(this._deploy.header.account.value()).toString('hex');
        const sourceAddress = new keyPair_1.KeyPair({ pub: sourcePublicKey }).getAddress();
        const result = {
            hash: Buffer.from(this._deploy.hash).toString('hex'),
            fee: { gasLimit: deployPayment.value().toString(), gasPrice: this._deploy.header.gasPrice.toString() },
            from: sourceAddress,
            startTime: new Date(this._deploy.header.timestamp).toISOString(),
            expiration: this._deploy.header.ttl,
            deployType: this._deploy.session.getArgByName(constants_1.TRANSACTION_TYPE).value(),
        };
        const transactionType = (0, utils_1.getDeployType)(this._deploy.session);
        switch (transactionType) {
            case sdk_core_1.TransactionType.Send:
                result.to = (0, utils_1.getTransferDestinationAddress)(this._deploy.session);
                result.amount = (0, utils_1.getTransferAmount)(this._deploy.session);
                result.transferId = (0, utils_1.getTransferId)(this._deploy.session);
                break;
            case sdk_core_1.TransactionType.WalletInitialization:
                result.owner1 = this.casperTx.session.getArgByName(constants_1.OWNER_PREFIX + owner1Index).value();
                result.owner2 = this.casperTx.session.getArgByName(constants_1.OWNER_PREFIX + owner2Index).value();
                result.owner3 = this.casperTx.session.getArgByName(constants_1.OWNER_PREFIX + owner3Index).value();
                break;
            case sdk_core_1.TransactionType.StakingLock:
                result.fromDelegate = (0, utils_1.getDelegatorAddress)(this.casperTx.session);
                result.validator = (0, utils_1.getValidatorAddress)(this.casperTx.session);
                result.amount = (0, utils_1.getDelegateAmount)(this.casperTx.session);
                break;
            case sdk_core_1.TransactionType.StakingUnlock:
                result.fromDelegate = (0, utils_1.getDelegatorAddress)(this.casperTx.session);
                result.validator = (0, utils_1.getValidatorAddress)(this.casperTx.session);
                result.amount = (0, utils_1.getDelegateAmount)(this.casperTx.session);
                break;
        }
        return result;
    }
    /**
     * Set the transaction type
     *
     * @param {TransactionType} transactionType The transaction type to be set
     */
    setTransactionType(transactionType) {
        this._type = transactionType;
    }
    /**
     * Retrieve signatures from the deploy instance and load them into the signatures list
     */
    loadPreviousSignatures() {
        if (this._deploy.approvals && this._deploy.approvals.length > 0) {
            this._deploy.approvals.forEach((approval) => {
                this._signatures.push(approval.signature);
            });
        }
    }
    /**
     * Set owners inside a json representing a wallet initialization tx.
     *
     * @param {Record<string, any>} txJson json to modify
     */
    setOwnersInJson(txJson) {
        if ((0, utils_1.getDeployType)(this.casperTx.session) === sdk_core_1.TransactionType.WalletInitialization) {
            const argName = 0;
            const argValue = 1;
            const owner0 = 0;
            const owner1 = 1;
            const owner2 = 2;
            const ownersValues = new Map();
            ownersValues.set(constants_1.TRANSACTION_TYPE, this.casperTx.session.getArgByName(constants_1.TRANSACTION_TYPE).value());
            [owner0, owner1, owner2].forEach((index) => {
                ownersValues.set(constants_1.OWNER_PREFIX + index, this.casperTx.session.getArgByName(constants_1.OWNER_PREFIX + index).value());
            });
            txJson['deploy']['session']['ModuleBytes']['args'].forEach((arg) => {
                if (ownersValues.has(arg[argName])) {
                    arg[argValue]['parsed'] = ownersValues.get(arg[argName]);
                }
            });
        }
    }
    /**
     * Set transfer fields inside a json representing a transfer tx.
     *
     * @param {Record<string, any>} txJson json to modify
     */
    setTransfersFieldsInJson(txJson) {
        if ((0, utils_1.getDeployType)(this.casperTx.session) === sdk_core_1.TransactionType.Send) {
            const argName = 0;
            const argValue = 1;
            const transferValues = new Map();
            transferValues.set(constants_1.TRANSACTION_TYPE, this.casperTx.session.getArgByName(constants_1.TRANSACTION_TYPE).value());
            transferValues.set('amount', (0, utils_1.getTransferAmount)(this.casperTx.session));
            transferValues.set('to_address', (0, utils_1.getTransferDestinationAddress)(this.casperTx.session));
            const transferId = (0, utils_1.getTransferId)(this.casperTx.session);
            if (transferId !== undefined) {
                transferValues.set('id', transferId.toString());
            }
            txJson['deploy']['session']['Transfer']['args'].forEach((arg) => {
                if (transferValues.has(arg[argName])) {
                    arg[argValue]['parsed'] = transferValues.get(arg[argName]);
                }
            });
        }
    }
    /**
     * Set delegate / undelegate fields inside a json representing the tx.
     *
     * @param {Record<string, any>} txJson json to modify
     */
    setDelegateFieldsInJson(txJson) {
        if ((0, utils_1.getDeployType)(this.casperTx.session) === sdk_core_1.TransactionType.StakingLock ||
            (0, utils_1.getDeployType)(this.casperTx.session) === sdk_core_1.TransactionType.StakingUnlock) {
            const argName = 0;
            const argValue = 1;
            const delegateValues = new Map();
            delegateValues.set(constants_1.TRANSACTION_TYPE, this.casperTx.session.getArgByName(constants_1.TRANSACTION_TYPE).value());
            delegateValues.set('amount', (0, utils_1.getDelegateAmount)(this.casperTx.session));
            delegateValues.set(constants_1.DELEGATE_FROM_ADDRESS, (0, utils_1.getDelegatorAddress)(this.casperTx.session));
            delegateValues.set(constants_1.DELEGATE_VALIDATOR, (0, utils_1.getValidatorAddress)(this.casperTx.session));
            txJson.deploy.session.ModuleBytes.args.forEach((arg) => {
                if (delegateValues.has(arg[argName])) {
                    arg[argValue]['parsed'] = delegateValues.get(arg[argName]);
                }
            });
        }
    }
    get casperTx() {
        return this._deploy;
    }
    set casperTx(deploy) {
        this._deploy = deploy;
    }
}
exports.Transaction = Transaction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3RyYW5zYWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMENBQTRCO0FBRTVCLGlEQUE2RjtBQUM3Riw4Q0FBbUg7QUFDbkgsdUNBQW9DO0FBRXBDLDJDQU1xQjtBQUNyQixtQ0FVaUI7QUFFakIsTUFBYSxXQUFZLFNBQVEsMEJBQWU7SUFJOUMsWUFBWSxXQUFpQztRQUMzQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQUVELGtCQUFrQjtJQUNsQixPQUFPLENBQUMsR0FBWTtRQUNsQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxJQUFJLENBQUMsT0FBZ0I7UUFDbkIsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ2IsTUFBTSxJQUFJLHVCQUFZLENBQUMscUJBQXFCLENBQUMsQ0FBQztTQUMvQztRQUNELElBQ0UsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUN6QixDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyw0QkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBQSx3QkFBZ0IsRUFBQyxJQUFBLG9DQUE0QixFQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUM5RyxFQUNEO1lBQ0EsTUFBTSxJQUFJLHVCQUFZLENBQUMsb0RBQW9ELENBQUMsQ0FBQztTQUM5RTtRQUNELE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQUksQ0FBQyxTQUFTLENBQ2pDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFD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QyxRQUFRLENBQUMsR0FBRyxjQUFjLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2lCQUM1RDtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxJQUFJLFFBQVEsQ0FBQyxNQUF5QjtRQUNwQyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUN4QixDQUFDO0NBR0Y7QUFoUEQsa0NBZ1BDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgQmFzZUNvaW4gYXMgQ29pbkNvbmZpZyB9IGZyb20gJ0BiaXRnby9zdGF0aWNzJztcbmltcG9ydCB7IENMUHVibGljS2V5IGFzIFB1YmxpY0tleSwgRGVwbG95VXRpbCwgS2V5cywgQ0xTdHJpbmcsIENMVTUxMiB9IGZyb20gJ2Nhc3Blci1qcy1zZGsnO1xuaW1wb3J0IHsgQmFzZUtleSwgQmFzZVRyYW5zYWN0aW9uLCBUcmFuc2FjdGlvblR5cGUsIEludmFsaWRUcmFuc2FjdGlvbkVycm9yLCBTaWduaW5nRXJyb3IgfSBmcm9tICdAYml0Z28vc2RrLWNvcmUnO1xuaW1wb3J0IHsgS2V5UGFpciB9IGZyb20gJy4va2V5UGFpcic7XG5pbXBvcnQgeyBDYXNwZXJUcmFuc2FjdGlvbiB9IGZyb20gJy4vaWZhY2VzJztcbmltcG9ydCB7XG4gIERFTEVHQVRFX0ZST01fQUREUkVTUyxcbiAgREVMRUdBVEVfVkFMSURBVE9SLFxuICBPV05FUl9QUkVGSVgsXG4gIFNFQ1AyNTZLMV9QUkVGSVgsXG4gIFRSQU5TQUNUSU9OX1RZUEUsXG59IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7XG4gIGdldFRyYW5zZmVyQW1vdW50LFxuICBnZXRUcmFuc2ZlckRlc3RpbmF0aW9uQWRkcmVzcyxcbiAgZ2V0VHJhbnNmZXJJZCxcbiAgaXNWYWxpZFB1YmxpY0tleSxcbiAgcmVtb3ZlQWxnb1ByZWZpeEZyb21IZXhWYWx1ZSxcbiAgZ2V0RGVwbG95VHlwZSxcbiAgZ2V0RGVsZWdhdG9yQWRkcmVzcyxcbiAgZ2V0VmFsaWRhdG9yQWRkcmVzcyxcbiAgZ2V0RGVsZWdhdGVBbW91bnQsXG59IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgY2xhc3MgVHJhbnNhY3Rpb24gZXh0ZW5kcyBCYXNlVHJhbnNhY3Rpb24ge1xuICBwcm90ZWN0ZWQgX3R5cGU6IFRyYW5zYWN0aW9uVHlwZTtcbiAgcHJvdGVjdGVkIF9kZXBsb3k6IERlcGxveVV0aWwuRGVwbG95O1xuXG4gIGNvbnN0cnVjdG9yKF9jb2luQ29uZmlnOiBSZWFkb25seTxDb2luQ29uZmlnPikge1xuICAgIHN1cGVyKF9jb2luQ29uZmlnKTtcbiAgfVxuXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICBjYW5TaWduKGtleTogQmFzZUtleSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgc2lnbihrZXlQYWlyOiBLZXlQYWlyKTogdm9pZCB7XG4gICAgY29uc3Qga2V5cyA9IGtleVBhaXIuZ2V0S2V5cygpO1xuICAgIGlmICgha2V5cy5wcnYpIHtcbiAgICAgIHRocm93IG5ldyBTaWduaW5nRXJyb3IoJ01pc3NpbmcgcHJpdmF0ZSBrZXknKTtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgdGhpcy5fZGVwbG95LmFwcHJvdmFscy5zb21lKFxuICAgICAgICAoYXApID0+ICFhcC5zaWduZXIuc3RhcnRzV2l0aChTRUNQMjU2SzFfUFJFRklYKSB8fCAhaXNWYWxpZFB1YmxpY0tleShyZW1vdmVBbGdvUHJlZml4RnJvbUhleFZhbHVlKGFwLnNpZ25lcikpXG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgU2lnbmluZ0Vycm9yKCdJbnZhbGlkIGRlcGxveS4gQWxyZWFkeSBzaWduZWQgd2l0aCBhbiBpbnZhbGlkIGtleScpO1xuICAgIH1cbiAgICBjb25zdCBzZWNwS2V5cyA9IG5ldyBLZXlzLlNlY3AyNTZLMShcbiAgICAgIFVpbnQ4QXJyYXkuZnJvbShCdWZmZXIuZnJvbShrZXlzLnB1YiwgJ2hleCcpKSxcbiAgICAgIFVpbnQ4QXJyYXkuZnJvbShCdWZmZXIuZnJvbShrZXlzLnBydiwgJ2hleCcpKVxuICAgICk7XG4gICAgY29uc3Qgc2lnbmVkRGVwbG95ID0gRGVwbG95VXRpbC5zaWduRGVwbG95KHRoaXMuX2RlcGxveSwgc2VjcEtleXMpO1xuICAgIHRoaXMuX3NpZ25hdHVyZXMucHVzaChzaWduZWREZXBsb3kuYXBwcm92YWxzW3NpZ25lZERlcGxveS5hcHByb3ZhbHMubGVuZ3RoIC0gMV0uc2lnbmF0dXJlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBzaWduYXR1cmUgdG8gdGhpcyB0cmFuc2FjdGlvbiBhbmQgdG8gYW5kIGl0cyBkZXBsb3lcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNpZ25hdHVyZSBUaGUgc2lnbmF0dXJlIHRvIGFkZCwgaW4gc3RyaW5nIGhleCBmb3JtYXRcbiAgICogQHBhcmFtIHtLZXlQYWlyfSBrZXlQYWlyIFRoZSBrZXkgcGFpciB0aGF0IGNyZWF0ZWQgdGhlIHNpZ25hdHVyZVxuICAgKi9cbiAgYWRkU2lnbmF0dXJlKHNpZ25hdHVyZTogc3RyaW5nLCBrZXlQYWlyOiBLZXlQYWlyKTogdm9pZCB7XG4gICAgY29uc3QgcHViID0ga2V5UGFpci5nZXRLZXlzKCkucHViO1xuICAgIGNvbnN0IHNpZ25hdHVyZUJ1ZmZlciA9IFVpbnQ4QXJyYXkuZnJvbShCdWZmZXIuZnJvbShzaWduYXR1cmUsICdoZXgnKSk7XG4gICAgY29uc3QgcHViS2V5QnVmZmVyID0gVWludDhBcnJheS5mcm9tKEJ1ZmZlci5mcm9tKHB1YiwgJ2hleCcpKTtcbiAgICBjb25zdCBwYXJzZWRQdWJsaWNLZXkgPSBLZXlzLlNlY3AyNTZLMS5wYXJzZVB1YmxpY0tleShwdWJLZXlCdWZmZXIsICdyYXcnKTtcbiAgICBjb25zdCBwdWJLZXlIZXggPSBLZXlzLlNlY3AyNTZLMS5hY2NvdW50SGV4KHBhcnNlZFB1YmxpY0tleSk7XG4gICAgaWYgKHJlbW92ZUFsZ29QcmVmaXhGcm9tSGV4VmFsdWUocHViS2V5SGV4KSAhPT0gcHViKSB7XG4gICAgICB0aHJvdyBuZXcgU2lnbmluZ0Vycm9yKCdTaWduZXIgZG9lcyBub3QgbWF0Y2ggc2lnbmF0dXJlJyk7XG4gICAgfVxuICAgIGNvbnN0IHNpZ25lZERlcGxveSA9IERlcGxveVV0aWwuc2V0U2lnbmF0dXJlKFxuICAgICAgdGhpcy5fZGVwbG95LFxuICAgICAgc2lnbmF0dXJlQnVmZmVyLFxuICAgICAgUHVibGljS2V5LmZyb21TZWNwMjU2SzEocGFyc2VkUHVibGljS2V5KVxuICAgICk7XG4gICAgY29uc3QgYXBwcm92YWwgPSBfLmxhc3Qoc2lnbmVkRGVwbG95LmFwcHJvdmFscykgYXMgRGVwbG95VXRpbC5BcHByb3ZhbDtcbiAgICBpZiAocmVtb3ZlQWxnb1ByZWZpeEZyb21IZXhWYWx1ZShhcHByb3ZhbC5zaWduYXR1cmUpICE9PSBzaWduYXR1cmUpIHtcbiAgICAgIHRocm93IG5ldyBTaWduaW5nRXJyb3IoJ0ludmFsaWQgc2lnbmF0dXJlJyk7XG4gICAgfVxuICAgIHRoaXMuX3NpZ25hdHVyZXMucHVzaChzaWduYXR1cmUpO1xuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHRvQnJvYWRjYXN0Rm9ybWF0KCk6IHN0cmluZyB7XG4gICAgaWYgKCF0aGlzLmNhc3BlclR4KSB7XG4gICAgICB0aHJvdyBuZXcgSW52YWxpZFRyYW5zYWN0aW9uRXJyb3IoJ0VtcHR5IHRyYW5zYWN0aW9uJyk7XG4gICAgfVxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgY29uc3QgdHhKc29uOiBhbnkgPSBEZXBsb3lVdGlsLmRlcGxveVRvSnNvbih0aGlzLmNhc3BlclR4KTtcbiAgICAvLyBUaGUgbmV3IGNhc3BlciBsaWIgaXMgY29udmVydGluZyB0aGUgVFRMIGZyb20gbWlsaXNlY29uZHMgdG8gYW5vdGhlciBkYXRlIGZvcm1hdCwgaW4gdGhpcyBjYXNlIDEgZGF5XG4gICAgLy8gd2UgbmVlZCB0byBsZWF2ZSBpdCBhcyBtcyBmb3IgdGhlIEhTTSB0byBiZSBhYmxlIHRvIHBhcnNlIGl0XG4gICAgdHhKc29uLmRlcGxveS5oZWFkZXIudHRsID0gYCR7dGhpcy5jYXNwZXJUeC5oZWFkZXIudHRsfW1zYDtcbiAgICB0aGlzLnNldE93bmVyc0luSnNvbih0eEpzb24pO1xuICAgIHRoaXMuc2V0VHJhbnNmZXJzRmllbGRzSW5Kc29uKHR4SnNvbik7XG4gICAgdGhpcy5zZXREZWxlZ2F0ZUZpZWxkc0luSnNvbih0eEpzb24pO1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0eEpzb24pO1xuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHRvSnNvbigpOiBDYXNwZXJUcmFuc2FjdGlvbiB7XG4gICAgY29uc3QgZGVwbG95UGF5bWVudCA9IHRoaXMuX2RlcGxveS5wYXltZW50LmFzTW9kdWxlQnl0ZXMoKT8uZ2V0QXJnQnlOYW1lKCdhbW91bnQnKSBhcyBDTFU1MTI7XG4gICAgaWYgKCFkZXBsb3lQYXltZW50KSB7XG4gICAgICB0aHJvdyBuZXcgSW52YWxpZFRyYW5zYWN0aW9uRXJyb3IoJ1VuZGVmaW5lZCBmZWUnKTtcbiAgICB9XG5cbiAgICBjb25zdCBvd25lcjFJbmRleCA9IDA7XG4gICAgY29uc3Qgb3duZXIySW5kZXggPSAxO1xuICAgIGNvbnN0IG93bmVyM0luZGV4ID0gMjtcbiAgICBjb25zdCBzb3VyY2VQdWJsaWNLZXkgPSBCdWZmZXIuZnJvbSh0aGlzLl9kZXBsb3kuaGVhZGVyLmFjY291bnQudmFsdWUoKSkudG9TdHJpbmcoJ2hleCcpO1xuICAgIGNvbnN0IHNvdXJjZUFkZHJlc3MgPSBuZXcgS2V5UGFpcih7IHB1Yjogc291cmNlUHVibGljS2V5IH0pLmdldEFkZHJlc3MoKTtcblxuICAgIGNvbnN0IHJlc3VsdDogQ2FzcGVyVHJhbnNhY3Rpb24gPSB7XG4gICAgICBoYXNoOiBCdWZmZXIuZnJvbSh0aGlzLl9kZXBsb3kuaGFzaCkudG9TdHJpbmcoJ2hleCcpLFxuICAgICAgZmVlOiB7IGdhc0xpbWl0OiBkZXBsb3lQYXltZW50LnZhbHVlKCkudG9TdHJpbmcoKSwgZ2FzUHJpY2U6IHRoaXMuX2RlcGxveS5oZWFkZXIuZ2FzUHJpY2UudG9TdHJpbmcoKSB9LFxuICAgICAgZnJvbTogc291cmNlQWRkcmVzcyxcbiAgICAgIHN0YXJ0VGltZTogbmV3IERhdGUodGhpcy5fZGVwbG95LmhlYWRlci50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCksXG4gICAgICBleHBpcmF0aW9uOiB0aGlzLl9kZXBsb3kuaGVhZGVyLnR0bCxcbiAgICAgIGRlcGxveVR5cGU6ICh0aGlzLl9kZXBsb3kuc2Vzc2lvbi5nZXRBcmdCeU5hbWUoVFJBTlNBQ1RJT05fVFlQRSkgYXMgQ0xTdHJpbmcpLnZhbHVlKCksXG4gICAgfTtcblxuICAgIGNvbnN0IHRyYW5zYWN0aW9uVHlwZSA9IGdldERlcGxveVR5cGUodGhpcy5fZGVwbG95LnNlc3Npb24pO1xuXG4gICAgc3dpdGNoICh0cmFuc2FjdGlvblR5cGUpIHtcbiAgICAgIGNhc2UgVHJhbnNhY3Rpb25UeXBlLlNlbmQ6XG4gICAgICAgIHJlc3VsdC50byA9IGdldFRyYW5zZmVyRGVzdGluYXRpb25BZGRyZXNzKHRoaXMuX2RlcGxveS5zZXNzaW9uKTtcbiAgICAgICAgcmVzdWx0LmFtb3VudCA9IGdldFRyYW5zZmVyQW1vdW50KHRoaXMuX2RlcGxveS5zZXNzaW9uKTtcbiAgICAgICAgcmVzdWx0LnRyYW5zZmVySWQgPSBnZXRUcmFuc2ZlcklkKHRoaXMuX2RlcGxveS5zZXNzaW9uKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5XYWxsZXRJbml0aWFsaXphdGlvbjpcbiAgICAgICAgcmVzdWx0Lm93bmVyMSA9ICh0aGlzLmNhc3BlclR4LnNlc3Npb24uZ2V0QXJnQnlOYW1lKE9XTkVSX1BSRUZJWCArIG93bmVyMUluZGV4KSBhcyBDTFN0cmluZykudmFsdWUoKTtcbiAgICAgICAgcmVzdWx0Lm93bmVyMiA9ICh0aGlzLmNhc3BlclR4LnNlc3Npb24uZ2V0QXJnQnlOYW1lKE9XTkVSX1BSRUZJWCArIG93bmVyMkluZGV4KSBhcyBDTFN0cmluZykudmFsdWUoKTtcbiAgICAgICAgcmVzdWx0Lm93bmVyMyA9ICh0aGlzLmNhc3BlclR4LnNlc3Npb24uZ2V0QXJnQnlOYW1lKE9XTkVSX1BSRUZJWCArIG93bmVyM0luZGV4KSBhcyBDTFN0cmluZykudmFsdWUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5TdGFraW5nTG9jazpcbiAgICAgICAgcmVzdWx0LmZyb21EZWxlZ2F0ZSA9IGdldERlbGVnYXRvckFkZHJlc3ModGhpcy5jYXNwZXJUeC5zZXNzaW9uKTtcbiAgICAgICAgcmVzdWx0LnZhbGlkYXRvciA9IGdldFZhbGlkYXRvckFkZHJlc3ModGhpcy5jYXNwZXJUeC5zZXNzaW9uKTtcbiAgICAgICAgcmVzdWx0LmFtb3VudCA9IGdldERlbGVnYXRlQW1vdW50KHRoaXMuY2FzcGVyVHguc2Vzc2lvbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUcmFuc2FjdGlvblR5cGUuU3Rha2luZ1VubG9jazpcbiAgICAgICAgcmVzdWx0LmZyb21EZWxlZ2F0ZSA9IGdldERlbGVnYXRvckFkZHJlc3ModGhpcy5jYXNwZXJUeC5zZXNzaW9uKTtcbiAgICAgICAgcmVzdWx0LnZhbGlkYXRvciA9IGdldFZhbGlkYXRvckFkZHJlc3ModGhpcy5jYXNwZXJUeC5zZXNzaW9uKTtcbiAgICAgICAgcmVzdWx0LmFtb3VudCA9IGdldERlbGVnYXRlQW1vdW50KHRoaXMuY2FzcGVyVHguc2Vzc2lvbik7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgdHJhbnNhY3Rpb24gdHlwZVxuICAgKlxuICAgKiBAcGFyYW0ge1RyYW5zYWN0aW9uVHlwZX0gdHJhbnNhY3Rpb25UeXBlIFRoZSB0cmFuc2FjdGlvbiB0eXBlIHRvIGJlIHNldFxuICAgKi9cbiAgc2V0VHJhbnNhY3Rpb25UeXBlKHRyYW5zYWN0aW9uVHlwZTogVHJhbnNhY3Rpb25UeXBlKTogdm9pZCB7XG4gICAgdGhpcy5fdHlwZSA9IHRyYW5zYWN0aW9uVHlwZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZSBzaWduYXR1cmVzIGZyb20gdGhlIGRlcGxveSBpbnN0YW5jZSBhbmQgbG9hZCB0aGVtIGludG8gdGhlIHNpZ25hdHVyZXMgbGlzdFxuICAgKi9cbiAgbG9hZFByZXZpb3VzU2lnbmF0dXJlcygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fZGVwbG95LmFwcHJvdmFscyAmJiB0aGlzLl9kZXBsb3kuYXBwcm92YWxzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuX2RlcGxveS5hcHByb3ZhbHMuZm9yRWFjaCgoYXBwcm92YWwpID0+IHtcbiAgICAgICAgdGhpcy5fc2lnbmF0dXJlcy5wdXNoKGFwcHJvdmFsLnNpZ25hdHVyZSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0IG93bmVycyBpbnNpZGUgYSBqc29uIHJlcHJlc2VudGluZyBhIHdhbGxldCBpbml0aWFsaXphdGlvbiB0eC5cbiAgICpcbiAgICogQHBhcmFtIHtSZWNvcmQ8c3RyaW5nLCBhbnk+fSB0eEpzb24ganNvbiB0byBtb2RpZnlcbiAgICovXG4gIHNldE93bmVyc0luSnNvbih0eEpzb246IFJlY29yZDxzdHJpbmcsIGFueT4pOiB2b2lkIHtcbiAgICBpZiAoZ2V0RGVwbG95VHlwZSh0aGlzLmNhc3BlclR4LnNlc3Npb24pID09PSBUcmFuc2FjdGlvblR5cGUuV2FsbGV0SW5pdGlhbGl6YXRpb24pIHtcbiAgICAgIGNvbnN0IGFyZ05hbWUgPSAwO1xuICAgICAgY29uc3QgYXJnVmFsdWUgPSAxO1xuICAgICAgY29uc3Qgb3duZXIwID0gMDtcbiAgICAgIGNvbnN0IG93bmVyMSA9IDE7XG4gICAgICBjb25zdCBvd25lcjIgPSAyO1xuXG4gICAgICBjb25zdCBvd25lcnNWYWx1ZXMgPSBuZXcgTWFwKCk7XG5cbiAgICAgIG93bmVyc1ZhbHVlcy5zZXQoVFJBTlNBQ1RJT05fVFlQRSwgKHRoaXMuY2FzcGVyVHguc2Vzc2lvbi5nZXRBcmdCeU5hbWUoVFJBTlNBQ1RJT05fVFlQRSkgYXMgQ0xTdHJpbmcpLnZhbHVlKCkpO1xuXG4gICAgICBbb3duZXIwLCBvd25lcjEsIG93bmVyMl0uZm9yRWFjaCgoaW5kZXgpID0+IHtcbiAgICAgICAgb3duZXJzVmFsdWVzLnNldChcbiAgICAgICAgICBPV05FUl9QUkVGSVggKyBpbmRleCxcbiAgICAgICAgICAodGhpcy5jYXNwZXJUeC5zZXNzaW9uLmdldEFyZ0J5TmFtZShPV05FUl9QUkVGSVggKyBpbmRleCkgYXMgQ0xTdHJpbmcpLnZhbHVlKClcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgICB0eEpzb25bJ2RlcGxveSddWydzZXNzaW9uJ11bJ01vZHVsZUJ5dGVzJ11bJ2FyZ3MnXS5mb3JFYWNoKChhcmcpID0+IHtcbiAgICAgICAgaWYgKG93bmVyc1ZhbHVlcy5oYXMoYXJnW2FyZ05hbWVdKSkge1xuICAgICAgICAgIGFyZ1thcmdWYWx1ZV1bJ3BhcnNlZCddID0gb3duZXJzVmFsdWVzLmdldChhcmdbYXJnTmFtZV0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRyYW5zZmVyIGZpZWxkcyBpbnNpZGUgYSBqc29uIHJlcHJlc2VudGluZyBhIHRyYW5zZmVyIHR4LlxuICAgKlxuICAgKiBAcGFyYW0ge1JlY29yZDxzdHJpbmcsIGFueT59IHR4SnNvbiBqc29uIHRvIG1vZGlmeVxuICAgKi9cbiAgc2V0VHJhbnNmZXJzRmllbGRzSW5Kc29uKHR4SnNvbjogUmVjb3JkPHN0cmluZywgYW55Pik6IHZvaWQge1xuICAgIGlmIChnZXREZXBsb3lUeXBlKHRoaXMuY2FzcGVyVHguc2Vzc2lvbikgPT09IFRyYW5zYWN0aW9uVHlwZS5TZW5kKSB7XG4gICAgICBjb25zdCBhcmdOYW1lID0gMDtcbiAgICAgIGNvbnN0IGFyZ1ZhbHVlID0gMTtcblxuICAgICAgY29uc3QgdHJhbnNmZXJWYWx1ZXMgPSBuZXcgTWFwKCk7XG4gICAgICB0cmFuc2ZlclZhbHVlcy5zZXQoVFJBTlNBQ1RJT05fVFlQRSwgKHRoaXMuY2FzcGVyVHguc2Vzc2lvbi5nZXRBcmdCeU5hbWUoVFJBTlNBQ1RJT05fVFlQRSkgYXMgQ0xTdHJpbmcpLnZhbHVlKCkpO1xuICAgICAgdHJhbnNmZXJWYWx1ZXMuc2V0KCdhbW91bnQnLCBnZXRUcmFuc2ZlckFtb3VudCh0aGlzLmNhc3BlclR4LnNlc3Npb24pKTtcbiAgICAgIHRyYW5zZmVyVmFsdWVzLnNldCgndG9fYWRkcmVzcycsIGdldFRyYW5zZmVyRGVzdGluYXRpb25BZGRyZXNzKHRoaXMuY2FzcGVyVHguc2Vzc2lvbikpO1xuICAgICAgY29uc3QgdHJhbnNmZXJJZCA9IGdldFRyYW5zZmVySWQodGhpcy5jYXNwZXJUeC5zZXNzaW9uKTtcbiAgICAgIGlmICh0cmFuc2ZlcklkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdHJhbnNmZXJWYWx1ZXMuc2V0KCdpZCcsIHRyYW5zZmVySWQudG9TdHJpbmcoKSk7XG4gICAgICB9XG5cbiAgICAgIHR4SnNvblsnZGVwbG95J11bJ3Nlc3Npb24nXVsnVHJhbnNmZXInXVsnYXJncyddLmZvckVhY2goKGFyZykgPT4ge1xuICAgICAgICBpZiAodHJhbnNmZXJWYWx1ZXMuaGFzKGFyZ1thcmdOYW1lXSkpIHtcbiAgICAgICAgICBhcmdbYXJnVmFsdWVdWydwYXJzZWQnXSA9IHRyYW5zZmVyVmFsdWVzLmdldChhcmdbYXJnTmFtZV0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0IGRlbGVnYXRlIC8gdW5kZWxlZ2F0ZSBmaWVsZHMgaW5zaWRlIGEganNvbiByZXByZXNlbnRpbmcgdGhlIHR4LlxuICAgKlxuICAgKiBAcGFyYW0ge1JlY29yZDxzdHJpbmcsIGFueT59IHR4SnNvbiBqc29uIHRvIG1vZGlmeVxuICAgKi9cbiAgc2V0RGVsZWdhdGVGaWVsZHNJbkpzb24odHhKc29uOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgZ2V0RGVwbG95VHlwZSh0aGlzLmNhc3BlclR4LnNlc3Npb24pID09PSBUcmFuc2FjdGlvblR5cGUuU3Rha2luZ0xvY2sgfHxcbiAgICAgIGdldERlcGxveVR5cGUodGhpcy5jYXNwZXJUeC5zZXNzaW9uKSA9PT0gVHJhbnNhY3Rpb25UeXBlLlN0YWtpbmdVbmxvY2tcbiAgICApIHtcbiAgICAgIGNvbnN0IGFyZ05hbWUgPSAwO1xuICAgICAgY29uc3QgYXJnVmFsdWUgPSAxO1xuXG4gICAgICBjb25zdCBkZWxlZ2F0ZVZhbHVlcyA9IG5ldyBNYXAoKTtcbiAgICAgIGRlbGVnYXRlVmFsdWVzLnNldChUUkFOU0FDVElPTl9UWVBFLCAodGhpcy5jYXNwZXJUeC5zZXNzaW9uLmdldEFyZ0J5TmFtZShUUkFOU0FDVElPTl9UWVBFKSBhcyBDTFN0cmluZykudmFsdWUoKSk7XG4gICAgICBkZWxlZ2F0ZVZhbHVlcy5zZXQoJ2Ftb3VudCcsIGdldERlbGVnYXRlQW1vdW50KHRoaXMuY2FzcGVyVHguc2Vzc2lvbikpO1xuICAgICAgZGVsZWdhdGVWYWx1ZXMuc2V0KERFTEVHQVRFX0ZST01fQUREUkVTUywgZ2V0RGVsZWdhdG9yQWRkcmVzcyh0aGlzLmNhc3BlclR4LnNlc3Npb24pKTtcbiAgICAgIGRlbGVnYXRlVmFsdWVzLnNldChERUxFR0FURV9WQUxJREFUT1IsIGdldFZhbGlkYXRvckFkZHJlc3ModGhpcy5jYXNwZXJUeC5zZXNzaW9uKSk7XG5cbiAgICAgIHR4SnNvbi5kZXBsb3kuc2Vzc2lvbi5Nb2R1bGVCeXRlcy5hcmdzLmZvckVhY2goKGFyZykgPT4ge1xuICAgICAgICBpZiAoZGVsZWdhdGVWYWx1ZXMuaGFzKGFyZ1thcmdOYW1lXSkpIHtcbiAgICAgICAgICBhcmdbYXJnVmFsdWVdWydwYXJzZWQnXSA9IGRlbGVnYXRlVmFsdWVzLmdldChhcmdbYXJnTmFtZV0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBnZXQgY2FzcGVyVHgoKTogRGVwbG95VXRpbC5EZXBsb3kge1xuICAgIHJldHVybiB0aGlzLl9kZXBsb3k7XG4gIH1cblxuICBzZXQgY2FzcGVyVHgoZGVwbG95OiBEZXBsb3lVdGlsLkRlcGxveSkge1xuICAgIHRoaXMuX2RlcGxveSA9IGRlcGxveTtcbiAgfVxuXG4gIC8vIGVuZHJlZ2lvblxufVxuIl19