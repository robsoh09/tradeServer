"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TransactionBuilder = void 0;
const sdk_core_1 = require("@bitgo/sdk-core");
const bignumber_js_1 = __importDefault(require("bignumber.js"));
const keyPair_1 = require("./keyPair");
const multisigUtils_1 = require("./multisigUtils");
const transaction_1 = require("./transaction");
const transferBuilder_1 = require("./transferBuilder");
const utils_1 = require("./utils");
const DEFAULT_M = 3;
/**
 * Tezos transaction builder.
 */
class TransactionBuilder extends sdk_core_1.BaseTransactionBuilder {
    /**
     * Public constructor.
     *
     * @param {CoinConfig} _coinConfig - coin configuration
     */
    constructor(_coinConfig) {
        super(_coinConfig);
        this._type = sdk_core_1.TransactionType.Send;
        this._counter = new bignumber_js_1.default(0);
        this._transfers = [];
        this._walletOwnerPublicKeys = [];
        this._multisigSignerKeyPairs = [];
        this._dataToSignOverride = [];
        this.transaction = new transaction_1.Transaction(_coinConfig);
    }
    // region Base Builder
    /** @inheritdoc */
    fromImplementation(rawTransaction) {
        // Decoding the transaction is an async operation, so save it and leave the decoding for the
        // build step
        this._serializedTransaction = rawTransaction;
        return new transaction_1.Transaction(this._coinConfig);
    }
    /** @inheritdoc */
    signImplementation(key) {
        const signer = new keyPair_1.KeyPair({ prv: key.key });
        // Currently public key revelation is the only type of account update tx supported in Tezos
        if (this._type === sdk_core_1.TransactionType.AccountUpdate && !this._publicKeyToReveal) {
            throw new sdk_core_1.SigningError('Cannot sign a public key revelation transaction without public key');
        }
        if (this._type === sdk_core_1.TransactionType.WalletInitialization && this._walletOwnerPublicKeys.length === 0) {
            throw new sdk_core_1.SigningError('Cannot sign an wallet initialization transaction without owners');
        }
        if (this._type === sdk_core_1.TransactionType.Send &&
            this._transfers.length === 0 &&
            this._serializedTransaction === undefined) {
            throw new sdk_core_1.SigningError('Cannot sign an empty send transaction');
        }
        if (this._type === sdk_core_1.TransactionType.Send && (!this._sourceAddress || this._sourceAddress !== signer.getAddress())) {
            // If the signer is not the source and it is a send transaction, add it to the list of
            // multisig wallet signers
            // TODO: support a combination of keys with and without custom index
            if (key.index && key.index >= DEFAULT_M) {
                throw new sdk_core_1.BuildTransactionError('Custom index cannot be greater than the wallet total number of signers (owners)');
            }
            // Make sure either all keys passed have a custom index or none of them have
            const shouldHaveCustomIndex = key.hasOwnProperty('index');
            for (let i = 0; i < this._multisigSignerKeyPairs.length; i++) {
                if (shouldHaveCustomIndex !== (this._multisigSignerKeyPairs[i].index !== undefined)) {
                    throw new sdk_core_1.BuildTransactionError('Custom index has to be set for all multisig contract signing keys or none');
                }
            }
            const multisigSignerKey = shouldHaveCustomIndex ? { key: signer, index: key.index } : { key: signer };
            this._multisigSignerKeyPairs.push(multisigSignerKey);
        }
        else {
            if (this._sourceKeyPair) {
                throw new sdk_core_1.SigningError('Cannot sign multiple times a non send-type transaction');
            }
            this._sourceKeyPair = signer;
        }
        // Signing the transaction is an async operation, so save the source and leave the actual
        // signing for the build step
        return this.transaction;
    }
    /** @inheritdoc */
    async buildImplementation() {
        // If the from() method was called, use the serialized transaction as a base
        if (this._serializedTransaction) {
            await this.transaction.initFromSerializedTransaction(this._serializedTransaction);
            for (let i = 0; i < this._dataToSignOverride.length; i++) {
                const signatures = await this.getSignatures(this._dataToSignOverride[i].dataToSign);
                await this.transaction.addTransferSignature(signatures, this._dataToSignOverride[i].index || i);
            }
            // TODO: make changes to the transaction if any extra parameter has been set then sign it
        }
        else {
            let contents = [];
            switch (this._type) {
                case sdk_core_1.TransactionType.AccountUpdate:
                    if (this._publicKeyToReveal) {
                        contents.push(this.buildPublicKeyRevelationOperation());
                    }
                    break;
                case sdk_core_1.TransactionType.WalletInitialization:
                    if (this._publicKeyToReveal) {
                        contents.push(this.buildPublicKeyRevelationOperation());
                    }
                    contents.push(this.buildWalletInitializationOperations());
                    break;
                case sdk_core_1.TransactionType.Send:
                    if (this._publicKeyToReveal) {
                        contents.push(this.buildPublicKeyRevelationOperation());
                    }
                    contents = contents.concat(await this.buildSendTransactionContent());
                    break;
                case sdk_core_1.TransactionType.AddressInitialization:
                    if (this._publicKeyToReveal) {
                        contents.push(this.buildPublicKeyRevelationOperation());
                    }
                    contents = contents.concat(this.buildForwarderDeploymentContent());
                    break;
                case sdk_core_1.TransactionType.SingleSigSend:
                    // No support for revelation txns as primary use case is to send from fee address
                    contents = contents.concat(await this.buildSendTransactionContent());
                    break;
                default:
                    throw new sdk_core_1.BuildTransactionError('Unsupported transaction type');
            }
            if (contents.length === 0) {
                throw new sdk_core_1.BuildTransactionError('Empty transaction');
            }
            const parsedTransaction = {
                branch: this._blockHeader,
                contents,
            };
            this.transaction = new transaction_1.Transaction(this._coinConfig);
            // Build and sign a new transaction based on the latest changes
            await this.transaction.initFromParsedTransaction(parsedTransaction);
        }
        if (this._sourceKeyPair && this._sourceKeyPair.getKeys().prv) {
            // TODO: check if there are more signers than needed for a singlesig or multisig transaction
            await this.transaction.sign(this._sourceKeyPair);
        }
        return this.transaction;
    }
    // endregion
    // region Common builder methods
    /**
     * Set the transaction branch id.
     *
     * @param {string} blockId A block hash to use as branch reference
     */
    branch(blockId) {
        if (!(0, utils_1.isValidBlockHash)(blockId)) {
            throw new sdk_core_1.BuildTransactionError('Invalid block hash ' + blockId);
        }
        this._blockHeader = blockId;
    }
    /**
     * The type of transaction being built.
     *
     * @param {TransactionType} type - type of the transaction
     */
    type(type) {
        if (type === sdk_core_1.TransactionType.Send && this._walletOwnerPublicKeys.length > 0) {
            throw new sdk_core_1.BuildTransactionError('Transaction cannot be labeled as Send when owners have already been set');
        }
        if (type !== sdk_core_1.TransactionType.Send && this._transfers.length > 0) {
            throw new sdk_core_1.BuildTransactionError('Transaction contains transfers and can only be labeled as Send');
        }
        this._type = type;
    }
    /**
     * Set the transaction fees. Low fees may get a transaction rejected or never picked up by bakers.
     *
     * @param {Fee} fee Baker fees. May also include the maximum gas and storage fees to pay
     */
    fee(fee) {
        this.validateValue(new bignumber_js_1.default(fee.fee));
        if (fee.gasLimit) {
            this.validateValue(new bignumber_js_1.default(fee.gasLimit));
        }
        if (fee.storageLimit) {
            this.validateValue(new bignumber_js_1.default(fee.storageLimit));
        }
        this._fee = fee;
    }
    /**
     * Set the transaction initiator. This account will pay for the transaction fees, but it will not
     * be added as an owner of a wallet in a init transaction, unless manually set as one of the
     * owners.
     *
     * @param {string} source A Tezos address
     */
    source(source) {
        this.validateAddress({ address: source });
        this._sourceAddress = source;
    }
    /**
     * Set an amount of mutez to transfer in this transaction this transaction. This is different than
     * the amount to transfer from a multisig wallet.
     *
     * @param {string} amount Amount in mutez (1/1000000 Tezies)
     */
    initialBalance(amount) {
        if (this._type !== sdk_core_1.TransactionType.WalletInitialization) {
            throw new sdk_core_1.BuildTransactionError('Initial balance can only be set for wallet initialization transactions');
        }
        this.validateValue(new bignumber_js_1.default(amount));
        this._initialBalance = amount;
    }
    /**
     * Set the transaction counter to prevent submitting repeated transactions.
     *
     * @param {string} counter The counter to use
     */
    counter(counter) {
        this._counter = new bignumber_js_1.default(counter);
    }
    /**
     * Set the destination address of a forwarder contract
     * Used in forwarder contract deployment as destination address
     *
     * @param {string} contractAddress - contract address to use
     */
    forwarderDestination(contractAddress) {
        if (this._type !== sdk_core_1.TransactionType.AddressInitialization) {
            throw new sdk_core_1.BuildTransactionError('Forwarder destination can only be set for address initialization transactions');
        }
        if (!(0, utils_1.isValidOriginatedAddress)(contractAddress)) {
            throw new sdk_core_1.BuildTransactionError('Forwarder destination can only be an originated address');
        }
        this._forwarderDestination = contractAddress;
    }
    // endregion
    // region PublicKeyRevelation builder methods
    /**
     * The public key to reveal.
     *
     * @param {string} publicKey A Tezos public key
     */
    publicKeyToReveal(publicKey) {
        if (this._publicKeyToReveal) {
            throw new sdk_core_1.BuildTransactionError('Public key to reveal already set: ' + this._publicKeyToReveal);
        }
        const keyPair = new keyPair_1.KeyPair({ pub: publicKey });
        if (keyPair.getAddress() !== this._sourceAddress) {
            throw new sdk_core_1.BuildTransactionError('Public key does not match the source address: ' + this._sourceAddress);
        }
        this._publicKeyToReveal = keyPair.getKeys().pub;
    }
    /**
     * Build a reveal operation for the source account with default fees.
     *
     * @returns {RevealOp} A Tezos reveal operation
     */
    buildPublicKeyRevelationOperation() {
        const operation = (0, multisigUtils_1.revealOperation)(this._counter.toString(), this._sourceAddress, this._publicKeyToReveal);
        this._counter = this._counter.plus(1);
        return operation;
    }
    // endregion
    // region WalletInitialization builder methods
    /**
     * Set one of the owners of the multisig wallet.
     *
     * @param {string} publicKey A Tezos public key
     */
    owner(publicKey) {
        if (this._type !== sdk_core_1.TransactionType.WalletInitialization) {
            throw new sdk_core_1.BuildTransactionError('Multisig wallet owner can only be set for initialization transactions');
        }
        if (this._walletOwnerPublicKeys.length >= DEFAULT_M) {
            throw new sdk_core_1.BuildTransactionError('A maximum of ' + DEFAULT_M + ' owners can be set for a multisig wallet');
        }
        if (!(0, utils_1.isValidPublicKey)(publicKey)) {
            throw new sdk_core_1.BuildTransactionError('Invalid public key: ' + publicKey);
        }
        if (this._walletOwnerPublicKeys.includes(publicKey)) {
            throw new sdk_core_1.BuildTransactionError('Repeated owner public key: ' + publicKey);
        }
        this._walletOwnerPublicKeys.push(publicKey);
    }
    /**
     * Set an initial delegate to initialize this wallet to. This is different than the delegation to
     * set while doing a separate delegation transaction.
     *
     * @param {string} delegate The address to delegate the funds to
     */
    initialDelegate(delegate) {
        if (this._type !== sdk_core_1.TransactionType.WalletInitialization) {
            throw new sdk_core_1.BuildTransactionError('Initial delegation can only be set for wallet initialization transactions');
        }
        this.validateAddress({ address: delegate });
        this._initialDelegate = delegate;
    }
    /**
     * Build an origination operation for a generic multisig contract.
     *
     * @returns {Operation} A Tezos origination operation
     */
    buildWalletInitializationOperations() {
        const originationOp = (0, multisigUtils_1.genericMultisigOriginationOperation)(this._counter.toString(), this._sourceAddress, this._fee.fee, this._fee.gasLimit || utils_1.DEFAULT_GAS_LIMIT.ORIGINATION.toString(), this._fee.storageLimit || utils_1.DEFAULT_STORAGE_LIMIT.ORIGINATION.toString(), this._initialBalance || '0', this._walletOwnerPublicKeys, this._initialDelegate);
        this._counter = this._counter.plus(1);
        return originationOp;
    }
    // endregion
    // region Send builder methods
    /**
     * Initialize a new TransferBuilder to for a singlesig or multisig transaction.
     *
     * @param {string} amount Amount in mutez to be transferred
     * @returns {TransferBuilder} A transfer builder
     */
    transfer(amount) {
        if (this._type !== sdk_core_1.TransactionType.Send && this._type !== sdk_core_1.TransactionType.SingleSigSend) {
            throw new sdk_core_1.BuildTransactionError('Transfers can only be set for send transactions');
        }
        let transferBuilder = new transferBuilder_1.TransferBuilder();
        // If source was set, use it as default for
        if (this._sourceAddress) {
            transferBuilder = transferBuilder.from(this._sourceAddress);
        }
        if (this._fee) {
            transferBuilder = transferBuilder.fee(this._fee.fee);
            transferBuilder = this._fee.gasLimit ? transferBuilder.gasLimit(this._fee.gasLimit) : transferBuilder;
            transferBuilder = this._fee.storageLimit ? transferBuilder.storageLimit(this._fee.storageLimit) : transferBuilder;
        }
        this._transfers.push(transferBuilder);
        return transferBuilder.amount(amount);
    }
    /**
     * Calculate the signatures for the multisig transaction.
     *
     * @param {string} packedData The string in hexadecimal to sign
     * @returns {Promise<string[]>} List of signatures for packedData
     */
    async getSignatures(packedData) {
        const signatures = [];
        // Generate the multisig contract signatures
        for (let i = 0; i < this._multisigSignerKeyPairs.length; i++) {
            const signature = await (0, utils_1.sign)(this._multisigSignerKeyPairs[i].key, packedData, new Uint8Array(0));
            const index = this._multisigSignerKeyPairs[i].index;
            signatures.push(index ? { signature: signature.sig, index } : { signature: signature.sig });
        }
        return signatures;
    }
    /**
     * Override the data to sign for a specific transfer. Used for offline signing to pass the
     * respective dataToSign for transfer at a particular index.
     *
     * @param {DataToSignOverride} data - data to override
     */
    overrideDataToSign(data) {
        if (!data.index) {
            data.index = this._dataToSignOverride.length;
        }
        this._dataToSignOverride.push(data);
    }
    /**
     * Build a transaction operation for a generic multisig contract.
     *
     * @returns {Promise<TransactionOp[]>} A Tezos transaction operation
     */
    async buildSendTransactionContent() {
        const contents = [];
        for (let i = 0; i < this._transfers.length; i++) {
            const transfer = this._transfers[i].build();
            let transactionOp;
            if ((0, utils_1.isValidOriginatedAddress)(transfer.from)) {
                // Offline transactions may not have the data to sign
                const signatures = transfer.dataToSign ? await this.getSignatures(transfer.dataToSign) : [];
                transactionOp = (0, multisigUtils_1.multisigTransactionOperation)(this._counter.toString(), this._sourceAddress, transfer.amount, transfer.from, transfer.counter || '0', transfer.to, signatures, transfer.fee.fee, transfer.fee.gasLimit, transfer.fee.storageLimit);
            }
            else {
                transactionOp = (0, multisigUtils_1.singlesigTransactionOperation)(this._counter.toString(), this._sourceAddress, transfer.amount, transfer.to, transfer.fee.fee, transfer.fee.gasLimit, transfer.fee.storageLimit);
            }
            contents.push(transactionOp);
            this._counter = this._counter.plus(1);
        }
        return contents;
    }
    // endregion
    // region ForwarderAddressDeployment
    /**
     * Build a transaction operation for a forwarder contract
     *
     * @returns {OriginationOp} a Tezos transaction operation
     */
    buildForwarderDeploymentContent() {
        const operation = (0, multisigUtils_1.forwarderOriginationOperation)(this._forwarderDestination, this._counter.toString(), this._sourceAddress, this._fee.fee, this._fee.gasLimit || utils_1.DEFAULT_GAS_LIMIT.ORIGINATION.toString(), this._fee.storageLimit || utils_1.DEFAULT_STORAGE_LIMIT.ORIGINATION.toString(), this._initialBalance || '0');
        this._counter = this._counter.plus(1);
        return operation;
    }
    // endregion
    // region Validators
    /** @inheritdoc */
    validateValue(value) {
        if (value.isLessThan(0)) {
            throw new sdk_core_1.BuildTransactionError('Value cannot be below less than zero');
        }
        // TODO: validate the amount is not bigger than the max amount in Tezos
    }
    /** @inheritdoc */
    validateAddress(address) {
        if (!(0, utils_1.isValidAddress)(address.address)) {
            throw new sdk_core_1.BuildTransactionError('Invalid address ' + address.address);
        }
    }
    /** @inheritdoc */
    validateKey(key) {
        const keyPair = new keyPair_1.KeyPair({ prv: key.key });
        if (!keyPair.getKeys().prv) {
            throw new sdk_core_1.BuildTransactionError('Invalid key');
        }
    }
    /** @inheritdoc */
    validateRawTransaction(rawTransaction) {
        // TODO: validate the transaction is either a JSON or a hex
    }
    /** @inheritdoc */
    validateTransaction(transaction) {
        // TODO: validate all required fields are present in the builder before buildImplementation
        switch (this._type) {
            case sdk_core_1.TransactionType.AccountUpdate:
                break;
            case sdk_core_1.TransactionType.WalletInitialization:
                break;
            case sdk_core_1.TransactionType.Send:
                break;
            case sdk_core_1.TransactionType.AddressInitialization:
                break;
            case sdk_core_1.TransactionType.SingleSigSend:
                break;
            default:
                throw new sdk_core_1.BuildTransactionError('Transaction type not supported');
        }
    }
    // endregion
    /** @inheritdoc */
    displayName() {
        return this._coinConfig.fullName;
    }
    /** @inheritdoc */
    get transaction() {
        return this._transaction;
    }
    /** @inheritdoc */
    set transaction(transaction) {
        this._transaction = transaction;
    }
}
exports.TransactionBuilder = TransactionBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb25CdWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi90cmFuc2FjdGlvbkJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsOENBQXdIO0FBRXhILGdFQUFxQztBQUdyQyx1Q0FBb0M7QUFDcEMsbURBTXlCO0FBQ3pCLCtDQUE0QztBQUM1Qyx1REFBb0Q7QUFDcEQsbUNBUWlCO0FBRWpCLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQVVwQjs7R0FFRztBQUNILE1BQWEsa0JBQW1CLFNBQVEsaUNBQXNCO0lBMEI1RDs7OztPQUlHO0lBQ0gsWUFBWSxXQUFpQztRQUMzQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRywwQkFBZSxDQUFDLElBQUksQ0FBQztRQUNsQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksc0JBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsc0JBQXNCLEdBQUcsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUkseUJBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQsc0JBQXNCO0lBQ3RCLGtCQUFrQjtJQUNSLGtCQUFrQixDQUFDLGNBQXNCO1FBQ2pELDRGQUE0RjtRQUM1RixhQUFhO1FBQ2IsSUFBSSxDQUFDLHNCQUFzQixHQUFHLGNBQWMsQ0FBQztRQUM3QyxPQUFPLElBQUkseUJBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELGtCQUFrQjtJQUNSLGtCQUFrQixDQUFDLEdBQVE7UUFDbkMs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b25FcnJvciwgU2lnbmluZ0Vycm9yLCBCYXNlVHJhbnNhY3Rpb25CdWlsZGVyLCBUcmFuc2FjdGlvblR5cGUgfSBmcm9tICdAYml0Z28vc2RrLWNvcmUnO1xuaW1wb3J0IHsgQmFzZUNvaW4gYXMgQ29pbkNvbmZpZyB9IGZyb20gJ0BiaXRnby9zdGF0aWNzJztcbmltcG9ydCBCaWdOdW1iZXIgZnJvbSAnYmlnbnVtYmVyLmpzJztcbmltcG9ydCB7IEFkZHJlc3MgfSBmcm9tICcuL2FkZHJlc3MnO1xuaW1wb3J0IHsgRmVlLCBJbmRleGVkRGF0YSwgSW5kZXhlZFNpZ25hdHVyZSwgS2V5LCBPcGVyYXRpb24sIE9yaWdpbmF0aW9uT3AsIFJldmVhbE9wLCBUcmFuc2FjdGlvbk9wIH0gZnJvbSAnLi9pZmFjZSc7XG5pbXBvcnQgeyBLZXlQYWlyIH0gZnJvbSAnLi9rZXlQYWlyJztcbmltcG9ydCB7XG4gIGZvcndhcmRlck9yaWdpbmF0aW9uT3BlcmF0aW9uLFxuICBnZW5lcmljTXVsdGlzaWdPcmlnaW5hdGlvbk9wZXJhdGlvbixcbiAgbXVsdGlzaWdUcmFuc2FjdGlvbk9wZXJhdGlvbixcbiAgcmV2ZWFsT3BlcmF0aW9uLFxuICBzaW5nbGVzaWdUcmFuc2FjdGlvbk9wZXJhdGlvbixcbn0gZnJvbSAnLi9tdWx0aXNpZ1V0aWxzJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uIH0gZnJvbSAnLi90cmFuc2FjdGlvbic7XG5pbXBvcnQgeyBUcmFuc2ZlckJ1aWxkZXIgfSBmcm9tICcuL3RyYW5zZmVyQnVpbGRlcic7XG5pbXBvcnQge1xuICBERUZBVUxUX0dBU19MSU1JVCxcbiAgREVGQVVMVF9TVE9SQUdFX0xJTUlULFxuICBpc1ZhbGlkQWRkcmVzcyxcbiAgaXNWYWxpZEJsb2NrSGFzaCxcbiAgaXNWYWxpZE9yaWdpbmF0ZWRBZGRyZXNzLFxuICBpc1ZhbGlkUHVibGljS2V5LFxuICBzaWduLFxufSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgREVGQVVMVF9NID0gMztcblxuaW50ZXJmYWNlIERhdGFUb1NpZ25PdmVycmlkZSBleHRlbmRzIEluZGV4ZWREYXRhIHtcbiAgZGF0YVRvU2lnbjogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSW5kZXhlZEtleVBhaXIgZXh0ZW5kcyBJbmRleGVkRGF0YSB7XG4gIGtleTogS2V5UGFpcjtcbn1cblxuLyoqXG4gKiBUZXpvcyB0cmFuc2FjdGlvbiBidWlsZGVyLlxuICovXG5leHBvcnQgY2xhc3MgVHJhbnNhY3Rpb25CdWlsZGVyIGV4dGVuZHMgQmFzZVRyYW5zYWN0aW9uQnVpbGRlciB7XG4gIHByaXZhdGUgX3NlcmlhbGl6ZWRUcmFuc2FjdGlvbjogc3RyaW5nO1xuICBwcml2YXRlIF90cmFuc2FjdGlvbjogVHJhbnNhY3Rpb247XG4gIHByaXZhdGUgX3R5cGU6IFRyYW5zYWN0aW9uVHlwZTtcbiAgcHJpdmF0ZSBfYmxvY2tIZWFkZXI6IHN0cmluZztcbiAgcHJpdmF0ZSBfY291bnRlcjogQmlnTnVtYmVyO1xuICBwcml2YXRlIF9mZWU6IEZlZTtcbiAgcHJpdmF0ZSBfc291cmNlQWRkcmVzczogc3RyaW5nO1xuICBwcml2YXRlIF9zb3VyY2VLZXlQYWlyPzogS2V5UGFpcjtcblxuICAvLyBQdWJsaWMga2V5IHJldmVsYXRpb24gdHJhbnNhY3Rpb24gcGFyYW1ldGVyc1xuICBwcml2YXRlIF9wdWJsaWNLZXlUb1JldmVhbDogc3RyaW5nO1xuXG4gIC8vIFdhbGxldCBpbml0aWFsaXphdGlvbiB0cmFuc2FjdGlvbiBwYXJhbWV0ZXJzXG4gIHByaXZhdGUgX2luaXRpYWxCYWxhbmNlOiBzdHJpbmc7XG4gIHByaXZhdGUgX2luaXRpYWxEZWxlZ2F0ZTogc3RyaW5nO1xuICBwcml2YXRlIF93YWxsZXRPd25lclB1YmxpY0tleXM6IHN0cmluZ1tdO1xuXG4gIC8vIFNlbmQgdHJhbnNhY3Rpb24gcGFyYW1ldGVyc1xuICBwcml2YXRlIF9tdWx0aXNpZ1NpZ25lcktleVBhaXJzOiBJbmRleGVkS2V5UGFpcltdO1xuICBwcml2YXRlIF9kYXRhVG9TaWduT3ZlcnJpZGU6IERhdGFUb1NpZ25PdmVycmlkZVtdO1xuICBwcml2YXRlIF90cmFuc2ZlcnM6IFRyYW5zZmVyQnVpbGRlcltdO1xuXG4gIC8vIEFkZHJlc3MgaW5pdGlhbGl6YXRpb24gcGFyYW1ldGVyc1xuICBwcml2YXRlIF9mb3J3YXJkZXJEZXN0aW5hdGlvbjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBQdWJsaWMgY29uc3RydWN0b3IuXG4gICAqXG4gICAqIEBwYXJhbSB7Q29pbkNvbmZpZ30gX2NvaW5Db25maWcgLSBjb2luIGNvbmZpZ3VyYXRpb25cbiAgICovXG4gIGNvbnN0cnVjdG9yKF9jb2luQ29uZmlnOiBSZWFkb25seTxDb2luQ29uZmlnPikge1xuICAgIHN1cGVyKF9jb2luQ29uZmlnKTtcbiAgICB0aGlzLl90eXBlID0gVHJhbnNhY3Rpb25UeXBlLlNlbmQ7XG4gICAgdGhpcy5fY291bnRlciA9IG5ldyBCaWdOdW1iZXIoMCk7XG4gICAgdGhpcy5fdHJhbnNmZXJzID0gW107XG4gICAgdGhpcy5fd2FsbGV0T3duZXJQdWJsaWNLZXlzID0gW107XG4gICAgdGhpcy5fbXVsdGlzaWdTaWduZXJLZXlQYWlycyA9IFtdO1xuICAgIHRoaXMuX2RhdGFUb1NpZ25PdmVycmlkZSA9IFtdO1xuICAgIHRoaXMudHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oX2NvaW5Db25maWcpO1xuICB9XG5cbiAgLy8gcmVnaW9uIEJhc2UgQnVpbGRlclxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgcHJvdGVjdGVkIGZyb21JbXBsZW1lbnRhdGlvbihyYXdUcmFuc2FjdGlvbjogc3RyaW5nKTogVHJhbnNhY3Rpb24ge1xuICAgIC8vIERlY29kaW5nIHRoZSB0cmFuc2FjdGlvbiBpcyBhbiBhc3luYyBvcGVyYXRpb24sIHNvIHNhdmUgaXQgYW5kIGxlYXZlIHRoZSBkZWNvZGluZyBmb3IgdGhlXG4gICAgLy8gYnVpbGQgc3RlcFxuICAgIHRoaXMuX3NlcmlhbGl6ZWRUcmFuc2FjdGlvbiA9IHJhd1RyYW5zYWN0aW9uO1xuICAgIHJldHVybiBuZXcgVHJhbnNhY3Rpb24odGhpcy5fY29pbkNvbmZpZyk7XG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgcHJvdGVjdGVkIHNpZ25JbXBsZW1lbnRhdGlvbihrZXk6IEtleSk6IFRyYW5zYWN0aW9uIHtcbiAgICBjb25zdCBzaWduZXIgPSBuZXcgS2V5UGFpcih7IHBydjoga2V5LmtleSB9KTtcbiAgICAvLyBDdXJyZW50bHkgcHVibGljIGtleSByZXZlbGF0aW9uIGlzIHRoZSBvbmx5IHR5cGUgb2YgYWNjb3VudCB1cGRhdGUgdHggc3VwcG9ydGVkIGluIFRlem9zXG4gICAgaWYgKHRoaXMuX3R5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5BY2NvdW50VXBkYXRlICYmICF0aGlzLl9wdWJsaWNLZXlUb1JldmVhbCkge1xuICAgICAgdGhyb3cgbmV3IFNpZ25pbmdFcnJvcignQ2Fubm90IHNpZ24gYSBwdWJsaWMga2V5IHJldmVsYXRpb24gdHJhbnNhY3Rpb24gd2l0aG91dCBwdWJsaWMga2V5Jyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX3R5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5XYWxsZXRJbml0aWFsaXphdGlvbiAmJiB0aGlzLl93YWxsZXRPd25lclB1YmxpY0tleXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgU2lnbmluZ0Vycm9yKCdDYW5ub3Qgc2lnbiBhbiB3YWxsZXQgaW5pdGlhbGl6YXRpb24gdHJhbnNhY3Rpb24gd2l0aG91dCBvd25lcnMnKTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLl90eXBlID09PSBUcmFuc2FjdGlvblR5cGUuU2VuZCAmJlxuICAgICAgdGhpcy5fdHJhbnNmZXJzLmxlbmd0aCA9PT0gMCAmJlxuICAgICAgdGhpcy5fc2VyaWFsaXplZFRyYW5zYWN0aW9uID09PSB1bmRlZmluZWRcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBTaWduaW5nRXJyb3IoJ0Nhbm5vdCBzaWduIGFuIGVtcHR5IHNlbmQgdHJhbnNhY3Rpb24nKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fdHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLlNlbmQgJiYgKCF0aGlzLl9zb3VyY2VBZGRyZXNzIHx8IHRoaXMuX3NvdXJjZUFkZHJlc3MgIT09IHNpZ25lci5nZXRBZGRyZXNzKCkpKSB7XG4gICAgICAvLyBJZiB0aGUgc2lnbmVyIGlzIG5vdCB0aGUgc291cmNlIGFuZCBpdCBpcyBhIHNlbmQgdHJhbnNhY3Rpb24sIGFkZCBpdCB0byB0aGUgbGlzdCBvZlxuICAgICAgLy8gbXVsdGlzaWcgd2FsbGV0IHNpZ25lcnNcblxuICAgICAgLy8gVE9ETzogc3VwcG9ydCBhIGNvbWJpbmF0aW9uIG9mIGtleXMgd2l0aCBhbmQgd2l0aG91dCBjdXN0b20gaW5kZXhcbiAgICAgIGlmIChrZXkuaW5kZXggJiYga2V5LmluZGV4ID49IERFRkFVTFRfTSkge1xuICAgICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKFxuICAgICAgICAgICdDdXN0b20gaW5kZXggY2Fubm90IGJlIGdyZWF0ZXIgdGhhbiB0aGUgd2FsbGV0IHRvdGFsIG51bWJlciBvZiBzaWduZXJzIChvd25lcnMpJ1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgLy8gTWFrZSBzdXJlIGVpdGhlciBhbGwga2V5cyBwYXNzZWQgaGF2ZSBhIGN1c3RvbSBpbmRleCBvciBub25lIG9mIHRoZW0gaGF2ZVxuICAgICAgY29uc3Qgc2hvdWxkSGF2ZUN1c3RvbUluZGV4ID0ga2V5Lmhhc093blByb3BlcnR5KCdpbmRleCcpO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9tdWx0aXNpZ1NpZ25lcktleVBhaXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChzaG91bGRIYXZlQ3VzdG9tSW5kZXggIT09ICh0aGlzLl9tdWx0aXNpZ1NpZ25lcktleVBhaXJzW2ldLmluZGV4ICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignQ3VzdG9tIGluZGV4IGhhcyB0byBiZSBzZXQgZm9yIGFsbCBtdWx0aXNpZyBjb250cmFjdCBzaWduaW5nIGtleXMgb3Igbm9uZScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCBtdWx0aXNpZ1NpZ25lcktleSA9IHNob3VsZEhhdmVDdXN0b21JbmRleCA/IHsga2V5OiBzaWduZXIsIGluZGV4OiBrZXkuaW5kZXggfSA6IHsga2V5OiBzaWduZXIgfTtcbiAgICAgIHRoaXMuX211bHRpc2lnU2lnbmVyS2V5UGFpcnMucHVzaChtdWx0aXNpZ1NpZ25lcktleSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLl9zb3VyY2VLZXlQYWlyKSB7XG4gICAgICAgIHRocm93IG5ldyBTaWduaW5nRXJyb3IoJ0Nhbm5vdCBzaWduIG11bHRpcGxlIHRpbWVzIGEgbm9uIHNlbmQtdHlwZSB0cmFuc2FjdGlvbicpO1xuICAgICAgfVxuICAgICAgdGhpcy5fc291cmNlS2V5UGFpciA9IHNpZ25lcjtcbiAgICB9XG5cbiAgICAvLyBTaWduaW5nIHRoZSB0cmFuc2FjdGlvbiBpcyBhbiBhc3luYyBvcGVyYXRpb24sIHNvIHNhdmUgdGhlIHNvdXJjZSBhbmQgbGVhdmUgdGhlIGFjdHVhbFxuICAgIC8vIHNpZ25pbmcgZm9yIHRoZSBidWlsZCBzdGVwXG4gICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb247XG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgcHJvdGVjdGVkIGFzeW5jIGJ1aWxkSW1wbGVtZW50YXRpb24oKTogUHJvbWlzZTxUcmFuc2FjdGlvbj4ge1xuICAgIC8vIElmIHRoZSBmcm9tKCkgbWV0aG9kIHdhcyBjYWxsZWQsIHVzZSB0aGUgc2VyaWFsaXplZCB0cmFuc2FjdGlvbiBhcyBhIGJhc2VcbiAgICBpZiAodGhpcy5fc2VyaWFsaXplZFRyYW5zYWN0aW9uKSB7XG4gICAgICBhd2FpdCB0aGlzLnRyYW5zYWN0aW9uLmluaXRGcm9tU2VyaWFsaXplZFRyYW5zYWN0aW9uKHRoaXMuX3NlcmlhbGl6ZWRUcmFuc2FjdGlvbik7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2RhdGFUb1NpZ25PdmVycmlkZS5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzaWduYXR1cmVzID0gYXdhaXQgdGhpcy5nZXRTaWduYXR1cmVzKHRoaXMuX2RhdGFUb1NpZ25PdmVycmlkZVtpXS5kYXRhVG9TaWduKTtcbiAgICAgICAgYXdhaXQgdGhpcy50cmFuc2FjdGlvbi5hZGRUcmFuc2ZlclNpZ25hdHVyZShzaWduYXR1cmVzLCB0aGlzLl9kYXRhVG9TaWduT3ZlcnJpZGVbaV0uaW5kZXggfHwgaSk7XG4gICAgICB9XG4gICAgICAvLyBUT0RPOiBtYWtlIGNoYW5nZXMgdG8gdGhlIHRyYW5zYWN0aW9uIGlmIGFueSBleHRyYSBwYXJhbWV0ZXIgaGFzIGJlZW4gc2V0IHRoZW4gc2lnbiBpdFxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgY29udGVudHM6IE9wZXJhdGlvbltdID0gW107XG4gICAgICBzd2l0Y2ggKHRoaXMuX3R5cGUpIHtcbiAgICAgICAgY2FzZSBUcmFuc2FjdGlvblR5cGUuQWNjb3VudFVwZGF0ZTpcbiAgICAgICAgICBpZiAodGhpcy5fcHVibGljS2V5VG9SZXZlYWwpIHtcbiAgICAgICAgICAgIGNvbnRlbnRzLnB1c2godGhpcy5idWlsZFB1YmxpY0tleVJldmVsYXRpb25PcGVyYXRpb24oKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5XYWxsZXRJbml0aWFsaXphdGlvbjpcbiAgICAgICAgICBpZiAodGhpcy5fcHVibGljS2V5VG9SZXZlYWwpIHtcbiAgICAgICAgICAgIGNvbnRlbnRzLnB1c2godGhpcy5idWlsZFB1YmxpY0tleVJldmVsYXRpb25PcGVyYXRpb24oKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnRlbnRzLnB1c2godGhpcy5idWlsZFdhbGxldEluaXRpYWxpemF0aW9uT3BlcmF0aW9ucygpKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUcmFuc2FjdGlvblR5cGUuU2VuZDpcbiAgICAgICAgICBpZiAodGhpcy5fcHVibGljS2V5VG9SZXZlYWwpIHtcbiAgICAgICAgICAgIGNvbnRlbnRzLnB1c2godGhpcy5idWlsZFB1YmxpY0tleVJldmVsYXRpb25PcGVyYXRpb24oKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnRlbnRzID0gY29udGVudHMuY29uY2F0KGF3YWl0IHRoaXMuYnVpbGRTZW5kVHJhbnNhY3Rpb25Db250ZW50KCkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5BZGRyZXNzSW5pdGlhbGl6YXRpb246XG4gICAgICAgICAgaWYgKHRoaXMuX3B1YmxpY0tleVRvUmV2ZWFsKSB7XG4gICAgICAgICAgICBjb250ZW50cy5wdXNoKHRoaXMuYnVpbGRQdWJsaWNLZXlSZXZlbGF0aW9uT3BlcmF0aW9uKCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb250ZW50cyA9IGNvbnRlbnRzLmNvbmNhdCh0aGlzLmJ1aWxkRm9yd2FyZGVyRGVwbG95bWVudENvbnRlbnQoKSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVHJhbnNhY3Rpb25UeXBlLlNpbmdsZVNpZ1NlbmQ6XG4gICAgICAgICAgLy8gTm8gc3VwcG9ydCBmb3IgcmV2ZWxhdGlvbiB0eG5zIGFzIHByaW1hcnkgdXNlIGNhc2UgaXMgdG8gc2VuZCBmcm9tIGZlZSBhZGRyZXNzXG4gICAgICAgICAgY29udGVudHMgPSBjb250ZW50cy5jb25jYXQoYXdhaXQgdGhpcy5idWlsZFNlbmRUcmFuc2FjdGlvbkNvbnRlbnQoKSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignVW5zdXBwb3J0ZWQgdHJhbnNhY3Rpb24gdHlwZScpO1xuICAgICAgfVxuICAgICAgaWYgKGNvbnRlbnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdFbXB0eSB0cmFuc2FjdGlvbicpO1xuICAgICAgfVxuICAgICAgY29uc3QgcGFyc2VkVHJhbnNhY3Rpb24gPSB7XG4gICAgICAgIGJyYW5jaDogdGhpcy5fYmxvY2tIZWFkZXIsXG4gICAgICAgIGNvbnRlbnRzLFxuICAgICAgfTtcblxuICAgICAgdGhpcy50cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbih0aGlzLl9jb2luQ29uZmlnKTtcbiAgICAgIC8vIEJ1aWxkIGFuZCBzaWduIGEgbmV3IHRyYW5zYWN0aW9uIGJhc2VkIG9uIHRoZSBsYXRlc3QgY2hhbmdlc1xuICAgICAgYXdhaXQgdGhpcy50cmFuc2FjdGlvbi5pbml0RnJvbVBhcnNlZFRyYW5zYWN0aW9uKHBhcnNlZFRyYW5zYWN0aW9uKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fc291cmNlS2V5UGFpciAmJiB0aGlzLl9zb3VyY2VLZXlQYWlyLmdldEtleXMoKS5wcnYpIHtcbiAgICAgIC8vIFRPRE86IGNoZWNrIGlmIHRoZXJlIGFyZSBtb3JlIHNpZ25lcnMgdGhhbiBuZWVkZWQgZm9yIGEgc2luZ2xlc2lnIG9yIG11bHRpc2lnIHRyYW5zYWN0aW9uXG4gICAgICBhd2FpdCB0aGlzLnRyYW5zYWN0aW9uLnNpZ24odGhpcy5fc291cmNlS2V5UGFpcik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnRyYW5zYWN0aW9uO1xuICB9XG4gIC8vIGVuZHJlZ2lvblxuXG4gIC8vIHJlZ2lvbiBDb21tb24gYnVpbGRlciBtZXRob2RzXG4gIC8qKlxuICAgKiBTZXQgdGhlIHRyYW5zYWN0aW9uIGJyYW5jaCBpZC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJsb2NrSWQgQSBibG9jayBoYXNoIHRvIHVzZSBhcyBicmFuY2ggcmVmZXJlbmNlXG4gICAqL1xuICBicmFuY2goYmxvY2tJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCFpc1ZhbGlkQmxvY2tIYXNoKGJsb2NrSWQpKSB7XG4gICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdJbnZhbGlkIGJsb2NrIGhhc2ggJyArIGJsb2NrSWQpO1xuICAgIH1cbiAgICB0aGlzLl9ibG9ja0hlYWRlciA9IGJsb2NrSWQ7XG4gIH1cblxuICAvKipcbiAgICogVGhlIHR5cGUgb2YgdHJhbnNhY3Rpb24gYmVpbmcgYnVpbHQuXG4gICAqXG4gICAqIEBwYXJhbSB7VHJhbnNhY3Rpb25UeXBlfSB0eXBlIC0gdHlwZSBvZiB0aGUgdHJhbnNhY3Rpb25cbiAgICovXG4gIHR5cGUodHlwZTogVHJhbnNhY3Rpb25UeXBlKTogdm9pZCB7XG4gICAgaWYgKHR5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5TZW5kICYmIHRoaXMuX3dhbGxldE93bmVyUHVibGljS2V5cy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdUcmFuc2FjdGlvbiBjYW5ub3QgYmUgbGFiZWxlZCBhcyBTZW5kIHdoZW4gb3duZXJzIGhhdmUgYWxyZWFkeSBiZWVuIHNldCcpO1xuICAgIH1cbiAgICBpZiAodHlwZSAhPT0gVHJhbnNhY3Rpb25UeXBlLlNlbmQgJiYgdGhpcy5fdHJhbnNmZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ1RyYW5zYWN0aW9uIGNvbnRhaW5zIHRyYW5zZmVycyBhbmQgY2FuIG9ubHkgYmUgbGFiZWxlZCBhcyBTZW5kJyk7XG4gICAgfVxuICAgIHRoaXMuX3R5cGUgPSB0eXBlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgdHJhbnNhY3Rpb24gZmVlcy4gTG93IGZlZXMgbWF5IGdldCBhIHRyYW5zYWN0aW9uIHJlamVjdGVkIG9yIG5ldmVyIHBpY2tlZCB1cCBieSBiYWtlcnMuXG4gICAqXG4gICAqIEBwYXJhbSB7RmVlfSBmZWUgQmFrZXIgZmVlcy4gTWF5IGFsc28gaW5jbHVkZSB0aGUgbWF4aW11bSBnYXMgYW5kIHN0b3JhZ2UgZmVlcyB0byBwYXlcbiAgICovXG4gIGZlZShmZWU6IEZlZSk6IHZvaWQge1xuICAgIHRoaXMudmFsaWRhdGVWYWx1ZShuZXcgQmlnTnVtYmVyKGZlZS5mZWUpKTtcbiAgICBpZiAoZmVlLmdhc0xpbWl0KSB7XG4gICAgICB0aGlzLnZhbGlkYXRlVmFsdWUobmV3IEJpZ051bWJlcihmZWUuZ2FzTGltaXQpKTtcbiAgICB9XG4gICAgaWYgKGZlZS5zdG9yYWdlTGltaXQpIHtcbiAgICAgIHRoaXMudmFsaWRhdGVWYWx1ZShuZXcgQmlnTnVtYmVyKGZlZS5zdG9yYWdlTGltaXQpKTtcbiAgICB9XG4gICAgdGhpcy5fZmVlID0gZmVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgdHJhbnNhY3Rpb24gaW5pdGlhdG9yLiBUaGlzIGFjY291bnQgd2lsbCBwYXkgZm9yIHRoZSB0cmFuc2FjdGlvbiBmZWVzLCBidXQgaXQgd2lsbCBub3RcbiAgICogYmUgYWRkZWQgYXMgYW4gb3duZXIgb2YgYSB3YWxsZXQgaW4gYSBpbml0IHRyYW5zYWN0aW9uLCB1bmxlc3MgbWFudWFsbHkgc2V0IGFzIG9uZSBvZiB0aGVcbiAgICogb3duZXJzLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gc291cmNlIEEgVGV6b3MgYWRkcmVzc1xuICAgKi9cbiAgc291cmNlKHNvdXJjZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy52YWxpZGF0ZUFkZHJlc3MoeyBhZGRyZXNzOiBzb3VyY2UgfSk7XG4gICAgdGhpcy5fc291cmNlQWRkcmVzcyA9IHNvdXJjZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgYW4gYW1vdW50IG9mIG11dGV6IHRvIHRyYW5zZmVyIGluIHRoaXMgdHJhbnNhY3Rpb24gdGhpcyB0cmFuc2FjdGlvbi4gVGhpcyBpcyBkaWZmZXJlbnQgdGhhblxuICAgKiB0aGUgYW1vdW50IHRvIHRyYW5zZmVyIGZyb20gYSBtdWx0aXNpZyB3YWxsZXQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhbW91bnQgQW1vdW50IGluIG11dGV6ICgxLzEwMDAwMDAgVGV6aWVzKVxuICAgKi9cbiAgaW5pdGlhbEJhbGFuY2UoYW1vdW50OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fdHlwZSAhPT0gVHJhbnNhY3Rpb25UeXBlLldhbGxldEluaXRpYWxpemF0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdJbml0aWFsIGJhbGFuY2UgY2FuIG9ubHkgYmUgc2V0IGZvciB3YWxsZXQgaW5pdGlhbGl6YXRpb24gdHJhbnNhY3Rpb25zJyk7XG4gICAgfVxuICAgIHRoaXMudmFsaWRhdGVWYWx1ZShuZXcgQmlnTnVtYmVyKGFtb3VudCkpO1xuICAgIHRoaXMuX2luaXRpYWxCYWxhbmNlID0gYW1vdW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgdHJhbnNhY3Rpb24gY291bnRlciB0byBwcmV2ZW50IHN1Ym1pdHRpbmcgcmVwZWF0ZWQgdHJhbnNhY3Rpb25zLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY291bnRlciBUaGUgY291bnRlciB0byB1c2VcbiAgICovXG4gIGNvdW50ZXIoY291bnRlcjogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5fY291bnRlciA9IG5ldyBCaWdOdW1iZXIoY291bnRlcik7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBkZXN0aW5hdGlvbiBhZGRyZXNzIG9mIGEgZm9yd2FyZGVyIGNvbnRyYWN0XG4gICAqIFVzZWQgaW4gZm9yd2FyZGVyIGNvbnRyYWN0IGRlcGxveW1lbnQgYXMgZGVzdGluYXRpb24gYWRkcmVzc1xuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29udHJhY3RBZGRyZXNzIC0gY29udHJhY3QgYWRkcmVzcyB0byB1c2VcbiAgICovXG4gIGZvcndhcmRlckRlc3RpbmF0aW9uKGNvbnRyYWN0QWRkcmVzczogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3R5cGUgIT09IFRyYW5zYWN0aW9uVHlwZS5BZGRyZXNzSW5pdGlhbGl6YXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0ZvcndhcmRlciBkZXN0aW5hdGlvbiBjYW4gb25seSBiZSBzZXQgZm9yIGFkZHJlc3MgaW5pdGlhbGl6YXRpb24gdHJhbnNhY3Rpb25zJyk7XG4gICAgfVxuICAgIGlmICghaXNWYWxpZE9yaWdpbmF0ZWRBZGRyZXNzKGNvbnRyYWN0QWRkcmVzcykpIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0ZvcndhcmRlciBkZXN0aW5hdGlvbiBjYW4gb25seSBiZSBhbiBvcmlnaW5hdGVkIGFkZHJlc3MnKTtcbiAgICB9XG4gICAgdGhpcy5fZm9yd2FyZGVyRGVzdGluYXRpb24gPSBjb250cmFjdEFkZHJlc3M7XG4gIH1cblxuICAvLyBlbmRyZWdpb25cblxuICAvLyByZWdpb24gUHVibGljS2V5UmV2ZWxhdGlvbiBidWlsZGVyIG1ldGhvZHNcbiAgLyoqXG4gICAqIFRoZSBwdWJsaWMga2V5IHRvIHJldmVhbC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHB1YmxpY0tleSBBIFRlem9zIHB1YmxpYyBrZXlcbiAgICovXG4gIHB1YmxpY0tleVRvUmV2ZWFsKHB1YmxpY0tleTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3B1YmxpY0tleVRvUmV2ZWFsKSB7XG4gICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdQdWJsaWMga2V5IHRvIHJldmVhbCBhbHJlYWR5IHNldDogJyArIHRoaXMuX3B1YmxpY0tleVRvUmV2ZWFsKTtcbiAgICB9XG5cbiAgICBjb25zdCBrZXlQYWlyID0gbmV3IEtleVBhaXIoeyBwdWI6IHB1YmxpY0tleSB9KTtcbiAgICBpZiAoa2V5UGFpci5nZXRBZGRyZXNzKCkgIT09IHRoaXMuX3NvdXJjZUFkZHJlc3MpIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ1B1YmxpYyBrZXkgZG9lcyBub3QgbWF0Y2ggdGhlIHNvdXJjZSBhZGRyZXNzOiAnICsgdGhpcy5fc291cmNlQWRkcmVzcyk7XG4gICAgfVxuICAgIHRoaXMuX3B1YmxpY0tleVRvUmV2ZWFsID0ga2V5UGFpci5nZXRLZXlzKCkucHViO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIGEgcmV2ZWFsIG9wZXJhdGlvbiBmb3IgdGhlIHNvdXJjZSBhY2NvdW50IHdpdGggZGVmYXVsdCBmZWVzLlxuICAgKlxuICAgKiBAcmV0dXJucyB7UmV2ZWFsT3B9IEEgVGV6b3MgcmV2ZWFsIG9wZXJhdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZFB1YmxpY0tleVJldmVsYXRpb25PcGVyYXRpb24oKTogUmV2ZWFsT3Age1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IHJldmVhbE9wZXJhdGlvbih0aGlzLl9jb3VudGVyLnRvU3RyaW5nKCksIHRoaXMuX3NvdXJjZUFkZHJlc3MsIHRoaXMuX3B1YmxpY0tleVRvUmV2ZWFsKTtcbiAgICB0aGlzLl9jb3VudGVyID0gdGhpcy5fY291bnRlci5wbHVzKDEpO1xuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cbiAgLy8gZW5kcmVnaW9uXG5cbiAgLy8gcmVnaW9uIFdhbGxldEluaXRpYWxpemF0aW9uIGJ1aWxkZXIgbWV0aG9kc1xuICAvKipcbiAgICogU2V0IG9uZSBvZiB0aGUgb3duZXJzIG9mIHRoZSBtdWx0aXNpZyB3YWxsZXQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwdWJsaWNLZXkgQSBUZXpvcyBwdWJsaWMga2V5XG4gICAqL1xuICBvd25lcihwdWJsaWNLZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLl90eXBlICE9PSBUcmFuc2FjdGlvblR5cGUuV2FsbGV0SW5pdGlhbGl6YXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ011bHRpc2lnIHdhbGxldCBvd25lciBjYW4gb25seSBiZSBzZXQgZm9yIGluaXRpYWxpemF0aW9uIHRyYW5zYWN0aW9ucycpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fd2FsbGV0T3duZXJQdWJsaWNLZXlzLmxlbmd0aCA+PSBERUZBVUxUX00pIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0EgbWF4aW11bSBvZiAnICsgREVGQVVMVF9NICsgJyBvd25lcnMgY2FuIGJlIHNldCBmb3IgYSBtdWx0aXNpZyB3YWxsZXQnKTtcbiAgICB9XG4gICAgaWYgKCFpc1ZhbGlkUHVibGljS2V5KHB1YmxpY0tleSkpIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0ludmFsaWQgcHVibGljIGtleTogJyArIHB1YmxpY0tleSk7XG4gICAgfVxuICAgIGlmICh0aGlzLl93YWxsZXRPd25lclB1YmxpY0tleXMuaW5jbHVkZXMocHVibGljS2V5KSkge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignUmVwZWF0ZWQgb3duZXIgcHVibGljIGtleTogJyArIHB1YmxpY0tleSk7XG4gICAgfVxuICAgIHRoaXMuX3dhbGxldE93bmVyUHVibGljS2V5cy5wdXNoKHB1YmxpY0tleSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGFuIGluaXRpYWwgZGVsZWdhdGUgdG8gaW5pdGlhbGl6ZSB0aGlzIHdhbGxldCB0by4gVGhpcyBpcyBkaWZmZXJlbnQgdGhhbiB0aGUgZGVsZWdhdGlvbiB0b1xuICAgKiBzZXQgd2hpbGUgZG9pbmcgYSBzZXBhcmF0ZSBkZWxlZ2F0aW9uIHRyYW5zYWN0aW9uLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGVsZWdhdGUgVGhlIGFkZHJlc3MgdG8gZGVsZWdhdGUgdGhlIGZ1bmRzIHRvXG4gICAqL1xuICBpbml0aWFsRGVsZWdhdGUoZGVsZWdhdGU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLl90eXBlICE9PSBUcmFuc2FjdGlvblR5cGUuV2FsbGV0SW5pdGlhbGl6YXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0luaXRpYWwgZGVsZWdhdGlvbiBjYW4gb25seSBiZSBzZXQgZm9yIHdhbGxldCBpbml0aWFsaXphdGlvbiB0cmFuc2FjdGlvbnMnKTtcbiAgICB9XG4gICAgdGhpcy52YWxpZGF0ZUFkZHJlc3MoeyBhZGRyZXNzOiBkZWxlZ2F0ZSB9KTtcbiAgICB0aGlzLl9pbml0aWFsRGVsZWdhdGUgPSBkZWxlZ2F0ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdWlsZCBhbiBvcmlnaW5hdGlvbiBvcGVyYXRpb24gZm9yIGEgZ2VuZXJpYyBtdWx0aXNpZyBjb250cmFjdC5cbiAgICpcbiAgICogQHJldHVybnMge09wZXJhdGlvbn0gQSBUZXpvcyBvcmlnaW5hdGlvbiBvcGVyYXRpb25cbiAgICovXG4gIHByaXZhdGUgYnVpbGRXYWxsZXRJbml0aWFsaXphdGlvbk9wZXJhdGlvbnMoKTogT3JpZ2luYXRpb25PcCB7XG4gICAgY29uc3Qgb3JpZ2luYXRpb25PcCA9IGdlbmVyaWNNdWx0aXNpZ09yaWdpbmF0aW9uT3BlcmF0aW9uKFxuICAgICAgdGhpcy5fY291bnRlci50b1N0cmluZygpLFxuICAgICAgdGhpcy5fc291cmNlQWRkcmVzcyxcbiAgICAgIHRoaXMuX2ZlZS5mZWUsXG4gICAgICB0aGlzLl9mZWUuZ2FzTGltaXQgfHwgREVGQVVMVF9HQVNfTElNSVQuT1JJR0lOQVRJT04udG9TdHJpbmcoKSxcbiAgICAgIHRoaXMuX2ZlZS5zdG9yYWdlTGltaXQgfHwgREVGQVVMVF9TVE9SQUdFX0xJTUlULk9SSUdJTkFUSU9OLnRvU3RyaW5nKCksXG4gICAgICB0aGlzLl9pbml0aWFsQmFsYW5jZSB8fCAnMCcsXG4gICAgICB0aGlzLl93YWxsZXRPd25lclB1YmxpY0tleXMsXG4gICAgICB0aGlzLl9pbml0aWFsRGVsZWdhdGVcbiAgICApO1xuICAgIHRoaXMuX2NvdW50ZXIgPSB0aGlzLl9jb3VudGVyLnBsdXMoMSk7XG4gICAgcmV0dXJuIG9yaWdpbmF0aW9uT3A7XG4gIH1cbiAgLy8gZW5kcmVnaW9uXG5cbiAgLy8gcmVnaW9uIFNlbmQgYnVpbGRlciBtZXRob2RzXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIGEgbmV3IFRyYW5zZmVyQnVpbGRlciB0byBmb3IgYSBzaW5nbGVzaWcgb3IgbXVsdGlzaWcgdHJhbnNhY3Rpb24uXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhbW91bnQgQW1vdW50IGluIG11dGV6IHRvIGJlIHRyYW5zZmVycmVkXG4gICAqIEByZXR1cm5zIHtUcmFuc2ZlckJ1aWxkZXJ9IEEgdHJhbnNmZXIgYnVpbGRlclxuICAgKi9cbiAgdHJhbnNmZXIoYW1vdW50OiBzdHJpbmcpOiBUcmFuc2ZlckJ1aWxkZXIge1xuICAgIGlmICh0aGlzLl90eXBlICE9PSBUcmFuc2FjdGlvblR5cGUuU2VuZCAmJiB0aGlzLl90eXBlICE9PSBUcmFuc2FjdGlvblR5cGUuU2luZ2xlU2lnU2VuZCkge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignVHJhbnNmZXJzIGNhbiBvbmx5IGJlIHNldCBmb3Igc2VuZCB0cmFuc2FjdGlvbnMnKTtcbiAgICB9XG4gICAgbGV0IHRyYW5zZmVyQnVpbGRlciA9IG5ldyBUcmFuc2ZlckJ1aWxkZXIoKTtcbiAgICAvLyBJZiBzb3VyY2Ugd2FzIHNldCwgdXNlIGl0IGFzIGRlZmF1bHQgZm9yXG4gICAgaWYgKHRoaXMuX3NvdXJjZUFkZHJlc3MpIHtcbiAgICAgIHRyYW5zZmVyQnVpbGRlciA9IHRyYW5zZmVyQnVpbGRlci5mcm9tKHRoaXMuX3NvdXJjZUFkZHJlc3MpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZmVlKSB7XG4gICAgICB0cmFuc2ZlckJ1aWxkZXIgPSB0cmFuc2ZlckJ1aWxkZXIuZmVlKHRoaXMuX2ZlZS5mZWUpO1xuICAgICAgdHJhbnNmZXJCdWlsZGVyID0gdGhpcy5fZmVlLmdhc0xpbWl0ID8gdHJhbnNmZXJCdWlsZGVyLmdhc0xpbWl0KHRoaXMuX2ZlZS5nYXNMaW1pdCkgOiB0cmFuc2ZlckJ1aWxkZXI7XG4gICAgICB0cmFuc2ZlckJ1aWxkZXIgPSB0aGlzLl9mZWUuc3RvcmFnZUxpbWl0ID8gdHJhbnNmZXJCdWlsZGVyLnN0b3JhZ2VMaW1pdCh0aGlzLl9mZWUuc3RvcmFnZUxpbWl0KSA6IHRyYW5zZmVyQnVpbGRlcjtcbiAgICB9XG4gICAgdGhpcy5fdHJhbnNmZXJzLnB1c2godHJhbnNmZXJCdWlsZGVyKTtcbiAgICByZXR1cm4gdHJhbnNmZXJCdWlsZGVyLmFtb3VudChhbW91bnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSB0aGUgc2lnbmF0dXJlcyBmb3IgdGhlIG11bHRpc2lnIHRyYW5zYWN0aW9uLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGFja2VkRGF0YSBUaGUgc3RyaW5nIGluIGhleGFkZWNpbWFsIHRvIHNpZ25cbiAgICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nW10+fSBMaXN0IG9mIHNpZ25hdHVyZXMgZm9yIHBhY2tlZERhdGFcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0U2lnbmF0dXJlcyhwYWNrZWREYXRhOiBzdHJpbmcpOiBQcm9taXNlPEluZGV4ZWRTaWduYXR1cmVbXT4ge1xuICAgIGNvbnN0IHNpZ25hdHVyZXM6IEluZGV4ZWRTaWduYXR1cmVbXSA9IFtdO1xuICAgIC8vIEdlbmVyYXRlIHRoZSBtdWx0aXNpZyBjb250cmFjdCBzaWduYXR1cmVzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9tdWx0aXNpZ1NpZ25lcktleVBhaXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBzaWduYXR1cmUgPSBhd2FpdCBzaWduKHRoaXMuX211bHRpc2lnU2lnbmVyS2V5UGFpcnNbaV0ua2V5LCBwYWNrZWREYXRhLCBuZXcgVWludDhBcnJheSgwKSk7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuX211bHRpc2lnU2lnbmVyS2V5UGFpcnNbaV0uaW5kZXg7XG4gICAgICBzaWduYXR1cmVzLnB1c2goaW5kZXggPyB7IHNpZ25hdHVyZTogc2lnbmF0dXJlLnNpZywgaW5kZXggfSA6IHsgc2lnbmF0dXJlOiBzaWduYXR1cmUuc2lnIH0pO1xuICAgIH1cbiAgICByZXR1cm4gc2lnbmF0dXJlcztcbiAgfVxuXG4gIC8qKlxuICAgKiBPdmVycmlkZSB0aGUgZGF0YSB0byBzaWduIGZvciBhIHNwZWNpZmljIHRyYW5zZmVyLiBVc2VkIGZvciBvZmZsaW5lIHNpZ25pbmcgdG8gcGFzcyB0aGVcbiAgICogcmVzcGVjdGl2ZSBkYXRhVG9TaWduIGZvciB0cmFuc2ZlciBhdCBhIHBhcnRpY3VsYXIgaW5kZXguXG4gICAqXG4gICAqIEBwYXJhbSB7RGF0YVRvU2lnbk92ZXJyaWRlfSBkYXRhIC0gZGF0YSB0byBvdmVycmlkZVxuICAgKi9cbiAgb3ZlcnJpZGVEYXRhVG9TaWduKGRhdGE6IERhdGFUb1NpZ25PdmVycmlkZSk6IHZvaWQge1xuICAgIGlmICghZGF0YS5pbmRleCkge1xuICAgICAgZGF0YS5pbmRleCA9IHRoaXMuX2RhdGFUb1NpZ25PdmVycmlkZS5sZW5ndGg7XG4gICAgfVxuICAgIHRoaXMuX2RhdGFUb1NpZ25PdmVycmlkZS5wdXNoKGRhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIGEgdHJhbnNhY3Rpb24gb3BlcmF0aW9uIGZvciBhIGdlbmVyaWMgbXVsdGlzaWcgY29udHJhY3QuXG4gICAqXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFRyYW5zYWN0aW9uT3BbXT59IEEgVGV6b3MgdHJhbnNhY3Rpb24gb3BlcmF0aW9uXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGJ1aWxkU2VuZFRyYW5zYWN0aW9uQ29udGVudCgpOiBQcm9taXNlPFRyYW5zYWN0aW9uT3BbXT4ge1xuICAgIGNvbnN0IGNvbnRlbnRzOiBUcmFuc2FjdGlvbk9wW10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3RyYW5zZmVycy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgdHJhbnNmZXIgPSB0aGlzLl90cmFuc2ZlcnNbaV0uYnVpbGQoKTtcbiAgICAgIGxldCB0cmFuc2FjdGlvbk9wO1xuICAgICAgaWYgKGlzVmFsaWRPcmlnaW5hdGVkQWRkcmVzcyh0cmFuc2Zlci5mcm9tKSkge1xuICAgICAgICAvLyBPZmZsaW5lIHRyYW5zYWN0aW9ucyBtYXkgbm90IGhhdmUgdGhlIGRhdGEgdG8gc2lnblxuICAgICAgICBjb25zdCBzaWduYXR1cmVzID0gdHJhbnNmZXIuZGF0YVRvU2lnbiA/IGF3YWl0IHRoaXMuZ2V0U2lnbmF0dXJlcyh0cmFuc2Zlci5kYXRhVG9TaWduKSA6IFtdO1xuICAgICAgICB0cmFuc2FjdGlvbk9wID0gbXVsdGlzaWdUcmFuc2FjdGlvbk9wZXJhdGlvbihcbiAgICAgICAgICB0aGlzLl9jb3VudGVyLnRvU3RyaW5nKCksXG4gICAgICAgICAgdGhpcy5fc291cmNlQWRkcmVzcyxcbiAgICAgICAgICB0cmFuc2Zlci5hbW91bnQsXG4gICAgICAgICAgdHJhbnNmZXIuZnJvbSxcbiAgICAgICAgICB0cmFuc2Zlci5jb3VudGVyIHx8ICcwJyxcbiAgICAgICAgICB0cmFuc2Zlci50byxcbiAgICAgICAgICBzaWduYXR1cmVzLFxuICAgICAgICAgIHRyYW5zZmVyLmZlZS5mZWUsXG4gICAgICAgICAgdHJhbnNmZXIuZmVlLmdhc0xpbWl0LFxuICAgICAgICAgIHRyYW5zZmVyLmZlZS5zdG9yYWdlTGltaXRcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRyYW5zYWN0aW9uT3AgPSBzaW5nbGVzaWdUcmFuc2FjdGlvbk9wZXJhdGlvbihcbiAgICAgICAgICB0aGlzLl9jb3VudGVyLnRvU3RyaW5nKCksXG4gICAgICAgICAgdGhpcy5fc291cmNlQWRkcmVzcyxcbiAgICAgICAgICB0cmFuc2Zlci5hbW91bnQsXG4gICAgICAgICAgdHJhbnNmZXIudG8sXG4gICAgICAgICAgdHJhbnNmZXIuZmVlLmZlZSxcbiAgICAgICAgICB0cmFuc2Zlci5mZWUuZ2FzTGltaXQsXG4gICAgICAgICAgdHJhbnNmZXIuZmVlLnN0b3JhZ2VMaW1pdFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgY29udGVudHMucHVzaCh0cmFuc2FjdGlvbk9wKTtcbiAgICAgIHRoaXMuX2NvdW50ZXIgPSB0aGlzLl9jb3VudGVyLnBsdXMoMSk7XG4gICAgfVxuICAgIHJldHVybiBjb250ZW50cztcbiAgfVxuICAvLyBlbmRyZWdpb25cblxuICAvLyByZWdpb24gRm9yd2FyZGVyQWRkcmVzc0RlcGxveW1lbnRcbiAgLyoqXG4gICAqIEJ1aWxkIGEgdHJhbnNhY3Rpb24gb3BlcmF0aW9uIGZvciBhIGZvcndhcmRlciBjb250cmFjdFxuICAgKlxuICAgKiBAcmV0dXJucyB7T3JpZ2luYXRpb25PcH0gYSBUZXpvcyB0cmFuc2FjdGlvbiBvcGVyYXRpb25cbiAgICovXG4gIHByaXZhdGUgYnVpbGRGb3J3YXJkZXJEZXBsb3ltZW50Q29udGVudCgpOiBPcmlnaW5hdGlvbk9wIHtcbiAgICBjb25zdCBvcGVyYXRpb24gPSBmb3J3YXJkZXJPcmlnaW5hdGlvbk9wZXJhdGlvbihcbiAgICAgIHRoaXMuX2ZvcndhcmRlckRlc3RpbmF0aW9uLFxuICAgICAgdGhpcy5fY291bnRlci50b1N0cmluZygpLFxuICAgICAgdGhpcy5fc291cmNlQWRkcmVzcyxcbiAgICAgIHRoaXMuX2ZlZS5mZWUsXG4gICAgICB0aGlzLl9mZWUuZ2FzTGltaXQgfHwgREVGQVVMVF9HQVNfTElNSVQuT1JJR0lOQVRJT04udG9TdHJpbmcoKSxcbiAgICAgIHRoaXMuX2ZlZS5zdG9yYWdlTGltaXQgfHwgREVGQVVMVF9TVE9SQUdFX0xJTUlULk9SSUdJTkFUSU9OLnRvU3RyaW5nKCksXG4gICAgICB0aGlzLl9pbml0aWFsQmFsYW5jZSB8fCAnMCdcbiAgICApO1xuICAgIHRoaXMuX2NvdW50ZXIgPSB0aGlzLl9jb3VudGVyLnBsdXMoMSk7XG4gICAgcmV0dXJuIG9wZXJhdGlvbjtcbiAgfVxuICAvLyBlbmRyZWdpb25cblxuICAvLyByZWdpb24gVmFsaWRhdG9yc1xuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgdmFsaWRhdGVWYWx1ZSh2YWx1ZTogQmlnTnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHZhbHVlLmlzTGVzc1RoYW4oMCkpIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ1ZhbHVlIGNhbm5vdCBiZSBiZWxvdyBsZXNzIHRoYW4gemVybycpO1xuICAgIH1cbiAgICAvLyBUT0RPOiB2YWxpZGF0ZSB0aGUgYW1vdW50IGlzIG5vdCBiaWdnZXIgdGhhbiB0aGUgbWF4IGFtb3VudCBpbiBUZXpvc1xuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHZhbGlkYXRlQWRkcmVzcyhhZGRyZXNzOiBBZGRyZXNzKTogdm9pZCB7XG4gICAgaWYgKCFpc1ZhbGlkQWRkcmVzcyhhZGRyZXNzLmFkZHJlc3MpKSB7XG4gICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdJbnZhbGlkIGFkZHJlc3MgJyArIGFkZHJlc3MuYWRkcmVzcyk7XG4gICAgfVxuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHZhbGlkYXRlS2V5KGtleTogQmFzZUtleSk6IHZvaWQge1xuICAgIGNvbnN0IGtleVBhaXIgPSBuZXcgS2V5UGFpcih7IHBydjoga2V5LmtleSB9KTtcbiAgICBpZiAoIWtleVBhaXIuZ2V0S2V5cygpLnBydikge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignSW52YWxpZCBrZXknKTtcbiAgICB9XG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgdmFsaWRhdGVSYXdUcmFuc2FjdGlvbihyYXdUcmFuc2FjdGlvbjogYW55KTogdm9pZCB7XG4gICAgLy8gVE9ETzogdmFsaWRhdGUgdGhlIHRyYW5zYWN0aW9uIGlzIGVpdGhlciBhIEpTT04gb3IgYSBoZXhcbiAgfVxuXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICB2YWxpZGF0ZVRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbik6IHZvaWQge1xuICAgIC8vIFRPRE86IHZhbGlkYXRlIGFsbCByZXF1aXJlZCBmaWVsZHMgYXJlIHByZXNlbnQgaW4gdGhlIGJ1aWxkZXIgYmVmb3JlIGJ1aWxkSW1wbGVtZW50YXRpb25cbiAgICBzd2l0Y2ggKHRoaXMuX3R5cGUpIHtcbiAgICAgIGNhc2UgVHJhbnNhY3Rpb25UeXBlLkFjY291bnRVcGRhdGU6XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUcmFuc2FjdGlvblR5cGUuV2FsbGV0SW5pdGlhbGl6YXRpb246XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUcmFuc2FjdGlvblR5cGUuU2VuZDpcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5BZGRyZXNzSW5pdGlhbGl6YXRpb246XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUcmFuc2FjdGlvblR5cGUuU2luZ2xlU2lnU2VuZDpcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdUcmFuc2FjdGlvbiB0eXBlIG5vdCBzdXBwb3J0ZWQnKTtcbiAgICB9XG4gIH1cbiAgLy8gZW5kcmVnaW9uXG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIGRpc3BsYXlOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2NvaW5Db25maWcuZnVsbE5hbWU7XG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgcHJvdGVjdGVkIGdldCB0cmFuc2FjdGlvbigpOiBUcmFuc2FjdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMuX3RyYW5zYWN0aW9uO1xuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHByb3RlY3RlZCBzZXQgdHJhbnNhY3Rpb24odHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uKSB7XG4gICAgdGhpcy5fdHJhbnNhY3Rpb24gPSB0cmFuc2FjdGlvbjtcbiAgfVxufVxuIl19