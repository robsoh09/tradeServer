"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KeyRegistrationBuilder = void 0;
const bignumber_js_1 = __importDefault(require("bignumber.js"));
const algosdk_1 = __importDefault(require("algosdk"));
const sdk_core_1 = require("@bitgo/sdk-core");
const transactionBuilder_1 = require("./transactionBuilder");
const txnSchema_1 = require("./txnSchema");
const utils_1 = __importDefault(require("./utils"));
class KeyRegistrationBuilder extends transactionBuilder_1.TransactionBuilder {
    constructor(coinConfig) {
        super(coinConfig);
    }
    /**
     * Sets the vote key
     *
     * @returns {KeyRegistrationBuilder} This Key Registration builder.
     *
     * @param {string} key The root participation public key. See Generate a Participation Key to learn more.
     * https://developer.algorand.org/docs/reference/transactions/#key-registration-transaction
     */
    voteKey(key) {
        this._voteKey = key;
        return this;
    }
    /**
     * Sets the selection key
     *
     * @returns {KeyRegistrationBuilder} This Key Registration builder.
     *
     * @param {string} key The VRF public key for the account.
     * https://developer.algorand.org/docs/reference/transactions/#key-registration-transaction
     */
    selectionKey(key) {
        this._selectionKey = key;
        return this;
    }
    /**
     * Sets the stateProof key
     *
     * @returns {KeyRegistrationBuilder} This Key Registration builder.
     *
     * @param {string} key The stateproof key. See consensus for more information.
     * https://developer.algorand.org/docs/get-details/algorand_consensus/?from_query=state#state-proof-keys
     */
    stateProofKey(key) {
        utils_1.default.validateBase64(key);
        this._stateProofKey = key;
        return this;
    }
    /**
     *Sets the vote first round
     *
     * @returns {KeyRegistrationBuilder} This Key Registration builder.
     *
     * @param {number} round The first round that the participation key is valid. Not to be confused with the FirstValid round of the keyreg transaction.
     * https://developer.algorand.org/docs/reference/transactions/#key-registration-transaction
     */
    voteFirst(round) {
        this.validateValue(new bignumber_js_1.default(round));
        this._voteFirst = round;
        return this;
    }
    /**
     * Sets the vote last round
     *
     * @returns {KeyRegistrationBuilder} This Key Registration builder.
     *
     * A recommended range is 3,000,000 rounds.
     *
     * @param {number} round No theoretical limit.
     * https://developer.algorand.org/docs/run-a-node/participate/generate_keys/
     */
    voteLast(round) {
        this.validateValue(new bignumber_js_1.default(round));
        this._voteLast = round;
        return this;
    }
    /**
     * Sets the vote key dilution
     *
     * @returns {KeyRegistrationBuilder} This Key Registration builder.
     *
     * Defaults to 10,000
     *
     * @param {number} size [10000]. To reduce the size of the participation key, set the key dilution value to roughly the square root of the range that the partkey is valid for.
     * https://developer.algorand.org/docs/run-a-node/participate/generate_keys/#generate-the-participation-key-with-goal
     * @param size
     */
    voteKeyDilution(size = 10000) {
        this.validateValue(new bignumber_js_1.default(size));
        this._voteKeyDilution = size;
        return this;
    }
    /**
     * Sets the non participation flag
     *
     * @returns {KeyRegistrationBuilder} This Key Registration builder.
     *
     * @param {boolean} nonParticipation All new Algorand accounts are participating by default.
     * This means that they earn rewards. Mark an account nonparticipating by setting this value to true and this account
     * will no longer earn rewards NEVER.
     * https://developer.algorand.org/docs/reference/transactions/#key-registration-transaction
     */
    nonParticipation(nonParticipation) {
        this._nonParticipation = nonParticipation;
        return this;
    }
    buildAlgoTxn() {
        return this.isOfflineKeyRegAccountLibTransaction()
            ? this.buildOfflineKeyRegTransaction()
            : this.isNonParticipationKeyRegAccountLibTransaction()
                ? this.buildNonParticipationKeyRegTransaction()
                : this.buildOnlineKeyRegTransaction();
    }
    buildOfflineKeyRegTransaction() {
        return algosdk_1.default.makeKeyRegistrationTxnWithSuggestedParams(this._sender, this._note, undefined, // voteKey param
        undefined, // selectionKey param
        undefined, // voteFirst param
        undefined, // voteLast param
        undefined, // voteKeyDilution param
        this.suggestedParams);
    }
    buildOnlineKeyRegTransaction() {
        return algosdk_1.default.makeKeyRegistrationTxnWithSuggestedParams(this._sender, this._note, this._voteKey, this._selectionKey, this._voteFirst, this._voteLast, this._voteKeyDilution, this.suggestedParams, undefined, // reKeyTo param
        undefined, // nonParticipation param
        this._stateProofKey);
    }
    buildNonParticipationKeyRegTransaction() {
        return algosdk_1.default.makeKeyRegistrationTxnWithSuggestedParams(this._sender, this._note, undefined, // voteKey param
        undefined, // selectionKey param
        undefined, // voteFirst param
        undefined, // voteLast param
        undefined, // voteKeyDilution param
        this.suggestedParams, this._reKeyTo, true // nonParticipation param
        );
    }
    get transactionType() {
        return sdk_core_1.TransactionType.WalletInitialization;
    }
    /** @inheritdoc */
    fromImplementation(rawTransaction) {
        const tx = super.fromImplementation(rawTransaction);
        const algoTxn = tx.getAlgoTransaction();
        if (algoTxn) {
            if (this.isNonParticipationKeyRegAlgoSDKTransaction(algoTxn)) {
                this.nonParticipation(!!algoTxn.nonParticipation);
            }
            else if (this.isOnlineKeyRegAlgoSDKTransaction(algoTxn)) {
                this.voteKey(algoTxn.voteKey.toString('base64'));
                this.selectionKey(algoTxn.selectionKey.toString('base64'));
                this.voteFirst(algoTxn.voteFirst);
                this.voteLast(algoTxn.voteLast);
                this.voteKeyDilution(algoTxn.voteKeyDilution);
                if (algoTxn.stateProofKey) {
                    this.stateProofKey(algoTxn.stateProofKey.toString('base64'));
                }
            }
        }
        return tx;
    }
    /** @inheritdoc */
    validateRawTransaction(rawTransaction) {
        const decodeTxn = utils_1.default.decodeAlgoTxn(rawTransaction);
        const algoTxn = decodeTxn.txn;
        if (algoTxn.type !== algosdk_1.default.TransactionType.keyreg) {
            throw new sdk_core_1.InvalidTransactionError(`Invalid Transaction Type: ${algoTxn.type}. Expected ${algosdk_1.default.TransactionType.keyreg}`);
        }
        if (this.isOnlineKeyRegAlgoSDKTransaction(algoTxn)) {
            this.validateFields(algoTxn.voteKey.toString('base64'), algoTxn.selectionKey.toString('base64'), algoTxn.voteFirst, algoTxn.voteLast, algoTxn.voteKeyDilution, algoTxn.stateProofKey && algoTxn.stateProofKey.toString('base64'));
        }
    }
    isNonParticipationKeyRegAlgoSDKTransaction(algoTxn) {
        return !!algoTxn.nonParticipation;
    }
    isNonParticipationKeyRegAccountLibTransaction() {
        return !!this._nonParticipation;
    }
    isOnlineKeyRegAlgoSDKTransaction(algoTxn) {
        return !(this.isOfflineKeyRegAlgoSDKTransaction(algoTxn) || this.isNonParticipationKeyRegAlgoSDKTransaction(algoTxn));
    }
    isOnlineKeyRegAccountLibTransaction() {
        return !(this.isOfflineKeyRegAccountLibTransaction() || this.isNonParticipationKeyRegAccountLibTransaction());
    }
    isOfflineKeyRegAlgoSDKTransaction(algoTxn) {
        return (!algoTxn.voteKey &&
            !algoTxn.selectionKey &&
            !algoTxn.voteFirst &&
            !algoTxn.voteLast &&
            !algoTxn.voteKeyDilution &&
            !algoTxn.stateProofKey &&
            !algoTxn.nonParticipation);
    }
    isOfflineKeyRegAccountLibTransaction() {
        return (!this._voteKey &&
            !this._selectionKey &&
            !this._voteFirst &&
            !this._voteLast &&
            !this._voteKeyDilution &&
            !this._stateProofKey &&
            !this._nonParticipation);
    }
    /** @inheritdoc */
    validateTransaction(transaction) {
        super.validateTransaction(transaction);
        if (this.isOnlineKeyRegAccountLibTransaction()) {
            // invalid offline will reach here
            this.validateFields(this._voteKey, this._selectionKey, this._voteFirst, this._voteLast, this._voteKeyDilution, this._stateProofKey);
        }
        else {
            // offline or nonparticipation transaction
            if (this._voteKey ||
                this._selectionKey ||
                this._voteFirst ||
                this._voteLast ||
                this._voteKeyDilution ||
                this._stateProofKey) {
                throw new sdk_core_1.InvalidTransactionError('VoteKey, SelectionKey, VoteFirst, VoteLast, VoteKeyDilution, StateProofKey fields cannot be set when offline or nonparticipation is set');
            }
        }
    }
    validateFields(voteKey, selectionKey, voteFirst, voteLast, voteKeyDilution, stateProofKey) {
        const validationResult = txnSchema_1.KeyRegTxnSchema.validate({
            voteKey,
            selectionKey,
            voteFirst,
            voteLast,
            voteKeyDilution,
            stateProofKey,
        });
        if (validationResult.error) {
            throw new sdk_core_1.InvalidTransactionError(`Transaction validation failed: ${validationResult.error.message}`);
        }
    }
}
exports.KeyRegistrationBuilder = KeyRegistrationBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5UmVnaXN0cmF0aW9uQnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIva2V5UmVnaXN0cmF0aW9uQnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnRUFBcUM7QUFDckMsc0RBQThCO0FBRTlCLDhDQUEyRTtBQUMzRSw2REFBMEQ7QUFFMUQsMkNBQThDO0FBQzlDLG9EQUE0QjtBQUU1QixNQUFhLHNCQUF1QixTQUFRLHVDQUFrQjtJQVM1RCxZQUFZLFVBQWdDO1FBQzFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNILE9BQU8sQ0FBQyxHQUFXO1FBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDO1FBQ3BCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSCxZQUFZLENBQUMsR0FBVztRQUN0QixJQUFJLENBQUMsYUFBYSxHQUFHLEdBQUcsQ0FBQztRQUN6QixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsYUFBYSxDQUFDLEdBQVc7UUFDdkIsZUFBSyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxQixJQUFJLENBQUMsY0FBYyxHQUFHLEdBQUcsQ0FBQztRQUMxQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsU0FBUyxDQUFDLEtBQWE7UUFDckIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLHNCQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztRQUV4QixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSCxRQUFRLENBQUMsS0FBYTtRQUNwQixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUks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QixDQUFDLGtDQUFrQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztTQUN2RztJQUNILENBQUM7Q0FDRjtBQXhURCx3REF3VEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmlnTnVtYmVyIGZyb20gJ2JpZ251bWJlci5qcyc7XG5pbXBvcnQgYWxnb3NkayBmcm9tICdhbGdvc2RrJztcbmltcG9ydCB7IEJhc2VDb2luIGFzIENvaW5Db25maWcgfSBmcm9tICdAYml0Z28vc3RhdGljcyc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvblR5cGUsIEludmFsaWRUcmFuc2FjdGlvbkVycm9yIH0gZnJvbSAnQGJpdGdvL3Nkay1jb3JlJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uQnVpbGRlciB9IGZyb20gJy4vdHJhbnNhY3Rpb25CdWlsZGVyJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uIH0gZnJvbSAnLi90cmFuc2FjdGlvbic7XG5pbXBvcnQgeyBLZXlSZWdUeG5TY2hlbWEgfSBmcm9tICcuL3R4blNjaGVtYSc7XG5pbXBvcnQgVXRpbHMgZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBjbGFzcyBLZXlSZWdpc3RyYXRpb25CdWlsZGVyIGV4dGVuZHMgVHJhbnNhY3Rpb25CdWlsZGVyIHtcbiAgcHJvdGVjdGVkIF92b3RlS2V5OiBzdHJpbmc7XG4gIHByb3RlY3RlZCBfc2VsZWN0aW9uS2V5OiBzdHJpbmc7XG4gIHByb3RlY3RlZCBfdm90ZUZpcnN0OiBudW1iZXI7XG4gIHByb3RlY3RlZCBfdm90ZUxhc3Q6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF92b3RlS2V5RGlsdXRpb246IG51bWJlcjtcbiAgcHJvdGVjdGVkIF9ub25QYXJ0aWNpcGF0aW9uOiBib29sZWFuO1xuICBwcm90ZWN0ZWQgX3N0YXRlUHJvb2ZLZXk6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihjb2luQ29uZmlnOiBSZWFkb25seTxDb2luQ29uZmlnPikge1xuICAgIHN1cGVyKGNvaW5Db25maWcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIHZvdGUga2V5XG4gICAqXG4gICAqIEByZXR1cm5zIHtLZXlSZWdpc3RyYXRpb25CdWlsZGVyfSBUaGlzIEtleSBSZWdpc3RyYXRpb24gYnVpbGRlci5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUgcm9vdCBwYXJ0aWNpcGF0aW9uIHB1YmxpYyBrZXkuIFNlZSBHZW5lcmF0ZSBhIFBhcnRpY2lwYXRpb24gS2V5IHRvIGxlYXJuIG1vcmUuXG4gICAqIGh0dHBzOi8vZGV2ZWxvcGVyLmFsZ29yYW5kLm9yZy9kb2NzL3JlZmVyZW5jZS90cmFuc2FjdGlvbnMvI2tleS1yZWdpc3RyYXRpb24tdHJhbnNhY3Rpb25cbiAgICovXG4gIHZvdGVLZXkoa2V5OiBzdHJpbmcpOiBLZXlSZWdpc3RyYXRpb25CdWlsZGVyIHtcbiAgICB0aGlzLl92b3RlS2V5ID0ga2V5O1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIHNlbGVjdGlvbiBrZXlcbiAgICpcbiAgICogQHJldHVybnMge0tleVJlZ2lzdHJhdGlvbkJ1aWxkZXJ9IFRoaXMgS2V5IFJlZ2lzdHJhdGlvbiBidWlsZGVyLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBWUkYgcHVibGljIGtleSBmb3IgdGhlIGFjY291bnQuXG4gICAqIGh0dHBzOi8vZGV2ZWxvcGVyLmFsZ29yYW5kLm9yZy9kb2NzL3JlZmVyZW5jZS90cmFuc2FjdGlvbnMvI2tleS1yZWdpc3RyYXRpb24tdHJhbnNhY3Rpb25cbiAgICovXG4gIHNlbGVjdGlvbktleShrZXk6IHN0cmluZyk6IEtleVJlZ2lzdHJhdGlvbkJ1aWxkZXIge1xuICAgIHRoaXMuX3NlbGVjdGlvbktleSA9IGtleTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBzdGF0ZVByb29mIGtleVxuICAgKlxuICAgKiBAcmV0dXJucyB7S2V5UmVnaXN0cmF0aW9uQnVpbGRlcn0gVGhpcyBLZXkgUmVnaXN0cmF0aW9uIGJ1aWxkZXIuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIHN0YXRlcHJvb2Yga2V5LiBTZWUgY29uc2Vuc3VzIGZvciBtb3JlIGluZm9ybWF0aW9uLlxuICAgKiBodHRwczovL2RldmVsb3Blci5hbGdvcmFuZC5vcmcvZG9jcy9nZXQtZGV0YWlscy9hbGdvcmFuZF9jb25zZW5zdXMvP2Zyb21fcXVlcnk9c3RhdGUjc3RhdGUtcHJvb2Yta2V5c1xuICAgKi9cbiAgc3RhdGVQcm9vZktleShrZXk6IHN0cmluZyk6IEtleVJlZ2lzdHJhdGlvbkJ1aWxkZXIge1xuICAgIFV0aWxzLnZhbGlkYXRlQmFzZTY0KGtleSk7XG4gICAgdGhpcy5fc3RhdGVQcm9vZktleSA9IGtleTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKlNldHMgdGhlIHZvdGUgZmlyc3Qgcm91bmRcbiAgICpcbiAgICogQHJldHVybnMge0tleVJlZ2lzdHJhdGlvbkJ1aWxkZXJ9IFRoaXMgS2V5IFJlZ2lzdHJhdGlvbiBidWlsZGVyLlxuICAgKlxuICAgKiBAcGFyYW0ge251bWJlcn0gcm91bmQgVGhlIGZpcnN0IHJvdW5kIHRoYXQgdGhlIHBhcnRpY2lwYXRpb24ga2V5IGlzIHZhbGlkLiBOb3QgdG8gYmUgY29uZnVzZWQgd2l0aCB0aGUgRmlyc3RWYWxpZCByb3VuZCBvZiB0aGUga2V5cmVnIHRyYW5zYWN0aW9uLlxuICAgKiBodHRwczovL2RldmVsb3Blci5hbGdvcmFuZC5vcmcvZG9jcy9yZWZlcmVuY2UvdHJhbnNhY3Rpb25zLyNrZXktcmVnaXN0cmF0aW9uLXRyYW5zYWN0aW9uXG4gICAqL1xuICB2b3RlRmlyc3Qocm91bmQ6IG51bWJlcik6IEtleVJlZ2lzdHJhdGlvbkJ1aWxkZXIge1xuICAgIHRoaXMudmFsaWRhdGVWYWx1ZShuZXcgQmlnTnVtYmVyKHJvdW5kKSk7XG4gICAgdGhpcy5fdm90ZUZpcnN0ID0gcm91bmQ7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSB2b3RlIGxhc3Qgcm91bmRcbiAgICpcbiAgICogQHJldHVybnMge0tleVJlZ2lzdHJhdGlvbkJ1aWxkZXJ9IFRoaXMgS2V5IFJlZ2lzdHJhdGlvbiBidWlsZGVyLlxuICAgKlxuICAgKiBBIHJlY29tbWVuZGVkIHJhbmdlIGlzIDMsMDAwLDAwMCByb3VuZHMuXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSByb3VuZCBObyB0aGVvcmV0aWNhbCBsaW1pdC5cbiAgICogaHR0cHM6Ly9kZXZlbG9wZXIuYWxnb3JhbmQub3JnL2RvY3MvcnVuLWEtbm9kZS9wYXJ0aWNpcGF0ZS9nZW5lcmF0ZV9rZXlzL1xuICAgKi9cbiAgdm90ZUxhc3Qocm91bmQ6IG51bWJlcik6IEtleVJlZ2lzdHJhdGlvbkJ1aWxkZXIge1xuICAgIHRoaXMudmFsaWRhdGVWYWx1ZShuZXcgQmlnTnVtYmVyKHJvdW5kKSk7XG4gICAgdGhpcy5fdm90ZUxhc3QgPSByb3VuZDtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIHZvdGUga2V5IGRpbHV0aW9uXG4gICAqXG4gICAqIEByZXR1cm5zIHtLZXlSZWdpc3RyYXRpb25CdWlsZGVyfSBUaGlzIEtleSBSZWdpc3RyYXRpb24gYnVpbGRlci5cbiAgICpcbiAgICogRGVmYXVsdHMgdG8gMTAsMDAwXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBzaXplIFsxMDAwMF0uIFRvIHJlZHVjZSB0aGUgc2l6ZSBvZiB0aGUgcGFydGljaXBhdGlvbiBrZXksIHNldCB0aGUga2V5IGRpbHV0aW9uIHZhbHVlIHRvIHJvdWdobHkgdGhlIHNxdWFyZSByb290IG9mIHRoZSByYW5nZSB0aGF0IHRoZSBwYXJ0a2V5IGlzIHZhbGlkIGZvci5cbiAgICogaHR0cHM6Ly9kZXZlbG9wZXIuYWxnb3JhbmQub3JnL2RvY3MvcnVuLWEtbm9kZS9wYXJ0aWNpcGF0ZS9nZW5lcmF0ZV9rZXlzLyNnZW5lcmF0ZS10aGUtcGFydGljaXBhdGlvbi1rZXktd2l0aC1nb2FsXG4gICAqIEBwYXJhbSBzaXplXG4gICAqL1xuICB2b3RlS2V5RGlsdXRpb24oc2l6ZSA9IDEwMDAwKTogS2V5UmVnaXN0cmF0aW9uQnVpbGRlciB7XG4gICAgdGhpcy52YWxpZGF0ZVZhbHVlKG5ldyBCaWdOdW1iZXIoc2l6ZSkpO1xuICAgIHRoaXMuX3ZvdGVLZXlEaWx1dGlvbiA9IHNpemU7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBub24gcGFydGljaXBhdGlvbiBmbGFnXG4gICAqXG4gICAqIEByZXR1cm5zIHtLZXlSZWdpc3RyYXRpb25CdWlsZGVyfSBUaGlzIEtleSBSZWdpc3RyYXRpb24gYnVpbGRlci5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSBub25QYXJ0aWNpcGF0aW9uIEFsbCBuZXcgQWxnb3JhbmQgYWNjb3VudHMgYXJlIHBhcnRpY2lwYXRpbmcgYnkgZGVmYXVsdC5cbiAgICogVGhpcyBtZWFucyB0aGF0IHRoZXkgZWFybiByZXdhcmRzLiBNYXJrIGFuIGFjY291bnQgbm9ucGFydGljaXBhdGluZyBieSBzZXR0aW5nIHRoaXMgdmFsdWUgdG8gdHJ1ZSBhbmQgdGhpcyBhY2NvdW50XG4gICAqIHdpbGwgbm8gbG9uZ2VyIGVhcm4gcmV3YXJkcyBORVZFUi5cbiAgICogaHR0cHM6Ly9kZXZlbG9wZXIuYWxnb3JhbmQub3JnL2RvY3MvcmVmZXJlbmNlL3RyYW5zYWN0aW9ucy8ja2V5LXJlZ2lzdHJhdGlvbi10cmFuc2FjdGlvblxuICAgKi9cbiAgbm9uUGFydGljaXBhdGlvbihub25QYXJ0aWNpcGF0aW9uOiBib29sZWFuKTogS2V5UmVnaXN0cmF0aW9uQnVpbGRlciB7XG4gICAgdGhpcy5fbm9uUGFydGljaXBhdGlvbiA9IG5vblBhcnRpY2lwYXRpb247XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHByb3RlY3RlZCBidWlsZEFsZ29UeG4oKTogYWxnb3Nkay5UcmFuc2FjdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNPZmZsaW5lS2V5UmVnQWNjb3VudExpYlRyYW5zYWN0aW9uKClcbiAgICAgID8gdGhpcy5idWlsZE9mZmxpbmVLZXlSZWdUcmFuc2FjdGlvbigpXG4gICAgICA6IHRoaXMuaXNOb25QYXJ0aWNpcGF0aW9uS2V5UmVnQWNjb3VudExpYlRyYW5zYWN0aW9uKClcbiAgICAgID8gdGhpcy5idWlsZE5vblBhcnRpY2lwYXRpb25LZXlSZWdUcmFuc2FjdGlvbigpXG4gICAgICA6IHRoaXMuYnVpbGRPbmxpbmVLZXlSZWdUcmFuc2FjdGlvbigpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZE9mZmxpbmVLZXlSZWdUcmFuc2FjdGlvbigpOiBhbGdvc2RrLlRyYW5zYWN0aW9uIHtcbiAgICByZXR1cm4gYWxnb3Nkay5tYWtlS2V5UmVnaXN0cmF0aW9uVHhuV2l0aFN1Z2dlc3RlZFBhcmFtcyhcbiAgICAgIHRoaXMuX3NlbmRlcixcbiAgICAgIHRoaXMuX25vdGUsXG4gICAgICB1bmRlZmluZWQsIC8vIHZvdGVLZXkgcGFyYW1cbiAgICAgIHVuZGVmaW5lZCwgLy8gc2VsZWN0aW9uS2V5IHBhcmFtXG4gICAgICB1bmRlZmluZWQsIC8vIHZvdGVGaXJzdCBwYXJhbVxuICAgICAgdW5kZWZpbmVkLCAvLyB2b3RlTGFzdCBwYXJhbVxuICAgICAgdW5kZWZpbmVkLCAvLyB2b3RlS2V5RGlsdXRpb24gcGFyYW1cbiAgICAgIHRoaXMuc3VnZ2VzdGVkUGFyYW1zXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRPbmxpbmVLZXlSZWdUcmFuc2FjdGlvbigpOiBhbGdvc2RrLlRyYW5zYWN0aW9uIHtcbiAgICByZXR1cm4gYWxnb3Nkay5tYWtlS2V5UmVnaXN0cmF0aW9uVHhuV2l0aFN1Z2dlc3RlZFBhcmFtcyhcbiAgICAgIHRoaXMuX3NlbmRlcixcbiAgICAgIHRoaXMuX25vdGUsXG4gICAgICB0aGlzLl92b3RlS2V5LFxuICAgICAgdGhpcy5fc2VsZWN0aW9uS2V5LFxuICAgICAgdGhpcy5fdm90ZUZpcnN0LFxuICAgICAgdGhpcy5fdm90ZUxhc3QsXG4gICAgICB0aGlzLl92b3RlS2V5RGlsdXRpb24sXG4gICAgICB0aGlzLnN1Z2dlc3RlZFBhcmFtcyxcbiAgICAgIHVuZGVmaW5lZCwgLy8gcmVLZXlUbyBwYXJhbVxuICAgICAgdW5kZWZpbmVkLCAvLyBub25QYXJ0aWNpcGF0aW9uIHBhcmFtXG4gICAgICB0aGlzLl9zdGF0ZVByb29mS2V5XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGROb25QYXJ0aWNpcGF0aW9uS2V5UmVnVHJhbnNhY3Rpb24oKTogYWxnb3Nkay5UcmFuc2FjdGlvbiB7XG4gICAgcmV0dXJuIGFsZ29zZGsubWFrZUtleVJlZ2lzdHJhdGlvblR4bldpdGhTdWdnZXN0ZWRQYXJhbXMoXG4gICAgICB0aGlzLl9zZW5kZXIsXG4gICAgICB0aGlzLl9ub3RlLFxuICAgICAgdW5kZWZpbmVkLCAvLyB2b3RlS2V5IHBhcmFtXG4gICAgICB1bmRlZmluZWQsIC8vIHNlbGVjdGlvbktleSBwYXJhbVxuICAgICAgdW5kZWZpbmVkLCAvLyB2b3RlRmlyc3QgcGFyYW1cbiAgICAgIHVuZGVmaW5lZCwgLy8gdm90ZUxhc3QgcGFyYW1cbiAgICAgIHVuZGVmaW5lZCwgLy8gdm90ZUtleURpbHV0aW9uIHBhcmFtXG4gICAgICB0aGlzLnN1Z2dlc3RlZFBhcmFtcyxcbiAgICAgIHRoaXMuX3JlS2V5VG8sXG4gICAgICB0cnVlIC8vIG5vblBhcnRpY2lwYXRpb24gcGFyYW1cbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldCB0cmFuc2FjdGlvblR5cGUoKTogVHJhbnNhY3Rpb25UeXBlIHtcbiAgICByZXR1cm4gVHJhbnNhY3Rpb25UeXBlLldhbGxldEluaXRpYWxpemF0aW9uO1xuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHByb3RlY3RlZCBmcm9tSW1wbGVtZW50YXRpb24ocmF3VHJhbnNhY3Rpb246IFVpbnQ4QXJyYXkgfCBzdHJpbmcpOiBUcmFuc2FjdGlvbiB7XG4gICAgY29uc3QgdHggPSBzdXBlci5mcm9tSW1wbGVtZW50YXRpb24ocmF3VHJhbnNhY3Rpb24pO1xuICAgIGNvbnN0IGFsZ29UeG4gPSB0eC5nZXRBbGdvVHJhbnNhY3Rpb24oKTtcblxuICAgIGlmIChhbGdvVHhuKSB7XG4gICAgICBpZiAodGhpcy5pc05vblBhcnRpY2lwYXRpb25LZXlSZWdBbGdvU0RLVHJhbnNhY3Rpb24oYWxnb1R4bikpIHtcbiAgICAgICAgdGhpcy5ub25QYXJ0aWNpcGF0aW9uKCEhYWxnb1R4bi5ub25QYXJ0aWNpcGF0aW9uKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc09ubGluZUtleVJlZ0FsZ29TREtUcmFuc2FjdGlvbihhbGdvVHhuKSkge1xuICAgICAgICB0aGlzLnZvdGVLZXkoYWxnb1R4bi52b3RlS2V5LnRvU3RyaW5nKCdiYXNlNjQnKSk7XG4gICAgICAgIHRoaXMuc2VsZWN0aW9uS2V5KGFsZ29UeG4uc2VsZWN0aW9uS2V5LnRvU3RyaW5nKCdiYXNlNjQnKSk7XG4gICAgICAgIHRoaXMudm90ZUZpcnN0KGFsZ29UeG4udm90ZUZpcnN0KTtcbiAgICAgICAgdGhpcy52b3RlTGFzdChhbGdvVHhuLnZvdGVMYXN0KTtcbiAgICAgICAgdGhpcy52b3RlS2V5RGlsdXRpb24oYWxnb1R4bi52b3RlS2V5RGlsdXRpb24pO1xuICAgICAgICBpZiAoYWxnb1R4bi5zdGF0ZVByb29mS2V5KSB7XG4gICAgICAgICAgdGhpcy5zdGF0ZVByb29mS2V5KGFsZ29UeG4uc3RhdGVQcm9vZktleS50b1N0cmluZygnYmFzZTY0JykpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0eDtcbiAgfVxuXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICB2YWxpZGF0ZVJhd1RyYW5zYWN0aW9uKHJhd1RyYW5zYWN0aW9uOiBVaW50OEFycmF5IHwgc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgZGVjb2RlVHhuID0gVXRpbHMuZGVjb2RlQWxnb1R4bihyYXdUcmFuc2FjdGlvbik7XG4gICAgY29uc3QgYWxnb1R4biA9IGRlY29kZVR4bi50eG47XG4gICAgaWYgKGFsZ29UeG4udHlwZSAhPT0gYWxnb3Nkay5UcmFuc2FjdGlvblR5cGUua2V5cmVnKSB7XG4gICAgICB0aHJvdyBuZXcgSW52YWxpZFRyYW5zYWN0aW9uRXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIFRyYW5zYWN0aW9uIFR5cGU6ICR7YWxnb1R4bi50eXBlfS4gRXhwZWN0ZWQgJHthbGdvc2RrLlRyYW5zYWN0aW9uVHlwZS5rZXlyZWd9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc09ubGluZUtleVJlZ0FsZ29TREtUcmFuc2FjdGlvbihhbGdvVHhuKSkge1xuICAgICAgdGhpcy52YWxpZGF0ZUZpZWxkcyhcbiAgICAgICAgYWxnb1R4bi52b3RlS2V5LnRvU3RyaW5nKCdiYXNlNjQnKSxcbiAgICAgICAgYWxnb1R4bi5zZWxlY3Rpb25LZXkudG9TdHJpbmcoJ2Jhc2U2NCcpLFxuICAgICAgICBhbGdvVHhuLnZvdGVGaXJzdCxcbiAgICAgICAgYWxnb1R4bi52b3RlTGFzdCxcbiAgICAgICAgYWxnb1R4bi52b3RlS2V5RGlsdXRpb24sXG4gICAgICAgIGFsZ29UeG4uc3RhdGVQcm9vZktleSAmJiBhbGdvVHhuLnN0YXRlUHJvb2ZLZXkudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNOb25QYXJ0aWNpcGF0aW9uS2V5UmVnQWxnb1NES1RyYW5zYWN0aW9uKGFsZ29UeG46IGFsZ29zZGsuVHJhbnNhY3Rpb24pOiBib29sZWFuIHtcbiAgICByZXR1cm4gISFhbGdvVHhuLm5vblBhcnRpY2lwYXRpb247XG4gIH1cblxuICBwcml2YXRlIGlzTm9uUGFydGljaXBhdGlvbktleVJlZ0FjY291bnRMaWJUcmFuc2FjdGlvbigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLl9ub25QYXJ0aWNpcGF0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBpc09ubGluZUtleVJlZ0FsZ29TREtUcmFuc2FjdGlvbihhbGdvVHhuOiBhbGdvc2RrLlRyYW5zYWN0aW9uKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEoXG4gICAgICB0aGlzLmlzT2ZmbGluZUtleVJlZ0FsZ29TREtUcmFuc2FjdGlvbihhbGdvVHhuKSB8fCB0aGlzLmlzTm9uUGFydGljaXBhdGlvbktleVJlZ0FsZ29TREtUcmFuc2FjdGlvbihhbGdvVHhuKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGlzT25saW5lS2V5UmVnQWNjb3VudExpYlRyYW5zYWN0aW9uKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhKHRoaXMuaXNPZmZsaW5lS2V5UmVnQWNjb3VudExpYlRyYW5zYWN0aW9uKCkgfHwgdGhpcy5pc05vblBhcnRpY2lwYXRpb25LZXlSZWdBY2NvdW50TGliVHJhbnNhY3Rpb24oKSk7XG4gIH1cblxuICBwcml2YXRlIGlzT2ZmbGluZUtleVJlZ0FsZ29TREtUcmFuc2FjdGlvbihhbGdvVHhuOiBhbGdvc2RrLlRyYW5zYWN0aW9uKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgICFhbGdvVHhuLnZvdGVLZXkgJiZcbiAgICAgICFhbGdvVHhuLnNlbGVjdGlvbktleSAmJlxuICAgICAgIWFsZ29UeG4udm90ZUZpcnN0ICYmXG4gICAgICAhYWxnb1R4bi52b3RlTGFzdCAmJlxuICAgICAgIWFsZ29UeG4udm90ZUtleURpbHV0aW9uICYmXG4gICAgICAhYWxnb1R4bi5zdGF0ZVByb29mS2V5ICYmXG4gICAgICAhYWxnb1R4bi5ub25QYXJ0aWNpcGF0aW9uXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNPZmZsaW5lS2V5UmVnQWNjb3VudExpYlRyYW5zYWN0aW9uKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICAhdGhpcy5fdm90ZUtleSAmJlxuICAgICAgIXRoaXMuX3NlbGVjdGlvbktleSAmJlxuICAgICAgIXRoaXMuX3ZvdGVGaXJzdCAmJlxuICAgICAgIXRoaXMuX3ZvdGVMYXN0ICYmXG4gICAgICAhdGhpcy5fdm90ZUtleURpbHV0aW9uICYmXG4gICAgICAhdGhpcy5fc3RhdGVQcm9vZktleSAmJlxuICAgICAgIXRoaXMuX25vblBhcnRpY2lwYXRpb25cbiAgICApO1xuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHZhbGlkYXRlVHJhbnNhY3Rpb24odHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uKTogdm9pZCB7XG4gICAgc3VwZXIudmFsaWRhdGVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbik7XG4gICAgaWYgKHRoaXMuaXNPbmxpbmVLZXlSZWdBY2NvdW50TGliVHJhbnNhY3Rpb24oKSkge1xuICAgICAgLy8gaW52YWxpZCBvZmZsaW5lIHdpbGwgcmVhY2ggaGVyZVxuICAgICAgdGhpcy52YWxpZGF0ZUZpZWxkcyhcbiAgICAgICAgdGhpcy5fdm90ZUtleSxcbiAgICAgICAgdGhpcy5fc2VsZWN0aW9uS2V5LFxuICAgICAgICB0aGlzLl92b3RlRmlyc3QsXG4gICAgICAgIHRoaXMuX3ZvdGVMYXN0LFxuICAgICAgICB0aGlzLl92b3RlS2V5RGlsdXRpb24sXG4gICAgICAgIHRoaXMuX3N0YXRlUHJvb2ZLZXlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIG9mZmxpbmUgb3Igbm9ucGFydGljaXBhdGlvbiB0cmFuc2FjdGlvblxuICAgICAgaWYgKFxuICAgICAgICB0aGlzLl92b3RlS2V5IHx8XG4gICAgICAgIHRoaXMuX3NlbGVjdGlvbktleSB8fFxuICAgICAgICB0aGlzLl92b3RlRmlyc3QgfHxcbiAgICAgICAgdGhpcy5fdm90ZUxhc3QgfHxcbiAgICAgICAgdGhpcy5fdm90ZUtleURpbHV0aW9uIHx8XG4gICAgICAgIHRoaXMuX3N0YXRlUHJvb2ZLZXlcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFRyYW5zYWN0aW9uRXJyb3IoXG4gICAgICAgICAgJ1ZvdGVLZXksIFNlbGVjdGlvbktleSwgVm90ZUZpcnN0LCBWb3RlTGFzdCwgVm90ZUtleURpbHV0aW9uLCBTdGF0ZVByb29mS2V5IGZpZWxkcyBjYW5ub3QgYmUgc2V0IHdoZW4gb2ZmbGluZSBvciBub25wYXJ0aWNpcGF0aW9uIGlzIHNldCdcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlRmllbGRzKFxuICAgIHZvdGVLZXk6IHN0cmluZyxcbiAgICBzZWxlY3Rpb25LZXk6IHN0cmluZyxcbiAgICB2b3RlRmlyc3Q6IG51bWJlcixcbiAgICB2b3RlTGFzdDogbnVtYmVyLFxuICAgIHZvdGVLZXlEaWx1dGlvbjogbnVtYmVyLFxuICAgIHN0YXRlUHJvb2ZLZXk/OiBzdHJpbmdcbiAgKTogdm9pZCB7XG4gICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IEtleVJlZ1R4blNjaGVtYS52YWxpZGF0ZSh7XG4gICAgICB2b3RlS2V5LFxuICAgICAgc2VsZWN0aW9uS2V5LFxuICAgICAgdm90ZUZpcnN0LFxuICAgICAgdm90ZUxhc3QsXG4gICAgICB2b3RlS2V5RGlsdXRpb24sXG4gICAgICBzdGF0ZVByb29mS2V5LFxuICAgIH0pO1xuXG4gICAgaWYgKHZhbGlkYXRpb25SZXN1bHQuZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkVHJhbnNhY3Rpb25FcnJvcihgVHJhbnNhY3Rpb24gdmFsaWRhdGlvbiBmYWlsZWQ6ICR7dmFsaWRhdGlvblJlc3VsdC5lcnJvci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxufVxuIl19